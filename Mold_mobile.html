<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ê¸ˆí˜• Spare Scanner</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/3.3.4/vue.global.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        :root {
            --bg-body: #111827;
            --bg-card: #1f2937;
            --text-main: #f9fafb;
            --accent: #10b981;
            --danger: #ef4444;
            --border: #374151;
        }

        body {
            background-color: var(--bg-body);
            color: var(--text-main);
            font-family: 'Segoe UI', sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        header {
            background: var(--bg-card);
            padding: 15px;
            text-align: center;
            font-weight: bold;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .container {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 20px;
            overflow-y: auto;
        }

        .btn {
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: white;
            padding: 12px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            width: 100%;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            position: relative;
            overflow: hidden;
        }

        .btn-primary {
            background: var(--accent);
            color: black;
            border: none;
            font-weight: bold;
        }

        .btn-danger {
            background: var(--danger);
            border: none;
        }

        .card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 15px;
            border: 1px solid var(--border);
            margin-bottom: 15px;
        }

        input,
        select {
            width: 100%;
            background: #374151;
            border: 1px solid var(--border);
            color: white;
            padding: 12px;
            border-radius: 8px;
            font-size: 16px;
            box-sizing: border-box;
            margin-bottom: 10px;
        }

        #reader {
            width: 100%;
            border-radius: 12px;
            overflow: hidden;
            background: black;
            margin-bottom: 20px;
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal {
            background: var(--bg-body);
            width: 90%;
            max-width: 400px;
            border-radius: 12px;
            padding: 20px;
            border: 1px solid var(--accent);
        }

        .loading {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        /* File Input Wrapper */
        .file-input-wrapper {
            position: absolute;
            inset: 0;
            opacity: 0;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <div id="app">
        <header>
            <i class="fa-solid fa-qrcode" style="color:var(--accent)"></i>
            <span>Mold Mobile Scanner</span>
            <span style="font-size:12px; color:#aaa;">V2.0</span>
            <a href="index.html"
                style="margin-left:auto; background:#334155; color:#e2e8f0; border:1px solid #475569; border-radius:6px; padding:4px 10px; text-decoration:none; font-size:12px; font-weight:700;">ğŸ </a>
        </header>

        <!-- Loading Overlay -->
        <div v-if="loading" class="loading">
            <i class="fa-solid fa-spinner fa-spin fa-3x" style="color:var(--accent); margin-bottom:20px;"></i>
            <div style="font-size:18px;">{{ loadingMsg }}</div>
        </div>

        <!-- MAIN SCREEN -->
        <div class="container" v-if="!currentProject">
            <!-- Global QR Scanner -->
            <div class="card" style="text-align:center; border-color:var(--accent);">
                <i class="fa-solid fa-camera fa-3x" style="color:var(--accent); margin-bottom:15px;"></i>
                <h3>QR ìŠ¤ìº”ìœ¼ë¡œ ì‹œì‘í•˜ê¸°</h3>
                <p style="color:#aaa; font-size:14px; margin-bottom:20px;">
                    í”„ë¡œì íŠ¸ ìë™ ë¡œë“œ & ìˆ˜ì •<br>
                    (Auto Load Project & Edit)
                </p>
                <button class="btn btn-primary" @click="startGlobalScanner">
                    <i class="fa-solid fa-qrcode"></i> ì¹´ë©”ë¼ ìŠ¤ìº” (Camera)
                </button>
                <div style="margin-top:10px; color:#aaa; font-size:12px;">
                    * ë³´ì•ˆì„ ìœ„í•´ ì‹¤ì‹œê°„ ì¹´ë©”ë¼ ìŠ¤ìº”ë§Œ í—ˆìš©ë©ë‹ˆë‹¤.<br>
                    (Only real-time camera scan allowed for security)
                </div>
            </div>

            <div v-if="isGlobalScanning" class="modal-overlay" @click.self="stopScanner">
                <div class="modal" style="width:90%;">
                    <div id="reader-global" style="width:100%;"></div>
                    <button class="btn btn-danger" @click="stopScanner">ë‹«ê¸° (Close)</button>
                </div>
            </div>

            <!-- Manual Selection -->
            <div class="card" style="text-align:center;">
                <h3>ë˜ëŠ” ìˆ˜ë™ ì„ íƒ</h3>

                <div v-if="cloudProjects.length === 0" style="margin-bottom:20px;">
                    <button class="btn" @click="loadCloudProjects">
                        <i class="fa-solid fa-sync"></i> í”„ë¡œì íŠ¸ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
                    </button>
                </div>
                <div v-else>
                    <select v-model="selectedProjectName" @change="loadProjectData">
                        <option value="" disabled>í”„ë¡œì íŠ¸ ì„ íƒ (Select Project)...</option>
                        <option v-for="p in cloudProjects" :value="p.name">
                            {{ p.name }} ({{ p.count }} items)
                        </option>
                    </select>
                </div>
            </div>
        </div>

        <div class="container" v-else>
            <!-- Project Header -->
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <div style="font-weight:bold; color:var(--accent);">
                    <i class="fa-solid fa-folder-open"></i> {{ currentProject }}
                </div>
                <button
                    style="background:none; border:1px solid #666; color:#aaa; padding:5px 10px; border-radius:4px; cursor:pointer;"
                    @click="exitProject">
                    ë‚˜ê°€ê¸° (Exit)
                </button>
            </div>

            <!-- SCANNER AREA -->
            <div v-if="isScanning" style="flex:1; display:flex; flex-direction:column;">
                <div id="reader"></div>
                <button class="btn btn-danger" @click="stopScanner">ìŠ¤ìº” ì¤‘ì§€ (Stop)</button>
            </div>

            <!-- DASHBOARD / ACTION AREA -->
            <div v-else>
                <button class="btn btn-primary" style="height:80px; font-size:20px;" @click="startScanner">
                    <i class="fa-solid fa-qrcode fa-2x"></i> QR ìŠ¤ìº” (Scan)
                </button>


                <div class="card" style="margin-top:20px;">
                    <h4>ìµœê·¼ ìŠ¤ìº” (Recientes)</h4>
                    <div v-if="recentScans.length === 0" style="color:#666; text-align:center; padding:20px;">
                        ê¸°ë¡ ì—†ìŒ (No history)
                    </div>
                    <div v-for="item in recentScans" :key="item.id"
                        style="display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid #444; align-items:center;"
                        @click="editItem(item)">
                        <div>
                            <div style="font-weight:bold;">{{ item.moldCode }}</div>
                            <div style="font-size:12px; color:#aaa;">{{ item.spareCode }}</div>
                        </div>
                        <div style="color:var(--accent); font-weight:bold;">{{ item.stock }} ea</div>
                    </div>
                </div>

                <button class="btn" @click="syncToCloud" style="background:#3b82f6; margin-top:auto;">
                    <i class="fa-solid fa-cloud-arrow-up"></i> í´ë¼ìš°ë“œ ì €ì¥ (Save to Cloud)
                </button>
            </div>
        </div>

        <!-- EDIT MODAL -->

        <div v-if="editingItem" class="modal-overlay">
            <div class="modal">
                <div style="display:flex; justify-content:space-between; margin-bottom:15px; align-items:center;">
                    <h3 style="margin:0;">ì¬ê³  ì¡°ì‚¬ (Stock Check)</h3>
                    <button @click="editingItem=null" class="btn"
                        style="background:transparent; color:#fff; padding:5px;">
                        <i class="fa-solid fa-times" style="font-size:24px;"></i>
                    </button>
                </div>

                <!-- 1. Read-Only Info Panel -->
                <div
                    style="background:rgba(255,255,255,0.05); padding:15px; border-radius:8px; margin-bottom:20px; border:1px solid #444;">
                    <div style="font-size:18px; font-weight:bold; color:#fbbf24; margin-bottom:5px;">
                        {{ editingItem.moldName || 'No Name' }}
                    </div>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; font-size:13px; color:#ccc;">
                        <div>
                            <span style="color:#888;">Code:</span> {{ editingItem.moldCode }}
                        </div>
                        <div>
                            <span style="color:#888;">Spare:</span> {{ editingItem.spareCode }}
                        </div>
                        <div style="grid-column: span 2;">
                            <span style="color:#888;">Spec:</span> {{ editingItem.model }}
                        </div>
                    </div>
                </div>

                <!-- 2. Stock Control (Main Focus) -->
                <div
                    style="background:rgba(59, 130, 246, 0.1); padding:20px; border-radius:12px; margin-bottom:20px; text-align:center; border:1px solid rgba(59, 130, 246, 0.3);">
                    <label style="color:#93c5fd; font-weight:bold; display:block; margin-bottom:10px;">
                        í˜„ì¬ ì¬ê³  (Current Stock)
                    </label>

                    <div
                        style="display:flex; align-items:center; justify-content:center; gap:10px; margin-bottom:15px;">
                        <button class="btn" style="width:50px; height:50px; background:#ef4444; font-size:18px;"
                            @click="adjustStock(-1)">
                            <i class="fa-solid fa-minus"></i>
                        </button>

                        <input type="number" v-model="editingItem.stock"
                            style="width:100px; text-align:center; font-size:32px; font-weight:bold; background:transparent; border:none; border-bottom:2px solid #fff; color:#fff; padding:5px;">

                        <button class="btn" style="width:50px; height:50px; background:#22c55e; font-size:18px;"
                            @click="adjustStock(1)">
                            <i class="fa-solid fa-plus"></i>
                        </button>
                    </div>

                    <!-- Quick Actions -->
                    <div style="display:flex; justify-content:center; gap:10px;">
                        <button class="btn" style="background:#4b5563; padding:5px 15px; font-size:14px;"
                            @click="adjustStock(-5)">-5</button>
                        <button class="btn" style="background:#4b5563; padding:5px 15px; font-size:14px;"
                            @click="adjustStock(-10)">-10</button>
                        <button class="btn" style="background:#4b5563; padding:5px 15px; font-size:14px;"
                            @click="adjustStock(5)">+5</button>
                        <button class="btn" style="background:#4b5563; padding:5px 15px; font-size:14px;"
                            @click="adjustStock(10)">+10</button>
                    </div>
                </div>

                <!-- 3. Location Control -->
                <div style="margin-bottom:25px;">
                    <label style="color:#aaa; font-size:12px; margin-bottom:5px; display:block;">ìœ„ì¹˜ (UbicaciÃ³n)</label>
                    <div style="position:relative;">
                        <i class="fa-solid fa-location-dot"
                            style="position:absolute; left:12px; top:12px; color:#aaa;"></i>
                        <input v-model="editingItem.loc"
                            style="width:100%; padding:10px 10px 10px 35px; background:#1f2937; border:1px solid #4b5563; color:#fff; border-radius:6px;">
                    </div>
                </div>

                <button class="btn btn-primary" style="width:100%; height:50px; font-size:18px;" @click="saveItem">
                    <i class="fa-solid fa-check"></i> ì €ì¥ (Confirmar)
                </button>
            </div>
        </div>

    </div>

    <script>
        const CLOUD_URL = "https://script.google.com/macros/s/AKfycbxb8Th7X8XkZACfEdg9EW6lJdpD_gp5qZ1Gs8FolNyP2T-iyCY48_im-902fkCBBblZVw/exec";
        const { createApp, ref, reactive, nextTick } = Vue;

        createApp({
            setup() {
                const loading = ref(false);
                const loadingMsg = ref('');
                const cloudProjects = ref([]);
                const currentProject = ref(null);
                const selectedProjectName = ref("");
                const parts = ref([]); // All parts in current project

                const isScanning = ref(false);
                const isGlobalScanning = ref(false); // For initial screen
                const scanner = ref(null);


                const pendingScanId = ref(null); // For legacy QR support

                const editingItem = ref(null);
                const recentScans = ref([]);

                const adjustStock = (amount) => {
                    if (!editingItem.value) return;
                    let current = parseInt(editingItem.value.stock) || 0;
                    current += amount;
                    if (current < 0) current = 0;
                    editingItem.value.stock = current;
                };

                // 1. Load Project List
                const loadCloudProjects = async () => {
                    loading.value = true;
                    loadingMsg.value = "ëª©ë¡ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";
                    try {
                        const r = await fetch(CLOUD_URL + "?action=load");
                        const d = await r.json();
                        if (d.result === 'error') throw new Error(d.message);

                        // Group by project name
                        const counts = {};
                        d.parts.forEach(p => {
                            const name = (p.project || p.model || 'Unknown').trim();
                            counts[name] = (counts[name] || 0) + 1;
                        });
                        cloudProjects.value = Object.keys(counts).map(k => ({ name: k, count: counts[k] }));
                    } catch (e) {
                        console.error(e);
                        // alert("Error: " + e.message);
                    } finally {
                        loading.value = false;
                    }
                };

                // Auto load list on mount
                loadCloudProjects();

                // 2. Load Specific Project Data
                const loadProjectData = async (targetProjectName) => {
                    const pName = targetProjectName || selectedProjectName.value;
                    if (!pName) return;

                    loading.value = true;
                    loadingMsg.value = `'${pName}' ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...`;
                    try {
                        const r = await fetch(CLOUD_URL + "?action=load"); // Inefficient but simple (gets all)
                        const d = await r.json();

                        // Find latest batch for this project
                        const allParts = d.parts.filter(p => (p.project || p.model || 'Unknown').trim() === pName);
                        if (allParts.length === 0) throw new Error("ë°ì´í„° ì—†ìŒ");

                        const latestBatchId = allParts.reduce((max, p) => Math.max(max, p.batchId || 0), 0);
                        const latestParts = allParts.filter(p => (p.batchId || 0) === latestBatchId);

                        parts.value = latestParts.map(p => ({ ...p })); // Clone
                        currentProject.value = pName;
                        selectedProjectName.value = pName;

                        // Check Pending Scan
                        if (pendingScanId.value) {
                            const found = parts.value.find(p => p.id === pendingScanId.value);
                            if (found) {
                                editItem(found);
                                pendingScanId.value = null; // Clear
                            } else {
                                alert(`ì„ íƒí•œ í”„ë¡œì íŠ¸ì— í•´ë‹¹ ë¶€í’ˆ(ID: ${pendingScanId.value})ì´ ì—†ìŠµë‹ˆë‹¤.\n(Part not found in this project)`);
                                pendingScanId.value = null;
                            }
                        }
                    } catch (e) {
                        alert("Load Failed: " + e.message);
                        selectedProjectName.value = "";
                    } finally {
                        loading.value = false;
                    }
                };

                const exitProject = () => {
                    if (confirm("í”„ë¡œì íŠ¸ë¥¼ ë‹«ìœ¼ì‹œê² ìŠµë‹ˆê¹Œ? ì €ì¥í•˜ì§€ ì•Šì€ ë‚´ìš©ì€ ì‚¬ë¼ì§‘ë‹ˆë‹¤.")) {
                        currentProject.value = null;
                        selectedProjectName.value = "";
                        parts.value = [];
                        recentScans.value = [];
                    }
                };

                // 3. Scanner Logic
                const startScanner = () => {
                    // Check logic moved to initScanner
                    isScanning.value = true;
                    nextTick(() => initScanner("reader"));
                };

                const startGlobalScanner = () => {
                    // Check logic moved to initScanner
                    isGlobalScanning.value = true;
                    nextTick(() => initScanner("reader-global"));
                };

                const initScanner = (elementId) => {
                    const html5QrCode = new Html5Qrcode(elementId);
                    scanner.value = html5QrCode;
                    html5QrCode.start(
                        { facingMode: "environment" },
                        { fps: 10, qrbox: { width: 250, height: 250 } },
                        (decodedText) => {
                            handleScan(decodedText);
                        },
                        (errorMessage) => {
                            // ignore
                        }
                    ).catch(err => {
                        console.error(err);
                        alert("ì¹´ë©”ë¼ ì‹¤í–‰ ì‹¤íŒ¨ (Camera Error).\n\n[ì¤‘ìš”/Critical]\nì´ ì•±ì€ ë³´ì•ˆìƒ 'HTTPS' ë˜ëŠ” 'localhost' í™˜ê²½ì—ì„œë§Œ ì‘ë™í•©ë‹ˆë‹¤.\n(This app requires HTTPS for camera security.)\n\nError: " + err);
                        stopScanner();
                    });
                };

                const stopScanner = () => {
                    if (scanner.value) {
                        scanner.value.stop().then(() => {
                            scanner.value.clear();
                            isScanning.value = false;
                            isGlobalScanning.value = false;
                            scanner.value = null;
                            console.error(err);
                            // isScanning.value = false; // Don't reset immediately if partial error
                            // isGlobalScanning.value = false;
                        });
                    } else {
                        isScanning.value = false;
                        isGlobalScanning.value = false;
                    }
                };



                const handleScan = async (text) => {
                    // STOP scanner first
                    stopScanner();

                    try {
                        // Expected: {"id": 12345, "project": "Name", "mode": "edit"}
                        const data = JSON.parse(text);

                        if (!data.id) return alert("ì˜ëª»ëœ QR ì½”ë“œì…ë‹ˆë‹¤.");

                        const targetProject = data.project;

                        // Scenario 1: Project not loaded (Global Scan)
                        if (!currentProject.value) {
                            if (targetProject) {
                                const ok = confirm(`'${targetProject}' í”„ë¡œì íŠ¸ë¥¼ ë¡œë“œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`);
                                if (ok) {
                                    await loadProjectData(targetProject);
                                    // After load, try to find item
                                    findAndEdit(data.id);
                                }
                            } else {
                                // alert("êµ¬ë²„ì „ QR ì½”ë“œì…ë‹ˆë‹¤. í”„ë¡œì íŠ¸ë¥¼ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.");
                                handleLegacyQR(data.id);
                            }
                        }
                        // Scenario 2: Project loaded, check match
                        else {
                            if (targetProject && targetProject !== currentProject.value) {
                                const switchProj = confirm(`í˜„ì¬ í”„ë¡œì íŠ¸ì™€ ë‹¤ë¦…ë‹ˆë‹¤. '${targetProject}'ë¡œ ì „í™˜í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(Switch Project?)`);
                                if (switchProj) {
                                    await loadProjectData(targetProject);
                                    findAndEdit(data.id);
                                }
                            } else {
                                findAndEdit(data.id);
                            }
                        }

                    } catch (e) {
                        console.error(e);
                        alert("QR Parse Error: " + text);
                    }
                };

                const handleLegacyQR = (id) => {
                    if (currentProject.value) {
                        // Project already loaded, assume it belongs here
                        findAndEdit(id);
                    } else {
                        // No project loaded
                        alert("êµ¬ë²„ì „ QR ì½”ë“œì…ë‹ˆë‹¤ (í”„ë¡œì íŠ¸ ì •ë³´ ì—†ìŒ).\nìˆ˜ë™ìœ¼ë¡œ í”„ë¡œì íŠ¸ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.\n(Legacy QR. Please select project manually to proceed.)");
                        pendingScanId.value = id;
                        // Optional: trigger project load dropdown focus?
                    }
                };

                const findAndEdit = (id) => {
                    const found = parts.value.find(p => p.id === id);
                    if (found) {
                        editItem(found);
                    } else {
                        // Fallback: search by ID only if project matches (sometimes legacy data)
                        alert("í˜„ì¬ í”„ë¡œì íŠ¸ì— ì—†ëŠ” ë¶€í’ˆì…ë‹ˆë‹¤. (Part not found)");
                    }
                };

                // 4. Edit & Save Logic
                const editItem = (item) => {
                    editingItem.value = item; // Reactive reference
                };

                const saveItem = () => {
                    // Update recent scans list (move to top)
                    const idx = recentScans.value.findIndex(x => x.id === editingItem.value.id);
                    if (idx >= 0) recentScans.value.splice(idx, 1);
                    recentScans.value.unshift(editingItem.value);

                    editingItem.value = null;
                };

                const syncToCloud = async () => {
                    if (!confirm("ë³€ê²½ì‚¬í•­ì„ í´ë¼ìš°ë“œì— ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (Save to Cloud?)")) return;

                    loading.value = true;
                    loadingMsg.value = "ì €ì¥ ì¤‘ (Saving)...";
                    try {
                        const payload = {
                            action: 'save',
                            project: currentProject.value,
                            parts: parts.value
                        };

                        const r = await fetch(CLOUD_URL, { id: 'saveRequest', method: 'POST', body: JSON.stringify(payload) });
                        const res = await r.json();
                        if (res.result === 'error') throw new Error(res.message);

                        alert("ì €ì¥ ì„±ê³µ! (Saved Successfully)");
                        recentScans.value = [];
                    } catch (e) {
                        alert("Save Error: " + e.message);
                    } finally {
                        loading.value = false;
                    }
                };

                return {
                    loading, loadingMsg, cloudProjects, currentProject, selectedProjectName,
                    loadCloudProjects, loadProjectData, exitProject,

                    isScanning, isGlobalScanning, startScanner, startGlobalScanner, stopScanner,
                    editingItem, recentScans, editItem, saveItem, syncToCloud, adjustStock
                };
            }
        }).mount('#app');
    </script>
    <div id="reader-hidden" style="display:none;"></div>
</body>

</html>