<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Í∏àÌòï Spare</title>
    <!-- Dependencies -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/3.3.4/vue.global.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dexie/3.2.4/dexie.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        :root {
            --bg-body: #111827;
            --bg-nav: #1f2937;
            --bg-card: #2d3748;
            --bg-input: #374151;
            --text-main: #f9fafb;
            --text-muted: #9ca3af;
            --accent: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --blue: #3b82f6;
            --border: #4b5563;
        }

        body {
            background-color: var(--bg-body);
            color: var(--text-main);
            font-family: 'Segoe UI', sans-serif;
            margin: 0;
            overflow: hidden;
            display: flex;
            height: 100vh;
        }

        /* Sidebar */
        aside {
            width: 260px;
            background: var(--bg-nav);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            padding: 15px;
        }

        .brand {
            font-size: 20px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 30px;
            color: var(--accent);
        }

        .nav-item {
            padding: 12px;
            margin-bottom: 5px;
            border-radius: 8px;
            cursor: pointer;
            transition: 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text-muted);
        }

        .nav-item:hover,
        .nav-item.active {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .project-list {
            flex: 1;
            overflow-y: auto;
            margin-top: 20px;
        }

        .project-item {
            padding: 8px 12px;
            cursor: pointer;
            border-radius: 6px;
            margin-bottom: 2px;
            font-size: 14px;
            color: var(--text-muted);
            display: flex;
            justify-content: space-between;
        }

        .project-item:hover,
        .project-item.active {
            background: var(--bg-input);
            color: white;
        }

        /* Sidebar Controls (Home + Toggle wrapper) */
        /* [ÏàòÏ†ïÎê®] ÌëúÏ§Ä Ìôà Î≤ÑÌäº & ÌÜ†Í∏Ä Î≤ÑÌäº Ïä§ÌÉÄÏùº */
        .sidebar-controls {
            display: flex;
            align-items: center;
            position: fixed;
            top: 15px;
            left: 15px !important;
            z-index: 1001;
            transition: none;
        }

        .home-btn {
            background: #334155 !important;
            color: #e2e8f0 !important;
            border: 1px solid #475569 !important;
            border-radius: 8px 0 0 8px !important;
            /* Îë•Í∑º Ï†ïÎèÑ 8px */
            height: 28px !important;
            /* ÎÜíÏù¥ 28px */
            padding: 0 10px !important;
            box-sizing: border-box !important;
            text-decoration: none !important;
            font-size: 12px !important;
            font-weight: 700 !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            gap: 4px !important;
            margin: 0 !important;
        }

        .home-btn:hover {
            background: #4285F4 !important;
            color: #fff !important;
        }

        .btn-toggle-sidebar {
            width: 24px !important;
            height: 28px !important;
            /* ÎÜíÏù¥ 28px */
            background: #1e293b !important;
            border: 1px solid #334155 !important;
            border-left: none !important;
            /* ÏôºÏ™Ω ÏÑ† Ï†úÍ±∞ (Ïó∞Í≤∞Ìö®Í≥º) */
            border-radius: 0 8px 8px 0 !important;
            /* Ïò§Î•∏Ï™ΩÎßå Îë•Í∏ÄÍ≤å */
            box-sizing: border-box !important;
            color: #94a3b8 !important;
            cursor: pointer !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            font-size: 12px !important;
            padding: 0 !important;
        }

        .btn-toggle-sidebar:hover {
            color: white !important;
            background: #334155 !important;
        }

        /* Collapsed State */
        aside {
            transition: margin-left 0.3s ease;
        }

        body.sidebar-collapsed aside {
            margin-left: -260px;
        }

        body.sidebar-collapsed .sidebar-controls {
            left: 0;
        }

        /* Main Content */
        main {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        header {
            height: 60px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            background: var(--bg-body);
        }

        .search-bar {
            background: var(--bg-input);
            border-radius: 6px;
            padding: 8px 15px;
            display: flex;
            align-items: center;
            width: 300px;
        }

        .search-bar input {
            background: transparent;
            border: none;
            color: white;
            margin-left: 10px;
            width: 100%;
            outline: none;
        }

        .actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            background: var(--bg-input);
            border: 1px solid var(--border);
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            transition: 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn:hover {
            background: #4b5563;
        }

        .btn.primary {
            background: var(--accent);
            color: #000;
            border: none;
            font-weight: bold;
        }

        .btn.danger {
            background: rgba(239, 68, 68, 0.2);
            color: var(--danger);
            border-color: var(--danger);
        }

        /* Table */
        .table-container {
            flex: 1;
            overflow: auto;
            padding: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        th {
            text-align: left;
            padding: 12px;
            border-bottom: 2px solid var(--border);
            color: var(--text-muted);
            position: sticky;
            top: 0;
            background: var(--bg-body);
            z-index: 10;
        }

        td {
            padding: 10px 12px;
            border-bottom: 1px solid var(--border);
            vertical-align: middle;
        }

        tr:hover {
            background: rgba(255, 255, 255, 0.02);
        }

        .status-badge {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
        }

        .status-ok {
            background: rgba(16, 185, 129, 0.2);
            color: var(--accent);
        }

        .status-low {
            background: rgba(239, 68, 68, 0.2);
            color: var(--danger);
        }

        .status-high {
            background: rgba(59, 130, 246, 0.2);
            color: var(--blue);
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal {
            background: var(--bg-card);
            border-radius: 12px;
            width: 600px;
            max-width: 90vw;
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            max-height: 90vh;
        }

        .modal-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border);
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-body {
            padding: 20px;
            overflow-y: auto;
        }

        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .input {
            width: 100%;
            background: var(--bg-input);
            border: 1px solid var(--border);
            color: white;
            padding: 8px;
            border-radius: 6px;
            margin-top: 4px;
            box-sizing: border-box;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        /* Print Override */
        @media print {
            @page {
                size: landscape;
                margin: 0;
            }

            aside,
            header,
            .no-print,
            .btn,
            .modal-footer,
            .modal-header,
            .actions {
                display: none !important;
            }



            body {
                height: auto;
                display: block;
                background: white;
                color: black;
                margin: 0;
                padding: 0;
            }

            .modal-overlay {
                position: static;
                background: white;
                display: block;
                padding: 0;
            }

            .modal {
                border: none;
                box-shadow: none;
                max-width: 100%;
                width: 100%;
                position: static;
                height: auto;
                background: white;
                color: black;
            }

            .table-container {
                overflow: visible;
            }

            table {
                font-size: 10px;
                width: 100%;
                border-collapse: collapse;
            }

            th,
            td {
                border: 1px solid #000 !important;
                padding: 4px;
                color: black !important;
                page-break-inside: avoid;
            }

            th {
                background: #eee !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            .status-badge {
                border: 1px solid #000;
                color: black !important;
                background: transparent !important;
            }

            /* Report Print Specifics */
            #report-print-area {
                display: block;
                width: 100% !important;
                margin: 0;
                padding: 0;
                overflow: visible !important;
                height: auto !important;
                zoom: 0.80;
                /* Stronger zoom out for Mold Manager potentially wider content */
            }

            table {
                width: 100% !important;
                min-width: 0 !important;
                font-size: 8px !important;
                table-layout: fixed;
            }

            th,
            td {
                word-wrap: break-word !important;
                white-space: normal !important;
                font-size: 8px !important;
            }


            /* QR Label */
            .print-label {
                display: flex;
                align-items: center;
                justify-content: center;
                height: 100vh;
            }

            .qr-area {
                border: 2px solid black;
                padding: 20px;
                text-align: center;
                page-break-inside: avoid;
            }
        }

        .btn-icon {
            background: none;
            border: none;
            padding: 5px;
            cursor: pointer;
            color: var(--text-muted);
            transition: color 0.2s;
        }

        .btn-icon:hover {
            color: white;
        }
    </style>
</head>

<body>
    <div id="app" style="width:100%; display:flex;">

        <!-- SIDEBAR -->
        <aside>
            <div class="brand">
            </div>




            <!-- Sync Status Indicator -->
            <div class="nav-item" :style="{color: isSyncing ? 'var(--warning)' : 'var(--text-muted)'}">
                <i class="fa-solid" :class="isSyncing ? 'fa-spinner fa-spin' : 'fa-cloud-arrow-up'"></i>
                {{ isSyncing ? 'ÎèôÍ∏∞Ìôî Ï§ë (Sincronizando...)' : 'ÎåÄÍ∏∞ (Listo)' }}
            </div>

            <div
                style="font-size:12px; font-weight:bold; margin-top:20px; margin-bottom:10px; color:#666; display:flex; justify-content:space-between;">
                PROJECTS (ÌîÑÎ°úÏ†ùÌä∏)
                <i class="fa-solid fa-plus" style="cursor:pointer; color:var(--accent);" @click="createProject"></i>
            </div>

            <div class="project-list">
                <div class="project-item" v-for="p in projects" :key="p.id"
                    :class="{active: currentProject && currentProject.id === p.id}" @click="selectProject(p)">
                    <span>{{ p.name }}</span>
                    <i class="fa-solid fa-trash" style="font-size:10px; color:#666;" @click.stop="deleteProject(p)"></i>
                </div>
            </div>

            <div style="margin-top:auto; font-size:11px; text-align:center; color:#444;">
                &copy; Antigravity Systems
            </div>
        </aside>

        <div class="sidebar-controls">
            <a class="home-btn" href="index.html">üè† Home</a>
            <button id="btn-toggle-sidebar" class="btn-toggle-sidebar" onclick="toggleSidebar()">‚óÄ</button>
        </div>



        <!-- MAIN -->
        <main>
            <header>
                <div class="search-bar">
                    <i class="fa-solid fa-search" style="color:#666;"></i>
                    <input v-model="searchQuery" placeholder="Í≤ÄÏÉâ (Search / Buscar)...">
                </div>

                <div class="app-title"
                    style="font-size: 20px; font-weight: bold; color: var(--accent); margin-left: 20px;">
                    <i class="fa-solid fa-industry"></i> Mold Manager
                </div>

                <div class="actions">
                    <button class="btn" @click="toggleLowStock">
                        <i class="fa-solid fa-filter" :style="{color: filterLowStock ? 'var(--danger)' : 'white'}"></i>
                        {{ filterLowStock ? 'Î∂ÄÏ°± Ïû¨Í≥† (Stock Bajo)' : 'Ï†ÑÏ≤¥ Î∂ÄÌíà (Todo)' }}
                    </button>
                    <!-- Col Option -->
                    <div style="position:relative;">
                        <button class="btn" @click="showColMenu = !showColMenu">
                            <i class="fa-solid fa-columns"></i> Ïª¨Îüº (Cols)
                        </button>
                        <div v-if="showColMenu"
                            style="position:absolute; top:100%; right:0; background:var(--bg-card); border:1px solid var(--border); padding:10px; border-radius:6px; z-index:100; width:150px; box-shadow:0 4px 6px rgba(0,0,0,0.3);">
                            <div v-for="c in columns" :key="c.key" style="margin-bottom:5px;">
                                <label style="display:flex; align-items:center; cursor:pointer;">
                                    <input type="checkbox" v-model="c.visible" style="margin-right:8px;"> {{ c.label }}
                                </label>
                            </div>
                        </div>
                    </div>

                    <div style="width:1px; height:20px; background:var(--border); margin:0 5px;"></div>
                    <button class="btn" @click="syncFromCloud" title="Download Projects"><i
                            class="fa-solid fa-cloud-arrow-down"></i> Î∂àÎü¨Ïò§Í∏∞ (Cargar)</button>
                    <button class="btn" @click="syncToCloud" title="Upload Current Project"><i
                            class="fa-solid fa-cloud-arrow-up"></i> Ï†ÄÏû• (Guardar)</button>
                    <div style="width:1px; height:20px; background:var(--border); margin:0 5px;"></div>
                    <button class="btn btn-secondary" @click="downloadJsonBackup"><i class="fa-solid fa-download"></i>
                        Î∞±ÏóÖ (Respaldo)</button>
                    <div style="position:relative;">
                        <button class="btn btn-secondary" onclick="document.getElementById('restoreFile').click()"><i
                                class="fa-solid fa-upload"></i> Î≥µÏõê (Restaurar)</button>
                        <input type="file" id="restoreFile" hidden @change="uploadJsonRestore" accept=".json">
                    </div>
                    <button class="btn btn-danger" @click="clearAllData"><i class="fa-solid fa-trash-can"></i>
                        Ï¥àÍ∏∞Ìôî (Reiniciar)</button>
                    <button class="btn btn-primary" style="background:#8b5cf6; border-color:#8b5cf6;"
                        @click="openAddModal">
                        <i class="fa-solid fa-plus"></i> ÏûêÏÇ∞ Ï∂îÍ∞Ä (Agregar Activo)
                    </button>
                    <button class="btn btn-primary" @click="openReport"><i class="fa-solid fa-chart-simple"></i>
                        Î¶¨Ìè¨Ìä∏ (Reporte)</button>

                </div>
            </header>

            <div class="table-container" id="print-area">
                <div id="report-header" style="display:none; margin-bottom:20px; align-items:center; gap:20px;">
                    <div>
                        <h1 style="margin:0;">Mold Spare List</h1>
                        <h3 style="margin:0; color:#666;">{{ currentProject?.name }}</h3>
                    </div>
                    <div style="margin-left:auto;">{{ new Date().toLocaleDateString() }}</div>
                </div>

                <table v-if="currentProject">
                    <thead>
                        <tr>
                            <th v-for="c in visibleColumns" :key="c.key"
                                :style="{width: c.width + 'px', cursor: c.sortable ? 'pointer' : 'default'}"
                                @click="c.sortable ? sortTable(c.key) : null"
                                :class="c.key === 'action' ? 'no-print' : ''">
                                {{ c.label }}
                                <i v-if="sortKey === c.key" class="fa-solid"
                                    :class="sortOrder === 1 ? 'fa-sort-up' : 'fa-sort-down'"></i>
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="p in filteredParts" :key="p.id">
                            <td v-for="c in visibleColumns" :key="c.key" :class="c.key === 'action' ? 'no-print' : ''"
                                :style="{textAlign: c.key==='price'?'right' : (['op','stock','status','action','img'].includes(c.key)?'center':'left')}">

                                <template v-if="c.key === 'img'">
                                    <div v-if="p.img"
                                        :style="`width:32px; height:32px; background-image:url(${p.img}); background-size:cover; border-radius:4px; margin:0 auto; border:1px solid #555; cursor:pointer`"
                                        @click="setModalImage(p.img)"></div>
                                    <span v-else>-</span>
                                </template>

                                <template v-else-if="c.key === 'moldCode'">
                                    <span style="font-weight:bold; color:var(--accent);">{{ p.moldCode }}</span>
                                </template>

                                <template v-else-if="c.key === 'spareCode'">
                                    <span style="font-family:monospace;">{{ p.spareCode }}</span>
                                </template>

                                <template v-else-if="c.key === 'op'">
                                    <span class="badge"
                                        style="background:#444; color:#fff; padding:2px 4px; border-radius:3px; font-size:10px;">{{
                                        p.op }}</span>
                                </template>

                                <template v-else-if="c.key === 'moldName'">
                                    <span style="font-style:italic; color:var(--text-muted);">{{ p.moldName }}</span>
                                </template>

                                <template v-else-if="c.key === 'moldType'">
                                    <span style="font-size:11px;">{{ p.moldType === 'dedicated' ? 'Dedicated' :
                                        (p.moldType === 'common' ? 'Common' : '-') }}</span>
                                </template>

                                <template v-else-if="c.key === 'loc'">
                                    <span style="color:var(--blue); font-family:monospace;">{{ p.loc }}</span>
                                </template>

                                <template v-else-if="c.key === 'stock'">
                                    <span style="font-weight:bold; font-size:14px; color:var(--accent);">{{ p.stock
                                        }}</span>
                                </template>

                                <template v-else-if="c.key === 'status'">
                                    <span v-if="p.stock <= p.min" class="status-badge status-low"><i
                                            class="fa-solid fa-bell"></i> LOW</span>
                                    <span v-else-if="p.stock >= p.max" class="status-badge status-high">OVER</span>
                                    <span v-else class="status-badge status-ok">OK</span>
                                </template>

                                <template v-else-if="c.key === 'price'">
                                    <span style="font-size:12px; color:var(--text-muted);">${{
                                        (p.price||0).toLocaleString() }}</span>
                                </template>

                                <template v-else-if="c.key === 'action'">
                                    <!-- Safe Button Wrapper to prevent auto-fire -->
                                    <div style="display:flex; gap:5px; justify-content:center;">
                                        <button type="button" class="btn-icon" title="Edit"
                                            @click.stop="() => editPart(p)">
                                            <i class="fa-solid fa-pen"></i>
                                        </button>
                                        <button type="button" class="btn-icon" title="QR Code"
                                            @click.stop="() => showQR(p)">
                                            <i class="fa-solid fa-qrcode"></i>
                                        </button>
                                    </div>
                                </template>

                                <template v-else>
                                    {{ p[c.key] }}
                                </template>
                            </td>
                        </tr>
                    </tbody>
                </table>
                <div v-else style="padding:50px; text-align:center; color:var(--text-muted);">
                    <i class="fa-solid fa-folder-open" style="font-size:48px; margin-bottom:20px;"></i>
                    <p>Select or Create a Project to begin.</p>
                </div>
            </div>
        </main>

        <!-- QR DISPLAY MODAL -->
        <div v-if="showQRModal" class="modal-overlay" @click.self="showQRModal=false">
            <div class="modal" style="width:350px; text-align:center;">
                <div class="modal-header">QR Code <i class="fa-solid fa-times" style="cursor:pointer;"
                        @click="showQRModal=false"></i></div>
                <div class="modal-body" style="display:flex; flex-direction:column; align-items:center;">
                    <div id="qrcode-container" style="background:white; padding:10px; border-radius:8px;"></div>
                    <div style="margin-top:15px; font-weight:bold; color:var(--accent);">{{ qrTargetName }}</div>
                    <div style="font-size:12px; color:#aaa;">{{ qrTargetCode }}</div>
                </div>
                <div class="modal-footer"><button class="btn" @click="printQR">Ï∂úÎ†• (Imprimir)</button></div>
            </div>
        </div>

        <!-- SCANNER MODAL -->


        <!-- MODALS (Data, Part, Dashboard, QR, Cloud) -->
        <div v-if="showDataModal" class="modal-overlay" @click.self="showDataModal=false">
            <div class="modal" style="width:400px;">
                <div class="modal-header">Î∞±ÏóÖ Î∞è Î≥µÏõê (Respaldo y Restauraci√≥n) <i class="fa-solid fa-times"
                        style="cursor:pointer;" @click="showDataModal=false"></i></div>
                <div class="modal-body">
                    <div style="margin-bottom:20px;">
                        <h4>1. Î∞±ÏóÖ (Exportar)</h4>
                        <p style="font-size:12px; color:#aaa;">JSON ÌååÏùº Îã§Ïö¥Î°úÎìú (Descargar JSON)</p>
                        <button class="btn primary" style="width:100%;" @click="downloadJsonBackup"><i
                                class="fa-solid fa-download"></i> Îã§Ïö¥Î°úÎìú (Descargar)</button>
                    </div>
                    <div>
                        <h4>2. Î≥µÏõê (Importar)</h4>
                        <p style="font-size:12px; color:#aaa;">JSON ÌååÏùº ÏóÖÎ°úÎìú (Subir JSON)</p>
                        <button class="btn" style="width:100%; position:relative; overflow:hidden;">
                            <i class="fa-solid fa-upload"></i> ÌååÏùº ÏÑ†ÌÉù (Seleccionar Archivo)
                            <input type="file" accept=".json" @change="uploadJsonRestore"
                                style="position:absolute; inset:0; opacity:0; cursor:pointer;">
                        </button>
                    </div>

                    <div style="margin-top:30px; border-top:1px solid #444; padding-top:20px;">
                        <h4 style="color:var(--danger);">3. ÏúÑÌóò Íµ¨Ïó≠ (Zona de Peligro)</h4>
                        <button class="btn danger" style="width:100%;" @click="clearAllData">
                            <i class="fa-solid fa-trash-can"></i> Ï†ÑÏ≤¥ Îç∞Ïù¥ÌÑ∞ ÏÇ≠Ï†ú (Borrar Todo)
                        </button>
                    </div>
                </div>
                <div class="modal-footer"><button class="btn" @click="showDataModal=false">Îã´Í∏∞ (Cerrar)</button></div>
            </div>
        </div>

        <div v-if="showPartModal" class="modal-overlay" @click.self="showPartModal=false">
            <div class="modal" style="width:700px;">
                <div class="modal-header"><span>{{ editingPart.id ? 'ÏàòÏ†ï (Editar)' : 'Ï∂îÍ∞Ä (Agregar)' }} Part</span><i
                        class="fa-solid fa-times" style="cursor:pointer;" @click="showPartModal=false"></i></div>
                <div class="modal-body">
                    <div style="display:flex; flex-wrap:wrap; gap:20px;">
                        <!-- Image Upload -->
                        <div style="flex:0 0 150px; display:flex; flex-direction:column; align-items:center;">
                            <div
                                style="width:150px; height:150px; border:2px dashed var(--border); border-radius:8px; display:flex; align-items:center; justify-content:center; overflow:hidden; position:relative; background:#111;">
                                <img v-if="editingPart.img" :src="editingPart.img"
                                    style="width:100%; height:100%; object-fit:cover;">
                                <div v-if="isImageProcessing"
                                    style="position:absolute; inset:0; background:rgba(0,0,0,0.5); display:flex; align-items:center; justify-content:center; color:white;">
                                    <i class="fa-solid fa-spinner fa-spin fa-2x"></i>
                                </div>
                                <input type="file" @change="handleImageUpload" accept="image/*"
                                    style="position:absolute; inset:0; opacity:0; cursor:pointer;"
                                    :disabled="isImageProcessing">
                                <div v-if="!editingPart.img && !isImageProcessing"
                                    style="color:#666; text-align:center;">
                                    <i class="fa-solid fa-image fa-2x" style="margin-bottom:10px;"></i><br>
                                    ÏóÖÎ°úÎìú ÌÅ¥Î¶≠ (Clic para subir)<br>or <span style="color:var(--accent)">Ctrl+V</span>
                                </div>
                            </div>
                            <div style="font-size:12px; color:var(--text-muted); margin-top:5px; text-align:center;">
                                * ÌÅ¥Î¶ΩÎ≥¥Îìú Î∂ôÏó¨ÎÑ£Í∏∞ Í∞ÄÎä• (Soporta Portapapeles)
                            </div>
                        </div>

                        <!-- Form Fields -->
                        <div style="flex:1; display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                            <div><small>Í∏àÌòï ÏΩîÎìú (C√≥digo Molde)</small><input v-model="editingPart.moldCode" class="input"
                                    list="dl-mold"></div>
                            <div><small>ÏòàÎπÑÌíà ÏΩîÎìú (C√≥digo Repuesto)</small><input v-model="editingPart.spareCode"
                                    class="input"></div>

                            <div><small>Í≥µÏ†ï (Proceso)</small>
                                <select v-model="editingPart.op" class="input">
                                    <option value="OP10">OP10</option>
                                    <option value="OP20">OP20</option>
                                    <option value="OP30">OP30</option>
                                    <option value="OP40">OP40</option>
                                    <option value="OP50">OP50</option>
                                </select>
                            </div>
                            <div><small>Î™®Îç∏ (Modelo)</small><input v-model="editingPart.model" class="input"
                                    list="dl-model">
                            </div>



                            <!-- Manual Transaction Entry -->
                            <div
                                style="grid-column: span 2; margin-top:10px; border-top:1px solid var(--border); padding-top:10px;">
                                <h4 style="margin:0 0 10px 0; color:var(--text-muted); font-size:14px;">üìù ÏàòÎèô ÏûÖÏ∂úÍ≥†
                                    (Transacci√≥n Manual)</h4>
                                <div style="display:flex; gap:5px; align-items:end;">
                                    <div style="flex:1;">
                                        <small>ÎÇ†Ïßú (Fecha)</small>
                                        <input v-model="newTx.date" type="date" class="input">
                                    </div>
                                    <div style="flex:1;">
                                        <small>Íµ¨Î∂Ñ (Tipo)</small>
                                        <select v-model="newTx.type" class="input">
                                            <option value="IN">ÏûÖÍ≥† (Entrada)</option>
                                            <option value="OUT">ÏÇ¨Ïö© (Salida)</option>
                                        </select>
                                    </div>
                                    <div style="width:60px;">
                                        <small>ÏàòÎüâ (Cant.)</small>
                                        <input v-model.number="newTx.qty" type="number" class="input">
                                    </div>
                                    <button @click="addManualTx" class="btn btn-primary" style="height:36px;">Ï∂îÍ∞Ä
                                        (Agregar)</button>
                                </div>
                            </div>


                        </div>
                    </div>

                    <!-- Stock Control Block -->
                    <div
                        style="grid-column:span 2; background:var(--bg-input); padding:10px; border-radius:8px; display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; border:1px solid var(--accent); margin-top:10px;">
                        <div class="text-center"
                            style="grid-column: span 3; display:flex; align-items:center; justify-content:center; gap:10px;">
                            <div style="text-align:center;">
                                <small style="color:var(--accent)">ÌòÑÏû¨ Ïû¨Í≥† (Stock Actual)</small>
                                <div style="display:flex; align-items:center;">
                                    <input v-model.number="editingPart.stock" type="number" class="input"
                                        style="width:80px; text-align:center; font-weight:bold; font-size:16px;">
                                    <button class="btn btn-warning"
                                        style="margin-left:5px; padding:2px 8px; font-size:10px;"
                                        @click="applySnapshotFromModal" title="Set as Last Record (Snapshot)">
                                        <i class="fa-solid fa-camera"></i>
                                    </button>
                                </div>
                            </div>
                            <div v-if="editingPart.lastRecord"
                                style="font-size:11px; color:#aaa; text-align:left; border-left:1px solid #555; padding-left:10px;">
                                <div>Last: <strong>{{ editingPart.lastRecord.qty }}</strong></div>
                                <div>{{ editingPart.lastRecord.date }}</div>
                            </div>
                        </div>
                        <div class="text-center" style="grid-column: span 1;"><small style="color:var(--danger)">ÏµúÏÜå
                                (Min)</small><input v-model.number="editingPart.min" type="number" class="input"
                                style="text-align:center; border-color:var(--danger);">
                        </div>
                        <div class="text-center" style="grid-column: span 1;"><small>ÏµúÎåÄ (Max)</small><input
                                v-model.number="editingPart.max" type="number" class="input" style="text-align:center;">
                        </div>
                        <div class="text-center" style="grid-column: span 1;"><small>ÏúÑÏπò (Ubicaci√≥n)</small><input
                                v-model="editingPart.loc" class="input" style="text-align:center;"></div>
                    </div>
                </div>

                <!-- Modal Footer -->
                <div class="modal-footer">
                    <button v-if="editingPart.id" class="btn danger" style="margin-right:auto;" @click="deletePart">ÏÇ≠Ï†ú
                        (Eliminar)</button>
                    <button class="btn" @click="showPartModal=false">Ï∑®ÏÜå (Cancelar)</button>
                    <button class="btn primary" @click="savePart">Ï†ÄÏû• (Guardar)</button>
                </div>
            </div>
        </div>





        <div v-if="showCloudModal" class="modal-overlay" @click.self="showCloudModal=false">
            <div class="modal" style="width:400px;">
                <div class="modal-header">ÌÅ¥ÎùºÏö∞Îìú ÌîÑÎ°úÏ†ùÌä∏ ÏÑ†ÌÉù (Sel. Proyecto Nube) <i class="fa-solid fa-times"
                        style="cursor:pointer;" @click="showCloudModal=false"></i></div>
                <div class="modal-body">
                    <p style="color:var(--text-muted); font-size:12px; margin-bottom:15px;">Î≥µÏõêÌï† ÌîÑÎ°úÏ†ùÌä∏ ÏÑ†ÌÉù (Sel. proyecto
                        para restaurar)<br>ÌòÑÏû¨ Îç∞Ïù¥ÌÑ∞Í∞Ä ÎçÆÏñ¥ÏîåÏõåÏßëÎãàÎã§. (Se sobrescribir√°n los datos actuales.)</p>
                    <div v-for="p in cloudProjectsList" :key="p.name"
                        style="display:flex; align-items:center; gap:5px;">
                        <button class="btn" style="text-align:left; justify-content:flex-start; flex:1;"
                            @click="loadSelectedCloudProject(p.name)">
                            <i class="fa-solid fa-folder" style="color:var(--blue); margin-right:10px;"></i>
                            {{ p.name }} <span style="margin-left:auto; font-size:11px; color:#888;">({{ p.count
                                }})</span>
                        </button>
                        <button class="btn danger" style="padding:0 10px;" @click.stop="deleteCloudProject(p.name)"
                            title="ÏÇ≠Ï†ú (Eliminar)">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ImageViewer Overlay -->
        <div v-if="zoomedImage" class="modal-overlay" @click="zoomedImage=null">
            <img :src="zoomedImage" style="max-width:90%; max-height:90vh; border-radius:8px; border:2px solid white;">
        </div>

        <!-- REPORT MODAL -->
        <transition name="fade">
            <div v-if="showReportModal" class="modal-overlay" @click.self="showReportModal = false">
                <div class="modal"
                    style="width:95%; max-width:1400px; height:90vh; display:flex; flex-direction:column;">
                    <div class="modal-header">
                        <div style="display:flex; align-items:center; gap:10px;">
                            <h3>üìä Ïó∞Í∞Ñ Î¶¨Ìè¨Ìä∏ (Reporte Anual)</h3>
                            <select v-model="reportYear" class="input" style="width:80px; font-weight:bold;">
                                <option v-for="y in [2023, 2024, 2025, 2026]" :value="y">{{ y }}</option>
                            </select>

                            <!-- Search & View Options -->
                            <select v-model="reportType" class="input"
                                style="width:120px; font-weight:bold; margin-left:10px;">
                                <option value="Quarterly">Î∂ÑÍ∏∞Î≥Ñ (Q)</option>
                                <option value="Monthly">ÏõîÎ≥Ñ (M)</option>
                            </select>
                            <label style="margin-left:15px; display:flex; align-items:center; gap:5px; cursor:pointer;"
                                class="no-print">
                                <input type="checkbox" v-model="showSelectedOnly"> ÏÑ†ÌÉù Ìï≠Î™©Îßå Î≥¥Í∏∞ (Selec.)
                            </label>

                            <select v-model="reportStockFilter" class="input no-print"
                                style="width:100px; font-weight:bold; margin-left:15px;">
                                <option value="All">Ï†ÑÏ≤¥ (Todo)</option>
                                <option value="Low">Î∂ÄÏ°± (Bajo)</option>
                                <option value="Over">Ï¥àÍ≥º (Exceso)</option>
                            </select>

                        </div>
                        <div class="actions">
                            <button class="btn btn-secondary" @click="captureReportModal">üì∑ Ï∫°Ï≤ò (Captura)</button>
                            <button class="btn btn-primary" @click="printReportModal">üñ® Ïù∏ÏáÑ (Imprimir)</button>
                            <i class="fa-solid fa-times" style="cursor:pointer; margin-left:10px;"
                                @click="showReportModal=false"></i>
                        </div>
                    </div>

                    <div id="report-print-area" class="modal-body"
                        style="flex:1; overflow:auto; padding:20px; background:white; color:black;">
                        <h2 style="text-align:center; margin-bottom:20px; color:black;">ÏÑ§ÎπÑ ÏòàÎπÑÎ∂ÄÌíà Î¶¨Ìè¨Ìä∏ (Reporte de
                            Repuestos) - {{
                            reportYear }} ({{ reportType }})</h2>
                        <!-- QUARTERLY TABLE -->
                        <table v-if="reportType === 'Quarterly'"
                            style="width:100%; border-collapse:collapse; font-size:11px; text-align:center; border:1px solid #000;">
                            <thead style="position:sticky; top:0; z-index:10; display:table-header-group;">
                                <tr style="background:#eee; border-bottom:1px solid #000; color:black;">
                                    <th rowspan="2" style="border:1px solid #000; padding:5px; width:30px;"
                                        class="no-print">
                                        <input type="checkbox" @click="toggleSelectAllReport"
                                            :checked="reportSelectedParts.size > 0 && reportSelectedParts.size === reportFilteredData.length">
                                    </th>
                                    <th rowspan="2" style="border:1px solid #000; padding:5px; cursor:pointer;"
                                        @click="sortReport('moldCode')">
                                        Í∏àÌòï ÏΩîÎìú (C√≥digo) <i v-if="reportSortKey==='moldCode'" class="fa-solid"
                                            :class="reportSortOrder===1?'fa-caret-up':'fa-caret-down'"></i>
                                    </th>
                                    <th rowspan="2" style="border:1px solid #000; padding:5px; cursor:pointer;"
                                        @click="sortReport('spareCode')">ÏòàÎπÑÌíà ÏΩîÎìú (Repuesto)</th>
                                    <th rowspan="2" style="border:1px solid #000; padding:5px; cursor:pointer;"
                                        @click="sortReport('model')">Î™®Îç∏ (Modelo)</th>


                                    <th colspan="2" style="border:1px solid #000; background:#e0f7fa;">Q1</th>
                                    <th colspan="2" style="border:1px solid #000; background:#f3e5f5;">Q2</th>
                                    <th colspan="2" style="border:1px solid #000; background:#fff3e0;">Q3</th>
                                    <th colspan="2" style="border:1px solid #000; background:#f1f8e9;">Q4</th>

                                    <th colspan="2" style="border:1px solid #000; background:#ffcdd2; cursor:pointer;"
                                        @click="sortReport('totalIn')">Ìï©Í≥Ñ (Total)</th>
                                    <th rowspan="2"
                                        style="border:1px solid #000; padding:5px; background:#ef9a9a; cursor:pointer;"
                                        @click="sortReport('currentStock')">Ïû¨Í≥† (Stock)</th>
                                </tr>
                                <tr style="border-bottom:1px solid #000; font-size:10px;">
                                    <template v-for="q in 4" :key="'qsub'+q">
                                        <th style="border:1px solid #000; background:#eee; color:black;">In</th>
                                        <th style="border:1px solid #000; background:#eee; color:black;">Out</th>
                                    </template>
                                    <th style="border:1px solid #000; background:#ffcdd2;">In</th>
                                    <th style="border:1px solid #000; background:#ffcdd2;">Out</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="row in reportFilteredData" :key="row.id"
                                    style="border-bottom:1px solid #ccc; page-break-inside:avoid;">
                                    <td style="border:1px solid #ccc; padding:2px;" class="no-print">
                                        <input type="checkbox" :checked="reportSelectedParts.has(row.id)"
                                            @click="toggleReportSelection(row.id)">
                                    </td>
                                    <td style="border:1px solid #ccc; padding:2px;">{{ row.moldCode }}</td>
                                    <td style="border:1px solid #ccc; padding:2px;">{{ row.spareCode }}</td>
                                    <td style="border:1px solid #ccc; padding:2px;">{{ row.model }}</td>


                                    <!-- Quarterly Data -->
                                    <td style="border:1px solid #ccc;">{{ row.q[1].in }}</td>
                                    <td style="border:1px solid #ccc;">{{ row.q[1].out }}</td>
                                    <td style="border:1px solid #ccc;">{{ row.q[2].in }}</td>
                                    <td style="border:1px #ccc;">{{ row.q[2].out }}</td>
                                    <td style="border:1px solid #ccc;">{{ row.q[3].in }}</td>
                                    <td style="border:1px solid #ccc;">{{ row.q[3].out }}</td>
                                    <td style="border:1px solid #ccc;">{{ row.q[4].in }}</td>
                                    <td style="border:1px solid #ccc;">{{ row.q[4].out }}</td>

                                    <td style="border:1px solid #ccc; font-weight:bold;">{{ row.total.in }}</td>
                                    <td style="border:1px solid #ccc; font-weight:bold;">{{ row.total.out }}</td>
                                    <td style="border:1px solid #000; font-weight:bold; background:#ef9a9a; cursor:pointer; text-decoration:underline;"
                                        @click="editPartFromReport(row.id)" title="Click to Edit Stock">
                                        {{ row.currentStock }}
                                    </td>
                                </tr>
                            </tbody>
                        </table>

                        <!-- MONTHLY TABLE -->
                        <table v-else
                            style="width:100%; min-width:1500px; border-collapse:collapse; font-size:10px; text-align:center; border:1px solid #000;">
                            <thead style="position:sticky; top:0; z-index:10; display:table-header-group;">
                                <tr style="background:#eee; border-bottom:1px solid #000; color:black;">
                                    <th rowspan="2"
                                        style="border:1px solid #000; padding:5px; width:30px; position:sticky; left:0; background:#eee; z-index:12;"
                                        class="no-print">
                                        <input type="checkbox" @click="toggleSelectAllReport"
                                            :checked="reportSelectedParts.size > 0 && reportSelectedParts.size === reportFilteredData.length">
                                    </th>
                                    <th rowspan="2"
                                        style="border:1px solid #000; padding:5px; cursor:pointer; min-width:80px; position:sticky; left:30px; background:#eee; z-index:11;"
                                        @click="sortReport('moldCode')">Í∏àÌòï ÏΩîÎìú (C√≥digo)</th>
                                    <th rowspan="2" style="border:1px solid #000; padding:5px; cursor:pointer;"
                                        @click="sortReport('model')">Î™®Îç∏ (Modelo)</th>


                                    <th colspan="2" v-for="m in 12" :key="'h'+m" style="border:1px solid #000;"
                                        :style="{background: (m%2===0 ? '#f5f5f5' : '#e0e0e0')}">{{ m }}Ïõî</th>

                                    <th colspan="2" style="border:1px solid #000; background:#ffcdd2;">Ìï©Í≥Ñ (Total)</th>
                                    <th rowspan="2" style="border:1px solid #000; padding:5px; background:#ef9a9a;">
                                        Ïû¨Í≥† (Stock)</th>
                                </tr>
                                <tr style="border-bottom:1px solid #000;">
                                    <template v-for="m in 12" :key="'Sub'+m">
                                        <th style="border:1px solid #000; border-left:2px solid #aaa;">In</th>
                                        <th style="border:1px solid #000;">Out</th>
                                    </template>
                                    <th style="border:1px solid #000; background:#ffcdd2;">In</th>
                                    <th style="border:1px solid #000; background:#ffcdd2;">Out</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="row in reportFilteredData" :key="row.id"
                                    style="border-bottom:1px solid #ccc; page-break-inside:avoid;">
                                    <td style="border:1px solid #ccc; padding:2px; position:sticky; left:0; background:white; z-index:2;"
                                        class="no-print">
                                        <input type="checkbox" :checked="reportSelectedParts.has(row.id)"
                                            @click="toggleReportSelection(row.id)">
                                    </td>
                                    <td
                                        style="border:1px solid #ccc; padding:2px; position:sticky; left:30px; background:white; z-index:1;">
                                        {{ row.moldCode }}</td>
                                    <td style="border:1px solid #ccc; padding:2px;">{{ row.model }}</td>


                                    <template v-for="m in 12" :key="'d'+m">
                                        <td style="border:1px solid #ccc; border-left:2px solid #eee;">{{ row.m[m].in ||
                                            '' }}</td>
                                        <td style="border:1px solid #ccc;">{{ row.m[m].out || '' }}</td>
                                    </template>

                                    <td style="border:1px solid #ccc; font-weight:bold;">{{ row.total.in }}</td>
                                    <td style="border:1px solid #ccc; font-weight:bold;">{{ row.total.out }}</td>
                                    <td style="border:1px solid #000; font-weight:bold; background:#ef9a9a; cursor:pointer; text-decoration:underline;"
                                        @click="editPartFromReport(row.id)" title="Click to Edit Stock">
                                        {{ row.currentStock }}
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                        <div style="margin-top:20px; font-size:10px; text-align:right;">
                            Generated by Smart Factory System | {{ new Date().toLocaleString() }}
                        </div>
                    </div>
                </div>
            </div>
        </transition>

    </div>

    <!-- GLOBAL HIDDEN ELEMENTS -->
    <!-- Datalists for Autocomplete -->
    <datalist id="dl-model">
        <option v-for="m in uniqueModels" :key="m" :value="m"></option>
    </datalist>
    <datalist id="dl-mold">
        <option v-for="m in uniqueMolds" :key="m" :value="m"></option>
    </datalist>

    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js').catch(err => console.log('SW reg failed: ', err));
            });
        }

        const CLOUD_URL = "https://script.google.com/macros/s/AKfycbxb8Th7X8XkZACfEdg9EW6lJdpD_gp5qZ1Gs8FolNyP2T-iyCY48_im-902fkCBBblZVw/exec";
        console.log("%c MOLD MANAGER VERSION 6.5 (Robust Cloud) LOADED ", "background: #000; color: #ff9900; font-size: 20px;");
        const { createApp, ref, computed, reactive, onMounted, onUnmounted, watch, nextTick } = Vue;
        const db = new Dexie('MoldManagerV6');
        db.version(21).stores({ projects: '++id, name, updated', parts: '++id, projectId, moldCode, spareCode, model' });

        createApp({
            setup() {
                const projects = ref([]);
                const currentProject = ref(null);
                const projectParts = ref([]);
                const searchQuery = ref("");
                const filterLowStock = ref(false);
                const showPartModal = ref(false);
                // Dashboard removed
                const showDataModal = ref(false);
                const isSyncing = ref(false);
                const isImageProcessing = ref(false); // Ïù¥ÎØ∏ÏßÄ Ï≤òÎ¶¨ Ï§ë ÏÉÅÌÉú
                const chartInstance = ref(null);
                const showCloudModal = ref(false);
                const cloudProjectsList = ref([]);
                const rawCloudData = ref([]);
                const zoomedImage = ref(null);

                const showColMenu = ref(false);
                const showQRModal = ref(false);
                const qrTargetName = ref('');
                const qrTargetCode = ref('');
                const sortKey = ref('moldCode');
                const sortOrder = ref(1); // 1 asc, -1 desc

                const columns = ref([
                    { key: 'img', label: 'Img', width: 50, visible: true, sortable: false },
                    { key: 'moldCode', label: 'Mold Code', width: 100, visible: true, sortable: true },
                    { key: 'spareCode', label: 'Spare Code', width: 100, visible: true, sortable: true },
                    { key: 'op', label: 'OP', width: 60, visible: true, sortable: true },
                    { key: 'model', label: 'Model', width: 100, visible: true, sortable: true },
                    // Removed: moldName, size, price
                    { key: 'type', label: 'Category', width: 80, visible: true, sortable: true },
                    { key: 'mat', label: 'Mat', width: 80, visible: true, sortable: true },
                    { key: 'loc', label: 'Loc', width: 80, visible: true, sortable: true },
                    { key: 'stock', label: 'Stock', width: 120, visible: true, sortable: true },
                    { key: 'status', label: 'Status', width: 80, visible: true, sortable: false },

                    { key: 'action', label: 'Action', width: 80, visible: true, sortable: false },
                ]);

                const defaultPart = {
                    projectId: null, moldCode: '', spareCode: '', op: 'OP10', model: '',
                    moldType: 'dedicated', type: '', mat: '',
                    loc: '', stock: 0, min: 2, max: 10, vendor: '', img: '',
                    carryover: 0, // Last Year Stock
                    transactions: [], // Array of { date, type, qty }
                    lastRecord: null // { qty: 10, date: '2023-12-31' }
                };
                const editingPart = reactive({ ...defaultPart });
                const newTx = reactive({ date: new Date().toISOString().split('T')[0], type: 'IN', qty: 1 });

                // Report State
                const showReportModal = ref(false);
                const reportYear = ref(new Date().getFullYear());
                const reportData = ref([]);

                // Report UI State
                const reportSearch = ref('');
                const reportType = ref('Quarterly'); // Changed from 'Quarterly' to 'Monthly'
                const reportSortKey = ref('moldCode');
                const reportSortOrder = ref(1);

                // Report Selection Logic
                const reportSelectedParts = ref(new Set());
                const showSelectedOnly = ref(false);
                const reportStockFilter = ref('All'); // 'All', 'Low', 'Over'

                const toggleReportSelection = (id) => {
                    if (reportSelectedParts.value.has(id)) reportSelectedParts.value.delete(id);
                    else reportSelectedParts.value.add(id);
                };

                const toggleSelectAllReport = () => {
                    if (reportSelectedParts.value.size === reportFilteredData.value.length) {
                        reportSelectedParts.value.clear();
                    } else {
                        reportFilteredData.value.forEach(r => reportSelectedParts.value.add(r.id));
                    }
                };

                // Ï§ëÎ≥µ Îç∞Ïù¥ÌÑ∞ Ï†úÍ±∞ Ìï®Ïàò (Mold Code + Spare Code Í∏∞Ï§Ä) - Last Wins (Îí§Ïóê ÏûàÎäî ÏµúÏã† Îç∞Ïù¥ÌÑ∞Í∞Ä Ïö∞ÏÑ†)


                const uniqueModels = computed(() => [...new Set(projectParts.value.map(p => p.model).filter(Boolean))]);
                const uniqueMolds = computed(() => [...new Set(projectParts.value.map(p => p.moldCode).filter(Boolean))]);

                const visibleColumns = computed(() => columns.value.filter(c => c.visible));
                const sortTable = (key) => {
                    if (sortKey.value === key) sortOrder.value *= -1;
                    else { sortKey.value = key; sortOrder.value = 1; }
                };

                const filteredParts = computed(() => {
                    let p = projectParts.value;
                    const q = searchQuery.value.toLowerCase();
                    if (q) p = p.filter(x =>
                        (x.moldCode || '').toLowerCase().includes(q) ||
                        (x.spareCode || '').toLowerCase().includes(q) ||
                        (x.moldName || '').toLowerCase().includes(q) ||
                        (x.model || '').toLowerCase().includes(q)
                    );
                    if (filterLowStock.value) p = p.filter(x => x.stock <= x.min);

                    // Dynamic Sort
                    const k = sortKey.value;
                    const o = sortOrder.value;

                    return p.sort((a, b) => {
                        let va = a[k], vb = b[k];
                        if (k === 'stock' || k === 'price') { va = Number(va) || 0; vb = Number(vb) || 0; }
                        else { va = (va || '').toString().toLowerCase(); vb = (vb || '').toString().toLowerCase(); }

                        if (va < vb) return -1 * o;
                        if (va > vb) return 1 * o;
                        return 0;
                    });
                });

                const stats = computed(() => {
                    const totalVal = projectParts.value.reduce((acc, p) => acc + ((p.stock || 0) * (p.price || 0)), 0);
                    const lowCount = projectParts.value.filter(p => p.stock <= p.min).length;
                    return { value: totalVal, low: lowCount };
                });

                onMounted(async () => {
                    loadProjects();
                    window.addEventListener('paste', handlePaste); // Global Paste Listener
                    const lastId = localStorage.getItem('lastProjectId');
                    if (lastId) {
                        const p = await db.projects.get(parseInt(lastId));
                        if (p) selectProject(p);
                    }
                });

                onUnmounted(() => {
                    window.removeEventListener('paste', handlePaste);
                });

                // --- Project Management ---
                const loadProjects = async () => { projects.value = await db.projects.toArray(); };
                const createProject = async () => {
                    const n = prompt("ÌîÑÎ°úÏ†ùÌä∏ Ïù¥Î¶Ñ (Nombre del Proyecto):"); if (!n) return;
                    await db.projects.add({ name: n, updated: new Date() });
                    loadProjects();
                };
                const selectProject = async (p) => {
                    currentProject.value = p;
                    projectParts.value = await db.parts.where('projectId').equals(p.id).toArray();
                    localStorage.setItem('lastProjectId', p.id);
                };
                const deleteProject = async (p) => {
                    if (!confirm(`Delete project '${p.name}' and ALL its parts?`)) return;
                    await db.projects.delete(p.id);
                    await db.parts.where('projectId').equals(p.id).delete();
                    if (currentProject.value?.id === p.id) { currentProject.value = null; projectParts.value = []; }
                    loadProjects();
                };

                // --- Part Management (Î∂ÄÌíà Í¥ÄÎ¶¨) ---
                const openAddModal = () => {
                    if (!currentProject.value) return alert("ÌîÑÎ°úÏ†ùÌä∏Î•º Î®ºÏ†Ä ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî! (Select a project first!)");
                    Object.assign(editingPart, { ...defaultPart, projectId: currentProject.value.id });
                    showPartModal.value = true;
                };
                const editPart = (p) => {
                    if (!p.id) alert("Warning: This part has no ID!");

                    // Deep copy to prevent direct mutation (ÏßÅÏ†ë ÏàòÏ†ï Î∞©ÏßÄÎ•º ÏúÑÌïú ÍπäÏùÄ Î≥µÏÇ¨)
                    // Ïù¥ÎØ∏ÏßÄ Îç∞Ïù¥ÌÑ∞Í∞Ä ÎàÑÎùΩÎêòÏßÄ ÏïäÎèÑÎ°ù ÌôïÏã§ÌïòÍ≤å Ï≤òÎ¶¨
                    Object.assign(editingPart, JSON.parse(JSON.stringify(p)));
                    showPartModal.value = true;
                };

                const savePart = async () => {
                    if (isImageProcessing.value) return alert("Ïù¥ÎØ∏ÏßÄ Ï≤òÎ¶¨ Ï§ëÏûÖÎãàÎã§. Ïû†ÏãúÎßå Í∏∞Îã§Î†§Ï£ºÏÑ∏Ïöî. (Processing image...)");
                    if (!editingPart.moldCode && !editingPart.moldCode) return alert("ÏΩîÎìúÎäî ÌïÑÏàòÏûÖÎãàÎã§! (Code required!)");

                    const copy = JSON.parse(JSON.stringify(editingPart));

                    if (copy.id) {
                        // --- EDIT MODE (Í∏∞Ï°¥ Î∂ÄÌíà ÏàòÏ†ï) ---
                        console.log("Updating Existing ID:", copy.id);
                        console.log("Length Before:", projectParts.value.length);

                        // 1. Update Local State (In-Place Update) using .map()
                        // Î∞∞Ïó¥Ïùò Í∏∏Ïù¥Î•º Î≥ÄÍ≤ΩÌïòÏßÄ ÏïäÍ≥†, Ìï¥Îãπ IDÎ•º Í∞ÄÏßÑ Ìï≠Î™©Îßå Ï†ïÌôïÌûà ÍµêÏ≤¥Ìï©ÎãàÎã§.
                        projectParts.value = projectParts.value.map(p => p.id === copy.id ? copy : p);

                        // 2. Update DB
                        await db.parts.put(copy);

                        console.log("Length After:", projectParts.value.length);
                    } else {
                        // --- ADD MODE (ÏÉà Î∂ÄÌíà Ï∂îÍ∞Ä) ---
                        // 1. Add to DB and get new ID
                        const id = await db.parts.add(copy);
                        copy.id = id;

                        // 2. Add to Local State
                        projectParts.value.push(copy);
                    }

                    showPartModal.value = false;
                };
                const deletePart = async () => {
                    if (!confirm("Ïù¥ Î∂ÄÌíàÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå? (Delete this part?)")) return;
                    await db.parts.delete(editingPart.id);
                    projectParts.value = await db.parts.where('projectId').equals(currentProject.value.id).toArray();
                    showPartModal.value = false;
                };
                const savePartToDb = async (part) => {
                    // Find and update in local state
                    projectParts.value = projectParts.value.map(p => p.id === part.id ? part : p);
                    // Update in DB
                    await db.parts.put(JSON.parse(JSON.stringify(part)));
                };
                const adjustStock = (p, delta) => {
                    // Update Stock
                    p.stock += delta;
                    if (p.stock < 0) p.stock = 0;

                    // Transaction Recording
                    if (!p.transactions) p.transactions = [];
                    const today = new Date().toISOString().split('T')[0];
                    p.transactions.push({
                        date: today,
                        type: delta > 0 ? 'IN' : 'OUT',
                        qty: Math.abs(delta)
                    });

                    savePartToDb(p);
                };

                const addManualTx = () => {
                    if (!newTx.date || !newTx.qty || newTx.qty <= 0) return alert("ÎÇ†ÏßúÏôÄ ÏàòÎüâÏùÑ ÌôïÏù∏ÌïòÏÑ∏Ïöî. (Verifique fecha y cantidad.)");

                    if (!editingPart.transactions) editingPart.transactions = [];
                    editingPart.transactions.push({ ...newTx });

                    // Recalculate Stock based on Carryover + All Transactions
                    // Formula: Stock = Carryover + Sum(IN) - Sum(OUT)
                    // Wait, if we use this formula, we must ensure 'carryover' is correct.
                    // Let's assume 'carryover' is for the beginning of THIS YEAR or just a base line?
                    // User request: "Use date and input date and carryover(last year) to showing report".
                    // So Current Stock should be dynamic? Or should we just update the 'stock' field incrementally?
                    // Let's stick to updating 'stock' incrementally for now to be safe with existing logic,
                    // BUT we should apply the manual transaction effect.

                    const delta = newTx.type === 'IN' ? newTx.qty : -newTx.qty;
                    editingPart.stock += delta;
                    if (editingPart.stock < 0) editingPart.stock = 0;

                    alert("Ìä∏ÎûúÏû≠ÏÖò Ï∂îÍ∞ÄÎê®. (Transacci√≥n agregada.)");
                };

                const openReport = () => {
                    showReportModal.value = true;
                    generateReport();
                };

                const generateReport = () => {
                    // Filter parts for current project
                    const parts = projectParts.value;
                    const year = reportYear.value;

                    reportData.value = parts.map(p => {
                        const row = {
                            id: p.id,
                            moldCode: p.moldCode,
                            spareCode: p.spareCode,
                            model: p.model,
                            type: p.moldType,
                            carryover: p.carryover || 0,
                            m: {}, // 1..12
                            q: {}, // 1..4
                            total: { in: 0, out: 0 },
                            currentStock: 0,
                            lastRecordQty: p.lastRecord?.qty ?? null, // UI binding
                            lastRecordDate: p.lastRecord?.date ?? null,
                            effectiveCarryover: 0, // Calculated
                            min: p.min || 0,
                            max: p.max || 999999
                        };

                        // Determine Baseline
                        let baselineStock = row.carryover;
                        let filterDate = null;

                        if (p.lastRecord && p.lastRecord.date) {
                            baselineStock = Number(p.lastRecord.qty);
                            filterDate = new Date(p.lastRecord.date);
                        }

                        row.effectiveCarryover = baselineStock;

                        // Initialize Months
                        for (let i = 1; i <= 12; i++) row.m[i] = { in: 0, out: 0 };
                        // Initialize Quarters
                        for (let i = 1; i <= 4; i++) row.q[i] = { in: 0, out: 0 };

                        // Process Transactions
                        (p.transactions || []).forEach(t => {
                            // Filter: Skip if created before last record date
                            if (!t.date) return;
                            const d = new Date(t.date);
                            if (filterDate && d <= filterDate) return;

                            // Filter by Year
                            if (d.getFullYear() === year) {
                                const month = d.getMonth() + 1; // 1-12
                                const q = Math.ceil(month / 3); // 1-4

                                if (t.type === 'IN') {
                                    row.m[month].in += t.qty;
                                    row.q[q].in += t.qty;
                                    row.total.in += t.qty;
                                } else if (t.type === 'OUT') {
                                    row.m[month].out += t.qty;
                                    row.q[q].out += t.qty;
                                    row.total.out += t.qty;
                                }
                            }
                        });

                        // Calculate Current Stock
                        // If using lastRecord, effectiveCarryover is the record qty.
                        // Transactions are only those AFTER the record.
                        row.currentStock = row.effectiveCarryover + row.total.in - row.total.out;

                        return row;
                    });
                };

                // Re-generate report when year changes
                watch(reportYear, generateReport);



                const sortReport = (key) => {
                    if (reportSortKey.value === key) reportSortOrder.value *= -1;
                    else { reportSortKey.value = key; reportSortOrder.value = 1; }
                };

                const reportFilteredData = computed(() => {
                    let data = reportData.value;

                    // Filter
                    if (reportSearch.value) {
                        const q = reportSearch.value.toLowerCase();
                        data = data.filter(r =>
                            (r.moldCode || '').toLowerCase().includes(q) ||
                            (r.spareCode || '').toLowerCase().includes(q) ||
                            (r.model || '').toLowerCase().includes(q) ||
                            (r.type || '').toLowerCase().includes(q)
                        );
                    }

                    // Filter by Selection
                    if (showSelectedOnly.value) {
                        data = data.filter(r => reportSelectedParts.value.has(r.id));
                    }

                    // Stock Filter
                    if (reportStockFilter.value === 'Low') {
                        data = data.filter(r => r.currentStock <= r.min);
                    } else if (reportStockFilter.value === 'Over') {
                        data = data.filter(r => r.currentStock >= r.max);
                    }

                    // Sort
                    const k = reportSortKey.value;
                    const o = reportSortOrder.value;

                    return data.sort((a, b) => {
                        let va = a[k], vb = b[k];
                        // Handle nested or special keys
                        if (k === 'totalIn') { va = a.total.in; vb = b.total.in; }
                        else if (k === 'totalOut') { va = a.total.out; vb = b.total.out; }
                        else if (k === 'carryover') { va = Number(va) || 0; vb = Number(vb) || 0; }
                        else if (k === 'currentStock') { va = Number(va) || 0; vb = Number(vb) || 0; }
                        else { va = (va || '').toString().toLowerCase(); vb = (vb || '').toString().toLowerCase(); }

                        if (va < vb) return -1 * o;
                        if (va > vb) return 1 * o;
                        return 0;
                    });
                });

                const printReportModal = () => {
                    window.print();
                };

                const captureReportModal = async () => {
                    const h = document.getElementById('report-header'); h.style.display = 'flex';
                    const c = await html2canvas(document.getElementById('report-print-area'), { scale: 2 });
                    h.style.display = 'none';
                    const a = document.createElement('a'); a.href = c.toDataURL(); a.download = 'Report.png'; a.click();
                };

                const editPartFromReport = (id) => {
                    const p = projectParts.value.find(x => x.id === id);
                    if (p) {
                        editPart(p); // Opens the edit modal
                        showReportModal.value = false; // Close report to focus on edit
                    }
                };

                const monthStats = computed(() => {
                    const stats = {}; // { "2024-05": { in: 0, out: 0 } }
                    const txs = editingPart.transactions || [];

                    txs.forEach(t => {
                        const month = t.date.substring(0, 7); // YYYY-MM
                        if (!stats[month]) stats[month] = { in: 0, out: 0 };
                        if (t.type === 'IN') stats[month].in += t.qty;
                        if (t.type === 'OUT') stats[month].out += t.qty;
                    });

                    // Convert to array and sort descending (recent first)
                    return Object.keys(stats).sort().reverse().map(m => ({
                        month: m,
                        in: stats[m].in,
                        out: stats[m].out
                    }));
                });

                // --- Image Logic (Unified) ---
                const handlePaste = (e) => {
                    if (!showPartModal.value) return; // Only work when modal is open

                    const items = (e.clipboardData || e.originalEvent.clipboardData).items;
                    for (let item of items) {
                        if (item.kind === 'file' && item.type.includes('image/')) {
                            e.preventDefault();
                            const blob = item.getAsFile();
                            processImageFile(blob);
                            return; // Only process one image
                        }
                    }
                };

                const handleImageUpload = (e) => {
                    const f = e.target.files[0]; if (!f) return;
                    processImageFile(f);
                };

                // --- QR Logic ---
                const showQR = (p) => {
                    qrTargetName.value = p.moldCode;
                    qrTargetCode.value = p.spareCode;
                    showQRModal.value = true;
                    nextTick(() => {
                        const container = document.getElementById('qrcode-container');
                        container.innerHTML = '';
                        // QR Content: JSON string with ID, Project, and Mode
                        const data = JSON.stringify({
                            id: p.id,
                            project: currentProject.value.name,
                            mode: 'edit'
                        });
                        new QRCode(container, {
                            text: data,
                            width: 150,
                            height: 150
                        });
                    });
                };

                const printQR = () => {
                    const w = window.open('', '', 'width=400,height=400');
                    const html = document.getElementById('qrcode-container').innerHTML;
                    w.document.write(`
                        <html><body style="text-align:center; display:flex; flex-direction:column; align-items:center; justify-content:center; height:100vh;">
                            ${html}
                            <h2 style="margin:10px 0 0;">${qrTargetName.value}</h2>
                            <p>${qrTargetCode.value}</p>
                        </body></html>
                    `);
                    w.document.close();
                    w.focus();
                    setTimeout(() => { w.print(); w.close(); }, 500);
                };



                const processImageFile = (file) => {
                    isImageProcessing.value = true;
                    const r = new FileReader();
                    r.onload = (ev) => {
                        const img = new Image();
                        img.onload = () => {
                            const TARGET_KB = 200; // Î™©Ìëú ÌÅ¨Í∏∞ (KB)
                            const MAX_SIZE = 800;  // ÏµúÎåÄ ÌîΩÏÖÄ ÌÅ¨Í∏∞
                            let width = img.width;
                            let height = img.height;

                            if (width > height) {
                                if (width > MAX_SIZE) { height = Math.round(height * MAX_SIZE / width); width = MAX_SIZE; }
                            } else {
                                if (height > MAX_SIZE) { width = Math.round(width * MAX_SIZE / height); height = MAX_SIZE; }
                            }

                            const c = document.createElement('canvas');
                            c.width = width;
                            c.height = height;
                            c.getContext('2d').drawImage(img, 0, 0, width, height);

                            // ÏûêÎèô ÏïïÏ∂ï: Î™©Ìëú ÌÅ¨Í∏∞ Ïù¥ÌïòÍ∞Ä Îê† ÎïåÍπåÏßÄ ÌíàÏßà Îã®Í≥ÑÏ†Å Í∞êÏÜå
                            let quality = 0.85;
                            let dataUrl;
                            do {
                                dataUrl = c.toDataURL('image/jpeg', quality);
                                // base64 ‚Üí Ïã§Ï†ú Î∞îÏù¥Ìä∏ Ï∂îÏ†ï
                                const estimatedKB = Math.round((dataUrl.length - 22) * 3 / 4 / 1024);
                                if (estimatedKB <= TARGET_KB || quality <= 0.3) break;
                                quality = Math.round((quality - 0.05) * 100) / 100;
                            } while (true);

                            editingPart.img = dataUrl;
                            isImageProcessing.value = false;
                        };
                        img.src = ev.target.result;
                    };
                    r.readAsDataURL(file);
                };
                const setModalImage = (src) => { zoomedImage.value = src; }

                // --- Cloud Logic (ÌÅ¥ÎùºÏö∞Îìú ÎèôÍ∏∞Ìôî) ---
                // --- Cloud Logic (ÌÅ¥ÎùºÏö∞Îìú ÎèôÍ∏∞Ìôî) ---
                // --- Cloud Logic (ÌÅ¥ÎùºÏö∞Îìú ÎèôÍ∏∞Ìôî - Simple Overwrite) ---
                const syncToCloud = async () => {
                    if (!currentProject.value) return alert("ÌîÑÎ°úÏ†ùÌä∏Î•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî! (¬°Seleccione proyecto!)");
                    if (!confirm("ÌÅ¥ÎùºÏö∞ÎìúÏóê Ï†ÄÏû•ÌïòÏãúÍ≤†ÏäµÎãàÍπå? (ÌòÑÏû¨ ÌôîÎ©¥ Í∑∏ÎåÄÎ°ú ÎçÆÏñ¥ÏîåÏõåÏßëÎãàÎã§)\nSave to Cloud? (Overwrite)")) return;
                    isSyncing.value = true;
                    try {
                        const batchId = Date.now(); // ÏùºÍ¥Ñ Ï≤òÎ¶¨ ID ÏÉùÏÑ± (Unique Batch ID)

                        let partsToSend;
                        if (projectParts.value.length === 0) {
                            // Îπà ÌîÑÎ°úÏ†ùÌä∏ Ï†ÄÏû•: 'Empty Marker' ÌïòÎÇòÎßå Î≥¥ÎÉÑ (Save Empty Marker)
                            partsToSend = [{
                                project: currentProject.value.name,
                                batchId: batchId, // Removed underscore
                                moldCode: 'EMPTY_PROJECT_MARKER',
                                isMarker: true
                            }];
                        } else {
                            // Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•: Ïù¥ÎØ∏ÏßÄ(img)Îäî ÏÖÄ Ïö©Îüâ Ï¥àÍ≥ºÎ°ú Ï†úÏô∏, Î°úÏª¨ÏóêÎßå Î≥¥Í¥Ä
                            partsToSend = projectParts.value.map(p => {
                                const { img, ...rest } = p;
                                return {
                                    ...rest,
                                    project: currentProject.value.name,
                                    batchId: batchId
                                };
                            });
                        }

                        const r = await fetch(CLOUD_URL, {
                            method: 'POST',
                            redirect: 'follow',
                            body: JSON.stringify({ action: 'save', project: currentProject.value.name, parts: partsToSend })
                        });
                        const res = await r.json();
                        if (res.result === 'error') throw new Error(res.message);
                        alert(`Ï†ÄÏû• ÏôÑÎ£å! (Guardado) (${partsToSend.length} items)`);
                    } catch (e) { alert("Ïò§Î•òÎ∞úÏÉù (Error): " + e); } finally { isSyncing.value = false; }
                };

                const syncFromCloud = async () => {
                    isSyncing.value = true;
                    try {
                        const r = await fetch(CLOUD_URL + "?action=load");
                        const d = await r.json();
                        if (!d.parts || d.parts.length === 0) return alert("ÌÅ¥ÎùºÏö∞ÎìúÏóê Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§. (No data in cloud.)");

                        rawCloudData.value = d.parts;

                        // Count items per project (Unique Name Trimmed)
                        const counts = {};
                        d.parts.forEach(p => {
                            const name = String(p.project || p.model || 'Unknown').trim();
                            counts[name] = (counts[name] || 0) + 1;
                        });

                        // Create list with counts
                        cloudProjectsList.value = Object.keys(counts).map(name => ({
                            name: name,
                            count: counts[name]
                        })).sort((a, b) => b.count - a.count); // Sort by count descending

                        console.log("Cloud Projects Loaded:", cloudProjectsList.value);
                        showCloudModal.value = true;
                    } catch (e) { alert("Ïò§Î•òÎ∞úÏÉù (Error): " + e); } finally { isSyncing.value = false; }
                };

                const loadSelectedCloudProject = async (pName) => {
                    if (!confirm(`ÌòÑÏû¨ ÌîÑÎ°úÏ†ùÌä∏Î•º ÌÅ¥ÎùºÏö∞Îìú Îç∞Ïù¥ÌÑ∞ '${pName}'Î°ú ÍµêÏ≤¥ÌïòÏãúÍ≤†ÏäµÎãàÍπå?\n(Replace current project with cloud data?)`)) return;

                    // 1. Ensure Project Exists Locally
                    let targetProj = projects.value.find(p => p.name === pName);
                    if (!targetProj) {
                        const id = await db.projects.add({ name: pName, updated: new Date() });
                        await loadProjects();
                        targetProj = projects.value.find(p => p.id === id);
                    }

                    // 2. Select it
                    await selectProject(targetProj);

                    // 3. Find Latest Batch (ÏµúÏã† Ï†ÄÏû•Î≥∏ Ï∞æÍ∏∞)
                    const cloudParts = rawCloudData.value.filter(p => (p.project || p.model || 'Unknown') === pName);

                    if (cloudParts.length === 0) {
                        alert("Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.");
                        return;
                    }

                    // Í∞ÄÏû• ÎÜíÏùÄ Ïà´ÏûêÏùò batchIdÎ•º Ï∞æÏùå (Find Max Batch ID)
                    const latestBatchId = cloudParts.reduce((max, p) => Math.max(max, p.batchId || 0), 0);
                    console.log(`[Cloud Load] Found ${cloudParts.length} total rows. Latest Batch ID: ${latestBatchId}`);

                    // Ìï¥Îãπ Batch IDÎ•º Í∞ÄÏßÑ Îç∞Ïù¥ÌÑ∞Îßå ÌïÑÌÑ∞ÎßÅ (Filter only latest batch)
                    let latestParts = cloudParts.filter(p => (p.batchId || 0) === latestBatchId);
                    console.log(`[Cloud Load] Rows in latest batch: ${latestParts.length}`);

                    // 4. Clean Data (Îç∞Ïù¥ÌÑ∞ Ï†ïÏ†ú)
                    // ÎßàÏª§ Ï†úÍ±∞ (Remove Empty Marker)
                    latestParts = latestParts.filter(p => !p.isMarker && p.moldCode !== 'EMPTY_PROJECT_MARKER');

                    // 5. Overwrite Local DB (Î°úÏª¨ DB ÎçÆÏñ¥Ïì∞Í∏∞)
                    projectParts.value = []; // MEMORY WIPE FIRST (ÌôîÎ©¥ Ï¶âÏãú ÎπÑÏö∞Í∏∞)
                    await db.parts.where('projectId').equals(targetProj.id).delete(); // Ïãπ ÎπÑÏö∞Í∏∞ (DB Wipe)

                    if (latestParts.length > 0) {
                        // DBÏóê Ï†ÄÏû•Ìï† ÌòïÌÉúÎ°ú Î≥ÄÌôò (Convert for DB)
                        const toAdd = latestParts.map(p => {
                            const { id, project, batchId, _syncId, ...rest } = p;
                            return { ...rest, projectId: targetProj.id };
                        });
                        await db.parts.bulkAdd(toAdd); // ÏÉà Îç∞Ïù¥ÌÑ∞ ÎÑ£Í∏∞ (Insert)
                    }

                    projectParts.value = await db.parts.where('projectId').equals(targetProj.id).toArray();

                    alert(`'${pName}' ÌîÑÎ°úÏ†ùÌä∏ Î°úÎìú ÏôÑÎ£å.\n(Loaded. Current Mode: Simple Overwrite)`);
                    showCloudModal.value = false;
                };

                const deleteCloudProject = async (pName) => {
                    if (!confirm(`Ï†ïÎßêÎ°ú ÌÅ¥ÎùºÏö∞Îìú ÌîÑÎ°úÏ†ùÌä∏ '${pName}'ÏùÑ ÏòÅÍµ¨ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?\n(Permanently delete cloud project '${pName}'?)`)) return;

                    isSyncing.value = true;
                    try {
                        // Îπà Î¶¨Ïä§Ìä∏Î•º Ï†ÄÏû•ÌïòÎ©¥ Ìï¥Îãπ ÌîÑÎ°úÏ†ùÌä∏ Îç∞Ïù¥ÌÑ∞Í∞Ä ÏÇ≠Ï†úÎê® (Sending empty parts deletes the project in GAS)
                        const r = await fetch(CLOUD_URL, {
                            method: 'POST',
                            body: JSON.stringify({ action: 'save', project: pName, parts: [] })
                        });
                        const res = await r.json();
                        if (res.result === 'error') throw new Error(res.message);

                        alert(`'${pName}' ÏÇ≠Ï†ú ÏôÑÎ£å. (Deleted)`);
                        await syncFromCloud(); // Refresh list
                    } catch (e) {
                        alert("Ïò§Î•òÎ∞úÏÉù (Error): " + e);
                        isSyncing.value = false;
                    }
                };

                // --- Backup/Restore & Utils (Î∞±ÏóÖ/Î≥µÏõê Î∞è Í∏∞ÌÉÄ) ---
                const downloadJsonBackup = () => {
                    // Ï†ÑÏ≤¥ Îç∞Ïù¥ÌÑ∞Î•º Î∞±ÏóÖ ÎåÄÏÉÅÏúºÎ°ú ÏÑ†Ï†ï
                    db.transaction('r', db.projects, db.parts, async () => {
                        const allProjects = await db.projects.toArray();
                        const allParts = await db.parts.toArray();
                        const data = { projects: allProjects, parts: allParts };

                        const blob = new Blob([JSON.stringify(data)], { type: "application/json" });
                        const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
                        a.download = `MoldBackup_${new Date().toISOString().slice(0, 10)}.json`; a.click();
                    }).catch(e => alert("Backup Failed: " + e));
                };

                const uploadJsonRestore = (e) => {
                    const f = e.target.files[0]; if (!f) return;
                    const r = new FileReader();
                    r.onload = async (ev) => {
                        try {
                            const d = JSON.parse(ev.target.result);
                            if (confirm("ÌòÑÏû¨ Î™®Îì† Îç∞Ïù¥ÌÑ∞Î•º ÏßÄÏö∞Í≥† Î≥µÏõêÌïòÏãúÍ≤†ÏäµÎãàÍπå? (WIPE all current data?)")) {
                                await db.projects.clear(); await db.parts.clear();

                                if (d.projects) await db.projects.bulkAdd(d.projects);

                                // Parts Î≥µÏõê ÏãúÏóêÎèÑ Ï§ëÎ≥µ Ï†úÍ±∞ Î°úÏßÅ Ï†ÅÏö© Í∂åÏû• (Îç∞Ïù¥ÌÑ∞ Î¨¥Í≤∞ÏÑ± ÏúÑÌï¥)
                                if (d.parts) {
                                    const cleanParts = deduplicateParts(d.parts);
                                    await db.parts.bulkAdd(cleanParts);
                                }

                                location.reload();
                            }
                        } catch (er) { alert("Ïú†Ìö®ÌïòÏßÄ ÏïäÏùÄ ÌååÏùºÏûÖÎãàÎã§ (Invalid File)"); }
                    }; r.readAsText(f);
                };

                // Ï†ÑÏ≤¥ Îç∞Ïù¥ÌÑ∞ Ï¥àÍ∏∞Ìôî (Clear All Data for Testing/Cleanup)
                const clearAllData = async () => {
                    if (confirm("Ï†ïÎßêÎ°ú Î™®Îì† ÌîÑÎ°úÏ†ùÌä∏ÏôÄ Îç∞Ïù¥ÌÑ∞Î•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?\nÏù¥ ÏûëÏóÖÏùÄ ÎêòÎèåÎ¶¥ Ïàò ÏóÜÏäµÎãàÎã§!\n(Delete ALL data? Irreversible!)")) {
                        await db.projects.clear();
                        await db.parts.clear();
                        localStorage.clear(); // Clear all local storage as requested
                        window.location.reload();
                    }
                };

                // --- Dashboard & Utils ---
                const toggleLowStock = () => { filterLowStock.value = !filterLowStock.value; };
                const printLabel = () => { document.body.classList.add('print-label'); window.print(); document.body.classList.remove('print-label'); };


                const applySnapshotFromModal = () => {
                    if (!confirm("Set CURRENT STOCK as Last Record?")) return;
                    editingPart.lastRecord = {
                        qty: Number(editingPart.stock),
                        date: new Date().toISOString().slice(0, 10)
                    };
                    alert("Snapshot Set! Click 'Save' to persist.");
                };

                const applyStockSnapshot = async () => {
                    if (!confirm("Apply Current Stock as Last Record for visible items? \n(This will close the stock as of today)")) return;

                    const today = new Date().toISOString().slice(0, 10);
                    const itemsToUpdate = reportFilteredData.value;

                    for (const row of itemsToUpdate) {
                        const p = projectParts.value.find(x => x.id === row.id);
                        if (p) {
                            p.lastRecord = {
                                qty: row.currentStock,
                                date: today
                            };
                            await db.parts.put(JSON.parse(JSON.stringify(p)));
                        }
                    }
                    alert("Snapshot Applied!");
                    generateReport();
                };

                return {
                    projects, currentProject, projectParts, searchQuery, filterLowStock,
                    showPartModal, showDataModal, isSyncing, isImageProcessing,
                    showCloudModal, cloudProjectsList, editingPart, uniqueModels, uniqueMolds,
                    filteredParts, stats, zoomedImage, columns, visibleColumns, showColMenu, sortKey, sortOrder,
                    monthStats, newTx, showReportModal, reportYear, reportData,
                    reportSearch, reportType, reportSortKey, reportSortOrder, reportFilteredData, sortReport,
                    reportSelectedParts, showSelectedOnly, toggleReportSelection, toggleSelectAllReport, reportStockFilter,
                    createProject, selectProject, deleteProject,
                    openAddModal, editPart, savePart, deletePart, adjustStock, handleImageUpload, setModalImage,
                    syncToCloud, syncFromCloud, loadSelectedCloudProject, deleteCloudProject,
                    downloadJsonBackup, uploadJsonRestore, clearAllData,
                    addManualTx, openReport, printReportModal, captureReportModal, editPartFromReport,
                    toggleLowStock, printLabel, sortTable, applyStockSnapshot, applySnapshotFromModal,
                    showQR, printQR,
                    showQRModal, qrTargetName, qrTargetCode,
                };
            }
        }).mount('#app');

        // Sidebar Toggle
        window.toggleSidebar = function () {
            document.body.classList.toggle('sidebar-collapsed');
            const btn = document.getElementById('btn-toggle-sidebar');
            if (document.body.classList.contains('sidebar-collapsed')) {
                btn.innerText = "‚ñ∂";
            } else {
                btn.innerText = "‚óÄ";
            }
            setTimeout(() => window.dispatchEvent(new Event('resize')), 300);
        };
    </script>
</body>

</html>