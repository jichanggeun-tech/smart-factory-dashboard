<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <title>Í∏àÌòï Loss</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <style>
        /* [Í≥µÌÜµ] Î†àÏù¥ÏïÑÏõÉ ÏÑ§Ï†ï */
        :root {
            --bg-body: #111827;
            --bg-nav: #1f2937;
            --bg-card: #2d3748;
            --bg-input: #374151;
            --text-main: #f9fafb;
            --text-muted: #9ca3af;
            --accent: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --blue: #3b82f6;
            --border: #4b5563;
        }

        /* [Í≥µÌÜµ] Î†àÏù¥ÏïÑÏõÉ ÏÑ§Ï†ï */
        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-body);
            display: flex;
            height: 100vh;
            font-family: 'Malgun Gothic', 'Segoe UI', sans-serif;
            color: var(--text-main);
            overflow: hidden;
        }

        /* [Ï¢åÏ∏°] ÏûÖÎ†• Ìå®ÎÑê */
        /* [Ï¢åÏ∏°] ÏûÖÎ†• Ìå®ÎÑê */
        .input-panel {
            width: 650px;
            min-width: 400px;
            max-width: 900px;
            background: var(--bg-nav);
            color: var(--text-main);
            padding: 20px;
            overflow-y: auto;
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            gap: 15px;
            z-index: 10;
        }

        .input-panel h2 {
            border-bottom: 2px solid var(--border);
            padding-bottom: 10px;
            font-size: 1.4rem;
            color: var(--blue);
            margin-top: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }



        .form-section {
            background: var(--bg-card);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        .form-section h3 {
            margin: 0 0 10px 0;
            font-size: 1rem;
            color: #17a2b8;
            border-bottom: 1px solid #6c757d;
            padding-bottom: 5px;
        }

        label {
            display: block;
            margin-bottom: 3px;
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        input,
        textarea,
        select {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--bg-input);
            color: var(--text-main);
            margin-bottom: 8px;
            font-size: 0.9rem;
            box-sizing: border-box;
        }

        input:focus,
        textarea:focus,
        select:focus {
            outline: 2px solid var(--blue);
            border-color: transparent;
        }

        /* Îß§Ìä∏Î¶≠Ïä§ & ÌÖåÏù¥Î∏î */
        .matrix-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 5px;
        }

        .matrix-table th {
            background: #495057;
            color: #ffc107;
            font-size: 0.75rem;
            padding: 4px;
            text-align: center;
            border: 1px solid #6c757d;
        }

        .matrix-table td {
            padding: 2px;
            border: 1px solid #6c757d;
        }

        .matrix-table input {
            width: 100%;
            margin: 0;
            text-align: center;
            font-size: 0.85rem;
            font-weight: bold;
            padding: 4px 0;
            border: none;
        }

        .matrix-machine {
            font-size: 0.8rem;
            font-weight: bold;
            color: #eee;
            padding-left: 5px;
            background: #212529;
        }

        .matrix-sum {
            font-size: 0.8rem;
            color: #0d6efd;
            text-align: center;
            font-weight: bold;
            background: #212529;
        }

        .file-upload-btn {
            display: inline-block;
            background: #6c757d;
            color: white;
            padding: 8px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            text-align: center;
            width: 100%;
            font-weight: bold;
            border: 1px solid #999;
        }

        input[type="file"] {
            display: none;
        }

        /* Î≤ÑÌäº Ïä§ÌÉÄÏùº */
        .btn-add {
            background: #17a2b8;
            border: none;
            padding: 8px;
            color: white;
            width: 100%;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 5px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .btn-action-group {
            display: flex;
            gap: 5px;
            margin-left: auto;
        }

        .btn-sm {
            padding: 2px 6px;
            font-size: 0.7rem;
            border-radius: 3px;
            cursor: pointer;
            border: 1px solid #4b5563;
            background: #374151;
            /* Unified Dark Blue-Grey */
            color: white;
        }

        .btn-sm:hover {
            background: #4b5563;
        }

        .btn-del {
            background: #dc3545;
        }

        .btn-copy {
            background: #6f42c1;
        }

        .drag-handle {
            cursor: grab;
            color: #adb5bd;
            font-size: 1.2rem;
            margin-right: 10px;
            display: flex;
            align-items: center;
        }

        .input-item {
            transition: transform 0.2s, background 0.2s;
            background: #2c3034;
            padding: 8px;
            border-radius: 4px;
            margin-bottom: 5px;
            border: 1px solid #444;
        }

        .sortable-ghost {
            opacity: 0.5;
            background: #495057 !important;
        }

        .btn-group {
            display: flex;
            gap: 5px;
            margin-top: 5px;
            flex-wrap: wrap;
        }

        .btn-print {
            flex: 1;
            background: #374151;
            border: 1px solid #4b5563;
            height: 50px;
            font-size: 1.1rem;
            color: #f9fafb;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: 0.2s;
        }

        .btn-print:hover {
            background: #4b5563;
        }

        .btn-capture {
            flex: 1;
            background: #374151;
            border: 1px solid #4b5563;
            height: 50px;
            font-size: 1.1rem;
            color: #f9fafb;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: 0.2s;
        }

        .btn-capture:hover {
            background: #4b5563;
        }

        .btn-excel {
            flex: 1;
            background: #374151;
            border: 1px solid #4b5563;
            height: 50px;
            font-size: 1.1rem;
            color: #f9fafb;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            transition: 0.2s;
        }

        .btn-excel:hover {
            background: #4b5563;
        }

        .btn-save {
            flex: 1;
            background: #374151;
            border: 1px solid #4b5563;
            height: 40px;
            font-size: 0.9rem;
            color: #f9fafb;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: 0.2s;
        }

        .btn-save:hover {
            background: #4b5563;
        }

        .btn-load {
            flex: 1;
            background: #374151;
            border: 1px solid #4b5563;
            height: 40px;
            font-size: 0.9rem;
            color: #f9fafb;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: 0.2s;
        }

        .btn-load:hover {
            background: #4b5563;
        }

        .btn-reset {
            flex: 1;
            background: #374151;
            border: 1px solid #4b5563;
            height: 40px;
            font-size: 0.9rem;
            color: #f9fafb;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: 0.2s;
        }

        .btn-reset:hover {
            background: #4b5563;
        }

        /* Cloud Buttons */
        .btn-cloud-save {
            flex: 1;
            background: #374151;
            border: 1px solid #4b5563;
            height: 40px;
            font-size: 0.9rem;
            color: #f9fafb;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            transition: 0.2s;
        }

        .btn-cloud-save:hover {
            background: #4b5563;
        }

        .btn-cloud-load {
            flex: 1;
            background: #374151;
            border: 1px solid #4b5563;
            height: 40px;
            font-size: 0.9rem;
            color: #f9fafb;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            transition: 0.2s;
        }

        .btn-cloud-load:hover {
            background: #4b5563;
        }


        /* Cloud List Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: #212529;
            color: white;
            padding: 20px;
            border-radius: 10px;
            width: 400px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            border: 1px solid #444;
        }

        .cloud-list {
            list-style: none;
            padding: 0;
            margin: 0;
            overflow-y: auto;
            flex: 1;
        }

        .cloud-item {
            padding: 12px;
            border-bottom: 1px solid #444;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: #e0e0e0;
        }

        .cloud-item:hover {
            background: #343a40;
        }

        .cloud-item:last-child {
            border-bottom: none;
        }

        .cloud-week {
            font-weight: bold;
            color: #0dcaf0;
            /* Changed from #ffc107 */
            font-size: 1.1rem;
        }

        .cloud-date {
            font-size: 0.8rem;
            color: #adb5bd;
            /* Changed from #ccc */
        }

        /* Preview Panel */
        .preview-panel {
            flex: 1;
            padding: 40px;
            overflow-y: auto;
            background: #e9ecef;
            color: #333;
            /* Explicitly set text color for white background */
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }

        .report-container {
            width: 297mm;
            min-height: 210mm;
            background: white;
            color: #333;
            /* Explicitly set text color for white background */
            margin: 0 auto;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
            box-sizing: border-box;
            padding: 20px;
            padding-bottom: 50px;
        }

        .header-box {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            border-bottom: 3px double #333;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        .header-logo img {
            max-width: 200px;
            max-height: 90px;
        }

        .header-title-area {
            text-align: center;
            flex: 1;
        }

        .header-title h1 {
            font-size: 24px;
            margin: 0;
            font-weight: 900;
        }

        .header-info {
            text-align: right;
            font-size: 11px;
            line-height: 1.5;
            color: #555;
            width: 220px;
        }

        .section-title {
            font-size: 14px;
            font-weight: bold;
            margin-top: 25px;
            margin-bottom: 8px;
            border-left: 6px solid #333;
            padding-left: 10px;
            background: #f8f9fa;
            padding: 4px 10px;
            color: #333;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 10px;
            margin-bottom: 10px;
            table-layout: fixed;
        }

        th,
        td {
            border: 1px solid #ccc;
            padding: 5px;
            text-align: center;
            vertical-align: middle;
            word-wrap: break-word;
        }

        th {
            background: #e5e7eb;
            /* Light Grey for print */
            color: #111827;
            /* Dark text */
            font-weight: bold;
            border-top: 2px solid #333;
        }

        .text-left {
            text-align: left;
        }

        /* KPI */
        .kpi-container {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-bottom: 15px;
        }

        .kpi-card {
            background: #fff;
            border: 1px solid #e0e0e0;
            border-left-width: 5px;
            padding: 10px 15px;
            border-radius: 6px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-height: 70px;
        }

        .kpi-card h4 {
            margin: 0 0 5px 0;
            font-size: 10px;
            color: #888;
            text-transform: uppercase;
            font-weight: 600;
        }

        .kpi-card .value {
            font-size: 22px;
            font-weight: 800;
            color: #333;
        }

        .kpi-card .unit {
            font-size: 12px;
            color: #374151;
            /* Dark text */
            font-weight: normal;
            margin-left: 2px;
        }

        .kpi-sub {
            font-size: 9px;
            color: #4b5563;
            /* Dark text */
            margin-top: 4px;
        }

        .kpi-blue {
            border-left-color: #0d6efd;
        }

        .kpi-blue .value {
            color: #374151;
        }

        .kpi-red {
            border-left-color: #dc3545;
        }

        .kpi-red .value {
            color: #374151;
        }

        .kpi-green {
            border-left-color: #198754;
        }

        .kpi-green .value {
            color: #374151;
        }

        .kpi-gray {
            border-left-color: #6c757d;
        }

        .kpi-gray .value {
            color: #374151;
        }

        .kpi-info {
            border-left-color: #0dcaf0;
        }

        .kpi-info .value {
            color: #374151;
        }

        .pie-chart-container {
            display: flex;
            width: 100%;
            height: 100%;
            align-items: center;
        }

        .pie-chart-svg {
            width: 150px;
            height: 150px;
            flex-shrink: 0;
        }

        .pie-legend {
            flex: 1;
            padding-left: 15px;
            font-size: 10px;
            overflow-y: auto;
            max-height: 150px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 4px;
        }

        .legend-color {
            width: 10px;
            height: 10px;
            margin-right: 5px;
            border-radius: 2px;
        }

        /* [ÏàòÏ†ïÎê®] ÏÇ¨ÏßÑ Í∑∏Î¶¨Îìú */
        .photo-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }

        /* 6. PM/Ï†ïÎπÑÏö©: ÌïúÏ§ÑÏóê 3Í∞ú (33%) */
        .pm-item {
            width: calc(33.33% - 10px);
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 5px;
            background: #f8f9fa;
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
        }

        .pm-item .photo-img-box {
            width: 100%;
            height: 140px;
            /* ÎÜíÏù¥ Ï†ÅÎãπÌûà */
            background: #fff;
            border: 1px solid #ccc;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            margin-bottom: 4px;
        }

        .pm-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* 5. Í∞úÏÑ†ÌôúÎèôÏö©: ÌïúÏ§ÑÏóê 2Í∞ú (50%), Í∞ïÏ°∞ */
        .improv-item {
            width: calc(50% - 10px);
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 8px;
            background: #fff;
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .improv-item .ba-container {
            display: flex;
            gap: 5px;
            width: 100%;
            height: 220px;
            /* ÎÜíÏù¥ ÌÅ¨Í≤å */
            margin-bottom: 6px;
        }

        .improv-item .ba-box {
            flex: 1;
            border: 1px solid #ccc;
            background: #f9f9f9;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        .improv-item .ba-label {
            position: absolute;
            top: 0;
            left: 0;
            font-size: 9px;
            background: #374151;
            /* Unified Dark Blue-Grey */
            color: white;
            text-align: center;
            padding: 2px 0;
            font-weight: bold;
            flex-shrink: 0;
        }

        .improv-item .ba-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .photo-desc {
            font-size: 11px;
            padding: 4px;
            background: #fff;
            border: 1px solid #eee;
            font-weight: bold;
            word-break: break-all;
        }

        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(33, 37, 41, 0.95);
            color: white;
            padding: 12px 25px;
            border-radius: 30px;
            font-size: 0.9rem;
            z-index: 9999;
            display: none;
            font-weight: bold;
            border: 1px solid #0d6efd;
        }

        @media print {

            .input-panel,
            .resizer,
            .modal-overlay,
            .btn-toggle-sidebar {
                display: none;
            }

            .preview-panel {
                padding: 0;
                background: white;
            }

            .report-container {
                max-width: 100%;
                width: 100%;
                margin: 0;
                padding: 0;
                box-shadow: none;
                border: none;
            }

            body {
                height: auto;
                overflow: visible;
                background: white;
            }

            @page {
                size: landscape;
                margin: 0;
            }
        }

        /* Sidebar Controls (Home + Toggle wrapper) */
        /* Sidebar Controls (Home + Toggle wrapper) */
        .sidebar-controls {
            display: flex;
            align-items: center;
            position: fixed;
            top: 15px;
            left: 15px !important;
            z-index: 1001;
            transition: none;
        }

        .home-btn {
            background: #334155;
            color: #e2e8f0;
            border: 1px solid #475569;
            border-radius: 20px 0 0 20px;
            width: 70px;
            height: 36px;
            text-decoration: none;
            font-size: 12px;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            padding: 0;
            box-sizing: border-box;
        }

        .home-btn:hover {
            background: #4285F4;
            color: #fff;
        }

        .btn-toggle-sidebar {
            width: 70px;
            height: 36px;
            background: #1e293b;
            border: 1px solid #334155;
            border-left: none;
            border-radius: 0 20px 20px 0;
            color: #94a3b8;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            padding: 0;
            box-sizing: border-box;
        }

        .btn-toggle-sidebar:hover {
            color: white;
            background: #334155;
        }

        body.full-screen .input-panel {
            display: none !important;
        }

        body.full-screen .resizer {
            display: none !important;
        }

        body.full-screen .sidebar-controls {
            left: 15px !important;
        }
    </style>
</head>

<body>

    <div id="cloud-modal" class="modal-overlay">
        <div class="modal-content">
            <div
                style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; border-bottom:1px solid #555; padding-bottom:10px;">
                <h3 style="margin:0; color:#0dcaf0;">‚òÅÔ∏è ÌÅ¥ÎùºÏö∞Îìú Ï†ÄÏû• Î™©Î°ù</h3>
                <button onclick="document.getElementById('cloud-modal').style.display='none'"
                    style="background:none; border:none; color:white; font-size:20px; cursor:pointer;">&times;</button>
            </div>
            <ul id="cloud-list-ul" class="cloud-list"></ul>
            <div style="text-align:center; margin-top:10px; color:#aaa; font-size:0.8rem;">ÏÑ†ÌÉùÌïòÎ©¥ Îç∞Ïù¥ÌÑ∞Í∞Ä ÎçÆÏñ¥ÏîåÏõåÏßëÎãàÎã§.</div>
        </div>
    </div>

    <datalist id="common-reasons"></datalist>

    <div id="toast" class="toast">‚úîÔ∏è ÏïåÎ¶º</div>

    <div class="input-panel" id="inputPanel">

        <h2>
            <i class="fa-solid fa-wrench"></i> Í∏àÌòï Loss
        </h2>
        <div style="display:flex; gap:5px; margin-bottom:10px;">
            <button class="btn-print" onclick="window.print()" style="flex:1;">PDF Î≥ÄÌôò (PDF)</button>
            <button class="btn-capture" onclick="captureImage()" style="flex:1;">Ïä§ÌÅ¨Î¶∞ÏÉ∑ (Captura)</button>
        </div>

        <div class="form-section" style="border-color:#fd7e14;">
            <h3 style="color:#fd7e14; border-color:#fd7e14;">‚òÅÔ∏è ÌÅ¥ÎùºÏö∞Îìú Ï†ÄÏû•/Î°úÎìú</h3>
            <div style="display:flex; gap:5px; margin-bottom:5px;">
                <button class="btn-cloud-save" onclick="saveToCloud()">üì§ Ï£ºÏ∞®Î≥Ñ Ï†ÄÏû• (Save)</button>
                <button class="btn-cloud-load" onclick="openCloudModal()">üì• Î™©Î°ùÏóêÏÑú Î∂àÎü¨Ïò§Í∏∞ (Load)</button>
            </div>


            <div class="btn-group" style="margin-top:10px;">
                <button class="btn-save" onclick="manualSaveFile()">üíæ Î°úÏª¨ Ï†ÄÏû• (JSON)</button>
                <label class="btn-load"
                    style="text-align:center; padding-top:10px; box-sizing:border-box; display:block;">
                    üìÇ ÌååÏùº Ïó¥Í∏∞ (Open)
                    <input type="file" accept=".json" onchange="loadFile(this)">
                </label>
                <button class="btn-reset" onclick="resetData()">‚Üª ÏÉàÎ°ú ÏûëÏÑ±</button>
            </div>
        </div>

        <div class="form-section">
            <h3>1. Í∏∞Î≥∏ Ï†ïÎ≥¥ & Í∏∞Í∞Ñ</h3>
            <div
                style="background:#495057; padding:10px; border-radius:4px; margin-bottom:10px; border:1px solid #6c757d;">
                <label style="color:#ffc107; font-weight:bold;">üè¢ Î°úÍ≥† ÏÑ§Ï†ï</label>
                <label class="file-upload-btn">üìÅ ÌååÏùº ÏÑ†ÌÉù<input type="file" accept="image/*"
                        onchange="handleLogoUpload(this)"></label>
            </div>
            <div style="display:flex; gap:10px;">
                <div style="flex:1;"><label>ÏãúÏûëÏùº</label><input type="date" id="in-start-date"
                        onchange="renderReport(); autoSave();"></div>
                <div style="flex:1;"><label>Ï¢ÖÎ£åÏùº</label><input type="date" id="in-end-date"
                        onchange="renderReport(); autoSave();"></div>
            </div>
            <label>ÏûëÏÑ±Ïûê</label> <input type="text" id="in-writer" value="Manager" onkeyup="renderReport(); autoSave();">
        </div>

        <div class="form-section">
            <h3>2. ÏöîÏùºÎ≥Ñ Í∞ÄÎèô Í≥ÑÌöç</h3>
            <div
                style="background:#2b3035; padding:8px; border-radius:4px; margin-bottom:10px; border:1px solid #6c757d; display:flex; gap:5px; align-items:center; flex-wrap:wrap;">
                <span style="font-size:11px; color:#ffc107;">‚ö° ÏùºÍ¥Ñ:</span>
                <span style="font-size:10px;">ÌèâÏùº</span><input type="number" id="batch-week" value="24"
                    style="width:40px; margin:0; height:20px; font-size:11px;">
                <span style="font-size:10px;">ÌÜ†</span><input type="number" id="batch-sat" value="0"
                    style="width:40px; margin:0; height:20px; font-size:11px;">
                <button class="btn-add" style="margin-top:0; width:auto; padding:2px 8px;"
                    onclick="applyBatchMatrix()">Ï†ÅÏö©</button>
            </div>
            <div id="matrix-container">
                <table class="matrix-table">
                    <thead>
                        <tr>
                            <th style="width:25%">ÏÑ§ÎπÑ (Mq)</th>
                            <th>Ïõî</th>
                            <th>Ìôî</th>
                            <th>Ïàò</th>
                            <th>Î™©</th>
                            <th>Í∏à</th>
                            <th style="color:#dc3545">ÌÜ†</th>
                            <th>Ìï©</th>
                        </tr>
                    </thead>
                    <tbody id="matrix-body"></tbody>
                </table>
            </div>
            <div style="text-align:right; margin-top:8px; font-size:11px; color:#fff;">Total Net Time: <span
                    id="input-total-net" style="font-weight:bold; color:#0d6efd; font-size:14px;">0</span> min</div>
            <label style="margin-top:15px;">ÏßÄÎÇúÏ£º Ï¥ù Loss</label><input type="number" id="in-last-loss" placeholder="min"
                onkeyup="renderReport(); autoSave();">
        </div>

        <div class="form-section">
            <h3>3. Loss ÏÉÅÏÑ∏ Í∏∞Î°ù (Detalles de P√©rdida)</h3>
            <div id="loss-inputs"></div>
            <button class="btn-add" onclick="addLossRow(); autoSave();">+ Loss Ï∂îÍ∞Ä (Agregar P√©rdida)</button>
        </div>

        <div class="form-section">
            <h3>4. PM ÎÇ¥Ïó≠ (Historial de PM)</h3>
            <div id="pm-inputs"></div>
            <button class="btn-add" onclick="addPmRow(); autoSave();">+ PM Ï∂îÍ∞Ä (Agregar PM)</button>
        </div>

        <div class="form-section">
            <h3 style="color:#17a2b8; border-color:#17a2b8;">5. Í∞úÏÑ† ÌôúÎèô (Mejora Continua)</h3>
            <div id="improv-inputs"></div>
            <button class="btn-add" style="background:#17a2b8;" onclick="addActivityRow('improv'); autoSave();">+ Í∞úÏÑ† ÌôúÎèô
                Ï∂îÍ∞Ä (Agregar Mejora)</button>
        </div>
    </div>

    <div class="sidebar-controls">
        <a class="home-btn" href="index.html">üè† Home</a>
        <button id="btn-toggle-sidebar" class="btn-toggle-sidebar" onclick="toggleSidebar()">‚óÄ</button>
    </div>





    <div class="preview-panel">

        <div class="report-container" id="capture-target">
            <div class="header-box">
                <div class="header-logo" id="out-logo-container">
                    <div class="header-logo-placeholder">Logo Area</div>
                </div>
                <div class="header-title-area">
                    <h1 id="out-title">2026ÎÖÑ OOÏ£ºÏ∞® Í∏àÌòïÌåÄ Loss Î∂ÑÏÑù</h1>
                    <p>Weekly Loss Analysis / An√°lisis Semanal de P√©rdidas</p>
                </div>
                <div class="header-info">
                    <strong>DEPT:</strong> <span id="out-dept-name">Í∏àÌòïÌåÄ (Equipo Molde)</span><br>
                    <strong>PERIOD:</strong> <span id="out-period-str" style="font-size:10px;">-</span><br>
                    <strong>WRITER:</strong> <span id="out-writer"></span>
                </div>
            </div>

            <div class="section-title">1. Ï£ºÍ∞Ñ KPI ÏöîÏïΩ</div>
            <div class="kpi-container">
                <div class="kpi-card kpi-blue">
                    <h4>Net Time</h4>
                    <div><span id="out-net-time" class="value">-</span><span class="unit">min</span></div>
                </div>
                <div class="kpi-card kpi-red">
                    <h4>Total Loss</h4>
                    <div><span id="out-total-loss" class="value">0</span><span class="unit">min</span></div>
                </div>
                <div class="kpi-card kpi-gray">
                    <h4>Tendencia</h4>
                    <div id="out-trend" style="margin-top:2px;">-</div>
                </div>
                <div class="kpi-card kpi-green">
                    <h4>Disponibilidad</h4>
                    <div><span id="out-avail-rate" class="value">100%</span></div>
                </div>
                <div class="kpi-card kpi-info" style="grid-column: span 2;">
                    <h4>MTTR</h4>
                    <div><span id="out-mttr" class="value">0</span><span class="unit">min</span></div>
                    <div class="kpi-sub">Total Loss / Í±¥Ïàò</div>
                </div>
                <div class="kpi-card kpi-green" style="grid-column: span 2;">
                    <h4>MTBF</h4>
                    <div><span id="out-mtbf" class="value">0</span><span class="unit">min</span></div>
                    <div class="kpi-sub">(Net - Loss) / Í±¥Ïàò</div>
                </div>
            </div>

            <div class="section-title">2. Loss Î∞úÏÉù ÏÉÅÏÑ∏ ÌòÑÌô©</div>
            <table>
                <colgroup>
                    <col width="5%">
                    <col width="12%">
                    <col width="18%">
                    <col width="15%">
                    <col width="13%">
                    <col width="7%">
                    <col width="30%">
                </colgroup>
                <thead>
                    <tr>
                        <th>No</th>
                        <th>Î∞úÏÉùÏùº</th>
                        <th id="th-machine">Î™®Îç∏</th>
                        <th id="th-detail">ÏÉÅÏÑ∏</th>
                        <th>ÏãúÍ∞Ñ</th>
                        <th>Min</th>
                        <th>ÏõêÏù∏ Î∞è ÎåÄÏ±Ö</th>
                    </tr>
                </thead>
                <tbody id="out-loss-body"></tbody>
                <tfoot>
                    <tr style="background:#eee; font-weight:bold; color:black;">
                        <td colspan="5">Total Loss Time</td>
                        <td id="out-loss-sum">-</td>
                        <td></td>
                    </tr>
                </tfoot>
            </table>

            <div style="display:flex; gap:20px;">
                <div style="flex:1;">
                    <div class="section-title" style="margin-top:10px;">3. Ìï≠Î™©Î≥Ñ Loss ÎπÑÏ§ë</div>
                    <div id="out-chart-area"
                        style="padding:10px; border:1px solid #ccc; border-radius:4px; height:150px;"></div>
                </div>
                <div style="flex:1.2;">
                    <div class="section-title" style="margin-top:10px;">4. Top 5 Í∞úÏÑ† ÎåÄÏ±Ö</div>
                    <table>
                        <colgroup>
                            <col width="8%">
                            <col width="42%">
                            <col width="10%">
                            <col width="40%">
                        </colgroup>
                        <thead>
                            <tr>
                                <th>No</th>
                                <th>Ìï≠Î™©</th>
                                <th>Loss</th>
                                <th>ÎåÄÏ±Ö</th>
                            </tr>
                        </thead>
                        <tbody id="out-top5-body"></tbody>
                    </table>
                </div>
            </div>

            <div class="section-title">5. PM ÌôúÎèô ÎÇ¥Ïó≠ (Historial de Actividades de PM)</div>
            <table>
                <colgroup>
                    <col width="6%">
                    <col width="12%">
                    <col width="15%">
                    <col width="10%">
                    <col width="15%">
                    <col width="42%">
                </colgroup>
                <thead>
                    <tr>
                        <th>No</th>
                        <th>ÏùºÏûê (Fecha)</th>
                        <th>Î™®Îç∏ (Modelo)</th>
                        <th>OP</th>
                        <th>Code (C√≥digo)</th>
                        <th>ÌôúÎèô ÎÇ¥Ïó≠ (Detalles de Actividad)</th>
                    </tr>
                </thead>
                <tbody id="out-pm-body"></tbody>
            </table>

            <div class="section-title">6. Í∞úÏÑ† ÌôúÎèô (Mejora Continua)</div>
            <div id="out-improv-area" class="photo-grid"></div>

            <div style="margin-top: 15px; font-size:11px; color:#666; text-align:right;">* Ïàú Î∂ÄÌïò ÏãúÍ∞Ñ (Net Time) = (Plan
                Diario Total) √ó 60min | K = 1,000 unit</div>
        </div>
    </div>

    <script>
        // ==========================================
        // [Ï§ëÏöî] Î™®Î∞îÏùºÍ≥º ÎèôÏùºÌïú Íµ¨Í∏Ä Ïï±Ïä§ Ïä§ÌÅ¨Î¶ΩÌä∏ URL
        // [Ï§ëÏöî] Ïó¨Í∏∞Ïóê Î∞∞Ìè¨Ìïú Íµ¨Í∏Ä Ïõπ Ïï± URLÏùÑ ÎÑ£ÏúºÏÑ∏Ïöî!
        const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwA_Ipn6krZ1zJY2lQ_-zY9GYTp8tsqRqgBQvCcWNGOb1doXirfx5Z2FHnh2deav6Z9/exec";

        // ==========================================

        const inputPanel = document.getElementById('inputPanel');

        function toggleSidebar() {
            document.body.classList.toggle('full-screen');
            const btn = document.getElementById('btn-toggle-sidebar');

            if (document.body.classList.contains('full-screen')) {
                btn.innerText = "‚ñ∂";
                btn.title = "Show Sidebar";
            } else {
                btn.innerText = "‚óÄ";
                btn.title = "Hide Sidebar";
            }
        }

        let currentDept = 'MOLD';
        const equipMachines = [];
        const moldMachines = ["PRESS_A", "PRESS_B", "PRESS_C"];
        const moldModels = ["RF6500C LH", "RF6500C RH", "RF6500C FRE 3D", "RF6500H LH", "RF6500H RH", "RF6500H FRE", "RF8000BC BASIC", "RF8000BC HUB", "RT6300D (35)", "RS5300T", "RS5300C", "RT6300D(53)", "RT6300D(42)", "RT6300D(38)", "RF8000F LH"];
        const moldCavities = ["#1", "#2", "#3", "#4", "#5", "Í∏∞ÌÉÄ (Otros)"];

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg; t.style.display = 'block';
            setTimeout(() => t.style.display = 'none', 3000);
        }

        // --- Cloud Functions ---
        // --- Ïù¥ÎØ∏ÏßÄ ÏûêÎèô ÏïïÏ∂ï (ÌÅ¥ÎùºÏö∞Îìú Ï†ÄÏû• Ï†Ñ) ---
        function compressImageData(dataUrl, maxWidth, quality) {
            return new Promise((resolve) => {
                if (!dataUrl || dataUrl.length < 100) { resolve(dataUrl); return; }
                const img = new Image();
                img.onload = function () {
                    let w = img.width, h = img.height;
                    if (w > maxWidth) { h *= maxWidth / w; w = maxWidth; }
                    const canvas = document.createElement('canvas');
                    canvas.width = w; canvas.height = h;
                    canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                    resolve(canvas.toDataURL('image/jpeg', quality));
                };
                img.onerror = () => resolve(dataUrl);
                img.src = dataUrl;
            });
        }

        async function saveToCloud() {
            if (APPS_SCRIPT_URL.includes("Ïó¨Í∏∞Ïóê")) { alert("ÏΩîÎìúÎ•º Ïó¥Ïñ¥ URLÏùÑ ÏÑ§Ï†ïÌï¥Ï£ºÏÑ∏Ïöî!"); return; }
            const data = gatherData();
            if (!data.startDate) { alert("ÏãúÏûëÏùºÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî."); return; }

            const weekId = `${data.startDate.split('-')[0]}-W${getWeekNumber(data.startDate).toString().padStart(2, '0')}`;
            if (!confirm(`[${weekId}] Ï£ºÏ∞®Î°ú Îç∞Ïù¥ÌÑ∞Î•º Ï†ÄÏû•ÌïòÏãúÍ≤†ÏäµÎãàÍπå?\n(Ïù¥ÎØ∏ Ï°¥Ïû¨ÌïòÎäî Ï£ºÏ∞®ÎùºÎ©¥ ÎçÆÏñ¥ÏîÅÎãàÎã§)`)) return;

            const btn = document.querySelector('.btn-cloud-save');
            btn.innerText = "ÏÇ¨ÏßÑ ÏïïÏ∂ï Ï§ë..."; btn.disabled = true;

            try {
                // Ïù¥ÎØ∏ÏßÄ ÏûêÎèô ÏïïÏ∂ï (Î°úÍ≥†)
                if (data.logo && data.logo.length > 100) {
                    data.logo = await compressImageData(data.logo, 200, 0.6);
                }
                // Í∞úÏÑ†ÌôúÎèô Ïù¥ÎØ∏ÏßÄ ÏïïÏ∂ï
                if (data.improv && data.improv.length > 0) {
                    for (let item of data.improv) {
                        if (item.imgBefore && item.imgBefore.length > 100) {
                            item.imgBefore = await compressImageData(item.imgBefore, 600, 0.5);
                        }
                        if (item.imgAfter && item.imgAfter.length > 100) {
                            item.imgAfter = await compressImageData(item.imgAfter, 600, 0.5);
                        }
                    }
                }

                btn.innerText = "Ï†ÄÏû• Ï§ë...";
                const payload = { weekId: weekId, startDate: data.startDate, endDate: data.endDate, data: data };
                await fetch(APPS_SCRIPT_URL, { method: "POST", mode: "no-cors", headers: { "Content-Type": "text/plain" }, body: JSON.stringify(payload) });
                showToast(`‚òÅÔ∏è [${weekId}] Ï†ÄÏû• ÏôÑÎ£å!`);
            } catch (error) { alert("Ïò§Î•ò: " + error.message); } finally { btn.innerText = "üì§ Ï£ºÏ∞®Î≥Ñ Ï†ÄÏû• (Save)"; btn.disabled = false; }
        }

        async function openCloudModal() {
            if (APPS_SCRIPT_URL.includes("Ïó¨Í∏∞Ïóê")) { alert("ÏΩîÎìúÎ•º Ïó¥Ïñ¥ URLÏùÑ ÏÑ§Ï†ïÌï¥Ï£ºÏÑ∏Ïöî!"); return; }
            const modal = document.getElementById('cloud-modal');
            const listUl = document.getElementById('cloud-list-ul');
            const btn = document.querySelector('.btn-cloud-load');
            btn.innerText = "Î°úÎî© Ï§ë..."; btn.disabled = true;
            listUl.innerHTML = '<li class="cloud-item" style="justify-content:center;">Î°úÎî© Ï§ë...</li>';
            modal.style.display = 'flex';
            try {
                const fetchUrl = `${APPS_SCRIPT_URL}?cmd=list&t=${new Date().getTime()}`;
                const response = await fetch(fetchUrl);
                const result = await response.json();
                listUl.innerHTML = "";
                if (result.list && result.list.length > 0) {
                    result.list.forEach(item => {
                        const li = document.createElement('li');
                        li.className = 'cloud-item';
                        li.innerHTML = `<div><div class="cloud-week">${item.weekId}</div><div class="cloud-date">${item.period}</div></div><div style="font-size:0.8rem; color:#888;">${item.updated}</div>`;
                        li.onclick = () => loadSpecificWeek(item.weekId);
                        listUl.appendChild(li);
                    });
                } else { listUl.innerHTML = '<li class="cloud-item" style="justify-content:center;">Ï†ÄÏû•Îêú Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.</li>'; }
            } catch (e) {
                console.error('Î™©Î°ù Î°úÎìú ÏóêÎü¨:', e);
                listUl.innerHTML = `<li class="cloud-item" style="color:red; justify-content:center;">Î™©Î°ù Î°úÎìú Ïã§Ìå®<br><span style="font-size:10px;">${e.message}</span></li>`;
            } finally { btn.innerText = "üì• Î™©Î°ùÏóêÏÑú Î∂àÎü¨Ïò§Í∏∞ (Load)"; btn.disabled = false; }
        }

        async function loadSpecificWeek(weekId) {
            if (!confirm(`[${weekId}] Îç∞Ïù¥ÌÑ∞Î•º Î∂àÎü¨Ïò§ÏãúÍ≤†ÏäµÎãàÍπå?\nÌòÑÏû¨ ÏûëÏóÖ Ï§ëÏù∏ ÎÇ¥Ïö©ÏùÄ ÏÇ¨ÎùºÏßëÎãàÎã§.`)) return;
            document.getElementById('cloud-modal').style.display = 'none';

            try {
                const fetchUrl = `${APPS_SCRIPT_URL}?cmd=load&weekId=${weekId}&t=${new Date().getTime()}`;
                const response = await fetch(fetchUrl);
                const responseText = await response.text();

                let data;
                try { data = JSON.parse(responseText); } catch (pe) {
                    alert('ÏÑúÎ≤Ñ ÏùëÎãµ ÌååÏã± Ïã§Ìå®');
                    console.error('Raw:', responseText);
                    return;
                }

                if (data.error) { alert('ÏÑúÎ≤Ñ ÏóêÎü¨: ' + data.error); return; }
                if (data.data && !data.losses) { data = data.data; }

                loadFromJSON(JSON.stringify(data));
                showToast(`‚òÅÔ∏è [${weekId}] Î∂àÎü¨Ïò§Í∏∞ ÏôÑÎ£å!`);
            } catch (e) {
                console.error('Load error:', e);
                alert("Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®: " + e.message);
            }
        }
        // [ÏàòÏ†ï] Î™®Î∞îÏùº Îç∞Ïù¥ÌÑ∞ Ìï©ÏπòÍ∏∞ Ìï®Ïàò (Timezone Î¨∏Ï†ú Ìï¥Í≤∞ Ï†ÅÏö©)

        window.onload = function () {
            loadCustomReasons();
            initSortable();
            if (localStorage.getItem('loss_report_autosave')) {
                loadFromJSON(localStorage.getItem('loss_report_autosave'));
                showToast("ÏûêÎèô Ï†ÄÏû•Îêú ÎÇ¥Ïö©ÏùÑ Î∂àÎü¨ÏôîÏäµÎãàÎã§.");
            } else {
                const today = new Date();
                const startOfWeek = new Date(today);
                startOfWeek.setDate(today.getDate() - today.getDay() + 1);
                const endOfWeek = new Date(today);
                endOfWeek.setDate(startOfWeek.getDate() + 5);
                document.getElementById('in-start-date').valueAsDate = startOfWeek;
                document.getElementById('in-end-date').valueAsDate = endOfWeek;
                setDept('MOLD');
            }
        }

        function initSortable() {
            const containers = ['loss-inputs', 'pm-inputs', 'improv-inputs'];
            containers.forEach(id => {
                const el = document.getElementById(id);
                if (el) { new Sortable(el, { handle: '.drag-handle', animation: 150, ghostClass: 'sortable-ghost', onEnd: function () { renderReport(); autoSave(); } }); }
            });
        }

        function validateDate(dateInput) {
            if (!dateInput.value) return;
            const inputDate = new Date(dateInput.value);
            const startDate = new Date(document.getElementById('in-start-date').value);
            const endDate = new Date(document.getElementById('in-end-date').value);
            if (inputDate.getFullYear() < 2000) {
                const targetYear = startDate.getFullYear() || new Date().getFullYear();
                inputDate.setFullYear(targetYear);
                dateInput.value = inputDate.toISOString().split('T')[0];
                showToast(`‚ö†Ô∏è Ïó∞ÎèÑ Ïò§ÌÉÄ Î≥¥Ï†ï: ${targetYear}ÎÖÑ`);
            }
            if (inputDate < startDate || inputDate > endDate) {
                dateInput.style.backgroundColor = "#ffcccc";
                dateInput.style.color = "black";
            } else {
                dateInput.style.backgroundColor = "white";
                dateInput.style.color = "black";
            }
        }

        function updateReasonList(input) {
            const val = input.value.trim();
            if (!val) return;
            let stored = JSON.parse(localStorage.getItem('custom_reasons')) || [];
            if (!stored.includes(val)) {
                stored.push(val);
                localStorage.setItem('custom_reasons', JSON.stringify(stored));
                const dl = document.getElementById('common-reasons');
                const opt = document.createElement('option'); opt.value = val; dl.appendChild(opt);
            }
            renderReport(); autoSave();
        }

        function loadCustomReasons() {
            let stored = JSON.parse(localStorage.getItem('custom_reasons')) || [];
            const dl = document.getElementById('common-reasons');
            stored.forEach(r => {
                let exists = false;
                for (let i = 0; i < dl.options.length; i++) { if (dl.options[i].value === r) exists = true; }
                if (!exists) { const opt = document.createElement('option'); opt.value = r; dl.appendChild(opt); }
            });
        }

        function duplicateRow(btn) {
            const row = btn.closest('.input-item');
            const clone = row.cloneNode(true);
            const selects = row.querySelectorAll('select');
            const cloneSelects = clone.querySelectorAll('select');
            selects.forEach((s, i) => cloneSelects[i].value = s.value);
            const inputs = row.querySelectorAll('input');
            const cloneInputs = clone.querySelectorAll('input');
            inputs.forEach((inp, i) => cloneInputs[i].value = inp.value);
            row.parentNode.insertBefore(clone, row.nextSibling);
            renderReport(); autoSave();
            showToast("Ìñâ Î≥µÏ†úÎê®");
        }

        function compressImage(file, maxWidth, quality, callback) {
            const reader = new FileReader(); reader.readAsDataURL(file);
            reader.onload = function (event) {
                const img = new Image(); img.src = event.target.result;
                img.onload = function () {
                    let width = img.width; let height = img.height;
                    if (width > maxWidth) { height *= maxWidth / width; width = maxWidth; }
                    const canvas = document.createElement('canvas'); canvas.width = width; canvas.height = height;
                    const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, width, height);
                    const dataUrl = canvas.toDataURL('image/jpeg', quality); callback(dataUrl);
                }
            }
        }

        function gatherData() {
            const data = {
                dept: currentDept, startDate: document.getElementById('in-start-date').value, endDate: document.getElementById('in-end-date').value,
                writer: document.getElementById('in-writer').value, lastLoss: document.getElementById('in-last-loss').value,
                matrix: [], losses: [], pmHistory: [], improv: [], logo: localStorage.getItem('my_report_logo') || ""
            };
            document.querySelectorAll('#matrix-body tr').forEach(row => { const rowVals = []; row.querySelectorAll('.mat-inp').forEach(inp => rowVals.push(inp.value)); data.matrix.push(rowVals); });
            const lossRows = document.getElementById('loss-inputs').children;
            for (let row of lossRows) {
                data.losses.push({
                    date: row.querySelector('.l-date').value, machine: row.querySelector('.l-machine').value, sub: row.querySelector('.l-sub').value,
                    start: row.querySelector('.l-start').value, end: row.querySelector('.l-end').value,
                    reason: row.querySelector('.l-reason').value,
                    action: row.querySelector('.l-action').value
                });
            }
            const pmRows = document.getElementById('pm-inputs').children;
            for (let row of pmRows) {
                data.pmHistory.push({
                    date: row.querySelector('.p-date').value,
                    model: row.querySelector('.p-model').value,
                    op: row.querySelector('.p-op').value,
                    code: row.querySelector('.p-code').value,
                    desc: row.querySelector('.p-desc').value
                });
            }
            const improvRows = document.getElementById('improv-inputs').children;
            for (let row of improvRows) { data.improv.push({ desc: row.querySelector('.act-desc').value, imgBefore: row.querySelector('.hidden-img-before').src, imgAfter: row.querySelector('.hidden-img-after').src }); }
            return data;
        }

        function loadFromJSON(jsonString) {
            const tempAutoSave = window.autoSave;
            window.autoSave = function () { };
            try {
                const data = (typeof jsonString === 'string') ? JSON.parse(jsonString) : jsonString;
                setDept('MOLD');
                if (data.startDate) document.getElementById('in-start-date').value = data.startDate;
                if (data.endDate) document.getElementById('in-end-date').value = data.endDate;
                if (data.writer) document.getElementById('in-writer').value = data.writer;
                if (data.lastLoss) document.getElementById('in-last-loss').value = data.lastLoss;
                if (data.logo) {
                    document.getElementById('out-logo-container').innerHTML = `<img src="${data.logo}" alt="Logo">`;
                    try { localStorage.setItem('my_report_logo', data.logo); } catch (e) { }
                }
                const matrixRows = document.querySelectorAll('#matrix-body tr');
                if (data.matrix && Array.isArray(data.matrix)) {
                    matrixRows.forEach((row, idx) => {
                        if (data.matrix[idx]) {
                            const inputs = row.querySelectorAll('.mat-inp');
                            inputs.forEach((inp, i) => { if (data.matrix[idx][i] !== undefined) inp.value = data.matrix[idx][i]; });
                        }
                    });
                }
                document.getElementById('loss-inputs').innerHTML = "";
                if (data.losses && Array.isArray(data.losses)) {
                    data.losses.forEach(lossData => {
                        addLossRow();
                        const newRow = document.getElementById('loss-inputs').lastElementChild;
                        if (newRow) {
                            const dateInput = newRow.querySelector('.l-date');
                            dateInput.value = lossData.date || "";
                            validateDate(dateInput);
                            if (lossData.machine) newRow.querySelector('.l-machine').value = lossData.machine;
                            if (lossData.sub) newRow.querySelector('.l-sub').value = lossData.sub;
                            if (lossData.start) newRow.querySelector('.l-start').value = lossData.start;
                            if (lossData.end) newRow.querySelector('.l-end').value = lossData.end;
                            newRow.querySelector('.l-reason').value = lossData.reason || "";
                            newRow.querySelector('.l-action').value = lossData.action || "";
                            calcTimeDiff(newRow.querySelector('.l-start'));
                        }
                    });
                } else {
                    addLossRow();
                }
                document.getElementById('pm-inputs').innerHTML = "";
                if (data.pmHistory && Array.isArray(data.pmHistory)) {
                    data.pmHistory.forEach(d => {
                        addPmRow();
                        const row = document.getElementById('pm-inputs').lastElementChild;
                        if (row) {
                            row.querySelector('.p-date').value = d.date || "";
                            row.querySelector('.p-model').value = d.model || "";
                            if (d.op) row.querySelector('.p-op').value = d.op;
                            row.querySelector('.p-code').value = d.code || "";
                            row.querySelector('.p-desc').value = d.desc || "";
                        }
                    });
                }
                document.getElementById('improv-inputs').innerHTML = "";
                if (data.improv && Array.isArray(data.improv)) {
                    data.improv.forEach(d => {
                        addActivityRow('improv');
                        const row = document.getElementById('improv-inputs').lastElementChild;
                        if (row) {
                            row.querySelector('.act-desc').value = d.desc || "";
                            if (d.imgBefore) row.querySelector('.hidden-img-before').src = d.imgBefore;
                            if (d.imgAfter) row.querySelector('.hidden-img-after').src = d.imgAfter;
                        }
                    });
                }
                renderReport();
            } catch (err) { alert("Îç∞Ïù¥ÌÑ∞ Ïò§Î•ò: " + err.message); console.error(err); } finally { window.autoSave = tempAutoSave; }
        }

        function autoSave() { try { localStorage.setItem('loss_report_autosave', JSON.stringify(gatherData())); } catch (e) { console.error("AutoSave Fail"); } }
        function resetData() { if (confirm("Ï¥àÍ∏∞Ìôî?")) { localStorage.removeItem('loss_report_autosave'); location.reload(); } }
        function manualSaveFile() { const data = gatherData(); const weekNum = data.startDate ? getWeekNumber(data.startDate) : 'X'; const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(data)); const downloadAnchorNode = document.createElement('a'); downloadAnchorNode.setAttribute("href", dataStr); downloadAnchorNode.setAttribute("download", `Loss_Data_MOLD_${weekNum}W.json`); document.body.appendChild(downloadAnchorNode); downloadAnchorNode.click(); downloadAnchorNode.remove(); }
        function loadFile(input) { const file = input.files[0]; if (!file) return; const reader = new FileReader(); reader.onload = function (e) { loadFromJSON(e.target.result); }; reader.readAsText(file); input.value = ""; }
        function handleLogoUpload(input) { if (input.files && input.files[0]) { compressImage(input.files[0], 300, 0.8, function (dataUrl) { document.getElementById('out-logo-container').innerHTML = `<img src="${dataUrl}" alt="Logo">`; localStorage.setItem('my_report_logo', dataUrl); autoSave(); }); } }
        function handleImage(input, targetClass) { if (input.files && input.files[0]) { const row = input.closest('.input-item'); compressImage(input.files[0], 800, 0.7, function (dataUrl) { row.querySelector('.' + targetClass).src = dataUrl; renderReport(); autoSave(); }); } }

        function captureImage() { const target = document.getElementById('capture-target'); html2canvas(target, { scale: 2 }).then(canvas => { const link = document.createElement('a'); link.download = 'Loss_Report.jpg'; link.href = canvas.toDataURL('image/jpeg', 0.9); link.click(); }); }

        function calcTimeDiff(startInput) {
            const container = startInput.closest('.input-item');
            if (!container) return;
            const s = container.querySelector('.l-start').value;
            const e = container.querySelector('.l-end').value;
            const minInput = container.querySelector('.l-min');

            if (s && e) {
                const d = new Date().toISOString().split('T')[0];
                let diff = (new Date(d + " " + e) - new Date(d + " " + s)) / 60000;
                if (diff < 0) diff += 1440;
                minInput.value = diff;
            }
        }

        function getWeekId(dateStr) {
            const target = new Date(dateStr); target.setHours(0, 0, 0, 0);
            const dayNum = target.getDay() || 7;
            const thisMonday = new Date(target); thisMonday.setDate(target.getDate() - dayNum + 1);
            const year = thisMonday.getFullYear();
            const jan1 = new Date(year, 0, 1);
            const jan1Day = jan1.getDay() || 7;
            const week1Start = new Date(jan1); week1Start.setDate(jan1.getDate() - jan1Day + 1);
            const diffTime = thisMonday - week1Start;
            const weekNum = Math.floor(diffTime / (7 * 24 * 60 * 60 * 1000)) + 1;
            return `${year}-W${weekNum.toString().padStart(2, '0')}`;
        }

        function formatK(num) { if (num >= 1000) { return (num / 1000).toFixed(1) + "k"; } return num; }



        function applyBatchMatrix() { const weekH = document.getElementById('batch-week').value; const satH = document.getElementById('batch-sat').value; document.querySelectorAll('#matrix-body tr').forEach(row => { const inputs = row.querySelectorAll('input'); for (let i = 0; i < 5; i++) inputs[i].value = weekH; inputs[5].value = satH; }); calcTotalTime(); renderReport(); autoSave(); }

        function renderMatrix() {
            const tbody = document.getElementById('matrix-body');
            tbody.innerHTML = "";
            moldMachines.forEach(m => {
                const tr = document.createElement('tr');
                let cols = `<td class="matrix-machine">${m}</td>`;
                for (let i = 0; i < 6; i++) cols += `<td><input type="number" class="mat-inp" value="24" onkeyup="calcTotalTime(); renderReport(); autoSave();"></td>`;
                cols += `<td class="matrix-sum" id="sum-${m}">0</td>`;
                tr.innerHTML = cols;
                tbody.appendChild(tr);
            });
            calcTotalTime();
        }

        function calcTotalTime() { let grandTotalMin = 0; document.querySelectorAll('#matrix-body tr').forEach(row => { let rowSumH = 0; row.querySelectorAll('.mat-inp').forEach(inp => { rowSumH += parseFloat(inp.value) || 0; }); row.querySelector('.matrix-sum').innerText = rowSumH; grandTotalMin += (rowSumH * 60); }); document.getElementById('input-total-net').innerText = formatK(grandTotalMin); return grandTotalMin; }

        function setDept(dept) {
            currentDept = 'MOLD';
            document.getElementById('out-dept-name').innerText = "Í∏àÌòïÌåÄ (Equipo de Moldes)";
            document.getElementById('th-machine').innerText = "Î™®Îç∏ (Modelo)";
            document.getElementById('th-detail').innerText = "Î≤àÌò∏ (No.)";
            document.getElementById('loss-inputs').innerHTML = "";
            renderMatrix();
            if (!localStorage.getItem('loss_report_autosave')) { addLossRow(); }
            renderReport();
        }

        function removeRow(btn) { if (confirm("ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?")) { btn.closest('.input-item').remove(); renderReport(); autoSave(); } }

        function addLossRow() {
            const div = document.createElement('div');
            div.className = 'input-item';
            div.style.background = "#2c3034"; div.style.padding = "8px"; div.style.marginBottom = "5px"; div.style.borderRadius = "4px"; div.style.border = "1px solid #444";

            let primaryOpts = `<option value="">-- Î™®Îç∏ (Modelo) --</option>`; moldModels.forEach(m => { primaryOpts += `<option value="${m}">${m}</option>`; });
            let subOpts = `<option value="-">-- Î≤àÌò∏ (No.) --</option>`; moldCavities.forEach(c => { subOpts += `<option value="${c}">${c}</option>`; });

            div.innerHTML = `
            <div style="display:flex; justify-content:space-between; margin-bottom:5px; align-items:center;">
                <div style="display:flex; align-items:center;">
                    <span class="drag-handle">‚ò∞</span>
                    <div style="color:#ddd; font-size:0.8rem;">üìÖ <input type="date" class="l-date" onchange="validateDate(this); renderReport(); autoSave();" style="width:auto; display:inline-block;"></div>
                </div>
                <div class="btn-action-group">
                    <button class="btn-sm btn-copy" onclick="duplicateRow(this)">üìë Î≥µÏÇ¨</button>
                    <button class="btn-sm btn-del" onclick="removeRow(this)">üóëÔ∏è ÏÇ≠Ï†ú</button>
                </div>
            </div>
            <select class="l-machine" onchange="renderReport(); autoSave();" style="width:100%; margin-bottom:5px; background:#d63384; color:white; font-weight:bold;">${primaryOpts}</select>
            <select class="l-sub" onchange="renderReport(); autoSave();" style="width:100%;">${subOpts}</select>
            <div style="display:flex; gap:5px; margin-top:5px;">
                <input type="time" class="l-start" onchange="calcTimeDiff(this); renderReport(); autoSave();">
                <input type="time" class="l-end" onchange="calcTimeDiff(this); renderReport(); autoSave();">
                <input type="number" class="l-min" placeholder="min" readonly style="width:50px; background:#eee; font-weight:bold; color:black;">
            </div>
            <input type="text" class="l-reason" list="common-reasons" placeholder="ÌòÑÏÉÅ Î∞è ÏõêÏù∏ (Fen√≥meno y Causa)" onchange="updateReasonList(this)" onkeyup="renderReport(); autoSave();" style="margin-top:5px;">
            <input type="text" class="l-action" placeholder="ÎåÄÏ±Ö Î∞è Ï°∞Ïπò (Acci√≥n / Medida)" onkeyup="renderReport(); autoSave();" style="margin-top:5px; background:#e9ecef; font-weight:bold; color:black;">
        `;
            document.getElementById('loss-inputs').appendChild(div);
        }

        function addActivityRow(type) {
            const container = document.getElementById('improv-inputs');
            const div = document.createElement('div');
            div.className = 'input-item';
            div.style.background = "#2c3034"; div.style.padding = "8px"; div.style.marginBottom = "5px"; div.style.borderRadius = "4px"; div.style.border = "1px solid #17a2b8";

            const headerHtml = `
            <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                <span class="drag-handle">‚ò∞</span>
                <div class="btn-action-group">
                    <button class="btn-sm btn-copy" onclick="duplicateRow(this)">üìë Î≥µÏÇ¨</button>
                    <button class="btn-sm btn-del" onclick="removeRow(this)">üóëÔ∏è ÏÇ≠Ï†ú</button>
                </div>
            </div>`;

            div.innerHTML = `
            ${headerHtml}
            <input type="text" class="act-desc" placeholder="Í∞úÏÑ† ÎÇ¥Ïö© (Descripci√≥n)" onkeyup="renderReport(); autoSave();">
            <div style="display:flex; gap:5px;">
                <label class="file-upload-btn" style="flex:1; background:#dc3545;">üì∑ Ï†Ñ (Before)<input type="file" accept="image/*" onchange="handleImage(this, 'hidden-img-before')"></label>
                <label class="file-upload-btn" style="flex:1; background:#0d6efd;">üì∑ ÌõÑ (After)<input type="file" accept="image/*" onchange="handleImage(this, 'hidden-img-after')"></label>
            </div>
            <img class="hidden-img-before" style="display:none;" src="">
            <img class="hidden-img-after" style="display:none;" src="">
        `;
            container.appendChild(div);
        }

        function addPmRow() {
            const container = document.getElementById('pm-inputs');
            const div = document.createElement('div');
            div.className = 'input-item';
            div.style.background = "#2c3034"; div.style.padding = "8px"; div.style.marginBottom = "5px"; div.style.borderRadius = "4px"; div.style.border = "1px solid #aaa";

            let modelOpts = `<option value="">-- Î™®Îç∏ (Modelo) --</option>`; moldModels.forEach(m => { modelOpts += `<option value="${m}">${m}</option>`; });
            const ops = ["OP 10", "OP 20", "OP 30", "OP 40", "OP 50"];
            let opOpts = `<option value="">-- OP --</option>`; ops.forEach(op => { opOpts += `<option value="${op}">${op}</option>`; });

            div.innerHTML = `
            <div style="display:flex; justify-content:space-between; margin-bottom:5px; align-items:center;">
                <span class="drag-handle">‚ò∞</span>
                <div class="btn-action-group">
                    <button class="btn-sm btn-copy" onclick="duplicateRow(this)">üìë Î≥µÏÇ¨</button>
                    <button class="btn-sm btn-del" onclick="removeRow(this)">üóëÔ∏è ÏÇ≠Ï†ú</button>
                </div>
            </div>
            <div style="display:flex; gap:5px; margin-bottom:5px;">
                <input type="date" class="p-date" onchange="renderReport(); autoSave();" style="width:110px;">
                <select class="p-model" onchange="renderReport(); autoSave();" style="flex:1;">${modelOpts}</select>
                <select class="p-op" onchange="renderReport(); autoSave();" style="width:80px;">${opOpts}</select>
                <input type="text" class="p-code" placeholder="Code" onkeyup="renderReport(); autoSave();" style="width:60px;">
            </div>
            <textarea class="p-desc" placeholder="ÌôúÎèô ÎÇ¥Ïó≠ (Detalles de Actividad)" onkeyup="renderReport(); autoSave();" style="width:100%; height:60px; resize:vertical;"></textarea>
        `;
            container.appendChild(div);
        }

        function calcTimeDiff(inputObj) {
            const timeContainer = inputObj.parentElement;
            const start = timeContainer.querySelector('.l-start').value;
            const end = timeContainer.querySelector('.l-end').value;
            if (start && end) {
                let s = new Date("2000-01-01 " + start);
                let e = new Date("2000-01-01 " + end);
                let diff = (e - s) / 60000;
                if (diff < 0) diff += 1440;
                timeContainer.querySelector('.l-min').value = diff;
            }
        }
        function drawPieChart(data, elementId) {
            const container = document.getElementById(elementId); container.innerHTML = "";
            if (data.length === 0) { container.innerHTML = "<div style='text-align:center; width:100%; color:#aaa; font-size:11px;'>No Data</div>"; return; }
            const colors = ['#0d6efd', '#dc3545', '#198754', '#ffc107', '#0dcaf0', '#6610f2', '#fd7e14', '#20c997', '#d63384', '#6c757d'];
            let total = data.reduce((sum, item) => sum + item.value, 0); let cumulativePercent = 0;
            let svgHtml = `<svg viewBox="-1 -1 2 2" class="pie-chart-svg" style="transform: rotate(-90deg);">`;
            data.forEach((item, index) => {
                const percent = item.value / total; const startPercent = cumulativePercent; const endPercent = cumulativePercent + percent; cumulativePercent += percent;
                const x1 = Math.cos(2 * Math.PI * startPercent); const y1 = Math.sin(2 * Math.PI * startPercent);
                const x2 = Math.cos(2 * Math.PI * endPercent); const y2 = Math.sin(2 * Math.PI * endPercent);
                const largeArcFlag = percent > 0.5 ? 1 : 0; const color = colors[index % colors.length];
                const pathData = `M 0 0 L ${x1} ${y1} A 1 1 0 ${largeArcFlag} 1 ${x2} ${y2} Z`;
                svgHtml += `<path d="${pathData}" fill="${color}" stroke="white" stroke-width="0.02"></path>`;
            });
            svgHtml += `<circle cx="0" cy="0" r="0.5" fill="white"></circle></svg>`;
            let legendHtml = `<div class="pie-legend">`;
            data.forEach((item, index) => { const color = colors[index % colors.length]; const percent = ((item.value / total) * 100).toFixed(1); legendHtml += `<div class="legend-item"><div class="legend-color" style="background:${color};"></div><div class="legend-text" title="${item.label}">${item.label}</div><div class="legend-value">${percent}%</div></div>`; });
            legendHtml += `</div>`; container.innerHTML = `<div class="pie-chart-container">${svgHtml}${legendHtml}</div>`;
        }
        function renderMachineStatusTable() {
            const tableContainer = document.getElementById('machine-detail-table'); const titleContainer = document.getElementById('machine-detail-title');
            if (!tableContainer) return;
            // ÏÑ§ÎπÑÌåÄÏù¥ÎØÄÎ°ú Ìï≠ÏÉÅ ÌëúÏãú
            titleContainer.style.display = 'block'; tableContainer.style.display = 'block';

            const machineData = {}; const matrixRows = document.querySelectorAll('#matrix-body tr');
            matrixRows.forEach(row => {
                const machineName = row.cells[0].innerText.trim(); let weeklyPlanMin = 0;
                row.querySelectorAll('.mat-inp').forEach(input => { if (!input.disabled && !input.readOnly && input.value) { weeklyPlanMin += (parseFloat(input.value) || 0) * 60; } });
                machineData[machineName] = { plan: weeklyPlanMin, loss: 0 };
            });
            const lossContainer = document.getElementById('loss-inputs');
            if (lossContainer) { Array.from(lossContainer.children).forEach(row => { const select = row.querySelector('.l-machine'); const minInput = row.querySelector('.l-min'); if (select && minInput && select.value) { const machine = select.value; const time = parseFloat(minInput.value) || 0; if (machineData[machine]) { machineData[machine].loss += time; } else { machineData[machine] = { plan: 0, loss: time }; } } }); }
            let html = `<table style="width:100%; border-collapse: collapse; text-align: center; font-size: 11px; margin-bottom: 10px;"><colgroup><col width="30%"><col width="20%"><col width="20%"><col width="30%"></colgroup><thead><tr style="background-color: #f1f3f5; border-bottom: 2px solid #333;"><th style="padding:6px; background:#f8f9fa;">ÏÑ§ÎπÑ (Machine)</th><th style="padding:6px; background:#f8f9fa;">Ï¥ù Î∂ÄÌïò (Total Load)</th><th style="padding:6px; background:#f8f9fa;">Loss ÏãúÍ∞Ñ (Loss Time)</th><th style="padding:6px; background:#f8f9fa;">Í∞ÄÎèôÎ•† (Availability)</th></tr></thead><tbody>`;
            const sortedMachines = Object.keys(machineData).sort();
            sortedMachines.forEach(machine => {
                const data = machineData[machine]; let availText = "-"; let colorStyle = "color:#333;";
                if (data.plan > 0) { const avail = ((data.plan - data.loss) / data.plan) * 100; availText = avail.toFixed(1) + "%"; if (avail >= 90) colorStyle = "color:#198754; font-weight:bold;"; else if (avail < 80) colorStyle = "color:#dc3545; font-weight:bold;"; }
                else if (data.loss > 0) { availText = "Error (No Plan)"; colorStyle = "color:#dc3545; font-weight:bold;"; }
                html += `<tr style="border-bottom: 1px solid #eee;"><td style="padding:5px; background:#fcfcfc; font-weight:bold; text-align:left;">${machine}</td><td style="padding:5px;">${data.plan > 0 ? formatK(data.plan) + ' min' : '-'}</td><td style="padding:5px;">${data.loss > 0 ? formatK(data.loss) + ' min' : '-'}</td><td style="padding:5px; ${colorStyle}">${availText}</td></tr>`;
            });
            html += `</tbody></table>`; tableContainer.innerHTML = html;
        }
        function renderReport() {
            const sVal = document.getElementById('in-start-date').value; const eVal = document.getElementById('in-end-date').value;
            if (sVal && eVal) {
                // [ÏàòÏ†ïÎê®] Î¨∏ÏûêÏó¥ Í∑∏ÎåÄÎ°ú ÏÇ¨Ïö©ÌïòÏó¨ Ï£ºÏ∞® Í≥ÑÏÇ∞ Ìï®Ïàò Ìò∏Ï∂ú (Date Í∞ùÏ≤¥ Î≥ÄÌôò Ï†Ñ)
                document.getElementById('out-title').innerText = `${sVal.split('-')[0]}ÎÖÑ ${getWeekNumber(sVal)}Ï£ºÏ∞® Í∏àÌòïÌåÄ Loss Î∂ÑÏÑù`;
                document.getElementById('out-period-str').innerText = `${sVal} ~ ${eVal}`;
            }
            document.getElementById('out-writer').innerText = document.getElementById('in-writer').value;
            const totalNetMin = calcTotalTime(); document.getElementById('out-net-time').innerText = formatK(totalNetMin);
            const tbody = document.getElementById('out-loss-body'); tbody.innerHTML = ""; let totalLoss = 0; let lossCount = 0;
            let itemDetailMap = {};

            Array.from(document.getElementById('loss-inputs').children).forEach((row, idx) => {
                const date = row.querySelector('.l-date').value || "-";
                const machTxt = row.querySelector('.l-machine').options[row.querySelector('.l-machine').selectedIndex]?.text || "-";
                const subTxt = row.querySelector('.l-sub').options[row.querySelector('.l-sub').selectedIndex]?.text || "-";
                const min = parseFloat(row.querySelector('.l-min').value) || 0;
                const reason = row.querySelector('.l-reason').value || "";
                const action = row.querySelector('.l-action').value || "";

                if (min > 0 || reason) {
                    totalLoss += min;
                    if (row.querySelector('.l-machine').value) {
                        const key = `${machTxt} [${subTxt}]`;
                        if (!itemDetailMap[key]) itemDetailMap[key] = { value: 0, actions: [] };
                        itemDetailMap[key].value += min;
                        if (action) itemDetailMap[key].actions.push(action);
                        lossCount++;
                    }
                    tbody.innerHTML += `<tr><td>${idx + 1}</td><td>${date}</td><td style="font-weight:bold;">${machTxt}</td><td>${subTxt}</td><td>${row.querySelector('.l-start').value}~${row.querySelector('.l-end').value}</td><td>${min}</td><td class="text-left">${reason}<br><span style='color:#0056b3; font-size:9px;'>‚Ü≥ ${action}</span></td></tr>`;
                }
            });

            document.getElementById('out-loss-sum').innerText = formatK(totalLoss); document.getElementById('out-total-loss').innerText = formatK(totalLoss);
            document.getElementById('out-avail-rate').innerText = totalNetMin > 0 ? (((totalNetMin - totalLoss) / totalNetMin) * 100).toFixed(1) + "%" : "0%";
            const lastLoss = parseFloat(document.getElementById('in-last-loss').value) || 0; const diff = totalLoss - lastLoss;
            document.getElementById('out-trend').innerHTML = lastLoss > 0 ? (diff > 0 ? `<span class="trend-up">‚ñ≤ ${formatK(Math.abs(diff))} (Bad)</span>` : (diff < 0 ? `<span class="trend-down">‚ñº ${formatK(Math.abs(diff))} (Good)</span>` : `<span class="trend-flat">-</span>`)) : `<span style="font-size:12px; color:#aaa;">-</span>`;
            const mttr = lossCount > 0 ? (totalLoss / lossCount).toFixed(1) : 0; const mtbf = lossCount > 0 ? ((totalNetMin - totalLoss) / lossCount).toFixed(1) : (totalNetMin > 0 ? "‚àû" : 0);
            document.getElementById('out-mttr').innerText = mttr; document.getElementById('out-mtbf').innerText = mtbf;

            const sortedItems = Object.keys(itemDetailMap).map(key => ({ label: key, value: itemDetailMap[key].value, actions: itemDetailMap[key].actions })).sort((a, b) => b.value - a.value);
            drawPieChart(sortedItems, 'out-chart-area');

            const top5Body = document.getElementById('out-top5-body');
            top5Body.innerHTML = "";
            for (let i = 0; i < 5; i++) {
                if (i < sortedItems.length) {
                    const item = sortedItems[i];
                    const actionStr = item.actions.length > 0 ? item.actions[0] : "-";
                    top5Body.innerHTML += `<tr><td style="font-weight:bold; color:red;">${i + 1}</td><td style="font-weight:bold; color:#333;">${item.label}</td><td>${formatK(item.value)}</td><td class="text-left" style="color:#0056b3; font-weight:bold;">${actionStr}</td></tr>`;
                } else {
                    top5Body.innerHTML += `<tr><td>${i + 1}</td><td style="color:#eee;">-</td><td>-</td><td></td></tr>`;
                }
            }
            // 5. PM History Rendering
            const pmBody = document.getElementById('out-pm-body');
            pmBody.innerHTML = "";
            Array.from(document.getElementById('pm-inputs').children).forEach((row, idx) => {
                const date = row.querySelector('.p-date').value || "-";
                const model = row.querySelector('.p-model').value || "-";
                const op = row.querySelector('.p-op').value || "-";
                const code = row.querySelector('.p-code').value || "-";
                const desc = row.querySelector('.p-desc').value || "-";
                pmBody.innerHTML += `<tr><td>${idx + 1}</td><td>${date}</td><td>${model}</td><td>${op}</td><td>${code}</td><td class="text-left">${desc}</td></tr>`;
            });

            // 6. Improvement Activity
            renderActivity('improv', 'out-improv-area');
        }
        function renderActivity(inputId, outputId) {
            const container = document.getElementById(outputId); container.innerHTML = ""; const inputs = document.getElementById(inputId + '-inputs').children;
            for (let row of inputs) {
                const desc = row.querySelector('.act-desc').value;
                // [ÏàòÏ†ïÎê®] Î†åÎçîÎßÅ Î∞©Ïãù Î∂ÑÍ∏∞ Ï≤òÎ¶¨
                if (inputId === 'maint') {
                    const img = row.querySelector('.hidden-img-data').src;
                    if (desc || (img && img.length > 100)) {
                        // [5. Ï†ïÎπÑ Î∞è PM] class="pm-item" ÏÇ¨Ïö© -> 3Ïó¥ Î∞∞Ïπò
                        container.innerHTML += `
                    <div class="pm-item">
                        <div class="photo-img-box">${img && img.length > 100 ? `<img src="${img}">` : '<span style="color:#ccc;">No Image</span>'}</div>
                        <div class="photo-desc">${desc}</div>
                    </div>`;
                    }
                }
                else {
                    const imgBefore = row.querySelector('.hidden-img-before').src;
                    const imgAfter = row.querySelector('.hidden-img-after').src;
                    if (desc || (imgBefore.length > 100 || imgAfter.length > 100)) {
                        // [6. Í∞úÏÑ†ÌôúÎèô] class="improv-item" ÏÇ¨Ïö© -> 2Ïó¥ Î∞∞Ïπò, Í∞ïÏ°∞
                        container.innerHTML += `
                    <div class="improv-item">
                        <div class="ba-container">
                            <div class="ba-box"><div class="ba-label">Before (Ï†Ñ)</div><div class="ba-img">${imgBefore && imgBefore.length > 100 ? `<img src="${imgBefore}" style="width:100%; height:100%; object-fit:cover;">` : `<div class="ba-placeholder">No Image</div>`}</div></div>
                            <div class="ba-box"><div class="ba-label">After (ÌõÑ)</div><div class="ba-img">${imgAfter && imgAfter.length > 100 ? `<img src="${imgAfter}" style="width:100%; height:100%; object-fit:cover;">` : `<div class="ba-placeholder">No Image</div>`}</div></div>
                        </div>
                        <div class="photo-desc">${desc}</div>
                    </div>`;
                    }
                }
            }
        }

        // [ÏàòÏ†ïÎê®] Î™®Î∞îÏùº V2.1Í≥º ÎèôÏùºÌïú Ï£ºÏ∞® Í≥ÑÏÇ∞ Î°úÏßÅ (Timezone Issue Fix)
        function getWeekNumber(dateInput) {
            if (!dateInput) return "";

            let target;
            // Î¨∏ÏûêÏó¥("2026-01-12")Ïù¥ Îì§Ïñ¥Ïò§Î©¥ ÏßÅÏ†ë ÌååÏã±ÌïòÏó¨ Î°úÏª¨ ÏãúÍ∞Ñ ÏÉùÏÑ±
            if (typeof dateInput === 'string') {
                const parts = dateInput.split('-');
                if (parts.length === 3) {
                    // Year, MonthIndex, Day (ÏõîÏùÄ 0Î∂ÄÌÑ∞ ÏãúÏûë)
                    target = new Date(parts[0], parts[1] - 1, parts[2]);
                } else {
                    target = new Date(dateInput);
                }
            } else {
                target = new Date(dateInput);
            }

            // ÏãúÍ∞Ñ Ï¥àÍ∏∞Ìôî
            target.setHours(0, 0, 0, 0);

            // Ìï¥Îãπ ÎÇ†ÏßúÏùò ÏöîÏùº (Ïùº:0 ~ ÌÜ†:6) -> (Ïùº:7 Î°ú Î≥ÄÌôò)
            const dayNum = target.getDay() || 7;

            // Ïù¥Î≤à Ï£º ÏõîÏöîÏùº Ï∞æÍ∏∞
            const thisMonday = new Date(target);
            thisMonday.setDate(target.getDate() - dayNum + 1);
            thisMonday.setHours(0, 0, 0, 0);

            const year = thisMonday.getFullYear();
            const jan1 = new Date(year, 0, 1);
            const jan1Day = jan1.getDay() || 7;

            // 1Ï£ºÏ∞®Ïùò ÏãúÏûëÏùº (1Ïõî 1ÏùºÏù¥ Ìè¨Ìï®Îêú Ï£ºÏùò ÏõîÏöîÏùº)
            const week1Start = new Date(jan1);
            week1Start.setDate(jan1.getDate() - jan1Day + 1);
            week1Start.setHours(0, 0, 0, 0);

            // Ï£ºÏ∞® Í≥ÑÏÇ∞
            const diffTime = thisMonday.getTime() - week1Start.getTime();
            return Math.floor(diffTime / (7 * 24 * 60 * 60 * 1000)) + 1;
        }
    </script>
</body>

</html>