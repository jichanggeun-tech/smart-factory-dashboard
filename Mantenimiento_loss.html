<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <title></title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <style>
        :root {
            --bg-body: #111827;
            --bg-nav: #1f2937;
            --bg-card: #2d3748;
            --bg-input: #374151;
            --text-main: #f9fafb;
            --text-muted: #9ca3af;
            --accent: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --blue: #3b82f6;
            --border: #4b5563;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-body);
            display: flex;
            height: 100vh;
            font-family: 'Segoe UI', sans-serif;
            color: var(--text-main);
            overflow: hidden;
        }

        .input-panel {
            width: 650px;
            min-width: 400px;
            max-width: 900px;
            background: var(--bg-nav);
            color: var(--text-main);
            padding: 20px;
            overflow-y: auto;
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            gap: 15px;
            z-index: 10;
        }

        .input-panel h2 {
            border-bottom: 2px solid var(--border);
            padding-bottom: 10px;
            font-size: 1.4rem;
            color: var(--blue);
            margin-top: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Resizer removed - using toggle button instead */

        .form-section {
            background: var(--bg-card);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        .form-section h3 {
            margin: 0 0 10px 0;
            font-size: 1rem;
            color: #17a2b8;
            border-bottom: 1px solid #6c757d;
            padding-bottom: 5px;
        }

        label {
            display: block;
            margin-bottom: 3px;
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        input,
        textarea,
        select {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--bg-input);
            color: var(--text-main);
            margin-bottom: 8px;
            font-size: 0.9rem;
            box-sizing: border-box;
        }

        input:focus,
        textarea:focus,
        select:focus {
            outline: 2px solid var(--blue);
            border-color: transparent;
        }

        .matrix-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 5px;
        }

        .matrix-table th {
            background: #495057;
            color: #ffc107;
            font-size: 0.75rem;
            padding: 4px;
            text-align: center;
            border: 1px solid #6c757d;
        }

        .matrix-table td {
            padding: 2px;
            border: 1px solid #6c757d;
        }

        .matrix-table input {
            width: 100%;
            margin: 0;
            text-align: center;
            font-size: 0.85rem;
            font-weight: bold;
            padding: 4px 0;
            border: none;
        }

        .matrix-machine {
            font-size: 0.8rem;
            font-weight: bold;
            color: #eee;
            padding-left: 5px;
            background: #212529;
        }

        .matrix-sum {
            font-size: 0.8rem;
            color: #0d6efd;
            text-align: center;
            font-weight: bold;
            background: #212529;
        }

        .file-upload-btn {
            display: inline-block;
            background: #6c757d;
            color: white;
            padding: 8px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            text-align: center;
            width: 100%;
            font-weight: bold;
            border: 1px solid #999;
        }

        .file-upload-btn:hover {
            background: #5a6268;
        }

        input[type="file"] {
            display: none;
        }

        .btn-add {
            background: #374151;
            border: 1px solid #4b5563;
            padding: 10px;
            color: #f9fafb;
            width: 100%;
            border-radius: 6px;
            cursor: pointer;
            margin-top: 5px;
            font-size: 0.9rem;
            font-weight: bold;
            transition: 0.2s;
        }

        .btn-add:hover {
            background: #4b5563;
        }

        .btn-add:hover {
            background: #2563eb;
        }

        .btn-action-group {
            display: flex;
            gap: 5px;
            margin-left: auto;
        }

        .btn-sm {
            padding: 2px 6px;
            font-size: 0.7rem;
            border-radius: 3px;
            cursor: pointer;
            border: 1px solid #4b5563;
            background: #374151;
            /* Unified Dark Blue-Grey */
            color: white;
            font-weight: bold;
        }

        .btn-sm:hover {
            background: #4b5563;
        }

        .btn-del {
            background: #dc3545;
        }

        .btn-del:hover {
            background: #bb2d3b;
        }

        .btn-copy {
            background: #6f42c1;
        }

        .btn-copy:hover {
            background: #59359a;
        }

        .drag-handle {
            cursor: grab;
            color: #adb5bd;
            font-size: 1.2rem;
            margin-right: 10px;
            display: flex;
            align-items: center;
        }

        .drag-handle:active {
            cursor: grabbing;
            color: #fff;
        }

        .input-item {
            transition: transform 0.2s, background 0.2s;
        }

        .sortable-ghost {
            opacity: 0.5;
            background: #495057 !important;
        }

        .btn-group {
            display: flex;
            gap: 5px;
            margin-top: 5px;
            flex-wrap: wrap;
        }

        .btn-print {
            flex: 1;
            background: #374151;
            border: 1px solid #4b5563;
            height: 50px;
            font-size: 1.1rem;
            color: #f9fafb;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: 0.2s;
        }

        .btn-print:hover {
            background: #4b5563;
        }

        .btn-capture {
            flex: 1;
            background: #374151;
            border: 1px solid #4b5563;
            height: 50px;
            font-size: 1.1rem;
            color: #f9fafb;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: 0.2s;
        }

        .btn-capture:hover {
            background: #4b5563;
        }

        .btn-excel {
            flex: 1;
            background: #374151;
            border: 1px solid #4b5563;
            height: 50px;
            font-size: 1.1rem;
            color: #f9fafb;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            transition: 0.2s;
        }

        .btn-excel:hover {
            background: #4b5563;
        }

        .btn-save {
            flex: 1;
            background: #374151;
            border: 1px solid #4b5563;
            height: 40px;
            font-size: 0.9rem;
            color: #f9fafb;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: 0.2s;
        }

        .btn-save:hover {
            background: #4b5563;
        }

        .btn-load {
            flex: 1;
            background: #374151;
            border: 1px solid #4b5563;
            height: 40px;
            font-size: 0.9rem;
            color: #f9fafb;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: 0.2s;
        }

        .btn-load:hover {
            background: #4b5563;
        }

        .btn-reset {
            flex: 1;
            background: #374151;
            border: 1px solid #4b5563;
            height: 40px;
            font-size: 0.9rem;
            color: #f9fafb;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: 0.2s;
        }

        .btn-reset:hover {
            background: #4b5563;
        }

        .btn-cloud-save {
            flex: 1;
            background: #374151;
            border: 1px solid #4b5563;
            height: 40px;
            font-size: 0.9rem;
            color: #f9fafb;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            transition: 0.2s;
        }

        .btn-cloud-save:hover {
            background: #4b5563;
        }

        .btn-cloud-load {
            flex: 1;
            background: #374151;
            border: 1px solid #4b5563;
            height: 40px;
            font-size: 0.9rem;
            color: #f9fafb;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            transition: 0.2s;
        }

        .btn-cloud-load:hover {
            background: #4b5563;
        }

        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: #212529;
            color: white;
            padding: 20px;
            border-radius: 10px;
            width: 400px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            border: 1px solid #444;
        }

        .cloud-list {
            list-style: none;
            padding: 0;
            margin: 0;
            overflow-y: auto;
            flex: 1;
        }

        .cloud-item {
            padding: 12px;
            border-bottom: 1px solid #444;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;

            /* ë‘ ì½”ë“œì˜ ì¥ì ì„ í•©ì¹¨ */
            color: #e0e0e0;
            /* ê¸€ììƒ‰: ë°ì€ íšŒìƒ‰ (ê°€ë…ì„± í™•ë³´) */
            transition: background 0.2s;
            /* ì• ë‹ˆë©”ì´ì…˜: ë°°ê²½ìƒ‰ ë³€ê²½ ì‹œ ë¶€ë“œëŸ½ê²Œ */
        }

        /* (ì°¸ê³ ) ë³´í†µ ì´ëŸ° ì½”ë“œì™€ ì§ê¿ìœ¼ë¡œ ì“°ì´ëŠ” í˜¸ë²„ íš¨ê³¼ */
        .cloud-item:hover {
            background-color: #555;
            /* ë§ˆìš°ìŠ¤ ì˜¬ë¦¬ë©´ ë°°ê²½ì´ ì‚´ì§ ë°ì•„ì§ */
        }

        .cloud-item:hover {
            background: #343a40;
        }

        .cloud-item:last-child {
            border-bottom: none;
        }

        .cloud-week {
            font-weight: bold;
            color: #ffc107;
            font-size: 1.1rem;
        }

        .cloud-date {
            font-size: 0.8rem;
            color: #ccc;
        }

        .preview-panel {
            flex: 1;
            padding: 40px;
            overflow-y: auto;
            background: #e9ecef;
            color: #333;
            /* Explicitly set text color for white background */
            display: flex;
            justify-content: center;
            align-items: flex-start;
        }

        .report-container {
            width: 297mm;
            min-height: 210mm;
            height: auto;
            margin: 0 auto;
            background: white;
            color: #333;
            /* Explicitly set text color for white background */
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
            box-sizing: border-box;
            padding: 20px;
            padding-bottom: 50px;
        }

        .header-box {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            border-bottom: 3px double #333;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        .header-logo {
            width: 200px;
            height: 90px;
            display: flex;
            align-items: center;
            justify-content: flex-start;
        }

        .header-logo img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .header-logo-placeholder {
            width: 100%;
            height: 100%;
            border: 2px dashed #ddd;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6b7280;
            /* Visible grey */
            font-size: 11px;
            text-align: center;
            background: #f3f4f6;
        }

        .header-title-area {
            text-align: center;
            flex: 1;
        }

        .header-title h1 {
            font-size: 24px;
            margin: 0;
            color: #333;
            font-weight: 900;
            letter-spacing: -0.5px;
        }

        .header-title p {
            font-size: 12px;
            color: #374151;
            /* Dark Blue-Grey */
            margin: 5px 0 0 0;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .header-info {
            text-align: right;
            font-size: 11px;
            line-height: 1.5;
            color: #555;
            width: 220px;
        }

        .section-title {
            font-size: 14px;
            font-weight: bold;
            margin-top: 25px;
            margin-bottom: 8px;
            border-left: 6px solid #333;
            padding-left: 10px;
            background: #f8f9fa;
            padding-top: 4px;
            padding-bottom: 4px;
            color: #333;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 10px;
            margin-bottom: 10px;
            table-layout: fixed;
        }

        th,
        td {
            border: 1px solid #ccc;
            padding: 5px;
            text-align: center;
            vertical-align: middle;
            word-wrap: break-word;
        }

        th {
            background: #e5e7eb;
            /* Light Grey for print friendly */
            color: #111827;
            /* Dark text for contrast */
            font-weight: bold;
            border-top: 2px solid #333;
        }

        .text-left {
            text-align: left;
        }

        .kpi-container {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-bottom: 15px;
        }

        .kpi-card {
            background: #fff;
            border: 1px solid #e0e0e0;
            border-left-width: 5px;
            padding: 10px 15px;
            border-radius: 6px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-height: 70px;
        }

        .kpi-card h4 {
            margin: 0 0 5px 0;
            font-size: 10px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .kpi-card .value {
            font-size: 22px;
            font-weight: 800;
            color: #333;
            line-height: 1.1;
        }

        .kpi-card .unit {
            font-size: 12px;
            color: #374151;
            /* Dark text */
            font-weight: normal;
            margin-left: 2px;
        }

        .kpi-sub {
            font-size: 9px;
            color: #4b5563;
            /* Dark text */
            margin-top: 4px;
        }

        .kpi-blue {
            border-left-color: #0d6efd;
        }

        .kpi-blue .value {
            color: #374151;
            /* Unified Dark Blue-Grey */
        }

        .kpi-red {
            border-left-color: #dc3545;
        }

        .kpi-red .value {
            color: #374151;
            /* Unified Dark Blue-Grey */
        }

        .kpi-green {
            border-left-color: #198754;
        }

        .kpi-green .value {
            color: #374151;
            /* Unified Dark Blue-Grey */
        }

        .kpi-gray {
            border-left-color: #6c757d;
        }

        .kpi-gray .value {
            color: #374151;
            /* Unified Dark Blue-Grey */
        }

        .kpi-info {
            border-left-color: #0dcaf0;
        }

        .kpi-info .value {
            color: #374151;
            /* Unified Dark Blue-Grey */
        }

        .trend-up {
            color: #dc3545;
            font-weight: bold;
            font-size: 14px;
        }

        .trend-down {
            color: #28a745;
            font-weight: bold;
            font-size: 14px;
        }

        .trend-flat {
            color: #6c757d;
            font-size: 14px;
        }

        .pie-chart-container {
            display: flex;
            width: 100%;
            height: 100%;
            align-items: center;
        }

        .pie-chart-svg {
            width: 150px;
            height: 150px;
            flex-shrink: 0;
        }

        .pie-legend {
            flex: 1;
            padding-left: 15px;
            font-size: 10px;
            overflow-y: auto;
            max-height: 150px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 4px;
        }

        .legend-color {
            width: 10px;
            height: 10px;
            margin-right: 5px;
            border-radius: 2px;
        }

        .legend-text {
            flex: 1;
            font-weight: bold;
            color: #555;
        }

        .legend-value {
            font-weight: bold;
            color: #333;
        }

        .photo-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }

        .photo-item {
            width: calc(50% - 10px);
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 8px;
            background: #f8f9fa;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            height: auto;
        }

        .photo-img-box {
            width: 100%;
            height: 180px;
            background: #fff;
            border: 1px solid #ccc;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            margin-bottom: 6px;
            flex-shrink: 0;
        }

        .photo-img-box img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            object-position: center;
        }

        .photo-desc {
            font-size: 11px;
            color: #333;
            font-weight: bold;
            line-height: 1.4;
            padding: 4px;
            background: #fff;
            border: 1px solid #eee;
            border-radius: 3px;
            word-break: break-all;
        }

        .ba-container {
            display: flex;
            gap: 5px;
            width: 100%;
            height: 180px;
            margin-bottom: 6px;
            flex-shrink: 0;
        }

        .ba-box {
            flex: 1;
            border: 1px solid #ccc;
            background: #fff;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .ba-label {
            font-size: 9px;
            background: #374151;
            /* Unified Dark Blue-Grey */
            color: white;
            text-align: center;
            padding: 2px 0;
            font-weight: bold;
            flex-shrink: 0;
        }

        .ba-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            object-position: center;
        }

        .ba-placeholder {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6b7280;
            /* Visible grey */
            font-size: 10px;
        }

        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(33, 37, 41, 0.95);
            color: white;
            padding: 12px 25px;
            border-radius: 30px;
            font-size: 0.9rem;
            z-index: 9999;
            display: none;
            font-weight: bold;
            border: 1px solid #0d6efd;
        }

        @media print {

            .input-panel,
            .resizer,
            .modal-overlay,
            .btn-toggle-sidebar {
                display: none;
            }

            .preview-panel {
                padding: 0;
                overflow: visible;
                background: white;
            }

            .report-container {
                max-width: 100%;
                width: 100%;
                margin: 0;
                padding: 0;
                box-shadow: none;
                border: none;
            }

            body {
                height: auto;
                overflow: visible;
                background: white;
            }

            @page {
                size: landscape;
                margin: 0;
            }
        }

        /* Sidebar Controls (Home + Toggle wrapper) */
        .sidebar-controls {
            display: flex;
            align-items: center;
            position: fixed;
            top: 15px;
            left: 15px !important;
            z-index: 1001;
            transition: none;
        }

        .home-btn {
            background: #334155;
            color: #e2e8f0;
            border: 1px solid #475569;
            border-radius: 20px 0 0 20px;
            width: 70px;
            height: 36px;
            text-decoration: none;
            font-size: 12px;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            padding: 0;
            box-sizing: border-box;
        }

        .home-btn:hover {
            background: #4285F4;
            color: #fff;
        }

        .btn-toggle-sidebar {
            width: 70px;
            height: 36px;
            background: #1e293b;
            border: 1px solid #334155;
            border-left: none;
            border-radius: 0 20px 20px 0;
            color: #94a3b8;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            padding: 0;
            box-sizing: border-box;
        }

        .btn-toggle-sidebar:hover {
            color: white;
            background: #334155;
        }

        body.full-screen .input-panel {
            display: none !important;
        }

        body.full-screen .resizer {
            display: none !important;
        }

        body.full-screen .sidebar-controls {
            left: 15px !important;
        }

        /* Standardized Home Button & Sidebar Controls */
        .sidebar-controls {
            display: flex;
            align-items: center;
            margin-left: auto;
        }

        .control-row h2 {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
        }

        .control-row h2::after {
            content: "";
            flex-grow: 1;
            /* ë‚¨ì€ ê³µê°„ì„ ì„ ìœ¼ë¡œ ê°€ë“ ì±„ì›€ */
            height: 1px;
            /* ì„ ì˜ ë‘ê»˜ (ì–‡ê²Œ í•˜ë ¤ë©´ 1px, ë‘ê»ê²Œ í•˜ë ¤ë©´ 2px) */
            background: #4b5563;
            /* ì„ ì˜ ìƒ‰ìƒ (íšŒìƒ‰) */
            margin-left: 0;
            /* ë²„íŠ¼ê³¼ ì„  ì‚¬ì´ì˜ ê°„ê²© (ë”± ë¶™ì´ë ¤ë©´ 0) */
            display: block;
        }

        .home-btn {
            background: #334155 !important;
            color: #e2e8f0 !important;
            border: 1px solid #475569 !important;
            border-radius: 8px 0 0 8px !important;
            height: 28px !important;
            padding: 0 10px !important;
            box-sizing: border-box !important;
            text-decoration: none !important;
            font-size: 12px !important;
            font-weight: 700 !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            gap: 4px !important;
            width: auto !important;
            /* Reset width */
            margin: 0 !important;
        }

        .home-btn:hover {
            background: #4285F4 !important;
            color: #fff !important;
        }

        .btn-toggle-sidebar {
            width: 24px !important;
            height: 28px !important;
            background: #1e293b !important;
            border: 1px solid #334155 !important;
            border-left: none !important;
            border-radius: 0 8px 8px 0 !important;
            box-sizing: border-box !important;
            color: #94a3b8 !important;
            cursor: pointer !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            font-size: 12px !important;
            padding: 0 !important;
        }

        .btn-toggle-sidebar:hover {
            color: white !important;
            background: #334155 !important;
        }
    </style>
</head>

<body>

    <div id="cloud-modal" class="modal-overlay">
        <div class="modal-content">
            <div
                style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; border-bottom:1px solid #555; padding-bottom:10px;">
                <h3 style="margin:0; color:#0dcaf0;">â˜ï¸ í´ë¼ìš°ë“œ ì €ì¥ ëª©ë¡</h3>
                <button onclick="document.getElementById('cloud-modal').style.display='none'"
                    style="background:none; border:none; color:white; font-size:20px; cursor:pointer;">&times;</button>
            </div>
            <ul id="cloud-list-ul" class="cloud-list"></ul>
            <div style="text-align:center; margin-top:10px; color:#aaa; font-size:0.8rem;">ì„ íƒí•˜ë©´ ë°ì´í„°ê°€ ë®ì–´ì”Œì›Œì§‘ë‹ˆë‹¤.</div>
        </div>
    </div>

    <datalist id="common-reasons"></datalist>

    <div id="toast" class="toast">âœ”ï¸ ì•Œë¦¼</div>

    <div class="input-panel" id="inputPanel">
        <h2>
            <div class="sidebar-controls">
                <a class="home-btn" href="index.html">ğŸ  Home</a>
                <button id="btn-toggle-sidebar" class="btn-toggle-sidebar" onclick="toggleSidebar()">â—€</button>
            </div>
        </h2>

        <div style="display:flex; gap:5px; margin-bottom:10px;">
            <button class="btn-print" onclick="window.print()" style="flex:1;">PDF ë³€í™˜ (PDF)</button>
            <button class="btn-capture" onclick="captureImage()" style="flex:1;">ìŠ¤í¬ë¦°ìƒ· (Captura)</button>
        </div>

        <div class="form-section" style="border-color:#fd7e14;">
            <h3 style="color:#fd7e14; border-color:#fd7e14;">â˜ï¸ í´ë¼ìš°ë“œ ì €ì¥/ë¡œë“œ</h3>
            <div style="display:flex; gap:5px; margin-bottom:5px;">
                <button class="btn-cloud-save" onclick="saveToCloud()">ğŸ“¤ ì£¼ì°¨ë³„ ì €ì¥ (Save)</button>
                <button class="btn-cloud-load" onclick="openCloudModal()">ğŸ“¥ ëª©ë¡ì—ì„œ ë¶ˆëŸ¬ì˜¤ê¸° (Load)</button>
            </div>

            <div class="btn-group" style="margin-top:10px;">
                <button class="btn-save" onclick="manualSaveFile()">ğŸ’¾ ë¡œì»¬ ì €ì¥ (JSON)</button>
                <label class="btn-load"
                    style="text-align:center; padding-top:10px; box-sizing:border-box; display:block;">
                    ğŸ“‚ íŒŒì¼ ì—´ê¸° (Open)
                    <input type="file" accept=".json" onchange="loadFile(this)">
                </label>
                <button class="btn-reset" onclick="resetData()">â†» ìƒˆë¡œ ì‘ì„±</button>
            </div>
        </div>

        <div class="form-section">
            <h3>1. ê¸°ë³¸ ì •ë³´ & ê¸°ê°„ (BÃ¡sica y PerÃ­odo)</h3>
            <div
                style="background:#495057; padding:10px; border-radius:4px; margin-bottom:10px; border:1px solid #6c757d;">
                <label style="color:#ffc107; font-weight:bold;">ğŸ¢ ë¡œê³  ì„¤ì • (Configurar Logo)</label>
                <label class="file-upload-btn">ğŸ“ íŒŒì¼ ì„ íƒ (Seleccionar Archivo)<input type="file" accept="image/*"
                        onchange="handleLogoUpload(this)"></label>
            </div>
            <div style="display:flex; gap:10px;">
                <div style="flex:1;"><label>ì‹œì‘ì¼ (Fecha Inicio)</label><input type="date" id="in-start-date"
                        onchange="renderReport(); autoSave();"></div>
                <div style="flex:1;"><label>ì¢…ë£Œì¼ (Fecha Fin)</label><input type="date" id="in-end-date"
                        onchange="renderReport(); autoSave();"></div>
            </div>
            <label>ì‘ì„±ì (Autor)</label> <input type="text" id="in-writer" value="Manager"
                onkeyup="renderReport(); autoSave();">
        </div>

        <div class="form-section">
            <h3>2. ìš”ì¼ë³„ ê°€ë™ ê³„íš (Plan Diario por DÃ­a)</h3>
            <div
                style="background:#2b3035; padding:8px; border-radius:4px; margin-bottom:10px; border:1px solid #6c757d; display:flex; gap:5px; align-items:center; flex-wrap:wrap;">
                <span style="font-size:11px; color:#ffc107;">âš¡ ì¼ê´„ (Lote):</span>
                <span style="font-size:10px;">í‰ì¼(Lun-Vie)</span><input type="number" id="batch-week" value="24"
                    style="width:40px; margin:0; height:20px; font-size:11px;">
                <span style="font-size:10px;">í† (SÃ¡b)</span><input type="number" id="batch-sat" value="0"
                    style="width:40px; margin:0; height:20px; font-size:11px;">
                <button class="btn-add" style="margin-top:0; width:auto; padding:2px 8px;"
                    onclick="applyBatchMatrix()">ì ìš© (Aplicar)</button>
            </div>
            <div id="matrix-container">
                <table class="matrix-table">
                    <thead>
                        <tr>
                            <th style="width:25%">ì„¤ë¹„ (Mq)</th>
                            <th>ì›”(Lun)</th>
                            <th>í™”(Mar)</th>
                            <th>ìˆ˜(MiÃ©)</th>
                            <th>ëª©(Jue)</th>
                            <th>ê¸ˆ(Vie)</th>
                            <th style="color:#dc3545">í† (SÃ¡b)</th>
                            <th>í•©(Total)</th>
                        </tr>
                    </thead>
                    <tbody id="matrix-body"></tbody>
                </table>
            </div>
            <div style="text-align:right; margin-top:8px; font-size:11px; color:#fff;">Total Net Time: <span
                    id="input-total-net" style="font-weight:bold; color:#0d6efd; font-size:14px;">0</span> min</div>
            <label style="margin-top:15px;">ì§€ë‚œì£¼ ì´ Loss (PÃ©rdida Anterior)</label><input type="number" id="in-last-loss"
                placeholder="min" onkeyup="renderReport(); autoSave();">
        </div>

        <div class="form-section">
            <h3>3. Loss ìƒì„¸ ê¸°ë¡ (Detalles de PÃ©rdida)</h3>
            <div id="loss-inputs"></div>
            <button class="btn-add" onclick="addLossRow(); autoSave();">+ Loss ì¶”ê°€ (Agregar PÃ©rdida)</button>
        </div>

        <div class="form-section" style="border: 1px solid #28a745;">
            <h3 style="color:#28a745; border-color:#28a745;">5. ì •ë¹„ ë° PM (Mantenimiento / PM)</h3>
            <div id="maint-inputs"></div>
            <button class="btn-add" style="background:#28a745;" onclick="addActivityRow('maint'); autoSave();">+ ì •ë¹„ í™œë™
                ì¶”ê°€ (Agregar Actividad)</button>
        </div>

        <div class="form-section" style="border: 1px solid #17a2b8;">
            <h3 style="color:#17a2b8; border-color:#17a2b8;">6. ê°œì„  í™œë™ (Mejora: Before/After)</h3>
            <div id="improv-inputs"></div>
            <button class="btn-add" style="background:#17a2b8;" onclick="addActivityRow('improv'); autoSave();">+ ê°œì„  í™œë™
                ì¶”ê°€ (Agregar Mejora)</button>
        </div>
    </div>

    <div class="sidebar-controls">
        <a class="home-btn" href="index.html">ğŸ  Home</a>
        <button id="btn-toggle-sidebar" class="btn-toggle-sidebar" onclick="toggleSidebar()">â—€</button>
    </div>

    <div class="resizer" id="dragHandle"></div>



    <div class="preview-panel">
        <h2 style="margin: 0 0 15px 0; color: #333; font-size: 24px; font-weight: bold;">
            <i class="fa-solid fa-wrench"></i>
        </h2>
        <div class="report-container" id="capture-target">
            <div class="header-box">
                <div class="header-logo" id="out-logo-container">
                    <div class="header-logo-placeholder">Logo Area<br>(Sin Logo)</div>
                </div>
                <div class="header-title-area">
                    <h1 id="out-title">2026ë…„ OOì£¼ì°¨ ì„¤ë¹„ Loss ë¶„ì„</h1>
                    <p>Weekly Loss Analysis / AnÃ¡lisis Semanal de PÃ©rdidas</p>
                </div>
                <div class="header-info">
                    <strong>DEPT:</strong> <span id="out-dept-name">ì„¤ë¹„íŒ€ (Equipo)</span><br>
                    <strong>PERIOD:</strong> <span id="out-period-str" style="font-size:10px;">-</span><br>
                    <strong>WRITER:</strong> <span id="out-writer"></span>
                </div>
            </div>

            <div class="section-title">1. ì£¼ê°„ KPI ìš”ì•½ (Resumen Semanal KPI)</div>
            <div class="kpi-container">
                <div class="kpi-card kpi-blue">
                    <h4>ì´ ìˆœ ë¶€í•˜ ì‹œê°„ (Net Time)</h4>
                    <div><span id="out-net-time" class="value">-</span><span class="unit">min</span></div>
                </div>
                <div class="kpi-card kpi-red">
                    <h4>ê¸ˆì£¼ ì´ Loss (PÃ©rdida Total)</h4>
                    <div><span id="out-total-loss" class="value">0</span><span class="unit">min</span></div>
                </div>
                <div class="kpi-card kpi-gray">
                    <h4>ì „ì£¼ ëŒ€ë¹„ ì¦ê° (Tendencia)</h4>
                    <div id="out-trend" style="margin-top:2px;"><span style="color:#aaa;">-</span></div>
                </div>
                <div class="kpi-card kpi-green">
                    <h4>ì‹¤ ê°€ë™ë¥  (Disponibilidad)</h4>
                    <div><span id="out-avail-rate" class="value">100%</span></div>
                </div>
                <div class="kpi-card kpi-info" style="grid-column: span 2;">
                    <h4>MTTR (í‰ê·  ìˆ˜ë¦¬ ì‹œê°„)</h4>
                    <div><span id="out-mttr" class="value">0</span><span class="unit">min</span></div>
                    <div class="kpi-sub">Total Loss / ê±´ìˆ˜ (Fallas)</div>
                </div>
                <div class="kpi-card kpi-green" style="grid-column: span 2;">
                    <h4>MTBF (í‰ê·  ê³ ì¥ ê°„ê²©)</h4>
                    <div><span id="out-mtbf" class="value">0</span><span class="unit">min</span></div>
                    <div class="kpi-sub">(Net Time - Loss) / ê±´ìˆ˜ (Fallas)</div>
                </div>
            </div>

            <div id="machine-detail-title" class="section-title">1.1 ì„¤ë¹„ë³„ ìƒì„¸ ê°€ë™ í˜„í™© (Detalles por Equipo)</div>
            <div id="machine-detail-table" style="margin-bottom:15px;"></div>

            <div class="section-title">2. Loss ë°œìƒ ìƒì„¸ í˜„í™© (Detalles de PÃ©rdida)</div>
            <table>
                <colgroup>
                    <col width="5%">
                    <col width="12%">
                    <col width="18%">
                    <col width="15%">
                    <col width="13%">
                    <col width="7%">
                    <col width="30%">
                </colgroup>
                <thead>
                    <tr>
                        <th>No</th>
                        <th>ë°œìƒì¼ (Fecha)</th>
                        <th id="th-machine">ì„¤ë¹„ (MÃ¡quina)</th>
                        <th id="th-detail">ìƒì„¸ (Detalle)</th>
                        <th>ì‹œê°„ (Hora)</th>
                        <th>Min</th>
                        <th>í˜„ìƒ ë° ì›ì¸ (FenÃ³meno y Causa)</th>
                    </tr>
                </thead>
                <tbody id="out-loss-body"></tbody>
                <tfoot>
                    <tr style="background:#eee; font-weight:bold; color:black;">
                        <td colspan="5">Total Loss Time (Tiempo Total de PÃ©rdida)</td>
                        <td id="out-loss-sum">-</td>
                        <td></td>
                    </tr>
                </tfoot>
            </table>

            <div style="display:flex; gap:20px;">
                <div style="flex:1;">
                    <div class="section-title" style="margin-top:10px;">3. í•­ëª©ë³„ Loss ë¹„ì¤‘ (GrÃ¡fico Circular)</div>
                    <div id="out-chart-area"
                        style="padding:10px; border:1px solid #ccc; border-radius:4px; height:150px;"></div>
                </div>
                <div style="flex:1.2;">
                    <div class="section-title" style="margin-top:10px;">4. Top 5 ê°œì„  ëŒ€ì±… (Top 5 Contramedidas)</div>
                    <table>
                        <colgroup>
                            <col width="8%">
                            <col width="42%">
                            <col width="10%">
                            <col width="40%">
                        </colgroup>
                        <thead>
                            <tr>
                                <th>No</th>
                                <th>í•­ëª© (Item)</th>
                                <th>Loss</th>
                                <th>ëŒ€ì±… (AcciÃ³n)</th>
                            </tr>
                        </thead>
                        <tbody id="out-top5-body"></tbody>
                    </table>
                </div>
            </div>

            <div class="section-title">5. ì •ë¹„ ë° PM í™œë™ (Mantenimiento y PM)</div>
            <div id="out-maint-area" class="photo-grid"></div>

            <div class="section-title">6. ê°œì„  í™œë™ (Mejora Continua: Antes y DespuÃ©s)</div>
            <div id="out-improv-area" class="photo-grid"></div>
            <div style="margin-top: 15px; font-size:11px; color:#666; text-align:right;">* ìˆœ ë¶€í•˜ ì‹œê°„ (Net Time) = (Plan
                Diario Total) Ã— 60min | K = 1,000 unit</div>
        </div>
    </div>

    <script>
        // ==========================================
        // [ì¤‘ìš”] ì—¬ê¸°ì— ë°°í¬í•œ êµ¬ê¸€ ì›¹ ì•± URLì„ ë„£ìœ¼ì„¸ìš”!
        const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyplXRWd-5xW-7tBplQDHWR6fOfSMNlxphIm3bNeiXawkdeBcQnZvuhmNQV5vbxFEhW/exec";
        // ==========================================

        // Resizer removed - using toggle button instead

        // Mutation observer removed - manual resizing not needed

        function toggleSidebar() {
            document.body.classList.toggle('full-screen');
            const btn = document.getElementById('btn-toggle-sidebar');

            if (document.body.classList.contains('full-screen')) {
                btn.innerText = "â–¶";
                btn.title = "Show Sidebar";
            } else {
                btn.innerText = "â—€";
                btn.title = "Hide Sidebar";
            }
        }

        // ì„¤ë¹„íŒ€ ê³ ì •
        const currentDept = 'EQUIP';
        const equipMachines = ["PRESS_A", "PRESS_B", "PRESS_C", "ICE_ROOM", "ESPUMADO"];
        const equipSubData = {
            "PRESS_A": ["#1", "#2", "#3", "#4", "#5", "TRANSFER", "ê¸°íƒ€ (Otros)"],
            "PRESS_B": ["#1", "#2", "#3", "#4", "#5", "TRANSFER", "ê¸°íƒ€ (Otros)"],
            "PRESS_C": ["#1", "#2", "#3", "#4", "#5", "TRANSFER", "ê¸°íƒ€ (Otros)"],
            "ICE_ROOM": ["CAVEZA", "SERVO", "ê¸°íƒ€ (Otros)"],
            "ESPUMADO": ["Cabeza #1", "Cabeza #2", "Cabeza #3", "Opener", "Closer", "MOLD C/V", "Ensamble C/V", "Lift", "ê¸°íƒ€ (Otros)"]
        };

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg; t.style.display = 'block';
            setTimeout(() => t.style.display = 'none', 3000);
        }

        // --- ì´ë¯¸ì§€ ì••ì¶• ìœ í‹¸ë¦¬í‹° (base64 â†’ ì••ì¶• base64) ---
        const CLOUD_IMG_LIMIT = 49000; // êµ¬ê¸€ ì‹œíŠ¸ ì…€ í•œê³„

        function compressBase64ForCloud(base64Str) {
            return new Promise((resolve) => {
                if (!base64Str || base64Str.length < 100) { resolve(""); return; }
                if (base64Str.length <= CLOUD_IMG_LIMIT) { resolve(base64Str); return; }

                const img = new Image();
                img.onload = function () {
                    // ì ì§„ì  ì••ì¶•: í¬ê¸°ì™€ í’ˆì§ˆì„ ë‚®ì¶”ë©´ì„œ í•œê³„ì— ë§ì¶œ ë•Œê¹Œì§€ ë°˜ë³µ
                    const steps = [
                        { maxW: 600, q: 0.5 },
                        { maxW: 400, q: 0.4 },
                        { maxW: 300, q: 0.3 },
                        { maxW: 200, q: 0.2 }
                    ];

                    for (const step of steps) {
                        let w = img.width, h = img.height;
                        if (w > step.maxW) { h *= step.maxW / w; w = step.maxW; }
                        const canvas = document.createElement('canvas');
                        canvas.width = w; canvas.height = h;
                        canvas.getContext('2d').drawImage(img, 0, 0, w, h);
                        const result = canvas.toDataURL('image/jpeg', step.q);
                        if (result.length <= CLOUD_IMG_LIMIT) { resolve(result); return; }
                    }
                    // ìµœì†Œ ì••ì¶•ìœ¼ë¡œë„ ì•ˆ ë˜ë©´ ë¹ˆ ë¬¸ìì—´
                    resolve("");
                };
                img.onerror = () => resolve("");
                img.src = base64Str;
            });
        }

        async function compressDataForCloud(data) {
            let compressed = 0;

            // ë¡œê³  ì••ì¶•
            if (data.logo && data.logo.length > CLOUD_IMG_LIMIT) {
                data.logo = await compressBase64ForCloud(data.logo);
                compressed++;
            }

            // ì •ë¹„ í™œë™ ì´ë¯¸ì§€ ì••ì¶•
            if (data.maint) {
                for (let i = 0; i < data.maint.length; i++) {
                    if (data.maint[i].imgSrc && data.maint[i].imgSrc.length > CLOUD_IMG_LIMIT) {
                        data.maint[i].imgSrc = await compressBase64ForCloud(data.maint[i].imgSrc);
                        compressed++;
                    }
                }
            }

            // ê°œì„  í™œë™ ì´ë¯¸ì§€ ì••ì¶•
            if (data.improv) {
                for (let i = 0; i < data.improv.length; i++) {
                    if (data.improv[i].imgBefore && data.improv[i].imgBefore.length > CLOUD_IMG_LIMIT) {
                        data.improv[i].imgBefore = await compressBase64ForCloud(data.improv[i].imgBefore);
                        compressed++;
                    }
                    if (data.improv[i].imgAfter && data.improv[i].imgAfter.length > CLOUD_IMG_LIMIT) {
                        data.improv[i].imgAfter = await compressBase64ForCloud(data.improv[i].imgAfter);
                        compressed++;
                    }
                }
            }

            return compressed;
        }

        // --- Cloud Functions ---
        async function saveToCloud() {
            if (APPS_SCRIPT_URL.includes("ì—¬ê¸°ì—")) { alert("ì½”ë“œë¥¼ ì—´ì–´ URLì„ ì„¤ì •í•´ì£¼ì„¸ìš”!"); return; }

            const data = gatherData();
            if (!data.startDate) { alert("ì‹œì‘ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }

            // ì£¼ì°¨ ID ê³„ì‚° (ì˜ˆ: 2026-W05)
            const d = new Date(data.startDate);
            const weekId = `${d.getFullYear()}-W${getWeekNumber(d).toString().padStart(2, '0')}`;

            if (!confirm(`[${weekId}] ì£¼ì°¨ë¡œ ë°ì´í„°ë¥¼ ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì£¼ì°¨ë¼ë©´ ë®ì–´ì”ë‹ˆë‹¤)`)) return;

            const btn = document.querySelector('.btn-cloud-save');
            btn.innerText = "ì´ë¯¸ì§€ ì••ì¶• ì¤‘..."; btn.disabled = true;

            try {
                // â˜… í´ë¼ìš°ë“œ ì €ì¥ ì „ ì´ë¯¸ì§€ ìë™ ì••ì¶•
                const compressedCount = await compressDataForCloud(data);
                if (compressedCount > 0) {
                    console.log(`â˜ï¸ ${compressedCount}ê°œ ì´ë¯¸ì§€ ì••ì¶• ì™„ë£Œ`);
                }

                btn.innerText = "ì—…ë¡œë“œ ì¤‘...";

                const payload = {
                    weekId: weekId,
                    startDate: data.startDate,
                    endDate: data.endDate,
                    data: data
                };

                await fetch(APPS_SCRIPT_URL, {
                    method: "POST",
                    mode: "no-cors",
                    headers: { "Content-Type": "text/plain" },
                    body: JSON.stringify(payload)
                });

                showToast(`â˜ï¸ [${weekId}] ì €ì¥ ì™„ë£Œ! (ì´ë¯¸ì§€ ${compressedCount}ê°œ ì••ì¶•)`);
            } catch (error) {
                alert("ì˜¤ë¥˜: " + error.message);
            } finally {
                btn.innerText = "ğŸ“¤ í´ë¼ìš°ë“œ ì €ì¥"; btn.disabled = false;
            }
        }

        // 2. ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° (Open Modal)
        async function openCloudModal() {
            if (APPS_SCRIPT_URL.includes("ì—¬ê¸°ì—")) { alert("ì½”ë“œë¥¼ ì—´ì–´ URLì„ ì„¤ì •í•´ì£¼ì„¸ìš”!"); return; }

            const modal = document.getElementById('cloud-modal');
            const listUl = document.getElementById('cloud-list-ul');
            const btn = document.querySelector('.btn-cloud-load');

            btn.innerText = "ë¡œë”© ì¤‘..."; btn.disabled = true;
            listUl.innerHTML = '<li class="cloud-item" style="justify-content:center;">ë¡œë”© ì¤‘...</li>';
            modal.style.display = 'flex';

            try {
                const fetchUrl = `${APPS_SCRIPT_URL}?cmd=list&t=${new Date().getTime()}`;
                const response = await fetch(fetchUrl);
                const result = await response.json();

                listUl.innerHTML = "";
                if (result.list && result.list.length > 0) {
                    result.list.forEach(item => {
                        const li = document.createElement('li');
                        li.className = 'cloud-item';
                        li.innerHTML = `
                        <div>
                            <div class="cloud-week">${item.weekId}</div>
                            <div class="cloud-date">${item.period}</div>
                        </div>
                        <div style="font-size:0.8rem; color:#888;">${item.updated}</div>
                    `;
                        li.onclick = () => loadCloudData(item.weekId);
                        listUl.appendChild(li);
                    });
                } else {
                    listUl.innerHTML = '<li class="cloud-item" style="justify-content:center;">ì €ì¥ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</li>';
                }
            } catch (e) {
                console.error('ëª©ë¡ ë¡œë“œ ì—ëŸ¬:', e);
                listUl.innerHTML = `<li class="cloud-item" style="color:red; justify-content:center;">ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨<br><small>${e.message || e}</small></li>`;
            } finally {
                btn.innerText = "ğŸ“¥ í´ë¼ìš°ë“œ ë¶ˆëŸ¬ì˜¤ê¸°"; btn.disabled = false;
            }
        }

        // 3. í´ë¼ìš°ë“œ ë°ì´í„° ë¡œë“œ (ë®ì–´ì“°ê¸°)
        async function loadCloudData(weekId) {
            if (!confirm(`[${weekId}] ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì‹œê² ìŠµë‹ˆê¹Œ?\ní˜„ì¬ ì‘ì—… ì¤‘ì¸ ë‚´ìš©ì€ ì‚¬ë¼ì§‘ë‹ˆë‹¤.`)) return;

            document.getElementById('cloud-modal').style.display = 'none';

            try {
                const fetchUrl = `${APPS_SCRIPT_URL}?cmd=load&weekId=${weekId}&t=${new Date().getTime()}`;
                const response = await fetch(fetchUrl);
                const responseText = await response.text();
                console.log('Cloud response:', responseText.substring(0, 500));

                let fetchedData;
                try {
                    fetchedData = JSON.parse(responseText);
                } catch (parseErr) {
                    alert('ì„œë²„ ì‘ë‹µ íŒŒì‹± ì‹¤íŒ¨. ì½˜ì†”ì„ í™•ì¸í•˜ì„¸ìš”.');
                    console.error('Raw response:', responseText);
                    return;
                }

                // ì—ëŸ¬ ì²´í¬
                if (fetchedData.error) {
                    alert('ì„œë²„ ì—ëŸ¬: ' + fetchedData.error);
                    return;
                }

                // ë°ì´í„°ê°€ .data ì•ˆì— ê°ì‹¸ì ¸ ìˆë‹¤ë©´ êº¼ëƒ„
                if (fetchedData.data && !fetchedData.losses) {
                    fetchedData = fetchedData.data;
                }

                restoreDataToForm(fetchedData);
                showToast(`â˜ï¸ [${weekId}] ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ!`);

            } catch (e) {
                alert("ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: " + e.message);
                console.error('Load error:', e);
            }
        }


        window.onload = function () {
            loadCustomReasons();
            initSortable();

            if (localStorage.getItem('loss_report_autosave')) {
                restoreDataToForm(JSON.parse(localStorage.getItem('loss_report_autosave')));
                showToast("ìë™ ì €ì¥ëœ ë‚´ìš©ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.");
            } else {
                const today = new Date();
                const startOfWeek = new Date(today);
                startOfWeek.setDate(today.getDate() - today.getDay() + 1);
                const endOfWeek = new Date(today);
                endOfWeek.setDate(startOfWeek.getDate() + 5);
                document.getElementById('in-start-date').valueAsDate = startOfWeek;
                document.getElementById('in-end-date').valueAsDate = endOfWeek;
                initTable(); // ì´ˆê¸°í™”
            }
        }

        // ì´ˆê¸° í…Œì´ë¸” ë Œë”ë§ í•¨ìˆ˜ ì¶”ê°€
        function initTable() {
            renderMatrix();
            addLossRow();
            renderReport();
        }

        function initSortable() {
            const containers = ['loss-inputs', 'maint-inputs', 'improv-inputs'];
            containers.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    new Sortable(el, {
                        handle: '.drag-handle', animation: 150, ghostClass: 'sortable-ghost',
                        onEnd: function () { renderReport(); autoSave(); }
                    });
                }
            });
        }

        function validateDate(dateInput) {
            if (!dateInput.value) return;
            const inputDate = new Date(dateInput.value);
            const startDate = new Date(document.getElementById('in-start-date').value);
            const endDate = new Date(document.getElementById('in-end-date').value);

            if (inputDate.getFullYear() < 2000) {
                const targetYear = startDate.getFullYear() || new Date().getFullYear();
                inputDate.setFullYear(targetYear);
                dateInput.value = inputDate.toISOString().split('T')[0];
                showToast(`âš ï¸ ì—°ë„ ì˜¤íƒ€ ë³´ì •: ${targetYear}ë…„`);
            }
            if (inputDate < startDate || inputDate > endDate) {
                if (inputDate < startDate || inputDate > endDate) {
                    dateInput.style.backgroundColor = "#ffcccc";
                    dateInput.style.color = "black";
                } else {
                    dateInput.style.backgroundColor = "white";
                    dateInput.style.color = "black";
                }
            }
        }

        function updateReasonList(input) {
            const val = input.value.trim();
            if (!val) return;
            let stored = JSON.parse(localStorage.getItem('custom_reasons')) || [];
            if (!stored.includes(val)) {
                stored.push(val);
                localStorage.setItem('custom_reasons', JSON.stringify(stored));
                const dl = document.getElementById('common-reasons');
                const opt = document.createElement('option'); opt.value = val; dl.appendChild(opt);
            }
            renderReport(); autoSave();
        }

        function loadCustomReasons() {
            let stored = JSON.parse(localStorage.getItem('custom_reasons')) || [];
            const dl = document.getElementById('common-reasons');
            stored.forEach(r => {
                let exists = false;
                for (let i = 0; i < dl.options.length; i++) { if (dl.options[i].value === r) exists = true; }
                if (!exists) { const opt = document.createElement('option'); opt.value = r; dl.appendChild(opt); }
            });
        }

        function duplicateRow(btn) {
            const row = btn.closest('.input-item');
            const clone = row.cloneNode(true);
            const selects = row.querySelectorAll('select');
            const cloneSelects = clone.querySelectorAll('select');
            selects.forEach((s, i) => cloneSelects[i].value = s.value);
            const inputs = row.querySelectorAll('input');
            const cloneInputs = clone.querySelectorAll('input');
            inputs.forEach((inp, i) => cloneInputs[i].value = inp.value);
            row.parentNode.insertBefore(clone, row.nextSibling);
            renderReport(); autoSave();
            showToast("í–‰ ë³µì œë¨");
        }

        function compressImage(file, maxWidth, quality, callback) {
            const reader = new FileReader(); reader.readAsDataURL(file);
            reader.onload = function (event) {
                const img = new Image(); img.src = event.target.result;
                img.onload = function () {
                    let width = img.width; let height = img.height;
                    if (width > maxWidth) { height *= maxWidth / width; width = maxWidth; }
                    const canvas = document.createElement('canvas'); canvas.width = width; canvas.height = height;
                    const ctx = canvas.getContext('2d'); ctx.drawImage(img, 0, 0, width, height);
                    const dataUrl = canvas.toDataURL('image/jpeg', quality); callback(dataUrl);
                }
            }
        }

        function gatherData() {
            const data = {
                dept: currentDept, startDate: document.getElementById('in-start-date').value, endDate: document.getElementById('in-end-date').value,
                writer: document.getElementById('in-writer').value, lastLoss: document.getElementById('in-last-loss').value,
                matrix: [], losses: [], maint: [], improv: [], logo: localStorage.getItem('my_report_logo') || ""
            };
            document.querySelectorAll('#matrix-body tr').forEach(row => { const rowVals = []; row.querySelectorAll('.mat-inp').forEach(inp => rowVals.push(inp.value)); data.matrix.push(rowVals); });
            const lossRows = document.getElementById('loss-inputs').children;
            for (let row of lossRows) {
                data.losses.push({
                    date: row.querySelector('.l-date').value, machine: row.querySelector('.l-machine').value, sub: row.querySelector('.l-sub').value,
                    start: row.querySelector('.l-start').value, end: row.querySelector('.l-end').value,
                    reason: row.querySelector('.l-reason').value,
                    action: row.querySelector('.l-action').value
                });
            }
            const maintRows = document.getElementById('maint-inputs').children;
            for (let row of maintRows) { data.maint.push({ desc: row.querySelector('.act-desc').value, imgSrc: row.querySelector('.hidden-img-data').src }); }
            const improvRows = document.getElementById('improv-inputs').children;
            for (let row of improvRows) { data.improv.push({ desc: row.querySelector('.act-desc').value, imgBefore: row.querySelector('.hidden-img-before').src, imgAfter: row.querySelector('.hidden-img-after').src }); }
            return data;
        }

        function autoSave() { try { localStorage.setItem('loss_report_autosave', JSON.stringify(gatherData())); } catch (e) { console.error(e); } }

        function resetData() { if (confirm("ì´ˆê¸°í™”?")) { localStorage.removeItem('loss_report_autosave'); location.reload(); } }

        function manualSaveFile() {
            const data = gatherData();

            // ì£¼ì°¨ ê³„ì‚° (startDate ê¸°ì¤€)
            let weekStr = 'Temp';
            if (data.startDate) {
                const d = new Date(data.startDate);
                const weekNum = getWeekNumber(d);
                weekStr = `${weekNum}W`;
            }

            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(data));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", `Loss_Data_EQUIP_${weekStr}.json`);
            document.body.appendChild(downloadAnchorNode); downloadAnchorNode.click(); downloadAnchorNode.remove();
        }

        function loadFile(input) {
            const file = input.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = function (e) {
                restoreDataToForm(JSON.parse(e.target.result));
                alert("ğŸ“‚ ë¡œì»¬ íŒŒì¼ ë¡œë“œ ì™„ë£Œ!");
            };
            reader.readAsText(file); input.value = "";
        }

        // --- ğŸ› ï¸ ê³µí†µ ë°ì´í„° ë³µêµ¬ ë¡œì§ (ë¡œì»¬/í´ë¼ìš°ë“œ ê²¸ìš©) ---
        function restoreDataToForm(data) {
            try {
                // ê¸°ë³¸ ì •ë³´
                if (data.startDate) document.getElementById('in-start-date').value = data.startDate;
                if (data.endDate) document.getElementById('in-end-date').value = data.endDate;
                if (data.writer) document.getElementById('in-writer').value = data.writer;
                if (data.lastLoss) document.getElementById('in-last-loss').value = data.lastLoss;
                if (data.logo) { document.getElementById('out-logo-container').innerHTML = `<img src="${data.logo}" alt="Logo">`; localStorage.setItem('my_report_logo', data.logo); }

                // ë§¤íŠ¸ë¦­ìŠ¤
                renderMatrix();
                const matrixRows = document.querySelectorAll('#matrix-body tr');
                if (data.matrix && data.matrix.length === matrixRows.length) {
                    matrixRows.forEach((row, idx) => {
                        const inputs = row.querySelectorAll('.mat-inp');
                        inputs.forEach((inp, i) => inp.value = data.matrix[idx][i]);
                    });
                }

                // Loss ìƒì„¸ (ë®ì–´ì“°ê¸° ëª¨ë“œ)
                document.getElementById('loss-inputs').innerHTML = "";
                if (data.losses && data.losses.length > 0) {
                    data.losses.forEach(lossData => {
                        addLossRow();
                        const newRow = document.getElementById('loss-inputs').lastElementChild;
                        const dateInput = newRow.querySelector('.l-date');
                        dateInput.value = lossData.date || "";
                        validateDate(dateInput);
                        newRow.querySelector('.l-machine').value = lossData.machine;
                        updateSub(newRow.querySelector('.l-machine')); // Sub update í•„ìˆ˜
                        newRow.querySelector('.l-sub').value = lossData.sub;
                        newRow.querySelector('.l-start').value = lossData.start;
                        newRow.querySelector('.l-end').value = lossData.end;
                        newRow.querySelector('.l-reason').value = lossData.reason;
                        newRow.querySelector('.l-action').value = lossData.action || "";
                        calcTimeDiff(newRow.querySelector('.l-start'));
                    });
                } else {
                    addLossRow();
                }

                // ì •ë¹„ í™œë™
                document.getElementById('maint-inputs').innerHTML = "";
                if (data.maint) {
                    data.maint.forEach(d => {
                        addActivityRow('maint');
                        const row = document.getElementById('maint-inputs').lastElementChild;
                        row.querySelector('.act-desc').value = d.desc;
                        row.querySelector('.hidden-img-data').src = d.imgSrc;
                    });
                }

                // ê°œì„  í™œë™
                document.getElementById('improv-inputs').innerHTML = "";
                if (data.improv) {
                    data.improv.forEach(d => {
                        addActivityRow('improv');
                        const row = document.getElementById('improv-inputs').lastElementChild;
                        row.querySelector('.act-desc').value = d.desc;
                        row.querySelector('.hidden-img-before').src = d.imgBefore;
                        row.querySelector('.hidden-img-after').src = d.imgAfter;
                    });
                }

                renderReport(); autoSave();
            } catch (err) {
                alert("ë°ì´í„° ë³µêµ¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + err.message);
                console.error(err);
            }
        }



        function captureImage() { const target = document.getElementById('capture-target'); html2canvas(target, { scale: 2, useCORS: true }).then(canvas => { const link = document.createElement('a'); const dateStr = document.getElementById('in-end-date').value || 'Report'; link.download = `Loss_Report_${dateStr}.png`; link.href = canvas.toDataURL("image/png"); link.click(); }); }
        function handleImage(input, targetClass) { if (input.files && input.files[0]) { compressImage(input.files[0], 800, 0.7, function (dataUrl) { const targetImg = input.parentElement.parentElement.querySelector(`.${targetClass}`) || input.closest('div').parentElement.querySelector(`.${targetClass}`); if (targetImg) { targetImg.src = dataUrl; renderReport(); autoSave(); } }); } }
        function handleLogoUpload(input) { if (input.files && input.files[0]) { compressImage(input.files[0], 300, 0.8, function (dataUrl) { document.getElementById('out-logo-container').innerHTML = `<img src="${dataUrl}" alt="Logo">`; localStorage.setItem('my_report_logo', dataUrl); autoSave(); }); } }
        function formatK(num) { if (num >= 1000) { return (num / 1000).toFixed(1) + "k"; } return num; }
        function applyBatchMatrix() { const weekH = document.getElementById('batch-week').value; const satH = document.getElementById('batch-sat').value; document.querySelectorAll('#matrix-body tr').forEach(row => { const inputs = row.querySelectorAll('input'); for (let i = 0; i < 5; i++) inputs[i].value = weekH; inputs[5].value = satH; }); calcTotalTime(); renderReport(); autoSave(); }

        function renderMatrix() {
            const tbody = document.getElementById('matrix-body');
            tbody.innerHTML = "";
            const machines = equipMachines;
            machines.forEach(m => {
                const tr = document.createElement('tr');
                let cols = `<td class="matrix-machine">${m}</td>`;
                for (let i = 0; i < 6; i++) cols += `<td><input type="number" class="mat-inp" value="24" onkeyup="calcTotalTime(); renderReport(); autoSave();"></td>`;
                cols += `<td class="matrix-sum" id="sum-${m}">0</td>`;
                tr.innerHTML = cols;
                tbody.appendChild(tr);
            });
            calcTotalTime();
        }

        function calcTotalTime() { let grandTotalMin = 0; document.querySelectorAll('#matrix-body tr').forEach(row => { let rowSumH = 0; row.querySelectorAll('.mat-inp').forEach(inp => { rowSumH += parseFloat(inp.value) || 0; }); row.querySelector('.matrix-sum').innerText = rowSumH; grandTotalMin += (rowSumH * 60); }); document.getElementById('input-total-net').innerText = formatK(grandTotalMin); return grandTotalMin; }

        function getWeekNumber(date) {
            const target = new Date(date);
            target.setHours(0, 0, 0, 0);
            const yearStart = new Date(target.getFullYear(), 0, 1);
            const diffDays = Math.floor((target - yearStart) / 86400000);
            const startDayOffset = yearStart.getDay();
            return Math.ceil((diffDays + startDayOffset + 1) / 7);
        }

        function removeRow(btn) { if (confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) { btn.closest('.input-item').remove(); renderReport(); autoSave(); } }

        function addLossRow() {
            const div = document.createElement('div');
            div.className = 'input-item';
            div.style.background = "#2c3034"; div.style.padding = "8px"; div.style.marginBottom = "5px"; div.style.borderRadius = "4px"; div.style.border = "1px solid #444";

            let primaryOpts = `<option value="">-- ì„¤ë¹„ (MÃ¡quina) --</option>`;
            equipMachines.forEach(m => { primaryOpts += `<option value="${m}">${m}</option>`; });
            let subOpts = `<option value="-">-- ë¶€í’ˆ (Parte) --</option>`;

            div.innerHTML = `
            <div style="display:flex; justify-content:space-between; margin-bottom:5px; align-items:center;">
                <div style="display:flex; align-items:center;">
                    <span class="drag-handle">â˜°</span>
                    <div style="color:#ddd; font-size:0.8rem;">ğŸ“… <input type="date" class="l-date" onchange="validateDate(this); renderReport(); autoSave();" style="width:auto; display:inline-block;"></div>
                </div>
                <div class="btn-action-group">
                    <button class="btn-sm btn-copy" onclick="duplicateRow(this)">ğŸ“‘ ë³µì‚¬</button>
                    <button class="btn-sm btn-del" onclick="removeRow(this)">ğŸ—‘ï¸ ì‚­ì œ</button>
                </div>
            </div>
            <select class="l-machine" onchange="updateSub(this); renderReport(); autoSave();" style="width:100%; margin-bottom:5px; background:#0d6efd; color:white; font-weight:bold;">${primaryOpts}</select>
            <select class="l-sub" onchange="renderReport(); autoSave();" style="width:100%;">${subOpts}</select>
            <div style="display:flex; gap:5px; margin-top:5px;">
                <input type="time" class="l-start" onchange="calcTimeDiff(this); renderReport(); autoSave();">
                <input type="time" class="l-end" onchange="calcTimeDiff(this); renderReport(); autoSave();">
                <input type="number" class="l-min" placeholder="min" readonly style="width:50px; background:#eee; font-weight:bold; color:black;">
            </div>
            <input type="text" class="l-reason" list="common-reasons" placeholder="í˜„ìƒ ë° ì›ì¸ (FenÃ³meno y Causa)" onchange="updateReasonList(this)" onkeyup="renderReport(); autoSave();" style="margin-top:5px;">
            <input type="text" class="l-action" placeholder="ëŒ€ì±… ë° ì¡°ì¹˜ (AcciÃ³n / Medida)" onkeyup="renderReport(); autoSave();" style="margin-top:5px; background:#e9ecef; font-weight:bold; color:black;">
        `;
            document.getElementById('loss-inputs').appendChild(div);
        }

        function addActivityRow(type) {
            const container = document.getElementById(type + '-inputs');
            const div = document.createElement('div');
            div.className = 'input-item';
            div.style.background = "#2c3034"; div.style.padding = "8px"; div.style.marginBottom = "5px"; div.style.borderRadius = "4px"; div.style.border = "1px solid #666";

            const headerHtml = `
            <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                <span class="drag-handle">â˜°</span>
                <div class="btn-action-group">
                    <button class="btn-sm btn-copy" onclick="duplicateRow(this)">ğŸ“‘ ë³µì‚¬</button>
                    <button class="btn-sm btn-del" onclick="removeRow(this)">ğŸ—‘ï¸ ì‚­ì œ</button>
                </div>
            </div>`;

            if (type === 'maint') {
                div.innerHTML = `
                ${headerHtml}
                <input type="text" class="act-desc" placeholder="ì •ë¹„ ë‚´ìš© (DescripciÃ³n)" onkeyup="renderReport(); autoSave();">
                <label class="file-upload-btn">ğŸ“· ì‚¬ì§„ (Foto)<input type="file" accept="image/*" onchange="handleImage(this, 'hidden-img-data')"></label>
                <img class="hidden-img-data" style="display:none;" src="">
            `;
            } else {
                div.innerHTML = `
                ${headerHtml}
                <input type="text" class="act-desc" placeholder="ê°œì„  ë‚´ìš© (DescripciÃ³n)" onkeyup="renderReport(); autoSave();">
                <div style="display:flex; gap:5px;">
                    <label class="file-upload-btn" style="flex:1; background:#dc3545;">ğŸ“· ì „ (Before)<input type="file" accept="image/*" onchange="handleImage(this, 'hidden-img-before')"></label>
                    <label class="file-upload-btn" style="flex:1; background:#0d6efd;">ğŸ“· í›„ (After)<input type="file" accept="image/*" onchange="handleImage(this, 'hidden-img-after')"></label>
                </div>
                <img class="hidden-img-before" style="display:none;" src="">
                <img class="hidden-img-after" style="display:none;" src="">
            `;
            }
            container.appendChild(div);
        }

        function updateSub(selectObj) {
            const machine = selectObj.value; const subSelect = selectObj.parentElement.querySelector('.l-sub');
            subSelect.innerHTML = '<option value="-">-- ë¶€í’ˆ (Parte) --</option>';
            if (equipSubData[machine]) { equipSubData[machine].forEach(item => { subSelect.innerHTML += `<option value="${item}">${item}</option>`; }); }
        }
        function calcTimeDiff(inputObj) {
            const timeContainer = inputObj.parentElement;
            const start = timeContainer.querySelector('.l-start').value;
            const end = timeContainer.querySelector('.l-end').value;
            if (start && end) {
                let s = new Date("2000-01-01 " + start);
                let e = new Date("2000-01-01 " + end);
                let diff = (e - s) / 60000;
                if (diff < 0) diff += 1440;
                timeContainer.querySelector('.l-min').value = diff;
            }
        }
        function drawPieChart(data, elementId) {
            const container = document.getElementById(elementId); container.innerHTML = "";
            if (data.length === 0) { container.innerHTML = "<div style='text-align:center; width:100%; color:#aaa; font-size:11px;'>No Data</div>"; return; }
            const colors = ['#0d6efd', '#dc3545', '#198754', '#ffc107', '#0dcaf0', '#6610f2', '#fd7e14', '#20c997', '#d63384', '#6c757d'];
            let total = data.reduce((sum, item) => sum + item.value, 0); let cumulativePercent = 0;
            let svgHtml = `<svg viewBox="-1 -1 2 2" class="pie-chart-svg" style="transform: rotate(-90deg);">`;
            data.forEach((item, index) => {
                const percent = item.value / total; const startPercent = cumulativePercent; const endPercent = cumulativePercent + percent; cumulativePercent += percent;
                const x1 = Math.cos(2 * Math.PI * startPercent); const y1 = Math.sin(2 * Math.PI * startPercent);
                const x2 = Math.cos(2 * Math.PI * endPercent); const y2 = Math.sin(2 * Math.PI * endPercent);
                const largeArcFlag = percent > 0.5 ? 1 : 0; const color = colors[index % colors.length];
                const pathData = `M 0 0 L ${x1} ${y1} A 1 1 0 ${largeArcFlag} 1 ${x2} ${y2} Z`;
                svgHtml += `<path d="${pathData}" fill="${color}" stroke="white" stroke-width="0.02"></path>`;
            });
            svgHtml += `<circle cx="0" cy="0" r="0.5" fill="white"></circle></svg>`;
            let legendHtml = `<div class="pie-legend">`;
            data.forEach((item, index) => { const color = colors[index % colors.length]; const percent = ((item.value / total) * 100).toFixed(1); legendHtml += `<div class="legend-item"><div class="legend-color" style="background:${color};"></div><div class="legend-text" title="${item.label}">${item.label}</div><div class="legend-value">${percent}%</div></div>`; });
            legendHtml += `</div>`; container.innerHTML = `<div class="pie-chart-container">${svgHtml}${legendHtml}</div>`;
        }
        function renderMachineStatusTable() {
            const tableContainer = document.getElementById('machine-detail-table'); const titleContainer = document.getElementById('machine-detail-title');
            if (!tableContainer) return;
            // ì„¤ë¹„íŒ€ì´ë¯€ë¡œ í•­ìƒ í‘œì‹œ
            titleContainer.style.display = 'block'; tableContainer.style.display = 'block';

            const machineData = {}; const matrixRows = document.querySelectorAll('#matrix-body tr');
            matrixRows.forEach(row => {
                const machineName = row.cells[0].innerText.trim(); let weeklyPlanMin = 0;
                row.querySelectorAll('.mat-inp').forEach(input => { if (!input.disabled && !input.readOnly && input.value) { weeklyPlanMin += (parseFloat(input.value) || 0) * 60; } });
                machineData[machineName] = { plan: weeklyPlanMin, loss: 0 };
            });
            const lossContainer = document.getElementById('loss-inputs');
            if (lossContainer) { Array.from(lossContainer.children).forEach(row => { const select = row.querySelector('.l-machine'); const minInput = row.querySelector('.l-min'); if (select && minInput && select.value) { const machine = select.value; const time = parseFloat(minInput.value) || 0; if (machineData[machine]) { machineData[machine].loss += time; } else { machineData[machine] = { plan: 0, loss: time }; } } }); }
            let html = `<table style="width:100%; border-collapse: collapse; text-align: center; font-size: 11px; margin-bottom: 10px;"><colgroup><col width="30%"><col width="20%"><col width="20%"><col width="30%"></colgroup><thead><tr style="background-color: #f1f3f5; border-bottom: 2px solid #333;"><th style="padding:6px; background:#f8f9fa;">ì„¤ë¹„ (Machine)</th><th style="padding:6px; background:#f8f9fa;">ì´ ë¶€í•˜ (Total Load)</th><th style="padding:6px; background:#f8f9fa;">Loss ì‹œê°„ (Loss Time)</th><th style="padding:6px; background:#f8f9fa;">ê°€ë™ë¥  (Availability)</th></tr></thead><tbody>`;
            const sortedMachines = Object.keys(machineData).sort();
            sortedMachines.forEach(machine => {
                const data = machineData[machine]; let availText = "-"; let colorStyle = "color:#333;";
                if (data.plan > 0) { const avail = ((data.plan - data.loss) / data.plan) * 100; availText = avail.toFixed(1) + "%"; if (avail >= 90) colorStyle = "color:#198754; font-weight:bold;"; else if (avail < 80) colorStyle = "color:#dc3545; font-weight:bold;"; }
                else if (data.loss > 0) { availText = "Error (No Plan)"; colorStyle = "color:#dc3545; font-weight:bold;"; }
                html += `<tr style="border-bottom: 1px solid #eee;"><td style="padding:5px; background:#fcfcfc; font-weight:bold; text-align:left;">${machine}</td><td style="padding:5px;">${data.plan > 0 ? formatK(data.plan) + ' min' : '-'}</td><td style="padding:5px;">${data.loss > 0 ? formatK(data.loss) + ' min' : '-'}</td><td style="padding:5px; ${colorStyle}">${availText}</td></tr>`;
            });
            html += `</tbody></table>`; tableContainer.innerHTML = html;
        }
        function renderReport() {
            const sVal = document.getElementById('in-start-date').value; const eVal = document.getElementById('in-end-date').value;
            if (sVal && eVal) { const parts = sVal.split("-"); const d = new Date(parts[0], parts[1] - 1, parts[2]); document.getElementById('out-title').innerText = `${d.getFullYear()}ë…„ ${getWeekNumber(d)}ì£¼ì°¨ ì„¤ë¹„ Loss ë¶„ì„`; document.getElementById('out-period-str').innerText = `${sVal} ~ ${eVal}`; }
            document.getElementById('out-writer').innerText = document.getElementById('in-writer').value;
            const totalNetMin = calcTotalTime(); document.getElementById('out-net-time').innerText = formatK(totalNetMin);
            const tbody = document.getElementById('out-loss-body'); tbody.innerHTML = ""; let totalLoss = 0; let lossCount = 0;
            let itemDetailMap = {};

            Array.from(document.getElementById('loss-inputs').children).forEach((row, idx) => {
                const date = row.querySelector('.l-date').value || "-";
                const machTxt = row.querySelector('.l-machine').options[row.querySelector('.l-machine').selectedIndex]?.text || "-";
                const subTxt = row.querySelector('.l-sub').options[row.querySelector('.l-sub').selectedIndex]?.text || "-";
                const min = parseFloat(row.querySelector('.l-min').value) || 0;
                const reason = row.querySelector('.l-reason').value || "";
                const action = row.querySelector('.l-action').value || "";

                if (min > 0 || reason) {
                    totalLoss += min;
                    if (row.querySelector('.l-machine').value) {
                        const key = `${machTxt} [${subTxt}]`;
                        if (!itemDetailMap[key]) itemDetailMap[key] = { value: 0, actions: [] };
                        itemDetailMap[key].value += min;
                        if (action) itemDetailMap[key].actions.push(action);
                        lossCount++;
                    }
                    tbody.innerHTML += `<tr><td>${idx + 1}</td><td>${date}</td><td style="font-weight:bold;">${machTxt}</td><td>${subTxt}</td><td>${row.querySelector('.l-start').value}~${row.querySelector('.l-end').value}</td><td>${min}</td><td class="text-left">${reason}<br><span style='color:#0056b3; font-size:9px;'>â†³ ${action}</span></td></tr>`;
                }
            });

            document.getElementById('out-loss-sum').innerText = formatK(totalLoss); document.getElementById('out-total-loss').innerText = formatK(totalLoss);
            document.getElementById('out-avail-rate').innerText = totalNetMin > 0 ? (((totalNetMin - totalLoss) / totalNetMin) * 100).toFixed(1) + "%" : "0%";
            const lastLoss = parseFloat(document.getElementById('in-last-loss').value) || 0; const diff = totalLoss - lastLoss;
            document.getElementById('out-trend').innerHTML = lastLoss > 0 ? (diff > 0 ? `<span class="trend-up">â–² ${formatK(Math.abs(diff))} (Bad)</span>` : (diff < 0 ? `<span class="trend-down">â–¼ ${formatK(Math.abs(diff))} (Good)</span>` : `<span class="trend-flat">-</span>`)) : `<span style="font-size:12px; color:#aaa;">-</span>`;
            const mttr = lossCount > 0 ? (totalLoss / lossCount).toFixed(1) : 0; const mtbf = lossCount > 0 ? ((totalNetMin - totalLoss) / lossCount).toFixed(1) : (totalNetMin > 0 ? "âˆ" : 0);
            document.getElementById('out-mttr').innerText = mttr; document.getElementById('out-mtbf').innerText = mtbf;
            renderMachineStatusTable();

            const sortedItems = Object.keys(itemDetailMap).map(key => ({ label: key, value: itemDetailMap[key].value, actions: itemDetailMap[key].actions })).sort((a, b) => b.value - a.value);
            drawPieChart(sortedItems, 'out-chart-area');

            const top5Body = document.getElementById('out-top5-body');
            top5Body.innerHTML = "";
            for (let i = 0; i < 5; i++) {
                if (i < sortedItems.length) {
                    const item = sortedItems[i];
                    const actionStr = item.actions.length > 0 ? item.actions[0] : "-";
                    top5Body.innerHTML += `<tr><td style="font-weight:bold; color:red;">${i + 1}</td><td style="font-weight:bold; color:#333;">${item.label}</td><td>${formatK(item.value)}</td><td class="text-left" style="color:#0056b3; font-weight:bold;">${actionStr}</td></tr>`;
                } else {
                    top5Body.innerHTML += `<tr><td>${i + 1}</td><td style="color:#eee;">-</td><td>-</td><td></td></tr>`;
                }
            }
            renderActivity('maint', 'out-maint-area'); renderActivity('improv', 'out-improv-area');
        }
        function renderActivity(inputId, outputId) {
            const container = document.getElementById(outputId); container.innerHTML = ""; const inputs = document.getElementById(inputId + '-inputs').children;
            for (let row of inputs) {
                const desc = row.querySelector('.act-desc').value;
                if (inputId === 'maint') { const img = row.querySelector('.hidden-img-data').src; if (desc || (img && img.length > 100)) { container.innerHTML += `<div class="photo-item"><div class="photo-img-box">${img && img.length > 100 ? `<img src="${img}">` : '<span style="color:#ccc;">No Image</span>'}</div><div class="photo-desc">${desc}</div></div>`; } }
                else { const imgBefore = row.querySelector('.hidden-img-before').src; const imgAfter = row.querySelector('.hidden-img-after').src; if (desc || (imgBefore.length > 100 || imgAfter.length > 100)) { container.innerHTML += `<div class="photo-item"><div class="ba-container"><div class="ba-box"><div class="ba-label">Before (ì „)</div><div class="ba-img">${imgBefore && imgBefore.length > 100 ? `<img src="${imgBefore}" style="width:100%; height:100%; object-fit:cover; object-position: center;">` : `<div class="ba-placeholder">No Image</div>`}</div></div><div class="ba-box"><div class="ba-label">After (í›„)</div><div class="ba-img">${imgAfter && imgAfter.length > 100 ? `<img src="${imgAfter}" style="width:100%; height:100%; object-fit:cover; object-position: center;">` : `<div class="ba-placeholder">No Image</div>`}</div></div></div><div class="photo-desc">${desc}</div></div>`; } }
            }
        }
    </script>
</body>

</html>