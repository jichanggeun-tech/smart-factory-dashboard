<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <title>Paileria - GestiÃ³n de Proyectos y Reparaciones (í”„ë¡œì íŠ¸Â·ìˆ˜ë¦¬ ê´€ë¦¬)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            --bg-body: #111827;
            --bg-nav: #1f2937;
            --bg-card: #2d3748;
            --bg-input: #374151;
            --text-main: #f9fafb;
            --text-muted: #9ca3af;
            --accent: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --blue: #3b82f6;
            --border: #4b5563;
            --text-dark: #111827;
        }

        body {
            margin: 0;
            padding: 0;
            background: var(--bg-body);
            display: flex;
            height: 100vh;
            font-family: 'Segoe UI', 'Malgun Gothic', sans-serif;
            color: var(--text-main);
            overflow: hidden;
        }

        .input-panel {
            width: 560px;
            min-width: 420px;
            background: var(--bg-nav);
            padding: 16px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 12px;
            border-right: 1px solid var(--border);
            z-index: 10;
            height: 100vh;
            box-sizing: border-box;
        }

        .input-panel h2 {
            border-bottom: 2px solid var(--border);
            padding-bottom: 10px;
            font-size: 1.3rem;
            margin: 0;
            color: var(--blue);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        input,
        textarea,
        select {
            background: var(--bg-input);
            color: var(--text-main);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 6px 8px;
            width: 100%;
            box-sizing: border-box;
            font-family: inherit;
            font-size: 0.85rem;
        }

        input:focus,
        textarea:focus,
        select:focus {
            outline: 2px solid var(--blue);
            border-color: transparent;
        }

        label {
            display: block;
            margin-bottom: 3px;
            font-size: 0.7rem;
            color: var(--text-muted);
            font-weight: 600;
        }

        .sidebar-controls {
            display: flex;
            align-items: center;
            position: fixed;
            top: 15px;
            left: 15px;
            z-index: 1001;
        }

        .home-btn {
            background: #334155;
            color: #e2e8f0;
            border: 1px solid #475569;
            border-radius: 8px 0 0 8px;
            height: 28px;
            padding: 0 10px;
            text-decoration: none;
            font-size: 12px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .home-btn:hover {
            background: #4285F4;
            color: #fff;
        }

        .btn-toggle-sidebar {
            width: 24px;
            height: 28px;
            background: #1e293b;
            border: 1px solid #334155;
            border-left: none;
            border-radius: 0 8px 8px 0;
            color: #94a3b8;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            padding: 0;
        }

        .btn-toggle-sidebar:hover {
            color: white;
            background: #334155;
        }

        body.full-screen .input-panel,
        .resizer {
            display: none;
        }

        .preview-panel {
            flex: 1;
            background: #f0f4f8;
            overflow-y: auto;
            padding: 30px;
            display: block;
            position: relative;
        }

        .report-container {
            width: 100%;
            max-width: 1100px;
            margin: 0 auto;
            background: white;
            padding: 50px;
            box-sizing: border-box;
            box-shadow: 0 20px 40px rgba(0, 0, 0, .08);
            border-radius: 8px;
            color: var(--text-dark);
            min-height: 100%;
        }

        /* Summary Cards */
        .summary-container {
            display: flex;
            gap: 12px;
            margin-bottom: 40px;
            flex-wrap: wrap;
        }

        .summary-card {
            flex: 1;
            min-width: 160px;
            padding: 18px 12px;
            border-radius: 10px;
            background: white;
            border: 1px solid #edf2f7;
            text-align: center;
            border-bottom: 4px solid #cbd5e0;
            box-shadow: 0 4px 6px rgba(0, 0, 0, .02);
        }

        .summary-card h4 {
            margin: 0 0 8px;
            font-size: 10px;
            color: #718096;
            text-transform: uppercase;
            font-weight: 700;
        }

        .summary-card .value {
            font-size: 28px;
            font-weight: 800;
            color: #1a202c;
        }

        .summary-card .sub {
            font-size: 10px;
            color: #a0aec0;
            margin-top: 3px;
        }

        /* Section Title */
        .section-title {
            font-size: 17px;
            font-weight: 800;
            margin: 35px 0 12px;
            display: flex;
            align-items: center;
            color: #1a202c;
        }

        .section-title::before {
            content: "";
            width: 5px;
            height: 22px;
            background: var(--accent);
            margin-right: 10px;
            border-radius: 3px;
        }

        /* Tables */
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
            margin-bottom: 18px;
        }

        th,
        td {
            border: 1px solid #9ca3af;
            padding: 10px 6px;
            text-align: center;
            vertical-align: middle;
            background: #fff;
            word-break: break-all;
        }

        th {
            background: #f8fafc;
            color: #4a5568;
            font-weight: 800;
        }

        tr:nth-child(even) td {
            background: #fafbfd;
        }

        .badge {
            padding: 3px 9px;
            border-radius: 50px;
            font-size: 10px;
            font-weight: 800;
            color: white;
            display: inline-block;
        }

        .bg-done {
            background: #15803d;
        }

        .bg-prog {
            background: #0f766e;
        }

        /* Form sections */
        .form-section {
            background: #343a40;
            padding: 14px;
            border-radius: 8px;
            border: 1px solid #495057;
            margin-bottom: 8px;
        }

        .form-section h3 {
            font-size: 0.87rem;
            border-bottom: 1px solid #555;
            padding-bottom: 6px;
            margin: 0 0 10px;
            color: #e9ecef;
        }

        /* Project cards in input */
        .project-card {
            background: #2b3035;
            border: 1px solid #495057;
            border-radius: 6px;
            margin-bottom: 8px;
            position: relative;
        }

        .card-header {
            background: #3c4249;
            height: 34px;
            display: flex;
            align-items: stretch;
            border-bottom: 1px solid #495057;
        }

        .move-controls {
            width: 24px;
            background: #343a40;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #495057;
        }

        .btn-move {
            flex: 1;
            border: none;
            background: transparent;
            color: #adb5bd;
            cursor: pointer;
            font-size: 8px;
            padding: 0;
        }

        .btn-move:first-child {
            border-bottom: 1px solid #495057;
        }

        .btn-move:hover {
            background: #495057;
            color: var(--accent);
        }

        .header-content {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 8px;
            cursor: pointer;
        }

        .header-content:hover {
            background: #454d55;
        }

        .card-title-text {
            color: #e9ecef;
            font-size: 0.82rem;
            font-weight: bold;
        }

        .card-info {
            font-size: 0.72rem;
            color: #adb5bd;
        }

        .card-actions {
            display: flex;
            align-items: center;
            gap: 3px;
            padding: 0 6px;
            background: #343a40;
            border-left: 1px solid #495057;
        }

        .btn-sm {
            width: 22px;
            height: 22px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            color: white;
        }

        .btn-del {
            background: var(--danger);
        }

        .card-body {
            padding: 12px;
        }

        .btn {
            background: #374151;
            border: 1px solid #4b5563;
            color: #f9fafb;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: .2s;
            height: 38px;
            width: 100%;
            font-size: 0.85rem;
        }

        .btn:hover {
            filter: brightness(1.15);
        }

        .btn-green {
            background: #065f46;
            border-color: #10b981;
        }

        .btn-blue {
            background: #1e3a5f;
            border-color: #3b82f6;
        }

        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(33, 37, 41, .95);
            color: var(--accent);
            padding: 10px 22px;
            border-radius: 30px;
            font-size: .88rem;
            z-index: 9999;
            display: none;
            box-shadow: 0 4px 15px rgba(0, 0, 0, .5);
            border: 1px solid var(--accent);
            font-weight: bold;
        }

        /* Repair section in output */
        .repair-date-bar {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 16px;
            padding: 12px;
            background: #f0f4f8;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            flex-wrap: wrap;
        }

        .repair-date-bar label {
            margin: 0;
            font-size: 0.78rem;
            color: #4a5568;
            font-weight: 700;
            white-space: nowrap;
        }

        .repair-date-bar input[type=date] {
            background: white;
            color: #1a202c;
            border: 1px solid #cbd5e0;
            border-radius: 6px;
            padding: 5px 8px;
            font-size: 0.83rem;
            width: auto;
        }

        .repair-stat-cards {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .repair-stat-card {
            flex: 1;
            min-width: 140px;
            padding: 16px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            text-align: center;
        }

        .checkbox-group-out {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 4px;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 10px;
            max-height: 140px;
            overflow-y: auto;
        }

        .checkbox-small {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.75rem;
            padding: 3px 0;
        }

        .checkbox-small input {
            width: auto;
            padding: 0;
        }

        /* Completion section */
        .completion-card {
            background: #2b3035;
            border: 1px solid #10b981;
            border-radius: 6px;
            margin-bottom: 8px;
            padding: 10px;
        }

        @media print {

            body,
            html {
                margin: 0;
                padding: 0;
                height: auto !important;
                overflow: visible !important;
                background: white;
            }

            .input-panel,
            .btn,
            .form-section,
            .toast,
            .sidebar-controls {
                display: none !important;
            }

            .preview-panel {
                display: block;
                width: 100% !important;
                height: auto !important;
                padding: 0 !important;
                background: white;
            }

            .report-container {
                width: 100% !important;
                max-width: none !important;
                margin: 0 !important;
                padding: 20px !important;
                box-shadow: none !important;
            }
        }
    </style>
</head>

<body>
    <div id="saveToast" class="toast">ğŸ’¾ ì €ì¥ ì™„ë£Œ! (Guardado)</div>
    <div id="cloudToast" class="toast" style="border-color:#4285F4;color:#4285F4;">â˜ï¸ ì²˜ë¦¬ ì™„ë£Œ!</div>

    <!-- Input Panel -->
    <div class="input-panel" id="leftPanel">
        <h2>ğŸ­ PailerÃ­a</h2>

        <!-- ì¸ì‡„/ìŠ¤í¬ë¦°ìƒ· -->
        <div style="display:flex;gap:6px;">
            <button class="btn" onclick="window.print()" style="flex:1;">ğŸ–¨ï¸ PDF ì¸ì‡„ (Imprimir)</button>
            <button class="btn" onclick="exportImage()" style="flex:1;">ğŸ“¸ ìŠ¤í¬ë¦°ìƒ· (Captura)</button>
        </div>

        <!-- íŒŒì¼/í´ë¼ìš°ë“œ -->
        <div class="form-section">
            <h3>ğŸ“‚ êµ¬ê¸€ ì‹œíŠ¸ ë° íŒŒì¼ (Google Sheet &amp; File)</h3>
            <div style="display:flex;gap:6px;margin-bottom:8px;">
                <button class="btn btn-blue" onclick="saveToCloud()" style="flex:1;">â˜ï¸ ì €ì¥ (Guardar)</button>
                <button class="btn btn-blue" onclick="openCloudModal()" style="flex:1;">â˜ï¸ ë¶ˆëŸ¬ì˜¤ê¸° (Cargar)</button>
            </div>
            <div style="display:flex;gap:8px;">
                <div style="flex:1;"><label>ë³´ê³  ë‚ ì§œ (Fecha del Reporte)</label><input type="date" id="in-date"
                        onchange="renderReport()"></div>
            </div>
            <div style="display:flex;gap:6px;margin-top:10px;">
                <button class="btn" style="flex:1;" onclick="manualSaveFile()">ğŸ’¾ íŒŒì¼ ë°±ì—… (Backup)</button>
                <label class="btn" style="flex:1;cursor:pointer;">ğŸ“‚ íŒŒì¼ ì—´ê¸° (Abrir)<input type="file" id="file-input"
                        accept=".json" onchange="handleFileLoad(this)" style="display:none;"></label>
            </div>
        </div>

        <!-- ìˆ˜ë¦¬ ì‹¤ì  ì…ë ¥ -->
        <div class="form-section">
            <h3>ğŸ”§ ìˆ˜ë¦¬ ì‹¤ì  ì…ë ¥ (Registro de ReparaciÃ³n de Carritos)</h3>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px;">
                <div><label>ìˆ˜ë¦¬ ë‚ ì§œ (Fecha)</label><input type="date" id="r-fecha"></div>
                <div><label>ëŒ€ì°¨ ëª¨ë¸ (Modelo)</label>
                    <select id="r-modelo" onchange="toggleRModeloOtros(this.value)">
                        <option value="">ì„ íƒ (Seleccione)</option>
                        <option>6500C FRE</option>
                        <option>6500C REF</option>
                        <option>6500H FRE</option>
                        <option>6500H REF</option>
                        <option>CASE ICE</option>
                        <option>COVER MULTI</option>
                        <option value="Otros">ê¸°íƒ€ (Otros)</option>
                    </select>
                </div>
                <div id="rModeloOtrosWrap" style="display:none;grid-column:span 2;"><label>ëª¨ë¸ ì§ì ‘ ì…ë ¥
                        (Especificar)</label><input type="text" id="r-modelo-otros"></div>
                <div><label>ë²ˆí˜¸ No. Carrito</label><input type="text" id="r-noid" placeholder="Ej: 123"></div>
                <div><label>ë‹´ë‹¹ì (Responsable)</label><input type="text" id="r-resp" placeholder="ì´ë¦„"></div>
            </div>
            <label style="margin-bottom:6px;">ìˆ˜ë¦¬ ë‚´ìš© (Detalles de ReparaciÃ³n)</label>
            <div class="checkbox-group-out" id="repair-checks">
                <label class="checkbox-small"><input type="checkbox" name="rd" value="Cinchos"> Cinchos <span
                        style="color:#9ca3af;">(ê²°ì†ì„ )</span></label>
                <label class="checkbox-small"><input type="checkbox" name="rd" value="Cortina"> Cortina <span
                        style="color:#9ca3af;">(ì»¤íŠ¼)</span></label>
                <label class="checkbox-small"><input type="checkbox" name="rd" value="Dampla"> Dampla <span
                        style="color:#9ca3af;">(ë‹¨í”Œë¼)</span></label>
                <label class="checkbox-small"><input type="checkbox" name="rd" value="Esponja"> Esponja <span
                        style="color:#9ca3af;">(ìŠ¤í°ì§€)</span></label>
                <label class="checkbox-small"><input type="checkbox" name="rd" value="Estructura"> Estructura <span
                        style="color:#9ca3af;">(ê³¨ì¡°)</span></label>
                <label class="checkbox-small"><input type="checkbox" name="rd" value="Felfa"> Felfa <span
                        style="color:#9ca3af;">(ë¶€ì§í¬)</span></label>
                <label class="checkbox-small"><input type="checkbox" name="rd" value="PistÃ³n"> PistÃ³n <span
                        style="color:#9ca3af;">(í”¼ìŠ¤í†¤)</span></label>
                <label class="checkbox-small"><input type="checkbox" name="rd" value="ProtecciÃ³n"> ProtecciÃ³n <span
                        style="color:#9ca3af;">(ë³´í˜¸ê°€ë“œ)</span></label>
                <label class="checkbox-small"><input type="checkbox" name="rd" value="Tubo/PTR"> Tubo/PTR <span
                        style="color:#9ca3af;">(íŒŒì´í”„)</span></label>
                <label class="checkbox-small"><input type="checkbox" name="rd" value="Jaladera"> Jaladera <span
                        style="color:#9ca3af;">(ì†ì¡ì´)</span></label>
                <label class="checkbox-small"><input type="checkbox" name="rd" value="Llanta"> Llanta <span
                        style="color:#9ca3af;">(ìºìŠ¤í„°)</span></label>
                <label class="checkbox-small"><input type="checkbox" name="rd" value="Separador"> Separador <span
                        style="color:#9ca3af;">(ë¶„ë¦¬ëŒ€)</span></label>
                <label class="checkbox-small"><input type="checkbox" name="rd" value="Velcro"> Velcro <span
                        style="color:#9ca3af;">(ì ‘ì°©)</span></label>
                <label class="checkbox-small"><input type="checkbox" name="rd" value="Placa"> Placa</label>
                <label class="checkbox-small"><input type="checkbox" name="rd" value="Porta etiqueta"> Porta etiqueta</label>
            </div>
            <div style="margin-top:8px;"><label>ê¸°íƒ€ (Otros)</label><textarea id="r-otros" rows="2"
                    placeholder="ê¸°íƒ€ ì‚¬í•­..."></textarea></div>
            <button class="btn btn-green" style="margin-top:8px;" onclick="submitRepair()">ğŸ”§ ìˆ˜ë¦¬ ë“±ë¡ (Registrar
                ReparaciÃ³n)</button>
        </div>

        <!-- ì €ì¥ ëŠ¥ë ¥ SET ì…ë ¥ -->
        <div class="form-section">
            <h3>ğŸ“¦ ì €ì¥ ëŠ¥ë ¥ ì„¤ì • (ConfiguraciÃ³n de Capacidad SET)</h3>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:4px;">
                <div>
                    <label>6500H ì €ì¥ SET</label>
                    <input type="number" id="set-6500h" value="2100" min="0" oninput="renderReport();">
                </div>
                <div>
                    <label>6500C ì €ì¥ SET</label>
                    <input type="number" id="set-6500c" value="2300" min="0" oninput="renderReport();">
                </div>
            </div>
        </div>

        <!-- í”„ë¡œì íŠ¸ ì§„í–‰ ì‹¤ì  ì…ë ¥ -->
        <div class="form-section">
            <h3>ğŸ“Š í”„ë¡œì íŠ¸ ì§„í–‰ ì‹¤ì  ì…ë ¥ (Registro de Avance de Proyectos)</h3>
            <div id="project-inputs" style="margin-top:8px;"></div>
            <button class="btn" style="margin-top:8px;" onclick="addProjectRow()">+ ì‹¤ì  í•­ëª© ì¶”ê°€ (AÃ±adir)</button>
        </div>

        <!-- í”„ë¡œì íŠ¸ ì™„ë£Œ í˜„í™© -->
        <div class="form-section">
            <h3>âœ… í”„ë¡œì íŠ¸ ì™„ë£Œ í˜„í™© (Estado de Proyectos Completados)</h3>
            <div id="completion-inputs" style="margin-top:6px;"></div>
            <button class="btn btn-green" style="margin-top:8px;" onclick="addCompletionRow()">+ ì™„ë£Œ í•­ëª© ì¶”ê°€ (AÃ±adir
                Completado)</button>
        </div>


    </div>

    <!-- Sidebar controls -->
    <div class="sidebar-controls">
        <a class="home-btn" href="index.html">ğŸ  Home</a>
        <button id="btn-toggle-sidebar" class="btn-toggle-sidebar" onclick="toggleSidebar()">â—€</button>
    </div>

    <!-- Preview Panel -->
    <div class="preview-panel">
        <div class="report-container" id="report-content">
            <!-- Header -->
            <div
                style="display:flex;justify-content:space-between;align-items:flex-end;border-bottom:4px solid #111827;padding-bottom:14px;margin-bottom:30px;">
                <div style="display:flex;align-items:center;gap:20px;">

                    <div>
                        <h1 style="margin:0;font-size:24px;font-weight:900;">PAILERIA í”„ë¡œì íŠ¸Â·ìˆ˜ë¦¬ ê´€ë¦¬ ë³´ê³ ì„œ</h1>
                        <div style="font-size:12px;color:#718096;font-weight:700;margin-top:4px;">Reporte de GestiÃ³n de
                            Proyectos y ReparaciÃ³n de Carritos</div>
                    </div>
                </div>
                <div style="text-align:right;">
                    <div style="font-size:18px;font-weight:900;color:#10b981;" id="out-week-display">Week --</div>
                    <div style="font-size:13px;color:#718096;font-weight:700;" id="out-date"></div>
                </div>
            </div>



            <!-- Section 1: í”„ë¡œì íŠ¸ ì§„í–‰ ì‹¤ì  -->
            <div class="section-title">1. í”„ë¡œì íŠ¸ë³„ ì§„í–‰ ì‹¤ì  (Avance de Proyectos)</div>
            <table id="tbl-projects">
                <thead>
                    <tr>
                        <th width="90">ë‚ ì§œ (Fecha)</th>
                        <th width="130">ëª¨ë¸ (Modelo)</th>
                        <th width="80">ìˆ˜ëŸ‰ (Cant.)</th>
                        <th>ë‚´ìš© (DescripciÃ³n)</th>
                    </tr>
                </thead>
                <tbody id="out-prod-body"></tbody>
            </table>

            <!-- Section 1-2: í”„ë¡œì íŠ¸ ì™„ë£Œ í˜„í™© -->
            <div class="section-title">1-2. í”„ë¡œì íŠ¸ ì™„ë£Œ í˜„í™© (Proyectos Completados)</div>
            <table id="tbl-completions">
                <thead>
                    <tr>
                        <th width="150">ëª¨ë¸ (Modelo)</th>
                        <th width="100">ì™„ì„± ìˆ˜ëŸ‰ (Cant.)</th>
                        <th width="110">ì™„ë£Œ ì¼ì (Fecha de Cierre)</th>
                    </tr>
                </thead>
                <tbody id="out-completion-body"></tbody>
            </table>

            <!-- Section 2: ìµœì¢… ì €ì¥ ëŠ¥ë ¥ (ê³ ì •ê°’) -->
            <div class="section-title">2. ìµœì¢… ì €ì¥ ëŠ¥ë ¥ ë¶„ì„ / AnÃ¡lisis de Capacidad de Almacenamiento (SET í™˜ì‚°)</div>
            <table>
                <thead>
                    <tr>
                        <th>ì°¨ì¢… ëª¨ë¸ (Modelo)</th>
                        <th>ê°€ìš© ì €ì¥ SET / Capacidad Disponible</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td style="font-weight:800;background:#f8fafc;">6500H</td>
                        <td id="out-set-6500h" style="font-weight:900;font-size:16px;color:#10b981;background:#f0fff4;">
                            2,100 SET</td>
                    </tr>
                    <tr>
                        <td style="font-weight:800;background:#f8fafc;">6500C</td>
                        <td id="out-set-6500c" style="font-weight:900;font-size:16px;color:#10b981;background:#f0fff4;">
                            2,300 SET</td>
                    </tr>
                </tbody>
            </table>

            <!-- Section 3: ëŒ€ì°¨ ìˆ˜ë¦¬ ì§„í–‰ ë‚´ì—­ -->
            <div class="section-title">3. ëŒ€ì°¨ ìˆ˜ë¦¬ ì§„í–‰ ë‚´ì—­ (Historial de ReparaciÃ³n de Carritos)</div>

            <!-- Date Range Picker -->
            <div class="repair-date-bar">
                <label>ğŸ“… ì¡°íšŒ ê¸°ê°„ / PerÃ­odo:</label>
                <input type="date" id="repair-from">
                <span style="color:#4a5568;font-weight:700;">~</span>
                <input type="date" id="repair-to">
                <button onclick="loadRepairData()"
                    style="background:#1e3a5f;color:#93c5fd;border:1px solid #3b82f6;border-radius:6px;padding:6px 14px;cursor:pointer;font-weight:700;white-space:nowrap;">ğŸ”
                    ì¡°íšŒ (Consultar)</button>
                <button onclick="loadRepairData('all')"
                    style="background:#374151;color:#d1d5db;border:1px solid #6b7280;border-radius:6px;padding:6px 14px;cursor:pointer;font-weight:700;white-space:nowrap;">ì „ì²´
                    ë³´ê¸° (Ver Todo)</button>
            </div>

            <!-- Repair Stat Cards -->
            <div class="repair-stat-cards">
                <div class="repair-stat-card" style="border-bottom:3px solid #ef4444;">
                    <h4 style="font-size:10px;color:#718096;text-transform:uppercase;font-weight:700;margin:0 0 6px;">ìˆ˜ë¦¬
                        ëˆ„ê³„ / Total Reparaciones</h4>
                    <div style="font-size:32px;font-weight:800;color:#ef4444;" id="repair-count-display">-</div>
                    <div style="font-size:10px;color:#a0aec0;">ê±´</div>
                </div>
                <div class="repair-stat-card" style="border-bottom:3px solid #f59e0b;">
                    <h4 style="font-size:10px;color:#718096;text-transform:uppercase;font-weight:700;margin:0 0 6px;">ì¤‘ë³µ
                        ìˆ˜ë¦¬ ëŒ€ì°¨ / Carritos con Reparaciones Repetidas</h4>
                    <div style="font-size:32px;font-weight:800;color:#f59e0b;" id="repair-dup-display">-</div>
                    <div style="font-size:10px;color:#a0aec0;">ëŒ€</div>
                </div>
            </div>

            <!-- ì¤‘ë³µ ìˆ˜ë¦¬ í…Œì´ë¸” -->
            <div style="font-size:13px;font-weight:700;color:#4a5568;margin-bottom:6px;">âš ï¸ ì¤‘ë³µ ìˆ˜ë¦¬ ë°œìƒ ëŒ€ì°¨ (Carritos con
                ReparaciÃ³n Repetida)</div>
            <table id="tbl-dup-repair">
                <thead>
                    <tr>
                        <th>ëª¨ë¸ (Modelo)</th>
                        <th>ë²ˆí˜¸ (No.)</th>
                        <th>ìˆ˜ë¦¬ íšŸìˆ˜ (Veces)</th>
                        <th>ìµœê·¼ ìˆ˜ë¦¬ì¼ (Ãšltima Fecha)</th>
                    </tr>
                </thead>
                <tbody id="dup-repair-body">
                    <tr>
                        <td colspan="4" style="color:#9ca3af;">ì¡°íšŒ ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš” / Haga clic en Consultar</td>
                    </tr>
                </tbody>
            </table>

            <!-- ìˆ˜ë¦¬ ë‚´ìš©ë³„ ì§‘ê³„ -->
            <div style="font-size:13px;font-weight:700;color:#4a5568;margin:16px 0 6px;">ğŸ“‹ ìˆ˜ë¦¬ ë‚´ìš©ë³„ ì§‘ê³„ (Resumen por Tipo
                de ReparaciÃ³n)</div>
            <table id="tbl-repair-log">
                <thead>
                    <tr>
                        <th>ìˆ˜ë¦¬ ë‚´ìš© (Tipo de ReparaciÃ³n)</th>
                        <th>ë¹„ìœ¨ (ProporciÃ³n)</th>
                        <th width="70">ìˆ˜ëŸ‰ (Cant.)</th>
                    </tr>
                </thead>
                <tbody id="repair-log-body">
                    <tr>
                        <td colspan="2" style="color:#9ca3af;">ì¡°íšŒ ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš” / Haga clic en Consultar</td>
                    </tr>
                </tbody>
            </table>

            <!-- Note -->
            <div
                style="margin:20px 0;padding:16px;border-radius:8px;background:#f8fafc;border:1px dashed #cbd5e0;font-size:12px;color:#4a5568;line-height:1.8;">
                <b>â€» ë¹„ê³  (Nota)</b><br>
                - ëŒ€ì°¨ ìˆ˜ë¦¬ ë°ì´í„°ëŠ” êµ¬ê¸€ ì‹œíŠ¸ REPAIR_LOG ì‹œíŠ¸ì— ì €ì¥ë©ë‹ˆë‹¤.<br>
                - Los datos de reparaciÃ³n se guardan en la hoja REPAIR_LOG de Google Sheets.
            </div>
        </div>
    </div>

    <!-- Cloud Modal -->
    <div id="cloud-modal"
        style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.7);z-index:9999;justify-content:center;align-items:center;">
        <div
            style="background:#1e1e1e;border-radius:12px;padding:24px;width:400px;max-height:80vh;overflow-y:auto;border:1px solid #444;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;">
                <h3 style="margin:0;color:#4285F4;">â˜ï¸ í´ë¼ìš°ë“œ ì£¼ì°¨ ëª©ë¡ (Lista de Semanas)</h3>
                <button onclick="document.getElementById('cloud-modal').style.display='none'"
                    style="background:none;border:none;color:#aaa;font-size:1.4rem;cursor:pointer;">âœ•</button>
            </div>
            <ul id="cloud-list-ul" style="list-style:none;padding:0;margin:0;"></ul>
        </div>
    </div>

    <!-- Repair Edit Modal -->
    <div id="repair-edit-modal"
        style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.75);z-index:10000;justify-content:center;align-items:center;">
        <div
            style="background:#1e2530;border-radius:12px;padding:24px;width:480px;border:1px solid #10b981;box-shadow:0 20px 60px rgba(0,0,0,.5);">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;">
                <h3 style="margin:0;color:#10b981;">âœï¸ ìˆ˜ë¦¬ ë‚´ì—­ ìˆ˜ì • (Editar ReparaciÃ³n)</h3>
                <button onclick="closeRepairModal()"
                    style="background:none;border:none;color:#aaa;font-size:1.4rem;cursor:pointer;">âœ•</button>
            </div>
            <input type="hidden" id="edit-rowNum">
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px;">
                <div><label style="color:#9ca3af;font-size:.75rem;font-weight:600;">ë‚ ì§œ (Fecha)</label><input type="date"
                        id="edit-fecha"
                        style="background:#2d3748;color:#f9fafb;border:1px solid #4b5563;border-radius:6px;padding:7px;width:100%;box-sizing:border-box;">
                </div>
                <div>
                    <label style="color:#9ca3af;font-size:.75rem;font-weight:600;">ëª¨ë¸ (Modelo)</label>
                    <select id="edit-modelo" onchange="toggleEditModeloOtros(this.value)"
                        style="background:#2d3748;color:#f9fafb;border:1px solid #4b5563;border-radius:6px;padding:7px;width:100%;box-sizing:border-box;">
                        <option value="">ì„ íƒ</option>
                        <option>6500C FRE</option>
                        <option>6500C REF</option>
                        <option>6500H FRE</option>
                        <option>6500H REF</option>
                        <option>CASE ICE</option>
                        <option>COVER MULTI</option>
                        <option value="Otros">ê¸°íƒ€ (Otros)</option>
                    </select>
                </div>
                <div id="editModeloOtrosWrap" style="display:none;grid-column:span 2;"><label
                        style="color:#9ca3af;font-size:.75rem;font-weight:600;">ëª¨ë¸ ì§ì ‘ ì…ë ¥</label><input type="text"
                        id="edit-modelo-otros"
                        style="background:#2d3748;color:#f9fafb;border:1px solid #4b5563;border-radius:6px;padding:7px;width:100%;box-sizing:border-box;">
                </div>
                <div><label style="color:#9ca3af;font-size:.75rem;font-weight:600;">ë²ˆí˜¸ (No. Carrito)</label><input
                        type="text" id="edit-noid"
                        style="background:#2d3748;color:#f9fafb;border:1px solid #4b5563;border-radius:6px;padding:7px;width:100%;box-sizing:border-box;">
                </div>
                <div><label style="color:#9ca3af;font-size:.75rem;font-weight:600;">ë‹´ë‹¹ì (Responsable)</label><input
                        type="text" id="edit-resp"
                        style="background:#2d3748;color:#f9fafb;border:1px solid #4b5563;border-radius:6px;padding:7px;width:100%;box-sizing:border-box;">
                </div>
            </div>
            <div style="margin-bottom:12px;"><label
                    style="color:#9ca3af;font-size:.75rem;font-weight:600;display:block;margin-bottom:4px;">ìˆ˜ë¦¬ ë‚´ìš©
                    (Detalles)</label>
                <textarea id="edit-detalles" rows="3"
                    style="background:#2d3748;color:#f9fafb;border:1px solid #4b5563;border-radius:6px;padding:8px;width:100%;box-sizing:border-box;resize:vertical;"></textarea>
            </div>
            <div style="display:flex;gap:8px;">
                <button onclick="saveRepairEdit()"
                    style="flex:1;background:#065f46;color:#fff;border:1px solid #10b981;border-radius:6px;padding:10px;cursor:pointer;font-weight:700;font-size:.9rem;">ğŸ’¾
                    ì €ì¥ (Guardar)</button>
                <button onclick="closeRepairModal()"
                    style="flex:1;background:#374151;color:#d1d5db;border:1px solid #6b7280;border-radius:6px;padding:10px;cursor:pointer;font-weight:700;">ì·¨ì†Œ
                    (Cancelar)</button>
            </div>
        </div>
    </div>
    <style>
        .cloud-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 14px;
            margin-bottom: 5px;
            background: #2b2b2b;
            border-radius: 8px;
            cursor: pointer;
            transition: .2s;
            border: 1px solid transparent;
        }

        .cloud-item:hover {
            background: #3a3a3a;
            border-color: #4285F4;
        }
    </style>

    <!-- JS will be appended below -->
    <script>
        const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwRIbd1kla0br3DFBCHtLvQsjpbdNhEQ6MN5rZCIANFsAda2GLmpGW2_aS10itK-kZv/exec";
        const STORAGE_KEY = 'paileria_v9_main';
        // â”€â”€ ìœ í‹¸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function cleanNum(v, d = 0) { return v === null || v === undefined || v === "" ? d : parseFloat(v) || d; }
        function getTodayStr() { const d = new Date(); return `${d.getFullYear()}-${('0' + (d.getMonth() + 1)).slice(-2)}-${('0' + d.getDate()).slice(-2)}`; }
        function getSimpleWeek(s) { if (!s) return 0; const d = new Date(s); d.setHours(0, 0, 0, 0); const f = new Date(d.getFullYear(), 0, 1); return Math.ceil(((d - f) / 86400000 + f.getDay() + 1) / 7); }
        function getCurrentWeekId() { const d = document.getElementById('in-date').value; if (!d) return null; return `${d.split('-')[0]}-W${String(getSimpleWeek(d)).padStart(2, '0')}`; }
        function showToast(msg, el = 'cloudToast') { const t = document.getElementById(el); t.innerText = msg; t.style.display = 'block'; setTimeout(() => { t.style.display = 'none'; }, 2500); }
        function toggleSidebar() { document.body.classList.toggle('full-screen'); document.getElementById('btn-toggle-sidebar').innerText = document.body.classList.contains('full-screen') ? 'â–¶' : 'â—€'; }

        // â”€â”€ ìˆ˜ë¦¬ ì…ë ¥ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function toggleRModeloOtros(v) { document.getElementById('rModeloOtrosWrap').style.display = v === 'Otros' ? 'block' : 'none'; }

        function submitRepair() {
            const fecha = document.getElementById('r-fecha').value;
            const modelo = document.getElementById('r-modelo').value === 'Otros' ? document.getElementById('r-modelo-otros').value : document.getElementById('r-modelo').value;
            const noid = document.getElementById('r-noid').value.trim();
            const resp = document.getElementById('r-resp').value.trim();
            const checks = [...document.querySelectorAll('input[name="rd"]:checked')].map(c => c.value);
            const otros = document.getElementById('r-otros').value.trim();
            if (!fecha || !modelo || !noid) { alert('ë‚ ì§œ, ëª¨ë¸, ë²ˆí˜¸ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤. / Fecha, Modelo y No. son obligatorios.'); return; }
            if (checks.length === 0 && !otros) { alert('ìˆ˜ë¦¬ ë‚´ìš©ì„ ì„ íƒí•˜ê±°ë‚˜ ê¸°íƒ€ë¥¼ ì…ë ¥í•˜ì„¸ìš”. / Seleccione detalles o escriba en Otros.'); return; }
            const detalles = [...checks, ...(otros ? [otros] : [])].join(', ');
            const payload = { cmd: 'saveRepair', fecha, modelo, noid, detalles, responsable: resp };
            if (APPS_SCRIPT_URL.includes('AKfycb')) {
                fetch(APPS_SCRIPT_URL, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'text/plain' }, body: JSON.stringify(payload) })
                    .then(() => showToast('ğŸ”§ ìˆ˜ë¦¬ ë“±ë¡ ì™„ë£Œ! (ReparaciÃ³n registrada)'))
                    .catch(e => alert('ì˜¤ë¥˜: ' + e.message));
            } else { alert('APPS_SCRIPT_URLì„ ì„¤ì •í•´ì£¼ì„¸ìš”.'); }
            // í¼ ì´ˆê¸°í™”
            document.getElementById('r-fecha').value = getTodayStr();
            document.getElementById('r-modelo').value = '';
            document.getElementById('r-noid').value = '';
            document.getElementById('r-resp').value = '';
            document.getElementById('r-otros').value = '';
            document.querySelectorAll('input[name="rd"]').forEach(c => c.checked = false);
            toggleRModeloOtros('');
        }

        async function loadRepairData(mode) {
            const from = mode === 'all' ? '' : document.getElementById('repair-from').value;
            const to = mode === 'all' ? '' : document.getElementById('repair-to').value;
            if (mode !== 'all' && (!from || !to)) { alert('ê¸°ê°„ì„ ì„ íƒí•´ì£¼ì„¸ìš”. / Seleccione el perÃ­odo.'); return; }
            const url = `${APPS_SCRIPT_URL}?cmd=repairRange&dateFrom=${from}&dateTo=${to}&t=${Date.now()}`;
            document.getElementById('dup-repair-body').innerHTML = '<tr><td colspan="4" style="color:#9ca3af;">ë¡œë”© ì¤‘... / Cargando...</td></tr>';
            document.getElementById('repair-log-body').innerHTML = '<tr><td colspan="5" style="color:#9ca3af;">ë¡œë”© ì¤‘... / Cargando...</td></tr>';
            try {
                const res = await fetch(url); const data = await res.json();
                renderRepairSection(data);
            } catch (e) {
                document.getElementById('dup-repair-body').innerHTML = `<tr><td colspan="4" style="color:red;">ì˜¤ë¥˜: ${e.message}</td></tr>`;
            }
        }

        function renderRepairSection(data) {
            const repairs = data.repairs || [];
            const dups = data.summary && data.summary.duplicates || [];
            document.getElementById('repair-count-display').innerText = repairs.length;
            document.getElementById('repair-dup-display').innerText = dups.length;
            // dup table
            const dupBody = document.getElementById('dup-repair-body');
            dupBody.innerHTML = dups.length === 0 ? '<tr><td colspan="4" style="color:#9ca3af;">ì¤‘ë³µ ìˆ˜ë¦¬ ì—†ìŒ / Sin carritos repetidos</td></tr>' :
                dups.map(d => `<tr><td style="font-weight:700;">${d.modelo}</td><td>${d.noid}</td><td style="font-weight:800;color:#ef4444;">${d.count}íšŒ</td><td>${d.lastDate || '-'}</td></tr>`).join('');
            // ìˆ˜ë¦¬ ë‚´ìš©ë³„ ì§‘ê³„ (detalles ì‰¼í‘œ êµ¬ë¶„ â†’ í•­ëª©ë³„ ì¹´ìš´íŠ¸)
            const logBody = document.getElementById('repair-log-body');
            if (repairs.length === 0) {
                logBody.innerHTML = '<tr><td colspan="2" style="color:#9ca3af;">ë°ì´í„° ì—†ìŒ / Sin datos</td></tr>';
            } else {
                const LABEL = {
                    'Cinchos': 'ê²°ì†ì„ ', 'Cortina': 'ì»¤íŠ¼',
                    'Dampla': 'ë‹¨í”Œë¼', 'Esponja': 'ìŠ¤í°ì§€',
                    'Estructura': 'ê³¨ì¡°', 'Felfa': 'ë¶€ì§í¬',
                    'PistÃ³n': 'í”¼ìŠ¤í†¤', 'ProtecciÃ³n': 'ë³´í˜¸ê°€ë“œ',
                    'Tubo/PTR': 'íŒŒì´í”„', 'Jaladera': 'ì†ì¡ì´',
                    'CorrosiÃ³n': 'ë¶€ì‹', 'Llanta': 'ìºìŠ¤í„°',
                    'Separador': 'ë¶„ë¦¬ëŒ€', 'Velcro': 'ì ‘ì°©',
                };
                const countMap = {};
                repairs.forEach(r => {
                    if (!r.detalles) return;
                    r.detalles.split(',').forEach(item => {
                        const key = item.trim();
                        if (key) countMap[key] = (countMap[key] || 0) + 1;
                    });
                });
                const sorted = Object.entries(countMap).sort((a, b) => b[1] - a[1]);
                const maxCnt = sorted.length > 0 ? sorted[0][1] : 1;
                const totalCnt = sorted.reduce((s, [, c]) => s + c, 0);
                logBody.innerHTML = sorted.length === 0
                    ? '<tr><td colspan="3" style="color:#9ca3af;">ìˆ˜ë¦¬ ë‚´ìš© ì—†ìŒ</td></tr>'
                    : sorted.map(([tipo, cnt]) => {
                        const kr = LABEL[tipo] ? ` <span style="color:#9ca3af;font-size:11px;">(${LABEL[tipo]})</span>` : '';
                        const pct = Math.round(cnt / totalCnt * 100);
                        const barW = Math.round(cnt / maxCnt * 100);
                        return `<tr>
                            <td style="text-align:left;font-weight:600;white-space:nowrap;">${tipo}${kr}</td>
                            <td style="padding:0 8px;min-width:120px;">
                                <div style="display:flex;align-items:center;gap:6px;">
                                    <div style="flex:1;background:#374151;border-radius:4px;height:8px;overflow:hidden;">
                                        <div style="width:${barW}%;height:100%;background:#10b981;border-radius:4px;transition:width .4s;"></div>
                                    </div>
                                    <span style="font-size:11px;color:#9ca3af;width:32px;text-align:right;">${pct}%</span>
                                </div>
                            </td>
                            <td style="font-weight:900;font-size:15px;color:#10b981;white-space:nowrap;">${cnt}ê±´</td>
                        </tr>`;
                    }).join('');
            }
        }

        // â”€â”€ ìˆ˜ë¦¬ ì‚­ì œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async function deleteRepairRow(rowNum, label) {
            if (!confirm(`[${label}] ìˆ˜ë¦¬ ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.)\nÂ¿Eliminar este registro de reparaciÃ³n?`)) return;
            try {
                await fetch(APPS_SCRIPT_URL, {
                    method: 'POST', mode: 'no-cors',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({ cmd: 'deleteRepair', rowNum })
                });
                showToast('ğŸ—‘ï¸ ì‚­ì œ ì™„ë£Œ (Eliminado)');
                setTimeout(() => loadRepairData(), 800); // 0.8ì´ˆ í›„ ëª©ë¡ ê°±ì‹ 
            } catch (e) { alert('ì˜¤ë¥˜: ' + e.message); }
        }

        // â”€â”€ ìˆ˜ë¦¬ í¸ì§‘ ëª¨ë‹¬ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function openEditModal(rowNum, jsonStr) {
            const r = JSON.parse(jsonStr);
            document.getElementById('edit-rowNum').value = rowNum;
            document.getElementById('edit-fecha').value = r.fecha || '';
            document.getElementById('edit-noid').value = r.noid || '';
            document.getElementById('edit-resp').value = r.responsable || '';
            document.getElementById('edit-detalles').value = r.detalles || '';
            // ëª¨ë¸ ì„¸íŒ…
            const sel = document.getElementById('edit-modelo');
            const knownModels = ['6500C FRE', '6500C REF', '6500H FRE', '6500H REF', 'CASE ICE', 'COVER MULTI'];
            if (knownModels.includes(r.modelo)) {
                sel.value = r.modelo;
                document.getElementById('editModeloOtrosWrap').style.display = 'none';
            } else {
                sel.value = 'Otros';
                document.getElementById('editModeloOtrosWrap').style.display = 'block';
                document.getElementById('edit-modelo-otros').value = r.modelo || '';
            }
            document.getElementById('repair-edit-modal').style.display = 'flex';
        }

        function closeRepairModal() {
            document.getElementById('repair-edit-modal').style.display = 'none';
        }

        function toggleEditModeloOtros(v) {
            document.getElementById('editModeloOtrosWrap').style.display = v === 'Otros' ? 'block' : 'none';
        }

        async function saveRepairEdit() {
            const rowNum = document.getElementById('edit-rowNum').value;
            const fecha = document.getElementById('edit-fecha').value;
            const modeloSel = document.getElementById('edit-modelo').value;
            const modelo = modeloSel === 'Otros' ? document.getElementById('edit-modelo-otros').value : modeloSel;
            const noid = document.getElementById('edit-noid').value.trim();
            const resp = document.getElementById('edit-resp').value.trim();
            const detalles = document.getElementById('edit-detalles').value.trim();
            if (!fecha || !modelo || !noid) { alert('ë‚ ì§œ, ëª¨ë¸, ë²ˆí˜¸ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.'); return; }
            try {
                await fetch(APPS_SCRIPT_URL, {
                    method: 'POST', mode: 'no-cors',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({ cmd: 'updateRepair', rowNum: Number(rowNum), fecha, modelo, noid, detalles, responsable: resp })
                });
                closeRepairModal();
                showToast('âœ… ìˆ˜ì • ì™„ë£Œ (Actualizado)');
                setTimeout(() => loadRepairData(), 800);
            } catch (e) { alert('ì˜¤ë¥˜: ' + e.message); }
        }

        // â”€â”€ í”„ë¡œì íŠ¸ ì‹¤ì  ì¹´ë“œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function addProjectRow(d = null) {
            d = d || { fecha: getTodayStr(), model: '', qty: 0, content: '' };
            const div = document.createElement('div'); div.className = 'project-card';
            div.innerHTML = `
  <div class="card-header">
    <div class="move-controls">
      <button class="btn-move" onclick="moveRow(this,-1)">â–²</button>
      <button class="btn-move" onclick="moveRow(this,1)">â–¼</button>
    </div>
    <div class="header-content" onclick="toggleCard(this)">
      <span class="card-title-text">${d.model || 'New'}</span>
      <span class="card-info">${d.fecha || ''}</span>
    </div>
    <div class="card-actions">
      <button class="btn-sm btn-del" onclick="this.closest('.project-card').remove();renderReport();" title="ì‚­ì œ">Ã—</button>
    </div>
  </div>
  <div class="card-body" style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
    <div><label>ë‚ ì§œ Fecha</label><input type="date" class="p-fecha" value="${d.fecha || getTodayStr()}" onchange="updatePHeader(this.closest('.project-card'));renderReport();"></div>
    <div><label>ëª¨ë¸ Modelo</label><input type="text" class="p-model" value="${d.model}" list="model-list" onkeyup="updatePHeader(this.closest('.project-card'));renderReport();" onchange="updatePHeader(this.closest('.project-card'));renderReport();"></div>
    <div><label>ìˆ˜ëŸ‰ Cantidad (EA)</label><input type="number" class="p-qty" value="${d.qty}" oninput="renderReport();"></div>
    <div style="grid-column:span 1;"><label>ë‚´ìš© DescripciÃ³n</label><input type="text" class="p-content" value="${d.content}" oninput="renderReport();"></div>
  </div>`;
            document.getElementById('project-inputs').appendChild(div);
            updatePHeader(div);
        }

        function updatePHeader(card) {
            const m = card.querySelector('.p-model').value || 'New';
            const f = card.querySelector('.p-fecha').value || '';
            card.querySelector('.card-title-text').innerText = m;
            card.querySelector('.card-info').innerText = f;
        }

        function moveRow(btn, dir) {
            const card = btn.closest('.project-card');
            const c = card.parentNode;
            if (dir === -1) { if (card.previousElementSibling) c.insertBefore(card, card.previousElementSibling); }
            else { if (card.nextElementSibling) c.insertBefore(card.nextElementSibling, card); }
            renderReport();
        }

        function toggleCard(hdr) {
            const body = hdr.closest('.card-header').nextElementSibling;
            body.style.display = body.style.display === 'none' ? 'grid' : 'none';
        }

        // â”€â”€ ì™„ë£Œ í˜„í™© ì¹´ë“œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function addCompletionRow(d = null) {
            d = d || { model: '', qty: 0, completedDate: getTodayStr() };
            const div = document.createElement('div'); div.className = 'completion-card';
            div.innerHTML = `
  <div style="display:grid;grid-template-columns:1fr 0.6fr 1fr auto;gap:8px;align-items:end;">
    <div><label>ëª¨ë¸ Modelo</label><input type="text" class="c-model" value="${d.model}" list="model-list" oninput="renderReport();"></div>
    <div><label>ì™„ì„± ìˆ˜ëŸ‰ Cant.</label><input type="number" class="c-qty" value="${d.qty}" oninput="renderReport();"></div>
    <div><label>ì™„ë£Œ ì¼ì Fecha</label><input type="date" class="c-date" value="${d.completedDate || getTodayStr()}" onchange="renderReport();"></div>
    <button class="btn-sm btn-del" onclick="this.closest('.completion-card').remove();renderReport();" style="margin-bottom:0;width:28px;height:28px;">Ã—</button>
  </div>`;
            document.getElementById('completion-inputs').appendChild(div);
        }

        // â”€â”€ renderReport â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function renderReport() {
            const inDate = document.getElementById('in-date').value;
            if (inDate) {
                document.getElementById('out-date').innerText = inDate;
                document.getElementById('out-week-display').innerText = `Week ${getSimpleWeek(inDate)}`;
            }
            // í”„ë¡œì íŠ¸ ì‹¤ì 
            const pBody = document.getElementById('out-prod-body'); pBody.innerHTML = '';
            let totalProj = 0, weeklyQty = 0;
            const thisWeek = inDate ? getSimpleWeek(inDate) : 0;
            document.querySelectorAll('.project-card').forEach(row => {
                const fecha = row.querySelector('.p-fecha').value;
                const model = row.querySelector('.p-model').value;
                const qty = cleanNum(row.querySelector('.p-qty').value);
                const content = row.querySelector('.p-content').value;
                if (model) {
                    totalProj++;
                    if (inDate && fecha && getSimpleWeek(fecha) === thisWeek) weeklyQty += qty;
                    pBody.innerHTML += `<tr><td>${fecha}</td><td style="font-weight:800;color:#10b981;">${model}</td><td style="font-weight:800;">${qty.toLocaleString()}</td><td style="text-align:left;">${content}</td></tr>`;
                }
            });
            if (pBody.innerHTML === '') pBody.innerHTML = '<tr><td colspan="4" style="color:#9ca3af;">ë°ì´í„° ì—†ìŒ / Sin datos</td></tr>';
            // ì™„ë£Œ í˜„í™©
            const cBody = document.getElementById('out-completion-body'); cBody.innerHTML = '';
            let compCount = 0;
            document.querySelectorAll('.completion-card').forEach(row => {
                const m = row.querySelector('.c-model').value;
                const q = cleanNum(row.querySelector('.c-qty').value);
                const dt = row.querySelector('.c-date').value;
                if (m) { compCount++; cBody.innerHTML += `<tr><td style="font-weight:800;">${m}</td><td style="font-weight:800;color:#10b981;">${q.toLocaleString()}</td><td>${dt}</td></tr>`; }
            });
            if (cBody.innerHTML === '') cBody.innerHTML = '<tr><td colspan="3" style="color:#9ca3af;">ë°ì´í„° ì—†ìŒ / Sin datos</td></tr>';
            // ì¹´ë“œ ì—…ë°ì´íŠ¸
            document.getElementById('sum-total-proj').innerText = totalProj;
            document.getElementById('sum-completions').innerText = compCount;
            document.getElementById('sum-weekly-qty').innerText = weeklyQty.toLocaleString();
            // SET ì €ì¥ ëŠ¥ë ¥ ì—…ë°ì´íŠ¸
            const set6500h = cleanNum(document.getElementById('set-6500h').value, 2100);
            const set6500c = cleanNum(document.getElementById('set-6500c').value, 2300);
            document.getElementById('out-set-6500h').innerText = set6500h.toLocaleString() + ' SET';
            document.getElementById('out-set-6500c').innerText = set6500c.toLocaleString() + ' SET';
            autoSave();
        }

        // â”€â”€ ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸° â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        function collectData() {
            const projects = [...document.querySelectorAll('.project-card')].map(r => ({ fecha: r.querySelector('.p-fecha').value, model: r.querySelector('.p-model').value, qty: r.querySelector('.p-qty').value, content: r.querySelector('.p-content').value }));
            const completions = [...document.querySelectorAll('.completion-card')].map(r => ({ model: r.querySelector('.c-model').value, qty: r.querySelector('.c-qty').value, completedDate: r.querySelector('.c-date').value }));
            return { v: '9.0', d: document.getElementById('in-date').value, set6500h: document.getElementById('set-6500h').value, set6500c: document.getElementById('set-6500c').value, projects, completions };
        }

        function autoSave() { localStorage.setItem(STORAGE_KEY, JSON.stringify(collectData())); }

        function manualSaveFile() {
            const data = collectData();
            const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = `Paileria_${data.d || 'backup'}.json`;
            document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
            showToast('ğŸ’¾ ë°±ì—… ì™„ë£Œ! (Backup listo)', 'saveToast');
        }

        function handleFileLoad(inp) {
            const file = inp.files[0]; if (!file) return;
            const r = new FileReader();
            r.onload = e => { try { loadDataObj(JSON.parse(e.target.result)); } catch { alert('íŒŒì¼ í˜•ì‹ ì˜¤ë¥˜'); } };
            r.readAsText(file); inp.value = '';
        }

        function loadDataObj(d) {
            document.getElementById('in-date').value = d.d || getTodayStr();
            if (d.set6500h) document.getElementById('set-6500h').value = d.set6500h;
            if (d.set6500c) document.getElementById('set-6500c').value = d.set6500c;
            document.getElementById('project-inputs').innerHTML = '';
            (d.projects || []).forEach(p => addProjectRow(p));
            document.getElementById('completion-inputs').innerHTML = '';
            (d.completions || []).forEach(c => addCompletionRow(c));
            setTimeout(() => renderReport(), 200);
        }

        // â”€â”€ í´ë¼ìš°ë“œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async function saveToCloud() {
            if (!getCurrentWeekId()) { alert('ë³´ê³  ë‚ ì§œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
            const weekId = getCurrentWeekId();
            if (!confirm(`[${weekId}] ë°ì´í„°ë¥¼ ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
            const payload = { ...collectData(), weekId };
            try {
                await fetch(APPS_SCRIPT_URL, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'text/plain' }, body: JSON.stringify(payload) });
                showToast(`â˜ï¸ [${weekId}] ì €ì¥ ì™„ë£Œ!`);
            } catch (e) { alert('ì˜¤ë¥˜: ' + e.message); }
        }

        async function openCloudModal() {
            const ul = document.getElementById('cloud-list-ul');
            ul.innerHTML = '<li style="text-align:center;padding:10px;color:#aaa;">ë¡œë”© ì¤‘...</li>';
            document.getElementById('cloud-modal').style.display = 'flex';
            try {
                const res = await fetch(`${APPS_SCRIPT_URL}?cmd=list&t=${Date.now()}`);
                const data = await res.json();
                ul.innerHTML = '';
                (data.list || []).forEach(item => {
                    const li = document.createElement('li'); li.className = 'cloud-item';
                    li.innerHTML = `<div><div style="font-weight:bold;color:#4285F4;">${item.weekId}</div><div style="font-size:.8rem;color:#aaa;">ë‚ ì§œ: ${item.date} | í•­ëª©: ${item.projectCount}ê±´</div></div><div style="font-size:.75rem;color:#888;">${item.updated}</div>`;
                    li.onclick = () => loadCloudWeek(item.weekId); ul.appendChild(li);
                });
                if (!data.list || data.list.length === 0) ul.innerHTML = '<li style="text-align:center;color:#aaa;padding:10px;">ì €ì¥ëœ ë°ì´í„° ì—†ìŒ</li>';
            } catch (e) { ul.innerHTML = `<li style="color:red;text-align:center;">ë¡œë“œ ì‹¤íŒ¨: ${e.message}</li>`; }
        }

        async function loadCloudWeek(weekId) {
            try {
                const res = await fetch(`${APPS_SCRIPT_URL}?cmd=load&weekId=${weekId}&t=${Date.now()}`);
                const result = await res.json();
                if (result.error) { alert('ì„œë²„ ì˜¤ë¥˜: ' + result.error); return; }
                loadDataObj(result.data || result);
                document.getElementById('cloud-modal').style.display = 'none';
                showToast(`â˜ï¸ [${weekId}] ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ!`);
            } catch (e) { alert('ë¡œë“œ ì‹¤íŒ¨: ' + e.toString()); }
        }

        async function exportImage() {
            const r = document.getElementById('report-content');
            const c = await html2canvas(r, { scale: 2, useCORS: true, backgroundColor: '#ffffff' });
            const a = document.createElement('a'); a.download = 'Paileria_Report.png'; a.href = c.toDataURL('image/png'); a.click();
        }

        // â”€â”€ init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        async function exportImage() {
            const r = document.getElementById('report-content');
            const c = await html2canvas(r, { scale: 2, useCORS: true, backgroundColor: '#ffffff' });
            const a = document.createElement('a'); a.download = 'Paileria_Report.png'; a.href = c.toDataURL('image/png'); a.click();
        }

        window.onload = () => {
            // ê¸°ê°„ ì´ˆê¸°ê°’: ì´ë²ˆë‹¬ 1ì¼ ~ ì˜¤ëŠ˜
            const today = getTodayStr();
            const firstOfMonth = today.substring(0, 8) + '01';
            document.getElementById('repair-from').value = firstOfMonth;
            document.getElementById('repair-to').value = today;
            document.getElementById('r-fecha').value = today;

            const saved = localStorage.getItem(STORAGE_KEY);
            if (saved) { try { loadDataObj(JSON.parse(saved)); } catch { document.getElementById('in-date').value = today; addProjectRow(); } }
            else { document.getElementById('in-date').value = today; addProjectRow(); }
            setTimeout(() => renderReport(), 300);
        };
    </script>
    <datalist id="model-list">
        <option value="6500H FRE">
        <option value="6500H REF">
        <option value="6500C FRE">
        <option value="6500C REF">
        <option value="CASE ICE">
        <option value="COVER MULTI">
    </datalist>
</body>

</html>