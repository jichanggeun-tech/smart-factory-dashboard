<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ëŒ€ì°¨</title>
    <!-- Dependencies -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/3.3.4/vue.global.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dexie/3.2.4/dexie.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <style>
        :root {
            --bg-body: #111827;
            --bg-nav: #1f2937;
            --bg-card: #2d3748;
            --bg-input: #374151;
            --text-main: #f9fafb;
            --text-muted: #9ca3af;
            --accent: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --blue: #3b82f6;
            --border: #4b5563;
        }

        body {
            background-color: var(--bg-body);
            color: var(--text-main);
            font-family: 'Segoe UI', sans-serif;
            margin: 0;
            overflow: hidden;
            display: flex;
            height: 100vh;
        }

        /* Sidebar */
        aside {
            width: 260px;
            background: var(--bg-nav);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            padding: 15px;
            transition: margin-left 0.3s ease;
        }

        body.sidebar-collapsed aside {
            margin-left: -260px;
        }

        .brand {
            font-size: 20px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 30px;
            color: var(--blue);
        }

        .nav-item {
            padding: 12px;
            margin-bottom: 5px;
            border-radius: 8px;
            cursor: pointer;
            transition: 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text-muted);
        }

        .nav-item:hover,
        .nav-item.active {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .project-list {
            flex: 1;
            overflow-y: auto;
            margin-top: 20px;
        }

        .project-item {
            padding: 8px 12px;
            cursor: pointer;
            border-radius: 6px;
            margin-bottom: 2px;
            font-size: 14px;
            color: var(--text-muted);
            display: flex;
            justify-content: space-between;
        }

        .project-item:hover,
        .project-item.active {
            background: var(--bg-input);
            color: white;
        }

        /* Sidebar Controls (Home + Toggle wrapper) */
        /* [ìˆ˜ì •ë¨] í‘œì¤€ í™ˆ ë²„íŠ¼ & í† ê¸€ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .sidebar-controls {
            display: flex;
            align-items: center;
            position: fixed;
            top: 15px;
            left: 15px !important;
            z-index: 1001;
            transition: none;
        }

        .home-btn {
            background: #334155 !important;
            color: #e2e8f0 !important;
            border: 1px solid #475569 !important;
            border-radius: 8px 0 0 8px !important;
            /* ë‘¥ê·¼ ì •ë„ 8px */
            height: 28px !important;
            /* ë†’ì´ 28px */
            padding: 0 10px !important;
            box-sizing: border-box !important;
            text-decoration: none !important;
            font-size: 12px !important;
            font-weight: 700 !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            gap: 4px !important;
            margin: 0 !important;
        }

        .home-btn:hover {
            background: #4285F4 !important;
            color: #fff !important;
        }

        .btn-toggle-sidebar {
            width: 24px !important;
            height: 28px !important;
            /* ë†’ì´ 28px */
            background: #1e293b !important;
            border: 1px solid #334155 !important;
            border-left: none !important;
            /* ì™¼ìª½ ì„  ì œê±° (ì—°ê²°íš¨ê³¼) */
            border-radius: 0 8px 8px 0 !important;
            /* ì˜¤ë¥¸ìª½ë§Œ ë‘¥ê¸€ê²Œ */
            box-sizing: border-box !important;
            color: #94a3b8 !important;
            cursor: pointer !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            font-size: 12px !important;
            padding: 0 !important;
        }

        .btn-toggle-sidebar:hover {
            color: white !important;
            background: #334155 !important;
        }

        body.sidebar-collapsed aside {
            margin-left: -260px;
        }

        body.sidebar-collapsed .sidebar-controls {
            left: 15px !important;
        }

        /* Main Content */
        main {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        header {
            height: 60px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            background: var(--bg-body);
        }

        .search-bar {
            background: var(--bg-input);
            border-radius: 6px;
            padding: 8px 15px;
            display: flex;
            align-items: center;
            width: 300px;
        }

        .search-bar input {
            background: transparent;
            border: none;
            color: white;
            margin-left: 10px;
            width: 100%;
            outline: none;
        }

        .actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            background: var(--bg-input);
            border: 1px solid var(--border);
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            transition: 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn:hover {
            background: #4b5563;
        }

        .btn.primary {
            background: var(--blue);
            color: white;
            border: none;
            font-weight: bold;
        }

        .btn.danger {
            background: rgba(239, 68, 68, 0.2);
            color: var(--danger);
            border-color: var(--danger);
        }

        /* Table */
        .table-container {
            flex: 1;
            overflow: auto;
            padding: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        th {
            text-align: left;
            padding: 12px;
            border-bottom: 2px solid var(--border);
            color: var(--text-muted);
            position: sticky;
            top: 0;
            background: var(--bg-body);
            z-index: 10;
        }

        td {
            padding: 10px 12px;
            border-bottom: 1px solid var(--border);
            vertical-align: middle;
        }

        tr:hover {
            background: rgba(255, 255, 255, 0.02);
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal {
            background: var(--bg-card);
            border-radius: 12px;
            width: 700px;
            max-width: 90vw;
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            max-height: 90vh;
        }

        .modal-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border);
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-body {
            padding: 20px;
            overflow-y: auto;
        }

        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .input,
        select {
            width: 100%;
            background: var(--bg-input);
            border: 1px solid var(--border);
            color: white;
            padding: 8px;
            border-radius: 6px;
            margin-top: 4px;
            box-sizing: border-box;
            font-family: inherit;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        /* Print/Report Styles matching Rental Asset */
        @media print {

            aside,
            header,
            .no-print,
            .btn,
            .modal-footer,
            .actions {
                display: none !important;
            }

            body,
            .modal {
                background: white;
                color: black;
                width: 100%;
                height: auto;
                overflow: visible;
                position: static;
            }

            .modal-overlay {
                position: static;
                background: white;
                display: block;
            }

            .modal {
                border: none;
                box-shadow: none;
                max-width: 100%;
                width: 100%;
            }

            th,
            td {
                border: 1px solid #000 !important;
                color: black !important;
            }

            th {
                background: #eee !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
        }

        /* Trend Indicators */
        .trend-up {
            color: #3b82f6;
        }

        /* Blue */
        .trend-down {
            color: #ef4444;
        }

        /* Red */
        .trend-same {
            color: #9ca3af;
        }
    </style>
</head>

<body>
    <div id="app" style="width:100%; display:flex;">

        <!-- SIDEBAR -->
        <aside>
            <div class="brand">
            </div>

            <div class="nav-item" :style="{color: isSyncing ? 'var(--warning)' : 'var(--text-muted)'}">
                <i class="fa-solid" :class="isSyncing ? 'fa-spinner fa-spin' : 'fa-cloud'"></i>
                {{ isSyncing ? 'ë™ê¸°í™” ì¤‘ (Sincronizando...)' : 'ëŒ€ê¸° (Listo)' }}
            </div>

            <div
                style="font-size:12px; font-weight:bold; margin-top:20px; margin-bottom:10px; color:#666; display:flex; justify-content:space-between;">
                PROJECTS (í”„ë¡œì íŠ¸)
                <i class="fa-solid fa-plus" style="cursor:pointer; color:var(--blue);" @click="createProject"></i>
            </div>

            <div class="project-list">
                <div class="project-item" v-for="p in projects" :key="p.id"
                    :class="{active: currentProject && currentProject.id === p.id}" @click="selectProject(p)">
                    <span>{{ p.name }}</span>
                    <i class="fa-solid fa-trash" style="font-size:10px; color:#666;" @click.stop="deleteProject(p)"></i>
                </div>
            </div>

            <div style="margin-top:auto; font-size:11px; text-align:center; color:#444;">
                &copy; Antigravity Systems
            </div>
        </aside>

        <!-- Sidebar Controls (Moved Outside) -->
        <div class="sidebar-controls">
            <a class="home-btn" href="index.html">ğŸ  Home</a>
            <button id="btn-toggle-sidebar" class="btn-toggle-sidebar" onclick="toggleSidebar()">â—€</button>
        </div>



        <!-- MAIN -->
        <main>
            <header>
                <div class="search-bar">
                    <i class="fa-solid fa-search" style="color:#666;"></i>
                    <input v-model="searchQuery" placeholder="ê²€ìƒ‰ (Search / Buscar)...">
                </div>

                <div class="app-title"
                    style="font-size: 20px; font-weight: bold; color: var(--blue); margin-left: 20px;">
                    <i class="fa-solid fa-truck-ramp-box"></i> Cart Manager
                </div>



                <!-- Year Selector -->
                <div style="margin-left:20px; display:flex; align-items:center; gap:10px;">
                    <button class="btn" @click="selectedYear--"><i class="fa-solid fa-chevron-left"></i></button>
                    <span style="font-weight:bold; font-size:16px; color:var(--text-main);">{{ selectedYear }}ë…„</span>
                    <button class="btn" @click="selectedYear++"><i class="fa-solid fa-chevron-right"></i></button>
                </div>

                <div class="actions">
                    <button class="btn" @click="syncFromCloud" title="Download Projects"><i
                            class="fa-solid fa-cloud-arrow-down"></i> ë¶ˆëŸ¬ì˜¤ê¸° (Cargar)</button>
                    <button class="btn" @click="syncToCloud" title="Upload Current Project"><i
                            class="fa-solid fa-cloud-arrow-up"></i> ì €ì¥ (Guardar)</button>
                    <div style="width:1px; height:20px; background:var(--border); margin:0 5px;"></div>

                    <button class="btn btn-primary" @click="openReport">
                        <i class="fa-solid fa-chart-line"></i> ë¦¬í¬íŠ¸ (Reporte)
                    </button>

                    <button class="btn" @click="triggerExcelImport">
                        <i class="fa-solid fa-file-excel"></i> ì—‘ì…€ ê°€ì ¸ì˜¤ê¸°
                    </button>
                    <input type="file" id="excel-import-input" accept=".xlsx,.xls" style="display:none;"
                        @change="importFromExcel">

                    <button class="btn primary" @click="openAddModal">
                        <i class="fa-solid fa-plus"></i> ì¶”ê°€ (Agregar)
                    </button>

                    <button class="btn" @click="showDataModal=true" title="Backup/Restore JSON"><i
                            class="fa-solid fa-database"></i></button>
                </div>
            </header>

            <div class="table-container">
                <table v-if="currentProject">
                    <thead>
                        <tr>
                            <th style="width:40px;">No</th>
                            <th style="width:60px; text-align:center;">Img</th>
                            <th>ê³µì¥ (FÃ¡brica)</th>
                            <th>ëª¨ë¸ëª… (Modelo)</th>
                            <th style="text-align:center;">ì ì¬ ìˆ˜ëŸ‰ (Ctd/Carro)</th>
                            <th style="text-align:center;">ëŒ€ì°¨ìˆ˜ëŸ‰ (Cant. Carros)</th>
                            <th style="text-align:right;">ì´ ì ì¬ëŸ‰ (Cap. Total)</th>
                            <th style="text-align:center;">Q1 ìˆ˜ëŸ‰</th>
                            <th style="text-align:center;">Q2 ìˆ˜ëŸ‰</th>
                            <th style="text-align:center;">Q3 ìˆ˜ëŸ‰</th>
                            <th style="text-align:center;">Q4 ìˆ˜ëŸ‰</th>
                            <th style="width:50px;">í¸ì§‘</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="(c, idx) in filteredCarts" :key="c.id">
                            <td>{{ idx + 1 }}</td>
                            <!-- Image -->
                            <td style="text-align:center;">
                                <div v-if="c.img"
                                    :style="`width:35px; height:35px; background-image:url(${c.img}); background-size:cover; border-radius:4px; margin:0 auto; border:1px solid #555; cursor:pointer`"
                                    @click="setModalImage(c.img)"></div>
                                <span v-else style="color:#555;">-</span>
                            </td>
                            <td>{{ c.factory }}</td>
                            <td style="font-weight:bold; color:var(--blue);">{{ c.modelName }}</td>
                            <td style="text-align:center; color:#ccc;">{{ c.qtyPerCart ?? 0 }}</td>
                            <td style="text-align:center; font-weight:bold; color:var(--accent);">{{ c.cartQty ?? 0 }}
                            </td>
                            <td style="text-align:right; font-family:monospace;">{{ (c.cartQty *
                                c.qtyPerCart).toLocaleString() }}</td>

                            <!-- Quarterly -->
                            <td style="text-align:center; font-size:12px;">{{ getQuarterVal(c, 'q1') }}</td>
                            <td style="text-align:center; font-size:12px;">{{ getQuarterVal(c, 'q2') }}</td>
                            <td style="text-align:center; font-size:12px;">{{ getQuarterVal(c, 'q3') }}</td>
                            <td style="text-align:center; font-size:12px;">{{ getQuarterVal(c, 'q4') }}</td>

                            <td style="text-align:center;">
                                <button style="background:none; border:none; cursor:pointer; color:var(--text-muted);"
                                    @click.stop="editCart(c)">
                                    <i class="fa-solid fa-pen"></i>
                                </button>
                            </td>
                        </tr>
                    </tbody>
                </table>
                <div v-else style="padding:50px; text-align:center; color:var(--text-muted);">
                    <i class="fa-solid fa-truck-ramp-box" style="font-size:48px; margin-bottom:20px;"></i>
                    <p>ì‹œì‘í•˜ë ¤ë©´ í”„ë¡œì íŠ¸ë¥¼ ì„ íƒí•˜ê±°ë‚˜ ìƒì„±í•˜ì„¸ìš”.<br>(Seleccione o cree un proyecto para comenzar.)</p>
                </div>
            </div>
        </main>

        <!-- REPORT MODAL -->
        <div v-if="showReportModal" class="modal-overlay" @click.self="showReportModal=false">
            <div class="modal" id="report-modal"
                style="width:1200px; max-width:98vw; height:90vh; display:flex; flex-direction:column;">
                <div class="modal-header">
                    <div style="display:flex; align-items:center; gap:10px;">
                        <span>ğŸ“Š ëŒ€ì°¨ ìš´ìš© ë¦¬í¬íŠ¸ (Reporte de OperaciÃ³n de Carros)</span>
                        <span style="font-size:1.2em; color:var(--blue);">{{ selectedYear }}</span>
                    </div>
                    <div class="actions">
                        <button class="btn btn-secondary" @click="captureReport">ğŸ“· ìº¡ì²˜ (Captura)</button>
                        <button class="btn btn-primary" @click="printReport">ğŸ–¨ PDF ì¸ì‡„ (Imprimir)</button>
                        <i class="fa-solid fa-times" style="cursor:pointer; margin-left:10px;"
                            @click="showReportModal=false"></i>
                    </div>
                </div>
                <div class="modal-body" id="report-print-area"
                    style="background:white; color:black; flex:1; padding:30px;">
                    <h2 style="text-align:center; margin-bottom:5px;">ëŒ€ì°¨ ìì‚° í˜„í™© (Estado de Activos de Carros)</h2>
                    <h4 style="text-align:center; margin-top:0; color:#555;">Project: {{ currentProject?.name }} | Year:
                        {{ selectedYear }}</h4>

                    <table style="width:100%; border-collapse:collapse; border:1px solid #000; font-size:11px;">
                        <thead>
                            <tr style="background:#eee; color:black;">
                                <th style="border:1px solid #000; padding:6px;">No</th>
                                <th style="border:1px solid #000; padding:6px;">Img (ì‚¬ì§„)</th>
                                <th style="border:1px solid #000; padding:6px;">ê³µì¥ (FÃ¡brica)</th>
                                <th style="border:1px solid #000; padding:6px;">ëª¨ë¸ëª… (Modelo)</th>
                                <th style="border:1px solid #000; padding:6px; text-align:center;">ì ì¬ ìˆ˜ëŸ‰ (Ctd/Carro)
                                </th>

                                <th style="border:1px solid #000; padding:6px; text-align:center; background:#e0f7fa;">
                                    Q1</th>
                                <th style="border:1px solid #000; padding:6px; text-align:center; background:#f3e5f5;">
                                    Q2</th>
                                <th style="border:1px solid #000; padding:6px; text-align:center; background:#fff3e0;">
                                    Q3</th>
                                <th style="border:1px solid #000; padding:6px; text-align:center; background:#f1f8e9;">
                                    Q4</th>

                                <th style="border:1px solid #000; padding:6px; text-align:center; background:#ffebee;">
                                    í˜„ì¬ (Actual)</th>
                                <th style="border:1px solid #000; padding:6px; text-align:center; background:#e8f5e9;">
                                    ì´ ì ì¬ëŸ‰ (Cap. Total)</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="(c, idx) in filteredCarts" :key="c.id">
                                <td style="border:1px solid #ccc; padding:4px; text-align:center;">{{ idx + 1 }}</td>
                                <td style="border:1px solid #ccc; padding:4px; text-align:center;">
                                    <div v-if="c.img"
                                        :style="`width:40px; height:40px; background-image:url(${c.img}); background-size:cover; background-position:center; margin:0 auto; border:1px solid #ddd;`">
                                    </div>
                                    <span v-else>-</span>
                                </td>
                                <td style="border:1px solid #ccc; padding:4px;">{{ c.factory }}</td>
                                <td style="border:1px solid #ccc; padding:4px; font-weight:bold;">{{ c.modelName }}</td>
                                <td style="border:1px solid #ccc; padding:4px; text-align:center;">{{ c.qtyPerCart ?? 0
                                    }}
                                </td>

                                <!-- Quarterly Data with Trend Arrows -->
                                <td style="border:1px solid #ccc; padding:4px; text-align:center; background:#e0f7fa;">
                                    {{ getQuarterVal(c, 'q1') }}
                                </td>
                                <td style="border:1px solid #ccc; padding:4px; text-align:center; background:#f3e5f5;">
                                    {{ getQuarterVal(c, 'q2') }}
                                    <i v-if="getTrend(c, 'q1', 'q2') !== 0" class="fa-solid"
                                        :class="getTrend(c, 'q1', 'q2') > 0 ? 'fa-caret-up trend-up' : 'fa-caret-down trend-down'"></i>
                                </td>
                                <td style="border:1px solid #ccc; padding:4px; text-align:center; background:#fff3e0;">
                                    {{ getQuarterVal(c, 'q3') }}
                                    <i v-if="getTrend(c, 'q2', 'q3') !== 0" class="fa-solid"
                                        :class="getTrend(c, 'q2', 'q3') > 0 ? 'fa-caret-up trend-up' : 'fa-caret-down trend-down'"></i>
                                </td>
                                <td style="border:1px solid #ccc; padding:4px; text-align:center; background:#f1f8e9;">
                                    {{ getQuarterVal(c, 'q4') }}
                                    <i v-if="getTrend(c, 'q3', 'q4') !== 0" class="fa-solid"
                                        :class="getTrend(c, 'q3', 'q4') > 0 ? 'fa-caret-up trend-up' : 'fa-caret-down trend-down'"></i>
                                </td>

                                <td
                                    style="border:1px solid #000; padding:4px; text-align:center; background:#ffebee; font-weight:bold;">
                                    {{ c.cartQty }}
                                </td>
                                <td
                                    style="border:1px solid #000; padding:4px; text-align:right; background:#e8f5e9; font-weight:bold; font-family:monospace;">
                                    {{ (c.cartQty * c.qtyPerCart).toLocaleString() }}
                                </td>
                            </tr>
                        </tbody>
                    </table>
                    <div style="margin-top:20px; font-size:10px; text-align:right;">
                        Generated by Cart Manager | {{ new Date().toLocaleString() }}
                    </div>
                </div>
            </div>
        </div>

        <!-- ADD/EDIT MODAL -->
        <div v-if="showCartModal" class="modal-overlay" @click.self="showCartModal=false">
            <div class="modal" style="width:800px;">
                <div class="modal-header">
                    <span>{{ editingCart.id ? 'ìˆ˜ì • (Editar)' : 'ì¶”ê°€ (Agregar)' }} Cart</span>
                    <i class="fa-solid fa-times" style="cursor:pointer;" @click="showCartModal=false"></i>
                </div>
                <div class="modal-body">
                    <div style="display:flex; gap:20px;">
                        <!-- Image Upload -->
                        <div style="flex:0 0 160px; display:flex; flex-direction:column; gap:10px;">
                            <div
                                style="width:160px; height:160px; border:2px dashed var(--border); border-radius:8px; display:flex; align-items:center; justify-content:center; overflow:hidden; position:relative; background:#1f2937;">
                                <img v-if="editingCart.img" :src="editingCart.img"
                                    style="width:100%; height:100%; object-fit:contain;">
                                <div style="position:absolute; bottom:5px; left:0; right:0; text-align:center; color:#aaa; font-size:11px;"
                                    v-if="!editingCart.img">Click / Paste</div>
                                <input type="file" @change="handleImageUpload" accept="image/*"
                                    style="position:absolute; inset:0; opacity:0; cursor:pointer;">
                                <i v-if="editingCart.img" class="fa-solid fa-times" @click.prevent="editingCart.img=''"
                                    style="position:absolute; top:5px; right:5px; cursor:pointer; background:rgba(0,0,0,0.6); color:white; padding:4px; border-radius:50%;"></i>
                            </div>
                        </div>

                        <!-- Fields -->
                        <div style="flex:1; display:flex; flex-direction:column; gap:10px;">
                            <div class="grid">
                                <div>
                                    <small>ê³µì¥ (FÃ¡brica)</small>
                                    <select v-model="editingCart.factory" class="input">
                                        <option value="1ê³µì¥">1ê³µì¥</option>
                                        <option value="3ê³µì¥">3ê³µì¥</option>
                                        <option value="ê¸°íƒ€ (Otro)">ê¸°íƒ€ (Otro)</option>
                                    </select>
                                </div>
                                <div>
                                    <small>ë¶€ì„œ (Departamento)</small>
                                    <input v-model="editingCart.department" class="input">
                                </div>
                            </div>

                            <div>
                                <small>ëª¨ë¸ëª… (Modelo)</small>
                                <input v-model="editingCart.modelName" class="input" placeholder="í•„ìˆ˜ (Requerido)">
                            </div>

                            <div class="grid">
                                <div>
                                    <small>ëŒ€ë‹¹ ì ì¬ìˆ˜ëŸ‰ (Cant. por Carro)</small>
                                    <input v-model.number="editingCart.qtyPerCart" type="number" class="input">
                                </div>
                                <div>
                                    <small style="color:var(--accent);">í˜„ì¬ ëŒ€ì°¨ìˆ˜ëŸ‰ (Cant. de Carros)</small>
                                    <input v-model.number="editingCart.cartQty" type="number" class="input"
                                        style="border:1px solid var(--accent);">
                                </div>
                            </div>

                            <!-- Quarterly Data -->
                            <div
                                style="background:var(--bg-input); padding:10px; border-radius:6px; border:1px solid var(--border); margin-top:10px;">
                                <div style="font-weight:bold; margin-bottom:5px; color:var(--blue);">
                                    {{ selectedYear }} ë¶„ê¸°ë³„ ëŒ€ì°¨ìˆ˜ëŸ‰ í˜„í™© (Estado Trimestral)
                                </div>
                                <div class="grid" style="grid-template-columns: 1fr 1fr 1fr 1fr; gap:5px;">
                                    <div><small>Q1</small><input v-model.number="editingQuarterly.q1" type="number"
                                            class="input" placeholder="-"></div>
                                    <div><small>Q2</small><input v-model.number="editingQuarterly.q2" type="number"
                                            class="input" placeholder="-"></div>
                                    <div><small>Q3</small><input v-model.number="editingQuarterly.q3" type="number"
                                            class="input" placeholder="-"></div>
                                    <div><small>Q4</small><input v-model.number="editingQuarterly.q4" type="number"
                                            class="input" placeholder="-"></div>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button v-if="editingCart.id" class="btn danger" style="margin-right:auto;" @click="deleteCart">ì‚­ì œ
                        (Eliminar)</button>
                    <button class="btn" @click="showCartModal=false">ì·¨ì†Œ (Cancelar)</button>
                    <button class="btn primary" @click="saveCart">ì €ì¥ (Guardar)</button>
                </div>
            </div>
        </div>

        <!-- DATA MODAL -->
        <div v-if="showDataModal" class="modal-overlay" @click.self="showDataModal=false">
            <div class="modal" style="width:400px;">
                <div class="modal-header">ë°±ì—… ë° ë³µì› (Respaldo y RestauraciÃ³n) <i class="fa-solid fa-times"
                        style="cursor:pointer;" @click="showDataModal=false"></i></div>
                <div class="modal-body">
                    <div style="margin-bottom:20px;">
                        <h4>1. ë°±ì—… (Exportar)</h4>
                        <button class="btn primary" style="width:100%;" @click="downloadJsonBackup"><i
                                class="fa-solid fa-download"></i> JSON ë‹¤ìš´ë¡œë“œ</button>
                    </div>
                    <div>
                        <h4>2. ë³µì› (Importar)</h4>
                        <button class="btn" style="width:100%; position:relative; overflow:hidden;">
                            <i class="fa-solid fa-upload"></i> íŒŒì¼ ì„ íƒ
                            <input type="file" accept=".json" @change="uploadJsonRestore"
                                style="position:absolute; inset:0; opacity:0; cursor:pointer;">
                        </button>
                    </div>
                    <div style="margin-top:20px; border-top:1px solid #444; padding-top:10px;">
                        <button class="btn danger" style="width:100%;" @click="clearAllData"><i
                                class="fa-solid fa-trash-can"></i> ì´ˆê¸°í™” (Reset)</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- CLOUD MODAL -->
        <div v-if="showCloudModal" class="modal-overlay" @click.self="showCloudModal=false">
            <div class="modal" style="width:400px;">
                <div class="modal-header">í´ë¼ìš°ë“œ í”„ë¡œì íŠ¸ (Proyectos Nube) <i class="fa-solid fa-times"
                        style="cursor:pointer;" @click="showCloudModal=false"></i></div>
                <div class="modal-body">
                    <div v-for="p in cloudProjectsList" :key="p.name"
                        style="display:flex; align-items:center; gap:5px; margin-bottom:5px;">
                        <button class="btn" style="text-align:left; justify-content:flex-start; flex:1;"
                            @click="loadSelectedCloudProject(p.name)">
                            <i class="fa-solid fa-folder" style="color:var(--blue); margin-right:10px;"></i>
                            {{ p.name }} <span style="margin-left:auto; font-size:11px; color:#888;">({{ p.count
                                }})</span>
                        </button>
                        <button class="btn danger" style="padding:0 10px;" @click.stop="deleteCloudProject(p.name)">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ImageViewer -->
        <div v-if="zoomedImage" class="modal-overlay" @click="zoomedImage=null">
            <img :src="zoomedImage" style="max-width:90%; max-height:90vh; border-radius:8px; border:2px solid white;">
        </div>

    </div>

    <script>
        const CLOUD_URL = "https://script.google.com/macros/s/AKfycbzinBaV7wad_mFQuu2ph69TXWQ-sSVl5sT6payj2uGVHglUEvCjTq1o-wCPZdnwKOxn2A/exec";
        const { createApp, ref, computed, reactive, onMounted, onUnmounted } = Vue;
        const db = new Dexie('CartManagerDB');
        // V2 Migration: Using same store names but ensuring robust schema
        db.version(1).stores({
            projects: '++id, name, updated',
            carts: '++id, projectId, modelName, factory, department'
        });

        createApp({
            setup() {
                const projects = ref([]);
                const currentProject = ref(null);
                const projectCarts = ref([]);
                const searchQuery = ref("");
                const showCartModal = ref(false);
                const showReportModal = ref(false);
                const showDataModal = ref(false);
                const showCloudModal = ref(false);
                const isSyncing = ref(false);
                const isImageProcessing = ref(false);
                const zoomedImage = ref(null);

                const selectedYear = ref(new Date().getFullYear());
                const cloudProjectsList = ref([]);
                const rawCloudData = ref([]);

                const defaultCart = {
                    projectId: null,
                    modelName: '',
                    factory: '1ê³µì¥',
                    qtyPerCart: 100,
                    cartQty: 0,
                    img: '',
                    quarterly: {} // { "2024": { q1: 10, q2: 20... } }
                };
                const editingCart = reactive({ ...defaultCart });
                const editingQuarterly = reactive({ q1: null, q2: null, q3: null, q4: null });

                // --- Image ---
                const handleImageUpload = (e) => { const f = e.target.files[0]; if (f) processImageFile(f); };
                const processImageFile = (file) => {
                    isImageProcessing.value = true;
                    const r = new FileReader();
                    r.onload = (ev) => {
                        const img = new Image();
                        img.onload = () => {
                            const c = document.createElement('canvas');
                            const MAX = 300; // Reduced for Safety
                            let w = img.width, h = img.height;
                            if (w > h && w > MAX) { h *= MAX / w; w = MAX; } else if (h > MAX) { w *= MAX / h; h = MAX; }
                            c.width = w; c.height = h;
                            c.getContext('2d').drawImage(img, 0, 0, w, h);
                            editingCart.img = c.toDataURL('image/jpeg', 0.5); // Lower quality
                            isImageProcessing.value = false;
                        };
                        img.src = ev.target.result;
                    };
                    r.readAsDataURL(file);
                };

                const handlePaste = (e) => {
                    if (!showCartModal.value) return;
                    const items = (e.clipboardData || e.originalEvent.clipboardData).items;
                    for (let item of items) {
                        if (item.kind === 'file' && item.type.includes('image/')) {
                            e.preventDefault();
                            processImageFile(item.getAsFile());
                            return; // Stop after first image
                        }
                    }
                };

                onMounted(async () => {
                    loadProjects();
                    window.addEventListener('paste', handlePaste);
                    const lastId = localStorage.getItem('lastCartProjectId');
                    if (lastId) {
                        const p = await db.projects.get(parseInt(lastId));
                        if (p) selectProject(p);
                    }
                });
                onUnmounted(() => window.removeEventListener('paste', handlePaste));

                // --- Computed ---
                const filteredCarts = computed(() => {
                    let c = projectCarts.value;
                    const q = searchQuery.value.toLowerCase();
                    if (q) c = c.filter(x =>
                        (x.modelName || '').toLowerCase().includes(q) ||
                        (x.factory || '').toLowerCase().includes(q)
                    );
                    return c.sort((a, b) => (a.modelName || '').localeCompare(b.modelName || ''));
                });

                // --- DB Actions ---
                const loadProjects = async () => { projects.value = await db.projects.toArray(); };
                const createProject = async () => {
                    const n = prompt("í”„ë¡œì íŠ¸ ì´ë¦„ (Nombre del Proyecto):"); if (!n) return;
                    await db.projects.add({ name: n, updated: new Date() });
                    loadProjects();
                };
                const selectProject = async (p) => {
                    currentProject.value = p;
                    projectCarts.value = await db.carts.where('projectId').equals(p.id).toArray();
                    localStorage.setItem('lastCartProjectId', p.id);
                };
                const deleteProject = async (p) => {
                    if (!confirm(`í”„ë¡œì íŠ¸ '${p.name}' ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (Delete Project?)`)) return;
                    await db.projects.delete(p.id);
                    await db.carts.where('projectId').equals(p.id).delete();
                    if (currentProject.value?.id === p.id) { currentProject.value = null; projectCarts.value = []; }
                    loadProjects();
                };

                // --- Cart Actions ---
                const openAddModal = () => {
                    if (!currentProject.value) return alert("í”„ë¡œì íŠ¸ë¥¼ ì„ íƒí•˜ì„¸ìš”! (Seleccione un proyecto!)");
                    Object.assign(editingCart, { ...defaultPart, projectId: currentProject.value.id, quarterly: {} });
                    Object.assign(editingQuarterly, { q1: null, q2: null, q3: null, q4: null });

                    // í˜„ì¬ ë¶„ê¸°ì— í˜„ì¬ ìˆ˜ëŸ‰ ì œì•ˆ
                    const currentQ = getCurrentQuarter();
                    editingQuarterly[currentQ] = editingCart.cartQty;

                    showCartModal.value = true;
                };

                const editCart = (c) => {
                    Object.assign(editingCart, JSON.parse(JSON.stringify(c)));
                    if (!editingCart.quarterly) editingCart.quarterly = {};

                    const y = selectedYear.value.toString();
                    const qData = editingCart.quarterly[y] || { q1: null, q2: null, q3: null, q4: null };

                    // í˜„ì¬ ë¶„ê¸° ë°ì´í„°ê°€ ë¹„ì–´ìˆë‹¤ë©´, í˜„ì¬ ìˆ˜ëŸ‰ì„ ê¸°ë°˜ìœ¼ë¡œ ì´ˆê¸°í™” ì œì•ˆ
                    const currentQ = getCurrentQuarter();
                    const isCurrentYear = new Date().getFullYear() === selectedYear.value;

                    if (isCurrentYear && (qData[currentQ] === null || qData[currentQ] === undefined)) {
                        qData[currentQ] = editingCart.cartQty;
                    }

                    Object.assign(editingQuarterly, qData);
                    showCartModal.value = true;
                };

                const saveCart = async () => {
                    if (isImageProcessing.value) return alert("ì´ë¯¸ì§€ ì²˜ë¦¬ì¤‘... (Procesando imagen...)");
                    if (!editingCart.modelName) return alert("ëª¨ë¸ëª… í•„ìˆ˜! (Modelo requerido!)");

                    const copy = JSON.parse(JSON.stringify(editingCart));

                    // Save Quarterly
                    const y = selectedYear.value.toString();
                    if (!copy.quarterly) copy.quarterly = {};

                    // í˜„ì¬ ë¶„ê¸° ë°ì´í„°ê°€ ì…ë ¥ë˜ì§€ ì•Šì•˜ë‹¤ë©´ í˜„ì¬ ìˆ˜ëŸ‰ì„ ìë™ìœ¼ë¡œ ê¸°ë¡
                    const currentQ = getCurrentQuarter();
                    const isCurrentYear = new Date().getFullYear() === selectedYear.value;
                    if (isCurrentYear && (editingQuarterly[currentQ] === null || editingQuarterly[currentQ] === undefined)) {
                        editingQuarterly[currentQ] = copy.cartQty;
                    }

                    copy.quarterly[y] = { ...editingQuarterly };

                    if (copy.id) {
                        await db.carts.put(copy);
                        projectCarts.value = projectCarts.value.map(c => c.id === copy.id ? copy : c);
                    } else {
                        const id = await db.carts.add(copy);
                        copy.id = id;
                        projectCarts.value.push(copy);
                    }
                    showCartModal.value = false;
                };

                const deleteCart = async () => {
                    if (!confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (Eliminar?)")) return;
                    await db.carts.delete(editingCart.id);
                    projectCarts.value = projectCarts.value.filter(c => c.id !== editingCart.id);
                    showCartModal.value = false;
                };

                // --- Image ---

                const setModalImage = (src) => zoomedImage.value = src;

                // --- Util ---
                const getCurrentQuarter = () => {
                    const month = new Date().getMonth(); // 0-11
                    if (month >= 0 && month <= 2) return 'q1';
                    if (month >= 3 && month <= 5) return 'q2';
                    if (month >= 6 && month <= 8) return 'q3';
                    return 'q4';
                };

                const getQuarterVal = (c, qKey) => {
                    const y = selectedYear.value.toString();
                    let val = (c.quarterly && c.quarterly[y]) ? c.quarterly[y][qKey] : null;

                    // í•´ë‹¹ ë¶„ê¸° ë°ì´í„°ê°€ ë¹„ì–´ìˆê³ , 'í˜„ì¬ ë¶„ê¸°'ë¼ë©´ í˜„ì¬ ìˆ˜ëŸ‰ì„ ê¸°ë°˜ìœ¼ë¡œ ë¯¸ë¦¬ë³´ê¸°
                    const currentQ = getCurrentQuarter();
                    const isCurrentYear = new Date().getFullYear() === selectedYear.value;

                    if (isCurrentYear && qKey === currentQ && (val === null || val === undefined)) {
                        val = c.cartQty;
                    }

                    return (val === null || val === undefined) ? '-' : val;
                };
                const getTrend = (c, prevKey, currKey) => {
                    const y = selectedYear.value.toString();
                    if (!c.quarterly || !c.quarterly[y]) return 0;
                    const prev = c.quarterly[y][prevKey];
                    const curr = c.quarterly[y][currKey];
                    if (prev == null || curr == null) return 0;
                    return curr - prev;
                };

                // --- Cloud ---
                const syncToCloud = async () => {
                    if (!currentProject.value) return alert("í”„ë¡œì íŠ¸ ì„ íƒ í•„ìš”! (Seleccione proyecto!)");
                    if (!confirm("í´ë¼ìš°ë“œì— ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (Guardar en Nube?)")) return;
                    isSyncing.value = true;
                    try {
                        const batchId = Date.now();
                        const parts = projectCarts.value.map(p => ({ ...p, project: currentProject.value.name, batchId, isCart: true }));
                        if (parts.length === 0) parts.push({ project: currentProject.value.name, batchId, isCart: true, modelName: 'EMPTY' });

                        const r = await fetch(CLOUD_URL, {
                            method: 'POST', redirect: 'follow',
                            body: JSON.stringify({ action: 'save', project: currentProject.value.name, parts })
                        });
                        const res = await r.json();
                        if (res.result === 'error') throw new Error(res.message);
                        alert("ì €ì¥ ì™„ë£Œ! (Guardado!)");
                    } catch (e) { alert("Error: " + e); } finally { isSyncing.value = false; }
                };

                const syncFromCloud = async () => {
                    isSyncing.value = true;
                    try {
                        const r = await fetch(CLOUD_URL + "?action=load", { redirect: 'follow' });
                        if (!r.ok) throw new Error(r.status);
                        const d = await r.json();
                        if (!d.parts) return alert("ë°ì´í„° ì—†ìŒ (No data)");
                        rawCloudData.value = d.parts;

                        const counts = {};
                        d.parts.forEach(p => {
                            if (p.isCart || p.modelName) {
                                const n = (p.project || 'Unknown').trim();
                                counts[n] = (counts[n] || 0) + 1;
                            }
                        });
                        cloudProjectsList.value = Object.keys(counts).map(k => ({ name: k, count: counts[k] }));
                        showCloudModal.value = true;
                    } catch (e) { alert("Error: " + e); } finally { isSyncing.value = false; }
                };

                const loadSelectedCloudProject = async (pName) => {
                    if (!confirm("ë®ì–´ì”ë‹ˆê¹Œ? (Overwrite?)")) return;
                    const cloudParts = JSON.parse(JSON.stringify(rawCloudData.value.filter(p => (p.project || '').trim() === pName)));

                    let proj = projects.value.find(p => p.name === pName);
                    if (!proj) {
                        const id = await db.projects.add({ name: pName, updated: new Date() });
                        await loadProjects();
                        proj = projects.value.find(p => p.id === id);
                    }
                    await selectProject(proj);
                    await db.carts.where('projectId').equals(proj.id).delete();

                    const toAdd = cloudParts.filter(p => p.modelName !== 'EMPTY').map(p => {
                        const { id, project, isCart, _syncId, batchId, ...rest } = p;
                        return { ...rest, projectId: proj.id };
                    });
                    if (toAdd.length > 0) await db.carts.bulkAdd(toAdd);

                    projectCarts.value = await db.carts.where('projectId').equals(proj.id).toArray();
                    showCloudModal.value = false;
                    alert("ë¡œë“œ ì™„ë£Œ (Loaded!)");
                };

                const deleteCloudProject = async (pName) => {
                    if (!confirm(`ì˜êµ¬ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (Delete permanently?)`)) return;
                    isSyncing.value = true;
                    try {
                        const r = await fetch(CLOUD_URL, {
                            method: 'POST',
                            body: JSON.stringify({ action: 'save', project: pName, parts: [] })
                        });
                        const res = await r.json();
                        if (res.result === 'error') throw new Error(res.message);
                        alert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤. (Deleted.)");
                        showCloudModal.value = false;
                    } catch (e) { alert("Error: " + e); } finally { isSyncing.value = false; }
                };

                // --- Backup ---
                const downloadJsonBackup = () => {
                    db.transaction('r', db.projects, db.carts, async () => {
                        const d = { projects: await db.projects.toArray(), carts: await db.carts.toArray() };
                        const b = new Blob([JSON.stringify(d)], { type: "application/json" });
                        const a = document.createElement('a'); a.href = URL.createObjectURL(b);
                        a.download = `CartManager_${new Date().toISOString().slice(0, 10)}.json`; a.click();
                    });
                };
                const uploadJsonRestore = (e) => {
                    const f = e.target.files[0]; if (!f) return;
                    const r = new FileReader();
                    r.onload = async (ev) => {
                        try {
                            const d = JSON.parse(ev.target.result);
                            if (confirm("ëª¨ë“  ë°ì´í„°ë¥¼ ì´ˆê¸°í™”í•˜ê³  ë³µì›í•©ë‹ˆê¹Œ? (Reset & Restore?)")) {
                                await db.projects.clear(); await db.carts.clear();
                                if (d.projects) await db.projects.bulkAdd(d.projects);
                                if (d.carts) await db.carts.bulkAdd(d.carts);
                                location.reload();
                            }
                        } catch (er) { alert("Invalid File"); }
                    }; r.readAsText(f);
                };
                const clearAllData = async () => {
                    if (confirm("ì •ë§ ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí•©ë‹ˆê¹Œ? (Delete ALL?)")) {
                        await db.projects.clear(); await db.carts.clear();
                        localStorage.clear();
                        window.location.reload();
                    }
                };

                // --- Excel Import ---
                const triggerExcelImport = () => {
                    if (!currentProject.value) return alert("í”„ë¡œì íŠ¸ë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”! (Seleccione un proyecto!)");
                    document.getElementById('excel-import-input').click();
                };

                const importFromExcel = async (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    e.target.value = '';

                    const buf = await file.arrayBuffer();
                    const wb = XLSX.read(buf, { type: 'array' });
                    const ws = wb.Sheets[wb.SheetNames[0]];
                    const rows = XLSX.utils.sheet_to_json(ws, { header: 1 });

                    // í—¤ë” í–‰ ì°¾ê¸° (TIPO ë˜ëŠ” NÂ° í¬í•¨ í–‰)
                    let headerIdx = rows.findIndex(r => r.some(c => typeof c === 'string' && (c.includes('TIPO') || c === 'NÂ°')));
                    if (headerIdx < 0) return alert("í—¤ë”ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");

                    const header = rows[headerIdx];
                    const colIdx = {
                        location: header.findIndex(c => typeof c === 'string' && c.toUpperCase().includes('UBIC')),
                        modelName: header.findIndex(c => typeof c === 'string' && c.includes('TIPO')),
                        size: header.findIndex(c => typeof c === 'string' && (c.toUpperCase().includes('ANCHO') || c.includes('*'))),
                        qtyPerCart: header.findIndex(c => typeof c === 'string' && c.toUpperCase().includes('CAPAC')),
                        q1: header.findIndex(c => typeof c === 'string' && /^1Q$/i.test(c.trim())),
                        q2: header.findIndex(c => typeof c === 'string' && /^2Q$/i.test(c.trim())),
                        q3: header.findIndex(c => typeof c === 'string' && /^3Q$/i.test(c.trim())),
                        q4: header.findIndex(c => typeof c === 'string' && /^4Q$/i.test(c.trim())),
                    };

                    console.log('[ExcelImport] ì½œëŸ¼ ì¸ë±ìŠ¤:', colIdx);
                    if (colIdx.modelName < 0) return alert("ëª¨ë¸ëª… ì½œëŸ¼(TIPO)ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");

                    const toFactory = (val) => {
                        if (!val) return '1ê³µì¥';
                        const s = String(val).trim();
                        if (s.includes('3')) return '3ê³µì¥';
                        if (s.includes('1')) return '1ê³µì¥';
                        return s;
                    };
                    const getNum = (r, idx) => (idx >= 0 && r[idx] != null && r[idx] !== '') ? Number(r[idx]) : null;

                    const dataRows = rows.slice(headerIdx + 1).filter(r => r[colIdx.modelName] && String(r[colIdx.modelName]).trim() !== '');
                    console.log('[ExcelImport] ë°ì´í„° í–‰ ìˆ˜:', dataRows.length);
                    if (dataRows.length === 0) return alert("ê°€ì ¸ì˜¬ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
                    if (!confirm(`${dataRows.length}ê°œ í•­ëª©ì„ ê°€ì ¸ì˜¤ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

                    const y = selectedYear.value.toString();
                    const currentQ = getCurrentQuarter();

                    // â˜… í•µì‹¬: DBì—ì„œ ì§ì ‘ ìµœì‹  ëª©ë¡ì„ ê°€ì ¸ì™€ ëª¨ë¸ëª…ìœ¼ë¡œ ì¸ë±ì‹±
                    const dbCarts = await db.carts.where('projectId').equals(currentProject.value.id).toArray();
                    const existingByModel = {};
                    dbCarts.forEach(c => {
                        const key = String(c.modelName || '').trim();
                        if (key) existingByModel[key] = c;
                    });
                    console.log('[ExcelImport] ê¸°ì¡´ ëª¨ë¸ ëª©ë¡:', Object.keys(existingByModel));

                    let added = 0, updated = 0;
                    for (const r of dataRows) {
                        const modelName = String(r[colIdx.modelName]).trim();
                        const factory = toFactory(colIdx.location >= 0 ? r[colIdx.location] : null);
                        const size = (colIdx.size >= 0 && r[colIdx.size] != null) ? String(r[colIdx.size]).trim() : '';
                        const qtyPerCart = getNum(r, colIdx.qtyPerCart) ?? 0;

                        const qData = {};
                        const v1 = getNum(r, colIdx.q1); if (v1 !== null) qData.q1 = v1;
                        const v2 = getNum(r, colIdx.q2); if (v2 !== null) qData.q2 = v2;
                        const v3 = getNum(r, colIdx.q3); if (v3 !== null) qData.q3 = v3;
                        const v4 = getNum(r, colIdx.q4); if (v4 !== null) qData.q4 = v4;

                        const cartQty = qData[currentQ] ?? qData.q4 ?? qData.q3 ?? qData.q2 ?? qData.q1 ?? 0;

                        console.log(`[ExcelImport] "${modelName}", ê¸°ì¡´:`, !!existingByModel[modelName]);

                        if (existingByModel[modelName]) {
                            const existing = existingByModel[modelName];
                            if (!existing.quarterly) existing.quarterly = {};
                            if (!existing.quarterly[y]) existing.quarterly[y] = {};
                            Object.assign(existing.quarterly[y], qData);
                            existing.cartQty = cartQty;
                            existing.factory = factory;
                            existing.qtyPerCart = qtyPerCart;
                            if (size) existing.size = size;
                            await db.carts.put(existing);
                            updated++;
                        } else {
                            const newCart = { projectId: currentProject.value.id, modelName, factory, size, qtyPerCart, cartQty, img: '', quarterly: Object.keys(qData).length > 0 ? { [y]: qData } : {} };
                            const id = await db.carts.add(newCart);
                            newCart.id = id;
                            existingByModel[modelName] = newCart;
                            added++;
                        }
                    }

                    projectCarts.value = await db.carts.where('projectId').equals(currentProject.value.id).toArray();
                    alert(`ì™„ë£Œ!\nì‹ ê·œ: ${added}ê°œ ì¶”ê°€\nì—…ë°ì´íŠ¸: ${updated}ê°œ`);
                };

                // --- Report ---
                const openReport = () => { showReportModal.value = true; };
                const printReport = () => window.print();
                const captureReport = async () => {
                    const el = document.getElementById('report-print-area');
                    const canvas = await html2canvas(el, { scale: 2 });
                    const a = document.createElement('a');
                    a.href = canvas.toDataURL();
                    a.download = `CartReport_${selectedYear.value}.png`;
                    a.click();
                };

                return {
                    projects, currentProject, filteredCarts, searchQuery,
                    showCartModal, showReportModal, showDataModal, showCloudModal,
                    editingCart, editingQuarterly, selectedYear,
                    isSyncing, isImageProcessing, zoomedImage, cloudProjectsList,
                    createProject, selectProject, deleteProject,
                    openAddModal, editCart, saveCart, deleteCart,
                    handleImageUpload, setModalImage,
                    getQuarterVal, getTrend,
                    syncToCloud, syncFromCloud, loadSelectedCloudProject, deleteCloudProject,
                    downloadJsonBackup, uploadJsonRestore, clearAllData,
                    triggerExcelImport, importFromExcel,
                    openReport, printReport, captureReport
                };
            }
        }).mount('#app');

        window.toggleSidebar = function () {
            document.body.classList.toggle('sidebar-collapsed');
            const btn = document.getElementById('btn-toggle-sidebar');
            btn.innerText = document.body.classList.contains('sidebar-collapsed') ? "â–¶" : "â—€";
            setTimeout(() => window.dispatchEvent(new Event('resize')), 300);
        };
    </script>
</body>

</html>