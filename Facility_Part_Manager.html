<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÏÑ§ÎπÑ Spare</title>
    <!-- Dependencies -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/3.3.4/vue.global.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dexie/3.2.4/dexie.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>


    <style>
        :root {
            --bg-body: #111827;
            --bg-nav: #1f2937;
            --bg-card: #2d3748;
            --bg-input: #374151;
            --text-main: #f9fafb;
            --text-muted: #9ca3af;
            --accent: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --blue: #3b82f6;
            --border: #4b5563;
        }

        body {
            background-color: var(--bg-body);
            color: var(--text-main);
            font-family: 'Segoe UI', sans-serif;
            margin: 0;
            overflow: hidden;
            display: flex;
            height: 100vh;
        }

        /* Sidebar */
        aside {
            width: 260px;
            background: var(--bg-nav);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            padding: 15px;
            transition: margin-left 0.3s ease;
        }

        .brand {
            font-size: 20px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 30px;
            color: var(--accent);
        }

        .nav-item {
            padding: 12px;
            margin-bottom: 5px;
            border-radius: 8px;
            cursor: pointer;
            transition: 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text-muted);
        }

        .nav-item:hover,
        .nav-item.active {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .project-list {
            flex: 1;
            overflow-y: auto;
            margin-top: 20px;
        }

        .project-item {
            padding: 8px 12px;
            cursor: pointer;
            border-radius: 6px;
            margin-bottom: 2px;
            font-size: 14px;
            color: var(--text-muted);
            display: flex;
            justify-content: space-between;
        }

        .project-item:hover,
        .project-item.active {
            background: var(--bg-input);
            color: white;
        }

        /* Sidebar Controls (Home + Toggle wrapper) */
        /* Sidebar Controls (Home + Toggle wrapper) */
        .sidebar-controls {
            display: flex;
            align-items: center;
            position: fixed;
            top: 15px;
            left: 15px !important;
            z-index: 1001;
            transition: none;
        }

        .home-btn {
            background: #334155;
            color: #e2e8f0;
            border: 1px solid #475569;
            border-radius: 20px 0 0 20px;
            width: 70px;
            height: 36px;
            text-decoration: none;
            font-size: 12px;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            padding: 0;
            box-sizing: border-box;
        }

        .home-btn:hover {
            background: #4285F4;
            color: #fff;
        }

        .btn-toggle-sidebar {
            width: 70px;
            height: 36px;
            background: #1e293b;
            border: 1px solid #334155;
            border-left: none;
            border-radius: 0 20px 20px 0;
            color: #94a3b8;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            padding: 0;
            box-sizing: border-box;
        }

        .btn-toggle-sidebar:hover {
            color: white;
            background: #334155;
        }

        body.sidebar-collapsed aside {
            margin-left: -260px;
        }

        body.sidebar-collapsed .sidebar-controls {
            left: 0;
        }

        /* Main Content */
        main {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        header {
            height: 60px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            background: var(--bg-body);
        }

        .search-bar {
            background: var(--bg-input);
            border-radius: 6px;
            padding: 8px 15px;
            display: flex;
            align-items: center;
            width: 350px;
        }

        .search-bar input {
            background: transparent;
            border: none;
            color: white;
            margin-left: 10px;
            width: 100%;
            outline: none;
        }

        .actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            background: var(--bg-input);
            border: 1px solid var(--border);
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            transition: 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn:hover {
            background: #4b5563;
        }

        .btn.primary {
            background: var(--accent);
            color: #000;
            border: none;
            font-weight: bold;
        }

        .btn.danger {
            background: rgba(239, 68, 68, 0.2);
            color: var(--danger);
            border-color: var(--danger);
        }

        .btn.secondary {
            background: var(--bg-card);
            color: var(--text-muted);
        }

        /* Table */
        .table-container {
            flex: 1;
            overflow: auto;
            padding: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        th {
            text-align: left;
            padding: 12px;
            border-bottom: 2px solid var(--border);
            color: var(--text-muted);
            position: sticky;
            top: 0;
            background: var(--bg-body);
            z-index: 10;
        }

        td {
            padding: 10px 12px;
            border-bottom: 1px solid var(--border);
            vertical-align: middle;
        }

        tr:hover {
            background: rgba(255, 255, 255, 0.02);
        }

        .status-badge {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
        }

        .status-ok {
            background: rgba(16, 185, 129, 0.2);
            color: var(--accent);
        }

        .status-low {
            background: rgba(239, 68, 68, 0.2);
            color: var(--danger);
        }

        .status-high {
            background: rgba(59, 130, 246, 0.2);
            color: var(--blue);
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal {
            background: var(--bg-card);
            border-radius: 12px;
            width: 600px;
            max-width: 90vw;
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            max-height: 90vh;
        }

        .modal-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border);
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-body {
            padding: 20px;
            overflow-y: auto;
        }

        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .input {
            width: 100%;
            background: var(--bg-input);
            border: 1px solid var(--border);
            color: white;
            padding: 8px;
            border-radius: 6px;
            margin-top: 4px;
            box-sizing: border-box;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        /* Print Override */
        @media print {
            @page {
                size: landscape;
                margin: 0;
            }

            aside,
            header,
            .no-print,
            .btn,
            .modal-footer,
            .modal-header,
            .actions {
                display: none !important;
            }

            body,
            .modal {
                background: white;
                color: black;
                width: 100%;
                height: auto;
                overflow: visible;
                position: static;
                margin: 0;
                padding: 0;
            }

            .modal-overlay {
                position: static;
                background: white;
                display: block;
                padding: 0;
            }

            .modal {
                border: none;
                box-shadow: none;
                max-width: 100%;
                width: 100%;
            }

            th,
            td {
                border: 1px solid #000 !important;
                color: black !important;
                page-break-inside: avoid;
            }

            th {
                background: #eee !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            .status-badge {
                border: 1px solid #000;
                color: black !important;
                background: transparent !important;
                font-weight: bold;
            }

            /* Hide Main Content if Modal is Open */
            main {
                display: none !important;
            }

            /* Report Print Specifics */
            #report-print-area {
                display: block;
                width: 100% !important;
                margin: 0;
                padding: 0;
                overflow: visible !important;
                height: auto !important;
                zoom: 0.85;
                /* Slight zoom out to fit */
            }

            /* Force Table to Fit */
            table {
                width: 100% !important;
                font-size: 9px !important;
                /* Smaller font for print */
                table-layout: fixed;
                min-width: 0 !important;
            }

            th,
            td {
                word-wrap: break-word !important;
                white-space: normal !important;
                font-size: 9px !important;
            }
        }
    </style>
</head>

<body>
    <div id="app" style="width:100%; display:flex;">

        <!-- SIDEBAR -->
        <aside>
            <div class="brand">
            </div>


            <!-- Sync Status Indicator -->
            <div class="nav-item" :style="{color: isSyncing ? 'var(--warning)' : 'var(--text-muted)'}">
                <i class="fa-solid" :class="isSyncing ? 'fa-spinner fa-spin' : 'fa-cloud-arrow-up'"></i>
                {{ isSyncing ? 'ÎèôÍ∏∞Ìôî Ï§ë... (Sincronizando...)' : 'ÎåÄÍ∏∞ (Listo)' }}
            </div>

            <div
                style="font-size:12px; font-weight:bold; margin-top:20px; margin-bottom:10px; color:#666; display:flex; justify-content:space-between;">
                PROJECTS (ÌîÑÎ°úÏ†ùÌä∏)
                <i class="fa-solid fa-plus" style="cursor:pointer; color:var(--accent);" @click="createProject"></i>
            </div>

            <div class="project-list">
                <div class="project-item" v-for="p in projects" :key="p.id"
                    :class="{active: currentProject && currentProject.id === p.id}" @click="selectProject(p)">
                    <span>{{ p.name }}</span>
                    <i class="fa-solid fa-trash" style="font-size:10px; color:#666;" @click.stop="deleteProject(p)"></i>
                </div>
            </div>

            <div style="margin-top:auto; font-size:11px; text-align:center; color:#444;">
                &copy; Antigravity Systems
            </div>
        </aside>

        <div class="sidebar-controls">
            <a class="home-btn" href="index.html">üè† Home</a>
            <button id="btn-toggle-sidebar" class="btn-toggle-sidebar" @click="toggleSidebar">‚óÄ</button>
        </div>



        <!-- MAIN -->
        <main>
            <header>
                <div class="search-bar">
                    <i class="fa-solid fa-search" style="color:#666;"></i>
                    <input v-model="searchQuery" placeholder="Í≤ÄÏÉâ (Search / Buscar)...">
                </div>

                <div class="app-title"
                    style="font-size: 20px; font-weight: bold; color: var(--accent); margin-left: 20px;">
                    <i class="fa-solid fa-gears"></i> Facility Spare
                </div>

                <div class="actions">
                    <button class="btn" @click="toggleLowStock">
                        <i class="fa-solid fa-filter" :style="{color: filterLowStock ? 'var(--danger)' : 'white'}"></i>
                        {{ filterLowStock ? 'Î∂ÄÏ°± Ïû¨Í≥† (Stock Bajo)' : 'Ï†ÑÏ≤¥ Î∂ÄÌíà (Todo)' }}
                    </button>
                    <!-- Col Option -->
                    <div style="position:relative;">
                        <button class="btn" @click="showColMenu = !showColMenu">
                            <i class="fa-solid fa-columns"></i> Ïª¨Îüº (Cols)
                        </button>
                        <div v-if="showColMenu"
                            style="position:absolute; top:100%; right:0; background:var(--bg-card); border:1px solid var(--border); padding:10px; border-radius:6px; z-index:100; width:150px; box-shadow:0 4px 6px rgba(0,0,0,0.3);">
                            <div v-for="c in columns" :key="c.key" style="margin-bottom:5px;">
                                <label style="display:flex; align-items:center; cursor:pointer;">
                                    <input type="checkbox" v-model="c.visible" style="margin-right:8px;"> {{ c.label }}
                                </label>
                            </div>
                        </div>
                    </div>

                    <div style="width:1px; height:20px; background:var(--border); margin:0 5px;"></div>
                    <button class="btn" @click="syncFromCloud" title="Download Projects"><i
                            class="fa-solid fa-cloud-arrow-down"></i> Î∂àÎü¨Ïò§Í∏∞ (Cargar)</button>
                    <button class="btn" @click="syncToCloud" title="Upload Current Project"><i
                            class="fa-solid fa-cloud-arrow-up"></i> Ï†ÄÏû• (Guardar)</button>
                    <div style="width:1px; height:20px; background:var(--border); margin:0 5px;"></div>
                    <button class="btn btn-secondary" @click="downloadJsonBackup"><i class="fa-solid fa-download"></i>
                        Î∞±ÏóÖ (Respaldo)</button>
                    <div style="position:relative;">
                        <button class="btn btn-secondary" onclick="document.getElementById('restoreFile').click()"><i
                                class="fa-solid fa-upload"></i> Î≥µÏõê (Restaurar)</button>
                        <input type="file" id="restoreFile" hidden @change="uploadJsonRestore" accept=".json">
                    </div>
                    <button class="btn btn-danger" @click="clearAllData"><i class="fa-solid fa-trash-can"></i>
                        Ï¥àÍ∏∞Ìôî (Reiniciar)</button>
                    <button class="btn btn-primary" style="background:#8b5cf6;" @click="openAddModal">
                        <i class="fa-solid fa-plus"></i> Î∂ÄÌíà Ï∂îÍ∞Ä (Agregar Refacci√≥n)
                    </button>
                    <button class="btn btn-primary" @click="openReport"><i class="fa-solid fa-chart-simple"></i>
                        Î¶¨Ìè¨Ìä∏ (Reporte)</button>
                </div>
            </header>


            <div class="table-container" id="print-area">
                <table v-if="currentProject">
                    <thead>
                        <tr>
                            <th v-for="c in visibleColumns" :key="c.key"
                                :style="{width: c.width + 'px', cursor: c.sortable ? 'pointer' : 'default'}"
                                @click="c.sortable ? sortTable(c.key) : null"
                                :class="c.key === 'action' ? 'no-print' : ''">
                                {{ c.label }}
                                <i v-if="sortKey === c.key" class="fa-solid"
                                    :class="sortOrder === 1 ? 'fa-sort-up' : 'fa-sort-down'"></i>
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="p in filteredParts" :key="p.id">
                            <td v-for="c in visibleColumns" :key="c.key" :class="c.key === 'action' ? 'no-print' : ''"
                                :style="{textAlign: c.key==='price'?'right' : (['op','stock','status','action','img'].includes(c.key)?'center':'left')}">

                                <template v-if="c.key === 'img'">
                                    <div v-if="p.img"
                                        :style="`width:32px; height:32px; background-image:url(${p.img}); background-size:cover; border-radius:4px; margin:0 auto; border:1px solid #555; cursor:pointer`"
                                        @click="setModalImage(p.img)"></div>
                                    <span v-else>-</span>
                                </template>

                                <template v-else-if="c.key === 'moldCode'">
                                    <span style="font-weight:bold; color:var(--accent);">{{ p.moldCode }}</span>
                                </template>

                                <template v-else-if="c.key === 'spareCode'">
                                    <span style="font-family:monospace;">{{ p.spareCode }}</span>
                                </template>

                                <template v-else-if="c.key === 'loc'">
                                    <span style="color:var(--blue); font-family:monospace;">{{ p.loc }}</span>
                                </template>

                                <template v-else-if="c.key === 'stock'">
                                    <span style="font-weight:bold; font-size:14px; color:var(--accent);">{{ p.stock
                                        }}</span>
                                </template>

                                <template v-else-if="c.key === 'status'">
                                    <span v-if="p.stock <= p.min" class="status-badge status-low"><i
                                            class="fa-solid fa-bell"></i> LOW</span>
                                    <span v-else-if="p.stock >= p.max" class="status-badge status-high">OVER</span>
                                    <span v-else class="status-badge status-ok">OK</span>
                                </template>

                                <template v-else-if="c.key === 'price'">
                                    <span style="font-size:12px; color:var(--text-muted);">${{
                                        (p.price||0).toLocaleString() }}</span>
                                </template>

                                <template v-else-if="c.key === 'action'">
                                    <button type="button"
                                        style="background:none; border:none; padding:0; cursor:pointer; color:var(--text-muted);"
                                        @click.stop="editPart(p)">
                                        <i class="fa-solid fa-pen"></i>
                                    </button>
                                    <button type="button"
                                        style="background:none; border:none; padding:0; cursor:pointer; color:var(--text-muted); margin-left:5px;"
                                        @click.stop="showQR(p)">
                                        <i class="fa-solid fa-qrcode"></i>
                                    </button>
                                </template>

                                <template v-else>
                                    {{ p[c.key] }}
                                </template>
                            </td>
                        </tr>
                    </tbody>
                </table>
                <div v-else style="padding:50px; text-align:center; color:var(--text-muted);">
                    <i class="fa-solid fa-gears" style="font-size:48px; margin-bottom:20px;"></i>
                    <p>Select or Create a Project to begin.</p>
                </div>
            </div>
        </main>

        <!-- ADD/EDIT MODAL -->
        <div v-if="showPartModal" class="modal-overlay" @click.self="showPartModal=false">
            <div class="modal" style="width:700px;">
                <div class="modal-header"><span>{{ editingPart.id ? 'ÏàòÏ†ï (Editar)' : 'Ï∂îÍ∞Ä (Agregar)' }} Spare
                        Part</span><i class="fa-solid fa-times" style="cursor:pointer;"
                        @click="showPartModal=false"></i></div>
                <div class="modal-body">
                    <div style="display:flex; flex-wrap:wrap; gap:20px;">
                        <!-- Image Upload -->
                        <div style="flex:0 0 150px; display:flex; flex-direction:column; align-items:center;">
                            <div
                                style="width:150px; height:150px; border:2px dashed var(--border); border-radius:8px; display:flex; align-items:center; justify-content:center; overflow:hidden; position:relative; background:#111;">
                                <img v-if="editingPart.img" :src="editingPart.img"
                                    style="width:100%; height:100%; object-fit:cover;">
                                <div v-if="isImageProcessing"
                                    style="position:absolute; inset:0; background:rgba(0,0,0,0.5); display:flex; align-items:center; justify-content:center; color:white;">
                                    <i class="fa-solid fa-spinner fa-spin fa-2x"></i>
                                </div>
                                <input type="file" @change="handleImageUpload" accept="image/*"
                                    style="position:absolute; inset:0; opacity:0; cursor:pointer;"
                                    :disabled="isImageProcessing">
                                <div v-if="!editingPart.img && !isImageProcessing"
                                    style="color:#666; text-align:center;">
                                    <i class="fa-solid fa-image fa-2x" style="margin-bottom:10px;"></i><br>
                                    Click / Paste (ÌÅ¥Î¶≠/Î∂ôÏó¨ÎÑ£Í∏∞)
                                </div>
                            </div>
                        </div>

                        <!-- Form Fields -->
                        <div style="flex:1; display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                            <!-- Mapped Fields: Internal names -> New Labels -->
                            <div style="grid-column: span 2;"><small>Î∂ÄÌíàÎ™Ö (Nombre / Part Name)</small><input
                                    v-model="editingPart.moldCode" class="input" placeholder="Part Name"></div>

                            <div><small>Í∑úÍ≤© (Spec / Modelo)</small><input v-model="editingPart.model" class="input"
                                    placeholder="Spec"></div>

                            <div>
                                <small>Íµ¨Î∂Ñ (Categor√≠a)</small>
                                <select v-model="editingPart.moldType" class="input">
                                    <option value="Electric">Electric (Ï†ÑÍ∏∞)</option>
                                    <option value="Pneumatic">Pneumatic (Í≥µÏïï)</option>
                                    <option value="Mechanical">Mechanical (Í∏∞Íµ¨)</option>
                                    <option value="Sensor">Sensor (ÏÑºÏÑú)</option>
                                    <option value="Consumable">Consumable (ÏÜåÎ™®Ìíà)</option>
                                    <option value="Other">Other (Í∏∞ÌÉÄ)</option>
                                </select>
                            </div>

                            <div><small>Ï†úÏ°∞ÏÇ¨ (Maker / Marca)</small><input v-model="editingPart.mat" class="input">
                            </div>



                            <!-- Stock Control Block -->
                            <div
                                style="grid-column:span 2; background:var(--bg-input); padding:10px; border-radius:8px; display:grid; grid-template-columns: 1fr 1fr 1fr; gap:10px; border:1px solid var(--accent); margin-top:10px;">
                                <div class="text-center"
                                    style="grid-column: span 3; display:flex; align-items:center; justify-content:center; gap:10px;">
                                    <div style="text-align:center;">
                                        <small style="color:var(--accent)">ÌòÑÏû¨ Ïû¨Í≥† (Stock Actual)</small>
                                        <div style="display:flex; align-items:center;">
                                            <input v-model.number="editingPart.stock" type="number" class="input"
                                                style="width:80px; text-align:center; font-weight:bold; font-size:16px;">
                                            <button class="btn btn-warning"
                                                style="margin-left:5px; padding:2px 8px; font-size:10px;"
                                                @click="applySnapshotFromModal" title="Set as Last Record (Snapshot)">
                                                <i class="fa-solid fa-camera"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div v-if="editingPart.lastRecord"
                                        style="font-size:11px; color:#aaa; text-align:left; border-left:1px solid #555; padding-left:10px;">
                                        <div>Last: <strong>{{ editingPart.lastRecord.qty }}</strong></div>
                                        <div>{{ editingPart.lastRecord.date }}</div>
                                    </div>
                                </div>
                                <div class="text-center" style="grid-column: span 1;"><small
                                        style="color:var(--danger)">Min</small><input v-model.number="editingPart.min"
                                        type="number" class="input"
                                        style="text-align:center; border-color:var(--danger);"></div>
                                <div class="text-center" style="grid-column: span 1;"><small>Max</small><input
                                        v-model.number="editingPart.max" type="number" class="input"
                                        style="text-align:center;"></div>
                                <div class="text-center" style="grid-column: span 1;"><small>ÏúÑÏπò (Loc)</small><input
                                        v-model="editingPart.loc" class="input" style="text-align:center;"></div>
                            </div>

                            <!-- Transaction Block -->
                            <div
                                style="grid-column:span 2; background:#222; padding:10px; border-radius:8px; border:1px dashed #555; margin-top:10px;">
                                <small style="display:block; margin-bottom:5px; color:#aaa;">ÏûÖÏ∂úÍ≥† Í∏∞Î°ù (Registro de
                                    E/S)</small>
                                <div style="display:flex; gap:10px; align-items:flex-end;">
                                    <div style="flex:1;">
                                        <small>ÎÇ†Ïßú (Fecha)</small>
                                        <input type="date" v-model="transDate" class="input" style="text-align:center;">
                                    </div>
                                    <div style="width:80px;">
                                        <small>Íµ¨Î∂Ñ (Tipo)</small>
                                        <select v-model="transType" class="input"
                                            :style="{color: transType==='IN'?'#4caf50':'#f44336', fontWeight:'bold'}">
                                            <option value="IN">IN (ÏûÖÍ≥†)</option>
                                            <option value="OUT">OUT (Ï∂úÍ≥†)</option>
                                        </select>
                                    </div>
                                    <div style="width:80px;">
                                        <small>ÏàòÎüâ (Cant.)</small>
                                        <input type="number" v-model="transQty" class="input"
                                            style="text-align:center;">
                                    </div>
                                    <button class="btn" style="height:36px; margin-top:auto;" @click="addTransaction">Îì±Î°ù
                                        (Grabar)</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Modal Footer -->
                <div class="modal-footer">
                    <button v-if="editingPart.id" class="btn danger" style="margin-right:auto;" @click="deletePart">ÏÇ≠Ï†ú
                        (Eliminar)</button>
                    <button class="btn" @click="showPartModal=false">Ï∑®ÏÜå (Cancelar)</button>
                    <button class="btn primary" @click="savePart">Ï†ÄÏû• (Guardar)</button>
                </div>
            </div>
        </div>




        <!-- REPORT MODAL -->
        <transition name="fade">
            <div v-if="showReportModal" class="modal-overlay" @click.self="showReportModal = false">
                <div class="modal"
                    style="width:95%; max-width:1400px; height:90vh; display:flex; flex-direction:column;">
                    <div class="modal-header">
                        <div style="display:flex; align-items:center; gap:10px;">
                            <h3>üìä ÏÑ§ÎπÑ ÏòàÎπÑÎ∂ÄÌíà Î¶¨Ìè¨Ìä∏ (Reporte de Repuestos)</h3>
                            <select v-model="reportYear" class="input" style="width:80px; font-weight:bold;">
                                <option v-for="y in [2023, 2024, 2025, 2026]" :value="y">{{ y }}</option>
                            </select>
                            <select v-model="reportType" class="input"
                                style="width:120px; font-weight:bold; margin-left:10px;">
                                <option value="Quarterly">Î∂ÑÍ∏∞Î≥Ñ (Trimestral)</option>
                                <option value="Monthly">ÏõîÎ≥Ñ (Mensual)</option>
                            </select>
                            <label style="margin-left:15px; display:flex; align-items:center; gap:5px; cursor:pointer;"
                                class="no-print">
                                <input type="checkbox" v-model="showSelectedOnly"> ÏÑ†ÌÉù Ìï≠Î™©Îßå Î≥¥Í∏∞ (Solo Selec.)
                            </label>

                            <select v-model="reportStockFilter" class="input no-print"
                                style="width:100px; font-weight:bold; margin-left:15px;">
                                <option value="All">Ï†ÑÏ≤¥ Ïû¨Í≥† (Todo)</option>
                                <option value="Low">Î∂ÄÏ°± (Bajo <= Min)</option>
                                <option value="Over">Ï¥àÍ≥º (Exceso >= Max)</option>
                            </select>

                        </div>
                        <div class="actions">
                            <button class="btn btn-secondary" @click="captureReportModal">üì∑ Ï∫°Ï≤ò (Captura)</button>
                            <button class="btn primary" @click="printReportModal">üñ® Ïù∏ÏáÑ (Imprimir)</button>
                            <i class="fa-solid fa-times" style="cursor:pointer; margin-left:10px;"
                                @click="showReportModal=false"></i>
                        </div>
                    </div>

                    <div id="report-print-area" class="modal-body"
                        style="flex:1; overflow:auto; padding:20px; background:white; color:black;">
                        <h2 style="text-align:center; margin-bottom:20px; color:black;">Facility Spare Parts Report - {{
                            reportYear }} ({{ reportType }})</h2>

                        <!-- QUARTERLY TABLE -->
                        <table v-if="reportType === 'Quarterly'"
                            style="width:100%; border-collapse:collapse; font-size:11px; text-align:center; border:1px solid #000;">
                            <thead style="position:sticky; top:0; z-index:10; display:table-header-group;">
                                <tr style="background:#eee; border-bottom:1px solid #000; color:black;">
                                    <th rowspan="2" style="border:1px solid #000; padding:5px; width:30px;"
                                        class="no-print">
                                        <input type="checkbox" @click="toggleSelectAllReport"
                                            :checked="reportSelectedParts.size > 0 && reportSelectedParts.size === reportFilteredData.length">
                                    </th>
                                    <th rowspan="2" style="border:1px solid #000; padding:5px; cursor:pointer;"
                                        @click="sortReport('moldCode')">
                                        Part Name <i v-if="reportSortKey==='moldCode'" class="fa-solid"
                                            :class="reportSortOrder===1?'fa-caret-up':'fa-caret-down'"></i>
                                    </th>
                                    <th rowspan="2" style="border:1px solid #000; padding:5px; cursor:pointer;"
                                        @click="sortReport('model')">
                                        Spec <i v-if="reportSortKey==='model'" class="fa-solid"
                                            :class="reportSortOrder===1?'fa-caret-up':'fa-caret-down'"></i>
                                    </th>


                                    <th colspan="2" style="border:1px solid #000; background:#e0f7fa;">Q1</th>
                                    <th colspan="2" style="border:1px solid #000; background:#f3e5f5;">Q2</th>
                                    <th colspan="2" style="border:1px solid #000; background:#fff3e0;">Q3</th>
                                    <th colspan="2" style="border:1px solid #000; background:#f1f8e9;">Q4</th>

                                    <th colspan="2" style="border:1px solid #000; background:#ffcdd2; cursor:pointer;"
                                        @click="sortReport('totalIn')">Total</th>
                                    <th rowspan="2"
                                        style="border:1px solid #000; padding:5px; background:#ef9a9a; cursor:pointer;"
                                        @click="sortReport('currentStock')">
                                        Stock <i v-if="reportSortKey==='currentStock'" class="fa-solid"
                                            :class="reportSortOrder===1?'fa-caret-up':'fa-caret-down'"></i>
                                    </th>
                                </tr>
                                <tr style="border-bottom:1px solid #000; font-size:10px;">
                                    <th style="border:1px solid #000; background:#b2ebf2;">In</th>
                                    <th style="border:1px solid #000; background:#b2ebf2;">Out</th>
                                    <th style="border:1px solid #000; background:#e1bee7;">In</th>
                                    <th style="border:1px solid #000; background:#e1bee7;">Out</th>
                                    <th style="border:1px solid #000; background:#ffe0b2;">In</th>
                                    <th style="border:1px solid #000; background:#ffe0b2;">Out</th>
                                    <th style="border:1px solid #000; background:#dcedc8;">In</th>
                                    <th style="border:1px solid #000; background:#dcedc8;">Out</th>
                                    <th style="border:1px solid #000; background:#ffcdd2;">In</th>
                                    <th style="border:1px solid #000; background:#ffcdd2;">Out</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="row in reportFilteredData" :key="row.id"
                                    style="border-bottom:1px solid #ccc; page-break-inside:avoid;">
                                    <td style="border:1px solid #ccc; padding:2px;" class="no-print">
                                        <input type="checkbox" :checked="reportSelectedParts.has(row.id)"
                                            @click="toggleReportSelection(row.id)">
                                    </td>
                                    <td style="border:1px solid #ccc; padding:2px;">{{ row.moldCode }}</td>
                                    <td style="border:1px solid #ccc; padding:2px;">{{ row.model }}</td>


                                    <td style="border:1px solid #ccc;">{{ row.q[1].in }}</td>
                                    <td style="border:1px solid #ccc;">{{ row.q[1].out }}</td>
                                    <td style="border:1px solid #ccc;">{{ row.q[2].in }}</td>
                                    <td style="border:1px solid #ccc;">{{ row.q[2].out }}</td>
                                    <td style="border:1px solid #ccc;">{{ row.q[3].in }}</td>
                                    <td style="border:1px solid #ccc;">{{ row.q[3].out }}</td>
                                    <td style="border:1px solid #ccc;">{{ row.q[4].in }}</td>
                                    <td style="border:1px solid #ccc;">{{ row.q[4].out }}</td>

                                    <td style="border:1px solid #ccc; font-weight:bold;">{{ row.total.in }}</td>
                                    <td style="border:1px solid #ccc; font-weight:bold;">{{ row.total.out }}</td>
                                    <td style="border:1px solid #000; font-weight:bold; background:#ef9a9a; cursor:pointer; text-decoration:underline;"
                                        @click="editPartFromReport(row.id)" title="Click to Edit Stock">
                                        {{ row.currentStock }}
                                    </td>
                                </tr>
                            </tbody>
                        </table>

                        <!-- MONTHLY TABLE -->
                        <table v-else
                            style="width:100%; min-width:1500px; border-collapse:collapse; font-size:10px; text-align:center; border:1px solid #000;">
                            <thead style="position:sticky; top:0; z-index:10; display:table-header-group;">
                                <tr style="background:#eee; border-bottom:1px solid #000; color:black;">
                                    <th rowspan="2"
                                        style="border:1px solid #000; padding:5px; width:30px; position:sticky; left:0; background:#eee; z-index:12;"
                                        class="no-print">
                                        <input type="checkbox" @click="toggleSelectAllReport"
                                            :checked="reportSelectedParts.size > 0 && reportSelectedParts.size === reportFilteredData.length">
                                    </th>
                                    <th rowspan="2"
                                        style="border:1px solid #000; padding:5px; cursor:pointer; min-width:100px; position:sticky; left:30px; background:#eee; z-index:11;"
                                        @click="sortReport('moldCode')">
                                        Part Name
                                    </th>
                                    <th rowspan="2" style="border:1px solid #000; padding:5px; cursor:pointer;"
                                        @click="sortReport('model')">Spec</th>


                                    <th colspan="2" v-for="m in 12" :key="'h'+m" style="border:1px solid #000;"
                                        :style="{background: (m%2===0 ? '#f5f5f5' : '#e0e0e0')}">{{ m }}Ïõî</th>

                                    <th colspan="2" style="border:1px solid #000; background:#ffcdd2;">Total</th>
                                    <th rowspan="2" style="border:1px solid #000; padding:5px; background:#ef9a9a;">
                                        Stock</th>
                                </tr>
                                <tr style="border-bottom:1px solid #000;">
                                    <template v-for="m in 12" :key="'Sub'+m">
                                        <th style="border:1px solid #000; border-left:2px solid #aaa;">In</th>
                                        <th style="border:1px solid #000;">Out</th>
                                    </template>
                                    <th style="border:1px solid #000; background:#ffcdd2;">In</th>
                                    <th style="border:1px solid #000; background:#ffcdd2;">Out</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="row in reportFilteredData" :key="row.id"
                                    style="border-bottom:1px solid #ccc;">
                                    <td style="border:1px solid #ccc; padding:2px; position:sticky; left:0; background:white; z-index:1;"
                                        class="no-print">
                                        <input type="checkbox" :checked="reportSelectedParts.has(row.id)"
                                            @click="toggleReportSelection(row.id)">
                                    </td>
                                    <td
                                        style="border:1px solid #ccc; padding:2px; position:sticky; left:30px; background:white; z-index:1;">
                                        {{ row.moldCode }}</td>
                                    <td style="border:1px solid #ccc; padding:2px;">{{ row.model }}</td>


                                    <template v-for="m in 12" :key="'d'+m">
                                        <td style="border:1px solid #ccc; border-left:2px solid #eee;">{{ row.m[m].in ||
                                            '' }}</td>
                                        <td style="border:1px solid #ccc;">{{ row.m[m].out || '' }}</td>
                                    </template>

                                    <td style="border:1px solid #ccc; font-weight:bold;">{{ row.total.in }}</td>
                                    <td style="border:1px solid #ccc; font-weight:bold;">{{ row.total.out }}</td>
                                    <td style="border:1px solid #000; font-weight:bold; background:#ef9a9a; cursor:pointer; text-decoration:underline;"
                                        @click="editPartFromReport(row.id)" title="Click to Edit Stock">
                                        {{ row.currentStock }}
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </transition>

        <!-- DASHBOARD & CLOUD MODALS (Reused) -->


        <div v-if="showCloudModal" class="modal-overlay" @click.self="showCloudModal=false">
            <div class="modal" style="width:400px;">
                <div class="modal-header">Select Cloud Project <i class="fa-solid fa-times" style="cursor:pointer;"
                        @click="showCloudModal=false"></i></div>
                <div class="modal-body">
                    <p style="color:var(--text-muted); font-size:12px; margin-bottom:15px;">Select a project to
                        restore.<br>Current data will be overwritten.</p>
                    <div v-for="p in cloudProjectsList" :key="p.name"
                        style="display:flex; align-items:center; gap:5px; margin-bottom:5px;">
                        <button class="btn" style="text-align:left; justify-content:flex-start; flex:1;"
                            @click="loadSelectedCloudProject(p.name)">
                            <i class="fa-solid fa-folder" style="color:var(--blue); margin-right:10px;"></i>
                            {{ p.name }} <span style="margin-left:auto; font-size:11px; color:#888;">({{ p.count
                                }})</span>
                        </button>
                        <button class="btn danger" style="padding:0 10px;" @click.stop="deleteCloudProject(p.name)">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>




        <!-- QR MODAL -->
        <div v-if="showQRModal" class="modal-overlay" @click.self="showQRModal=false">
            <div class="modal" style="width:350px; text-align:center;">
                <div class="modal-header">QR Code <i class="fa-solid fa-times" style="cursor:pointer;"
                        @click="showQRModal=false"></i></div>
                <div class="modal-body">
                    <div id="qrcode" style="margin:20px auto; display:inline-block;"></div>
                    <p style="font-weight:bold; margin-top:10px;">{{ qrPartName }}</p>
                    <p style="font-size:12px; color:gray;">{{ qrProjectName }}</p>
                    <p style="font-size:10px; color:#555;">UUID: {{ qrPartId }}</p>
                    <button class="btn primary" style="width:100%; margin-top:15px;" @click="printQR">Print</button>
                </div>
            </div>
        </div>

        <!-- ImageViewer Overlay -->
        <div v-if="zoomedImage" class="modal-overlay" @click="zoomedImage=null">
            <img :src="zoomedImage" style="max-width:90%; max-height:90vh; border-radius:8px; border:2px solid white;">
        </div>

    </div>

    <script>
        const CLOUD_URL = "https://script.google.com/macros/s/AKfycbxO-lKvZtUWOx0CkUcUkdcamma5rc5UIeGp8Fs0px344buiG_Zb6AtgOwpuAnmPNGkhyw/exec";
        const { createApp, ref, computed, reactive, onMounted, onUnmounted, watch, nextTick, toRaw } = Vue;
        const db = new Dexie('FacilityManagerDB');
        db.version(1).stores({ projects: '++id, name, updated', parts: '++id, projectId, moldCode, spareCode, model' });

        createApp({
            setup() {
                const projects = ref([]);
                const currentProject = ref(null);
                const projectParts = ref([]);
                const searchQuery = ref("");
                const filterLowStock = ref(false);
                const showPartModal = ref(false);
                // Dashboard removed (Cleaned up)
                console.log("VERSION: 2026-02-13 20:35 - QR ENABLED");
                console.log("Setup starting...");
                const showCloudModal = ref(false);
                const isSyncing = ref(false);
                const isImageProcessing = ref(false);
                const zoomedImage = ref(null);
                const showColMenu = ref(false);
                const sortKey = ref('moldCode');
                const sortOrder = ref(1);
                const cloudProjectsList = ref([]);
                const rawCloudData = ref([]);

                // --- REPORT STATE ---
                const showReportModal = ref(false);
                const reportYear = ref(new Date().getFullYear());
                const reportData = ref([]);
                const reportSortKey = ref('moldCode');
                const reportSortOrder = ref(1);
                const reportType = ref('Quarterly');

                // Report Selection Logic
                const reportSelectedParts = ref(new Set());
                const showSelectedOnly = ref(false);
                const reportStockFilter = ref('All'); // 'All', 'Low', 'Over'

                const toggleReportSelection = (id) => {
                    if (reportSelectedParts.value.has(id)) reportSelectedParts.value.delete(id);
                    else reportSelectedParts.value.add(id);
                };

                const toggleSelectAllReport = () => {
                    if (reportSelectedParts.value.size === reportFilteredData.value.length) {
                        reportSelectedParts.value.clear();
                    } else {
                        reportFilteredData.value.forEach(r => reportSelectedParts.value.add(r.id));
                    }
                }; // 'Quarterly' or 'Monthly'

                // Column Definitions - Mapped for Facility Spare Context
                const columns = ref([
                    { key: 'img', label: 'Img', width: 50, visible: true, sortable: false },
                    { key: 'moldCode', label: 'Î∂ÄÌíàÎ™Ö (Nombre)', width: 150, visible: true, sortable: true }, // Renamed to Part Name
                    // spareCode (Part No) & op (Vendor) removed as per request
                    { key: 'model', label: 'Í∑úÍ≤© (Spec)', width: 120, visible: true, sortable: true }, // Mapped
                    { key: 'moldType', label: 'Íµ¨Î∂Ñ (CTGR)', width: 80, visible: true, sortable: true }, // Mapped
                    { key: 'mat', label: 'Ï†úÏ°∞ÏÇ¨ (Maker)', width: 80, visible: true, sortable: true }, // Mapped
                    { key: 'loc', label: 'ÏúÑÏπò (Loc)', width: 80, visible: true, sortable: true },
                    { key: 'stock', label: 'Ïû¨Í≥† (Stock)', width: 80, visible: true, sortable: true },
                    { key: 'status', label: 'ÏÉÅÌÉú (Estado)', width: 60, visible: true, sortable: false },
                    { key: 'action', label: 'Ìé∏Ïßë', width: 50, visible: true, sortable: false },
                ]);

                const visibleColumns = computed(() => columns.value.filter(c => c.visible));

                const defaultPart = {
                    projectId: null, moldCode: '', spareCode: '', op: '', model: '',
                    moldType: 'Electric', mat: '', // Default Category
                    loc: '', stock: 0, min: 2, max: 10, img: '',
                    carryover: 0,
                    transactions: [],
                    lastRecord: null // { qty: 0, date: 'YYYY-MM-DD' }
                };
                const editingPart = reactive({ ...defaultPart });

                // Paste
                const handlePaste = (e) => {
                    if (!showPartModal.value) return;
                    const items = (e.clipboardData || e.originalEvent.clipboardData).items;
                    for (let item of items) {
                        if (item.kind === 'file' && item.type.includes('image/')) {
                            e.preventDefault();
                            processImageFile(item.getAsFile());
                            return;
                        }
                    }
                };

                const handleImageUpload = (e) => {
                    const f = e.target.files[0]; if (f) processImageFile(f);
                };

                const setModalImage = (img) => {
                    zoomedImage.value = img;
                };

                const processImageFile = (file) => {
                    isImageProcessing.value = true;
                    const r = new FileReader();
                    r.onload = (ev) => {
                        const img = new Image();
                        img.onload = () => {
                            const c = document.createElement('canvas');
                            const MAX_SIZE = 800;
                            let width = img.width; let height = img.height;
                            if (width > height) { if (width > MAX_SIZE) { height *= MAX_SIZE / width; width = MAX_SIZE; } }
                            else { if (height > MAX_SIZE) { width *= MAX_SIZE / height; height = MAX_SIZE; } }
                            c.width = width; c.height = height;
                            c.getContext('2d').drawImage(img, 0, 0, width, height);
                            editingPart.img = c.toDataURL('image/jpeg', 0.7);
                            isImageProcessing.value = false;
                        };
                        img.src = ev.target.result;
                    };
                    r.readAsDataURL(file);
                };

                onMounted(async () => {
                    console.log("App Mounted");
                    await loadProjects();

                    // --- MIGRATION: Ensure all parts have partId ---
                    const allP = await db.parts.toArray();
                    let updatedCount = 0;
                    for (const p of allP) {
                        if (!p.partId) {
                            p.partId = 'P-' + Date.now() + '-' + Math.floor(Math.random() * 10000);
                            await db.parts.put(p);
                            updatedCount++;
                        }
                    }
                    if (updatedCount > 0) {
                        console.log(`Migrated ${updatedCount} parts with partId`);
                        alert("ÏãúÏä§ÌÖú ÏóÖÎç∞Ïù¥Ìä∏: Îç∞Ïù¥ÌÑ∞ Íµ¨Ï°∞Í∞Ä Í∞úÏÑ†ÎêòÏóàÏäµÎãàÎã§. \n(System Updated: Data Migration Complete)");
                        // Reload parts if current project selected
                        if (currentProject.value) {
                            projectParts.value = await db.parts.where('projectId').equals(currentProject.value.id).toArray();
                        }
                    }

                    window.addEventListener('paste', handlePaste);
                    const lastId = localStorage.getItem('lastFacilityProjectId');
                    if (lastId) {
                        const p = await db.projects.get(parseInt(lastId));
                        if (p) selectProject(p);
                    }
                });
                onUnmounted(() => window.removeEventListener('paste', handlePaste));

                const loadProjects = async () => { projects.value = await db.projects.toArray(); };
                const createProject = async () => {
                    const n = prompt("ÌîÑÎ°úÏ†ùÌä∏ Ïù¥Î¶Ñ (Nombre del Proyecto):"); if (!n) return;
                    await db.projects.add({ name: n, updated: new Date() });
                    loadProjects();
                };
                const selectProject = async (p) => {
                    currentProject.value = p;
                    projectParts.value = await db.parts.where('projectId').equals(p.id).toArray();
                    localStorage.setItem('lastFacilityProjectId', p.id);
                };
                const deleteProject = async (p) => {
                    if (!confirm(`Delete '${p.name}'?`)) return;
                    await db.projects.delete(p.id);
                    await db.parts.where('projectId').equals(p.id).delete();
                    if (currentProject.value?.id === p.id) { currentProject.value = null; projectParts.value = []; }
                    loadProjects();
                };

                const openAddModal = () => {
                    if (!currentProject.value) return alert("ÌîÑÎ°úÏ†ùÌä∏Î•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî. (Seleccione un proyecto primero.)");
                    Object.assign(editingPart, { ...defaultPart, projectId: currentProject.value.id });
                    showPartModal.value = true;
                };

                const editPart = (p) => {
                    Object.assign(editingPart, JSON.parse(JSON.stringify(p)));
                    showPartModal.value = true;
                };

                const savePart = async () => {
                    if (isImageProcessing.value) return alert("Ïù¥ÎØ∏ÏßÄ Ï≤òÎ¶¨ Ï§ë... (Procesando imagen...)");
                    if (!editingPart.moldCode) return alert("Î∂ÄÌíàÎ™ÖÏùÄ ÌïÑÏàòÏûÖÎãàÎã§. (Nombre requerido.)");

                    const copy = JSON.parse(JSON.stringify(toRaw(editingPart)));

                    // Ensure partId (UUID)
                    if (!copy.partId) {
                        copy.partId = 'P-' + Date.now() + '-' + Math.floor(Math.random() * 10000);
                    }

                    if (copy.id) {
                        // Optimistic Update
                        const idx = projectParts.value.findIndex(p => p.id === copy.id);
                        if (idx >= 0) projectParts.value[idx] = copy;

                        await db.parts.put(copy);
                    } else {
                        const id = await db.parts.add(copy);
                        copy.id = id;
                        projectParts.value.push(copy);
                    }
                    showPartModal.value = false;
                };

                const deletePart = async () => {
                    if (!confirm("ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå? (¬øEliminar?)")) return;
                    projectParts.value = projectParts.value.filter(p => p.id !== editingPart.id);
                    showPartModal.value = false;
                };

                // --- TRANSATION LOGIC (Variables + Functions) ---
                const transDate = ref(new Date().toISOString().slice(0, 10));
                const transType = ref('OUT');
                const transQty = ref(1);

                const addTransaction = () => {
                    if (!transQty.value || transQty.value <= 0) return alert("Qty must be > 0");
                    const qty = Number(transQty.value);

                    if (transType.value === 'OUT') {
                        editingPart.stock = (editingPart.stock || 0) - qty;
                    } else {
                        editingPart.stock = (editingPart.stock || 0) + qty;
                    }

                    if (!editingPart.transactions) editingPart.transactions = [];
                    editingPart.transactions.push({
                        date: transDate.value,
                        type: transType.value,
                        qty: qty,
                        timestamp: Date.now()
                    });

                    // Auto-save logic if needed, but for now user must click Save.
                    alert(`Recorded: ${transType.value} ${qty}. Click 'Save' to apply.`);
                };

                const applySnapshotFromModal = () => {
                    if (!confirm("ÌòÑÏû¨ Ïû¨Í≥†Î•º Í∏∞Ï§Ä ÏàòÎüâÏúºÎ°ú ÏÑ§Ï†ïÌïòÏãúÍ≤†ÏäµÎãàÍπå? (Set CURRENT STOCK as Last Record?)")) return;
                    editingPart.lastRecord = {
                        qty: Number(editingPart.stock),
                        date: new Date().toISOString().slice(0, 10)
                    };
                    alert("Snapshot Set! Click 'Save' to persist.");
                };

                const filteredParts = computed(() => {
                    let p = [...projectParts.value]; // Create a copy to avoid mutating original source
                    const q = searchQuery.value.toLowerCase();
                    if (q) p = p.filter(x =>
                        (x.moldCode || '').toLowerCase().includes(q) ||
                        (x.spareCode || '').toLowerCase().includes(q) ||
                        (x.model || '').toLowerCase().includes(q)
                    );
                    if (filterLowStock.value) p = p.filter(x => x.stock <= x.min);

                    const k = sortKey.value; const o = sortOrder.value;
                    return p.sort((a, b) => {
                        let va = a[k], vb = b[k];
                        if (k === 'stock') { va = Number(va) || 0; vb = Number(vb) || 0; }
                        else { va = (va || '').toString().toLowerCase(); vb = (vb || '').toString().toLowerCase(); }
                        if (va < vb) return -1 * o; if (va > vb) return 1 * o; return 0;
                    });
                });

                const sortTable = (key) => {
                    if (sortKey.value === key) sortOrder.value *= -1;
                    else { sortKey.value = key; sortOrder.value = 1; }
                };

                // Stats


                // --- Sync ---
                const syncToCloud = async () => {
                    if (!currentProject.value) return alert("ÌîÑÎ°úÏ†ùÌä∏Î•º ÏÑ†ÌÉùÌïòÏÑ∏Ïöî! (Seleccione Proyecto!)");
                    if (!confirm("ÌÅ¥ÎùºÏö∞ÎìúÏóê Ï†ÄÏû•ÌïòÏãúÍ≤†ÏäµÎãàÍπå (ÎçÆÏñ¥Ïì∞Í∏∞)? (Overwrite Cloud Data?)")) return;
                    isSyncing.value = true;
                    try {
                        const batchId = Date.now();
                        let partsToSend;
                        if (projectParts.value.length === 0) {
                            partsToSend = [{ project: currentProject.value.name, batchId, moldCode: 'EMPTY_MARKER', isMarker: true }];
                        } else {
                            // FIX: Force include ID and partId (UUID)
                            partsToSend = projectParts.value.map(p => {
                                const raw = JSON.parse(JSON.stringify(toRaw(p)));
                                return {
                                    ...raw,
                                    id: raw.id, // Explicitly ensure ID
                                    partId: raw.partId, // Explicitly ensure UUID
                                    project: currentProject.value.name,
                                    batchId
                                };
                            });
                        }

                        // DEBUG: Verify before sending
                        if (partsToSend.length > 0) {
                            console.log("Syncing First Item:", partsToSend[0]);
                            if (!partsToSend[0].id || !partsToSend[0].partId) {
                                alert("Warning: ID or UUID missing in outgoing data! Check Console.");
                            }
                        }

                        await fetch(CLOUD_URL, {
                            method: 'POST',
                            body: JSON.stringify({ action: 'save', project: currentProject.value.name, parts: partsToSend })
                        });
                        alert("Ï†ÄÏû• ÏôÑÎ£å! (Guardado!)");
                    } catch (e) { alert("Ïò§Î•ò (Error): " + e); } finally { isSyncing.value = false; }
                };

                const syncFromCloud = async () => {
                    isSyncing.value = true;
                    try {
                        const r = await fetch(CLOUD_URL + "?action=load");
                        const d = await r.json();
                        if (!d.parts) return alert("Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå (No Cloud Data)");
                        rawCloudData.value = d.parts;

                        const counts = {};
                        d.parts.forEach(p => {
                            const name = (p.project || p.model || 'Unknown').trim();
                            counts[name] = (counts[name] || 0) + 1;
                        });
                        cloudProjectsList.value = Object.keys(counts).map(n => ({ name: n, count: counts[n] }));
                        showCloudModal.value = true;
                    } catch (e) { alert("Error: " + e); } finally { isSyncing.value = false; }
                };

                const loadSelectedCloudProject = async (pName) => {
                    if (!confirm(`'${pName}' ÌîÑÎ°úÏ†ùÌä∏Î°ú ÎçÆÏñ¥Ïì∞ÏãúÍ≤†ÏäµÎãàÍπå? (Overwrite local with '${pName}'?)`)) return;
                    let targetProj = projects.value.find(p => p.name === pName);
                    if (!targetProj) {
                        const id = await db.projects.add({ name: pName, updated: new Date() });
                        await loadProjects();
                        targetProj = projects.value.find(p => p.id === id);
                    }
                    await selectProject(targetProj);

                    const cloudParts = rawCloudData.value.filter(p => (p.project || 'Unknown') === pName);
                    // Filter latest batch logic omitted for simplicity given time - taking all unique?
                    // Re-implementing simplified batch logic:
                    const latestBatchId = cloudParts.reduce((max, p) => Math.max(max, p.batchId || 0), 0);
                    let latestParts = cloudParts.filter(p => (p.batchId || 0) === latestBatchId && !p.isMarker && p.moldCode !== 'EMPTY_MARKER');

                    await db.parts.where('projectId').equals(targetProj.id).delete();

                    const toAdd = latestParts.map(p => {
                        const rawP = toRaw(p);
                        const { id, _id, ...rest } = rawP;
                        return { ...rest, projectId: targetProj.id };
                    });

                    await db.parts.bulkAdd(toAdd);
                    projectParts.value = await db.parts.where('projectId').equals(targetProj.id).toArray();
                    showCloudModal.value = false;
                    alert("Î°úÎìú ÏôÑÎ£å! (Loaded!)");
                };

                const deleteCloudProject = async (pName) => {
                    if (!confirm("ÌÅ¥ÎùºÏö∞ÎìúÏóêÏÑú ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå? (Delete from Cloud?)")) return;
                    await fetch(CLOUD_URL, {
                        method: 'POST',
                        body: JSON.stringify({ action: 'save', project: pName, parts: [] })
                    });
                    syncFromCloud();
                };

                // --- Backup/Restore ---
                const downloadJsonBackup = () => {
                    db.transaction('r', db.projects, db.parts, async () => {
                        const allProjects = await db.projects.toArray();
                        const allAssets = await db.parts.toArray();
                        const data = { projects: allProjects, parts: allAssets };
                        const blob = new Blob([JSON.stringify(data)], { type: "application/json" });
                        const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
                        a.download = `FacilityData_${new Date().toISOString().slice(0, 10)}.json`; a.click();
                    });
                };
                const uploadJsonRestore = (e) => {
                    const f = e.target.files[0]; if (!f) return;
                    const r = new FileReader();
                    r.onload = async (ev) => {
                        const d = JSON.parse(ev.target.result);
                        if (confirm("Î™®Îì† Îç∞Ïù¥ÌÑ∞Î•º ÎçÆÏñ¥Ïì∞ÏãúÍ≤†ÏäµÎãàÍπå? (Overwrite ALL data?)")) {
                            await db.projects.clear(); await db.parts.clear();
                            if (d.projects) await db.projects.bulkAdd(d.projects);
                            if (d.parts) await db.parts.bulkAdd(d.parts);
                            location.reload();
                        }
                    }; r.readAsText(f);
                };
                const clearAllData = async () => {
                    if (confirm("Ï†ÑÏ≤¥ Ï¥àÍ∏∞Ìôî ÌïòÏãúÍ≤†ÏäµÎãàÍπå? (Delete ALL?)")) {
                        await db.projects.clear(); await db.parts.clear();
                        location.reload();
                    }
                };

                // --- Report ---
                const openReport = () => {
                    showReportModal.value = true;
                    generateReport();
                };

                const sortReport = (key) => {
                    if (reportSortKey.value === key) reportSortOrder.value *= -1;
                    else { reportSortKey.value = key; reportSortOrder.value = 1; }
                };

                const generateReport = () => {
                    const year = reportYear.value;
                    reportData.value = projectParts.value.map(p => {
                        const row = {
                            id: p.id,
                            moldCode: p.moldCode,
                            spareCode: p.spareCode,
                            model: p.model,
                            carryover: p.carryover || 0,
                            lastRecordQty: p.lastRecord?.qty ?? null, // UI binding
                            lastRecordDate: p.lastRecord?.date ?? null,
                            effectiveCarryover: 0, // Calculated based on record or carryover
                            q: { 1: { in: 0, out: 0 }, 2: { in: 0, out: 0 }, 3: { in: 0, out: 0 }, 4: { in: 0, out: 0 } },
                            m: {}, // Monthly Data
                            total: { in: 0, out: 0 },
                            currentStock: 0,
                            min: p.min || 0,
                            max: p.max || 999999
                        };

                        // Determine Baseline
                        let baselineStock = row.carryover;
                        let filterDate = null;

                        if (p.lastRecord && p.lastRecord.date) {
                            baselineStock = Number(p.lastRecord.qty);
                            filterDate = new Date(p.lastRecord.date);
                        }

                        row.effectiveCarryover = baselineStock;

                        // Init monthly
                        for (let i = 1; i <= 12; i++) row.m[i] = { in: 0, out: 0 };

                        (p.transactions || []).forEach(t => {
                            if (!t.date) return;
                            const d = new Date(t.date);

                            // IF Last Record exists, skip transactions BEFORE or ON that date
                            if (filterDate && d <= filterDate) return;

                            if (d.getFullYear() === year) {
                                const month = d.getMonth() + 1;
                                const q = Math.ceil(month / 3);

                                if (t.type === 'IN') {
                                    row.q[q].in += t.qty;
                                    row.m[month].in += t.qty;
                                    row.total.in += t.qty;
                                } else {
                                    row.q[q].out += t.qty;
                                    row.m[month].out += t.qty;
                                    row.total.out += t.qty;
                                }
                            }
                        });
                        row.currentStock = row.effectiveCarryover + row.total.in - row.total.out;
                        return row;
                    });
                };
                watch(reportYear, generateReport);

                const reportFilteredData = computed(() => {
                    let data = [...reportData.value]; // Create a copy

                    // Filter by Selection
                    if (showSelectedOnly.value) {
                        data = data.filter(r => reportSelectedParts.value.has(r.id));
                    }

                    // Stock Filter
                    if (reportStockFilter.value === 'Low') {
                        data = data.filter(r => r.currentStock <= r.min);
                    } else if (reportStockFilter.value === 'Over') {
                        data = data.filter(r => r.currentStock >= r.max);
                    }

                    const k = reportSortKey.value;
                    const o = reportSortOrder.value;
                    return data.sort((a, b) => {
                        let va = a[k], vb = b[k];
                        if (['carryover', 'currentStock'].includes(k)) { va = Number(va) || 0; vb = Number(vb) || 0; }
                        else if (['totalIn', 'totalOut'].includes(k)) {
                            if (k === 'totalIn') { va = a.total.in; vb = b.total.in; }
                            else { va = a.total.out; vb = b.total.out; }
                        }
                        else { va = (va || '').toString().toLowerCase(); vb = (vb || '').toString().toLowerCase(); }

                        if (va < vb) return -1 * o;
                        if (va > vb) return 1 * o;
                        return 0;
                    });
                });

                const printReportModal = () => window.print();
                const captureReportModal = async () => {
                    const el = document.getElementById('report-print-area');
                    const c = await html2canvas(el, { scale: 2 });
                    const a = document.createElement('a'); a.href = c.toDataURL(); a.download = 'Report.png'; a.click();
                };

                const editPartFromReport = (id) => {
                    const p = projectParts.value.find(x => x.id === id);
                    if (p) {
                        editPart(p); // Opens the edit modal
                        // Optional: Keep report open? Or close it?
                        // User suggestion: "When found to be wrong -> modify".
                        // It's better to keep Report open behind it or close it?
                        // If we keep it open, the modal z-index might conflict or be double overlay.
                        // Let's keep report open but ensure Edit Modal is on top (z-index is high enough).
                        // Both use .modal-overlay.
                        // If proper z-indexing isn't handled, close Report might be safer.
                        // But user might want to continue reviewing report.
                        // Let's try keeping it open. If z-index issues, we can close report.
                        // Actually, let's close Report to avoid confusion and force refresh on re-open.
                        // "ÏàòÏ†ïÌïòÎ†§Î©¥ Ï∞ΩÏùÑ Îã´Í≥† ... Î∂àÌé∏Ìï®".
                        // Let's close report for now to be safe and ensure data refresh when they reopen report.
                        showReportModal.value = false;
                    }
                };





                const applyStockSnapshot = async () => {
                    if (!confirm("Apply Current Stock as Last Record for visible items? \n(This will close the stock as of today)")) return;

                    const today = new Date().toISOString().slice(0, 10);
                    const itemsToUpdate = reportFilteredData.value; // Use filtered list (showing selected or all)

                    for (const row of itemsToUpdate) {
                        const p = projectParts.value.find(x => x.id === row.id);
                        if (p) {
                            p.lastRecord = {
                                qty: row.currentStock,
                                date: today
                            };
                            await db.parts.put(JSON.parse(JSON.stringify(toRaw(p))));
                        }
                    }
                    alert("Snapshot Applied!");
                    generateReport();
                };

                // --- QR Logic ---
                const showQRModal = ref(false);
                const qrPartName = ref('');
                const qrPartId = ref('');
                const qrProjectName = ref('');

                const showQR = (p) => {
                    if (!currentProject.value) return alert("ÌîÑÎ°úÏ†ùÌä∏Î•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.");
                    const partName = p.moldCode || 'Unknown Part';
                    qrPartName.value = partName;
                    qrPartId.value = p.partId || 'No UUID';
                    qrProjectName.value = currentProject.value.name;
                    showQRModal.value = true;

                    // Generate QR with partId
                    const data = JSON.stringify({
                        id: p.id,
                        partId: p.partId, // Add UUID
                        project: currentProject.value.name,
                        type: 'part'
                    });

                    nextTick(() => {
                        const el = document.getElementById("qrcode");
                        if (el) {
                            el.innerHTML = "";
                            new QRCode(el, {
                                text: data,
                                width: 128,
                                height: 128
                            });
                        }
                    });
                };

                const printQR = () => {
                    const el = document.getElementById("qrcode");
                    if (!el) return;
                    const win = window.open('', '', 'width=400,height=400');
                    win.document.write(`
                        <html>
                            <body style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:100vh;">
                                ${el.innerHTML}
                                <p style="margin-top:20px; font-weight:bold; font-size:20px;">${qrPartName.value}</p>
                            </body>
                        </html>
                    `);
                    win.document.close();
                    win.focus();
                    setTimeout(() => { win.print(); win.close(); }, 500);
                };

                return {
                    projects, currentProject, filteredParts, searchQuery, filterLowStock,
                    showPartModal, showReportModal, showCloudModal,
                    editingPart, defaultPart,
                    isSyncing, isImageProcessing, zoomedImage, columns, visibleColumns, showColMenu,
                    sortKey, sortOrder, // Added missing sort keys
                    reportYear, reportFilteredData, cloudProjectsList, reportSortKey, reportSortOrder, reportType,
                    reportSelectedParts, showSelectedOnly, toggleReportSelection, toggleSelectAllReport, reportStockFilter,
                    transDate, transType, transQty, addTransaction,
                    createProject, selectProject, deleteProject,
                    openAddModal, editPart, savePart, deletePart, editPartFromReport,
                    handleImageUpload, setModalImage, sortTable, sortReport,
                    applyStockSnapshot, applySnapshotFromModal,
                    syncToCloud, syncFromCloud, loadSelectedCloudProject, deleteCloudProject,
                    downloadJsonBackup, uploadJsonRestore, clearAllData, openReport,
                    printReportModal, captureReportModal,
                    showQRModal, qrPartName, qrPartId, qrProjectName, showQR, printQR,

                    toggleLowStock: () => filterLowStock.value = !filterLowStock.value,
                    toggleSidebar: () => {
                        document.body.classList.toggle('sidebar-collapsed');
                        const b = document.getElementById('btn-toggle-sidebar');
                        b.innerText = document.body.classList.contains('sidebar-collapsed') ? '‚ñ∂' : '‚óÄ';
                    }
                };
            }
        }).mount('#app');
    </script>
</body>

</html>