<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <title>ì„¤ë¹„ ìˆ˜ë¦¬ í’ˆì˜ì„œ V6.1 (Cloud Select)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        /* [ê³µí†µ] ë ˆì´ì•„ì›ƒ */
        body {
            margin: 0;
            padding: 0;
            background-color: #2c3e50;
            display: flex;
            height: 100vh;
            font-family: 'Malgun Gothic', 'Segoe UI', sans-serif;
            overflow: hidden;
        }

        /* [ì¢Œì¸¡] ì…ë ¥ íŒ¨ë„ */
        .input-panel {
            width: 450px;
            min-width: 350px;
            max-width: 900px;
            background: #212529;
            color: white;
            padding: 20px;
            overflow-y: auto;
            box-shadow: 4px 0 10px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            gap: 15px;
            z-index: 10;
        }

        .input-panel h2 {
            border-bottom: 2px solid #adb5bd;
            padding-bottom: 10px;
            font-size: 1.2rem;
            color: #f8f9fa;
            margin-top: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .save-status {
            font-size: 0.7rem;
            color: #28a745;
            font-weight: normal;
        }

        /* Resizer */
        .resizer {
            width: 8px;
            background-color: #1a1d20;
            cursor: col-resize;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            transition: background 0.2s;
        }

        .resizer:hover,
        .resizer.resizing {
            background-color: #0d6efd;
        }

        .resizer::after {
            content: "â‹®";
            color: #6c757d;
            font-size: 14px;
            font-weight: bold;
        }

        .form-section {
            background: #343a40;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #495057;
        }

        .form-section h3 {
            margin: 0 0 10px 0;
            font-size: 0.95rem;
            color: #ffc107;
            border-bottom: 1px solid #6c757d;
            padding-bottom: 5px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-size: 0.8rem;
            color: #ced4da;
        }

        input,
        textarea,
        select {
            width: 100%;
            padding: 6px;
            border: 1px solid #6c757d;
            border-radius: 4px;
            background: #fff;
            color: #333;
            margin-bottom: 8px;
            font-family: inherit;
            font-size: 0.9rem;
            box-sizing: border-box;
        }

        ::placeholder {
            color: #aaa;
            font-style: italic;
            font-size: 0.85rem;
        }

        textarea {
            height: 60px;
            resize: none;
        }

        /* Visibility Toggle Style */
        .visibility-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .visibility-item {
            display: flex;
            align-items: center;
            gap: 8px;
            background: #495057;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            user-select: none;
        }

        .visibility-item:hover {
            background: #6c757d;
        }

        .visibility-item input {
            width: auto;
            margin: 0;
            cursor: pointer;
        }

        .visibility-item span {
            font-size: 0.8rem;
            color: #fff;
        }

        /* ì…ë ¥ ê·¸ë£¹ ìŠ¤íƒ€ì¼ */
        .cost-input-group,
        .compare-input-box,
        .history-input-box,
        .schedule-box {
            background: #2c3034;
            padding: 8px;
            border-radius: 4px;
            border: 1px solid #555;
            margin-bottom: 5px;
        }

        .cost-row,
        .compare-row,
        .history-row {
            display: flex;
            gap: 5px;
            align-items: center;
            margin-bottom: 3px;
        }

        .cmp-label {
            font-size: 0.75rem;
            color: #aaa;
            width: 45px;
        }

        .btn-action {
            display: flex;
            gap: 5px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .btn-save {
            flex: 1;
            background: #0d6efd;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 4px;
            font-weight: bold;
            cursor: pointer;
        }

        .btn-load {
            flex: 1;
            background: #6c757d;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 4px;
            font-weight: bold;
            cursor: pointer;
        }

        .btn-reset {
            flex: 0.5;
            background: #dc3545;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 4px;
            font-weight: bold;
            cursor: pointer;
        }

        /* Cloud Buttons */
        .btn-cloud-save {
            flex: 1;
            background: #4285F4;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 4px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .btn-cloud-load {
            flex: 1;
            background: #34A853;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 4px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .btn-add {
            background: #17a2b8;
            border: none;
            padding: 8px;
            color: white;
            width: 100%;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 5px;
            font-size: 0.8rem;
        }

        .btn-del-mini {
            background: #dc3545;
            color: white;
            border: none;
            padding: 2px 6px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.7rem;
            margin-left: 5px;
        }

        .btn-output-group {
            display: flex;
            gap: 5px;
            margin-bottom: 5px;
        }

        .btn-print {
            flex: 1;
            background: #374151;
            border: 1px solid #4b5563;
            height: 38px;
            font-size: 0.85rem;
            color: #f9fafb;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.2s;
        }

        .btn-print:hover {
            background: #4b5563;
        }

        .btn-capture {
            flex: 1;
            background: #374151;
            border: 1px solid #4b5563;
            height: 38px;
            font-size: 0.85rem;
            color: #f9fafb;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.2s;
        }

        .btn-capture:hover {
            background: #4b5563;
        }

        .budget-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 10px;
        }

        .budget-tab {
            flex: 1;
            padding: 8px;
            border: none;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.8rem;
            border-radius: 4px;
            background: #495057;
            color: #ccc;
        }

        .budget-tab.active {
            background: #ffc107;
            color: #000;
        }

        .budget-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 5px;
            margin-bottom: 10px;
        }

        .budget-container {
            display: none;
        }

        .budget-container.active {
            display: block;
        }

        /* [ìš°ì¸¡] ë¯¸ë¦¬ë³´ê¸° íŒ¨ë„ */
        .preview-panel {
            flex: 1;
            padding: 40px;
            overflow: auto;
            background: #555;
            display: block;
            min-width: 300px;
        }

        .report-container {
            width: 297mm;
            min-height: 210mm;
            height: auto;
            margin: 0 auto;
            background: white;
            box-sizing: border-box;
            padding: 15mm;
            padding-bottom: 30mm;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
        }

        /* [Header] */
        .modern-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            border-bottom: 3px solid black;
            padding-bottom: 15px;
            margin-bottom: 30px;
        }

        .header-left {
            flex: 1;
        }

        .doc-title {
            font-size: 32px;
            font-weight: 900;
            color: #000;
            margin: 0;
            line-height: 1;
            text-decoration: underline;
            text-underline-offset: 5px;
        }

        .doc-subtitle {
            font-size: 14px;
            color: #555;
            margin-top: 8px;
            font-weight: bold;
        }

        .header-right {
            text-align: right;
        }

        .info-table {
            border-collapse: collapse;
            display: inline-table;
        }

        .info-table td {
            padding: 3px 0 3px 15px;
            text-align: right;
            font-size: 12px;
            color: #333;
        }

        .info-label {
            font-weight: bold;
            color: #000;
        }

        .category-badge {
            font-weight: bold;
            color: #d63384;
        }

        .section-title {
            font-size: 15px;
            font-weight: bold;
            color: #000;
            margin-top: 30px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            border-left: 6px solid #333;
            padding-left: 10px;
            background: #f8f9fa;
            padding-top: 4px;
            padding-bottom: 4px;
        }

        .section-sub {
            font-size: 11px;
            color: #666;
            margin-left: auto;
            font-weight: normal;
        }

        table.styled-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 10px;
            margin-bottom: 15px;
            table-layout: fixed;
        }

        .styled-table th,
        .styled-table td {
            border: 1px solid #444;
            padding: 6px 4px;
            vertical-align: middle;
        }

        .styled-table th {
            background-color: #e9ecef;
            color: #000;
            text-align: center;
            font-weight: bold;
            border-top: 2px solid black;
        }

        .styled-table tr:nth-child(even) {
            background-color: transparent;
        }

        .photo-img {
            max-width: 98%;
            max-height: 130px;
            object-fit: contain;
            display: block;
            margin: 0 auto;
        }

        .total-row td {
            background-color: #f8f9fa !important;
            font-weight: bold;
        }

        .grand-total-row td {
            background-color: #e2e6ea !important;
            color: #000 !important;
            font-size: 12px;
            font-weight: bold;
            border-top: 2px solid #000;
        }

        .cost-header-mxn {
            background-color: #d1ecf1;
            font-weight: bold;
        }

        .cost-header-krw {
            background-color: #fff3cd;
            font-weight: bold;
        }

        .diff-plus {
            color: blue;
            font-weight: bold;
        }

        .diff-minus {
            color: red;
            font-weight: bold;
        }

        .compare-sel {
            background-color: #e3f2fd;
        }

        .compare-cmp {
            background-color: #f8f9fa;
        }

        .price-up {
            color: red;
            font-weight: bold;
        }

        .price-down {
            color: blue;
            font-weight: bold;
        }

        .price-same {
            color: #999;
        }

        .bar-bg {
            width: 100%;
            background: #e9ecef;
            height: 12px;
            border-radius: 6px;
            overflow: hidden;
            margin-top: 3px;
        }

        .bar-fill {
            height: 100%;
            background: #28a745;
            width: 0%;
            transition: width 0.3s;
        }

        .bar-fill.warning {
            background: #ffc107;
        }

        .bar-fill.danger {
            background: #dc3545;
        }

        .budget-month-table th {
            background: #eee;
        }

        .budget-month-table td {
            text-align: right;
        }

        #out-overview-box {
            border: 1px solid #444;
            padding: 10px;
            min-height: 40px;
            color: #000;
        }

        #out-overview-text {
            font-size: 11px;
            white-space: pre-wrap;
            margin-bottom: 5px;
        }

        #out-overview-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 5px;
            margin-top: 10px;
        }

        .overview-img-item {
            width: 100%;
            height: 180px;
            object-fit: contain;
            border: 1px solid #eee;
            background: #fff;
            padding: 2px;
        }

        /* Schedule CSS */
        .sch-btn-small {
            padding: 4px 8px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.7rem;
            color: white;
        }

        .copy {
            background: #2980b9;
        }

        .del {
            background: #c0392b;
        }

        .sch-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 10px;
            table-layout: fixed;
        }

        .sch-table th {
            font-size: 9px;
            padding: 4px 2px;
            border: 1px solid #ccc;
            background: #fff;
        }

        .sch-table td {
            padding: 0;
            height: 24px;
            border: 1px solid #ddd;
            position: relative;
            vertical-align: middle;
        }

        .sch-bar-container {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .sch-bar-middle {
            width: 100%;
            height: 8px;
            background: #2980b9;
            display: block;
        }

        .sch-end-box {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
        }

        .sch-line-end {
            flex-grow: 1;
            height: 8px;
            background: #2980b9;
        }

        .sch-arrow {
            width: 0;
            height: 0;
            border-top: 8px solid transparent;
            border-bottom: 8px solid transparent;
            border-left: 10px solid #2980b9;
        }

        .sch-dot {
            width: 10px;
            height: 10px;
            background: #2980b9;
            border-radius: 50%;
            margin: 0 auto;
        }

        .row-flex {
            display: flex;
            gap: 5px;
            align-items: center;
            margin-bottom: 5px;
        }

        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(33, 37, 41, 0.95);
            color: #fff;
            padding: 12px 25px;
            border-radius: 30px;
            font-size: 0.9rem;
            z-index: 9999;
            display: none;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
            border: 1px solid #444;
            font-weight: bold;
        }

        /* [ì¶”ê°€ë¨] í´ë¼ìš°ë“œ íŒŒì¼ ëª©ë¡ íŒì—… ìŠ¤íƒ€ì¼ */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal-box {
            background: #2c3e50;
            width: 500px;
            max-height: 80vh;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            color: white;
        }

        .modal-header {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            border-bottom: 1px solid #555;
            padding-bottom: 10px;
        }

        .modal-close {
            cursor: pointer;
            color: #ff6b6b;
            font-weight: bold;
        }

        .file-list-container {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .file-item {
            background: #34495e;
            padding: 12px;
            border-radius: 6px;
            cursor: pointer;
            border: 1px solid #444;
            transition: 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .file-item:hover {
            background: #0d6efd;
            border-color: #0d6efd;
        }

        .file-info {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }

        .f-title {
            font-weight: bold;
            font-size: 0.95rem;
            color: #fff;
        }

        .f-meta {
            font-size: 0.8rem;
            color: #ccc;
        }

        .f-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 5px 12px;
            border-radius: 4px;
            font-size: 0.8rem;
            cursor: pointer;
        }

        @media print {

            .input-panel,
            .resizer,
            .toast,
            .modal-overlay,
            .sidebar-controls {
                display: none !important;
            }

            .preview-panel {
                padding: 0;
                background: white;
            }

            .report-container {
                width: 100%;
                margin: 0;
                padding: 0;
                box-shadow: none;
                border: none;
            }

            body {
                background: white;
                height: auto;
                overflow: visible;
            }
        }

        /* Sidebar Controls (Home + Toggle) */
        .sidebar-controls {
            display: flex;
            align-items: center;
            position: fixed;
            top: 15px;
            left: 15px;
            z-index: 1001;
        }

        .home-btn {
            background: #334155 !important;
            color: #e2e8f0 !important;
            border: 1px solid #475569 !important;
            border-radius: 8px 0 0 8px !important;
            height: 28px !important;
            padding: 0 10px !important;
            box-sizing: border-box !important;
            text-decoration: none !important;
            font-size: 12px !important;
            font-weight: 700 !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            gap: 4px !important;
            margin: 0 !important;
        }

        .home-btn:hover {
            background: #4285F4 !important;
            color: #fff !important;
        }

        .btn-toggle-sidebar {
            width: 24px !important;
            height: 28px !important;
            background: #1e293b !important;
            border: 1px solid #334155 !important;
            border-left: none !important;
            border-radius: 0 8px 8px 0 !important;
            box-sizing: border-box !important;
            color: #94a3b8 !important;
            cursor: pointer !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            font-size: 12px !important;
            padding: 0 !important;
        }

        .btn-toggle-sidebar:hover {
            color: white !important;
            background: #334155 !important;
        }

        body.full-screen .input-panel {
            display: none !important;
        }

        body.full-screen .resizer {
            display: none !important;
        }

        body.full-screen .sidebar-controls {
            position: fixed;
            left: 15px;
            top: 15px;
            z-index: 1001;
        }
    </style>
</head>

<body>

    <div id="cloudToast" class="toast">â˜ï¸ ì•Œë¦¼</div>

    <div id="cloudModal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-header">
                <span>â˜ï¸ í´ë¼ìš°ë“œ ì €ì¥ ëª©ë¡ (Cloud List)</span>
                <span class="modal-close" onclick="closeCloudModal()">X</span>
            </div>
            <div id="cloudFileList" class="file-list-container">
                <div style="text-align:center; padding:20px; color:#aaa;">ë¡œë”© ì¤‘...</div>
            </div>
        </div>
    </div>

    <div class="input-panel" id="inputPanel">
        <h2>
            <span id="save-status" class="save-status"></span>
        </h2>

        <div class="btn-output-group">
            <button class="btn-print" onclick="window.print()">ğŸ–¨ï¸ PDF ë³€í™˜ (PDF)</button>
            <button class="btn-capture" onclick="captureImage()">ğŸ“¸ ìŠ¤í¬ë¦°ìƒ· (Captura)</button>
        </div>

        <div class="btn-action">
            <button class="btn-cloud-save" onclick="saveToCloud()">â˜ï¸ í´ë¼ìš°ë“œ ì €ì¥ (Cloud Save)</button>
            <button class="btn-cloud-load" onclick="loadFromCloud()">â˜ï¸ ì„ íƒ ë¶ˆëŸ¬ì˜¤ê¸° (Cloud Load)</button>
        </div>
        <div class="btn-action">
            <button class="btn-save" onclick="saveData()">ğŸ’¾ íŒŒì¼ ì €ì¥</button>
            <button class="btn-load" onclick="document.getElementById('file-load').click()">ğŸ“‚ íŒŒì¼ ì—´ê¸°</button>
            <button class="btn-reset" onclick="resetForm()">ğŸ—‘ï¸ ì´ˆê¸°í™”</button>
            <input type="file" id="file-load" style="display:none;" accept=".json" onchange="loadDataFile(this)">
        </div>

        <div class="form-section">
            <h3>ğŸ‘ï¸ ì¶œë ¥ í•­ëª© ì„¤ì • (Visibilidad)</h3>
            <div class="visibility-group">
                <label class="visibility-item"><input type="checkbox" id="chk-overview" checked
                        onchange="toggleSection('sec-overview', this.checked)"><span>1. ê°œìš”/ëª©ì </span></label>
                <label class="visibility-item"><input type="checkbox" id="chk-issue" checked
                        onchange="toggleSection('sec-issue', this.checked)"><span>2. ìì¬ ëª©ë¡</span></label>
                <label class="visibility-item"><input type="checkbox" id="chk-cost" checked
                        onchange="toggleSection('sec-cost', this.checked)"><span>3. ë¹„ìš© ì‚°ì¶œ</span></label>
                <label class="visibility-item"><input type="checkbox" id="chk-compare" checked
                        onchange="toggleSection('sec-compare', this.checked)"><span>4. ë¹„êµ ê²¬ì </span></label>
                <label class="visibility-item"><input type="checkbox" id="chk-budget" checked
                        onchange="toggleSection('sec-budget', this.checked)"><span>5. ì˜ˆì‚° ê´€ë¦¬</span></label>
                <label class="visibility-item"><input type="checkbox" id="chk-schedule" checked
                        onchange="toggleSection('sec-schedule', this.checked)"><span>6. ìˆ˜ë¦¬ ì¼ì •</span></label>
            </div>
            <div style="font-size:0.7rem; color:#aaa; margin-top:5px;">* ì²´í¬ í•´ì œ ì‹œ ì¶œë ¥ í™”ë©´ì—ì„œ ì™„ì „íˆ ìˆ¨ê²¨ì§‘ë‹ˆë‹¤.</div>
        </div>

        <div class="form-section">
            <h3>1. ê¸°ë³¸ ì •ë³´ (InformaciÃ³n BÃ¡sica)</h3>

            <label style="color:#d63384; font-weight:bold;">í’ˆì˜ êµ¬ë¶„ (CategorÃ­a)</label>
            <select id="in-category" onchange="updateView()" style="background:#fff0f6; font-weight:bold;">
                <option value="ìˆ˜ì„  (ReparaciÃ³n)">ìˆ˜ì„  (ReparaciÃ³n)</option>
                <option value="íˆ¬ì (InversiÃ³n)">íˆ¬ì (InversiÃ³n)</option>
                <option value="ì†Œëª¨ (Consumibles)">ì†Œëª¨ (Consumibles)</option>
                <option value="ì‹œì„¤ë¬¼ ë³´ìˆ˜ (ReparaciÃ³n de Instalaciones)">ì‹œì„¤ë¬¼ ë³´ìˆ˜ (ReparaciÃ³n de Instalaciones)</option>
            </select>

            <label>ì¼ì (Fecha)</label> <input type="date" id="in-date" onchange="updateView()">
            <label>ë¶€ì„œ (Departamento)</label> <input type="text" id="in-dept" value="" placeholder="Departamento (ë¶€ì„œëª…)"
                onkeyup="updateView()">
            <label>ë¬¸ì„œ ì œëª© (TÃ­tulo del Documento)</label> <input type="text" id="in-doc-name" value=""
                placeholder="TÃ­tulo del Documento (ë¬¸ì„œ ì œëª©)" onkeyup="updateView()">
            <label>í™˜ìœ¨ (Tipo de Cambio: 1 MXN)</label> <input type="number" id="in-rate" value=""
                placeholder="Tipo de Cambio (ì˜ˆ: 75)" onkeyup="updateView()">
        </div>

        <div class="form-section">
            <h3>2. ê°œìš” ë° ëª©ì  (Resumen y PropÃ³sito)</h3>
            <textarea id="in-overview" onkeyup="updateView()"
                placeholder="Resumen y PropÃ³sito de la reparaciÃ³n (ìˆ˜ë¦¬ ê°œìš” ë° ëª©ì  ì…ë ¥)"></textarea>

            <div style="margin-top:8px; border-top:1px dashed #666; padding-top:8px;">
                <label style="color:#ffc107;">ğŸ“· ê°œìš” ì‚¬ì§„ (Fotos del Resumen)</label>
                <div id="overview-img-list"></div>
                <button class="btn-add" style="margin-top:5px;" onclick="addOverviewImgInput()">+ ê°œìš” ì‚¬ì§„ ì¶”ê°€ (Agregar
                    Foto)</button>
            </div>
        </div>

        <div class="form-section">
            <h3>3. ì ê²€ ê²°ê³¼ (Fotos de InspecciÃ³n)</h3>
            <div id="issue-inputs"></div>
            <button class="btn-add" onclick="addIssueRow(); updateView()">+ ì‚¬ì§„ ì¶”ê°€ (Agregar Foto)</button>
        </div>

        <div class="form-section">
            <h3>4. ë¹„ìš© ì‚°ì¶œ (CÃ¡lculo de Costos)</h3>

            <div style="font-size:0.8rem; color:#aaa; margin-bottom:5px;">* í•­ëª©ë³„ ëŒ€ìƒ ê³µì¥ ë° ì¬ê³ /ì´ë ¥ í¬í•¨ ì…ë ¥</div>
            <div style="margin-bottom:10px;">
                <div id="mxn-inputs"></div>
                <button class="btn-add" onclick="addCostRow('MXN'); updateView()">+ MXN ì¶”ê°€ (Agregar MXN)</button>
            </div>
            <div>
                <div id="krw-inputs"></div>
                <button class="btn-add" style="background:#e0a800;" onclick="addCostRow('KRW'); updateView()">+ KRW ì¶”ê°€
                    (Agregar KRW)</button>
            </div>
        </div>

        <div class="form-section">
            <h3>5. ë¹„êµ ê²¬ì  ë° ë‹¨ê°€ ì´ë ¥ (ComparaciÃ³n)</h3>
            <label style="color:#17a2b8;">5-1. ì—…ì²´ ê°„ ë¹„êµ (ComparaciÃ³n de Proveedores)</label>
            <div id="compare-mxn-inputs"></div>
            <button class="btn-add" onclick="addCompareRow('MXN'); updateView()">+ ë¹„êµ ì¶”ê°€ MXN (Agregar Comp.)</button>
            <div style="margin-top:5px;" id="compare-krw-inputs"></div>
            <button class="btn-add" style="background:#e0a800;" onclick="addCompareRow('KRW'); updateView()">+ ë¹„êµ ì¶”ê°€ KRW
                (Agregar Comp.)</button>

            <label style="color:#20c997; margin-top:20px; border-top:1px dashed #666; padding-top:10px;">5-2. ë‹¨ê°€ ë³€ë™ ì´ë ¥
                (Historial de Precios)</label>
            <div style="font-size:0.8rem; color:#aaa; margin-bottom:5px;">* ê¸ˆë²ˆ/ì´ì „ ë‹¨ê°€ ë° ì¼ì ë¹„êµ</div>
            <div id="history-inputs"></div>
            <button class="btn-add" style="background:#20c997;" onclick="addHistoryRow(); updateView()">+ ì´ë ¥ ì¶”ê°€ (Agregar
                Historial)</button>
        </div>

        <div class="form-section">
            <h3>6. ì˜ˆì‚° ê´€ë¦¬ (Presupuesto)</h3>
            <div class="budget-tabs">
                <button class="budget-tab active" onclick="switchBudgetTab('P1')">1ê³µì¥ (P1)</button>
                <button class="budget-tab" onclick="switchBudgetTab('P3')">3ê³µì¥ (P3)</button>
            </div>
            <div id="budget-input-p1" class="budget-container active">
                <div class="budget-grid" id="budget-plan-p1"></div>
                <div class="budget-grid" id="budget-act-p1"></div>
            </div>
            <div id="budget-input-p3" class="budget-container">
                <div class="budget-grid" id="budget-plan-p3"></div>
                <div class="budget-grid" id="budget-act-p3"></div>
            </div>
        </div>

        <div class="form-section">
            <h3>7. ì¼ì • ê´€ë¦¬ (Cronograma)</h3>
            <div style="font-size:0.8rem; color:#aaa; margin-bottom:5px;">* ê¸°ê°„ ë° ì‘ì—… ë‚´ìš© ì…ë ¥ (Periodo y Actividad)</div>
            <div id="schedule-inputs"></div>
            <button class="btn-add" style="background:#8e44ad;" onclick="addScheduleRow(); updateView()">+ ì¼ì • ì¶”ê°€
                (Agregar Tarea)</button>
        </div>

    </div>

    <div class="resizer" id="dragMe"></div>

    <div class="sidebar-controls">
        <a class="home-btn" href="index.html">ğŸ  Home</a>
        <button id="btn-toggle-sidebar" class="btn-toggle-sidebar" onclick="toggleSidebar()">â—€</button>
    </div>

    <div class="preview-panel">
        <div class="report-container" id="capture-target">

            <div class="modern-header">
                <div class="header-left">
                    <h1 class="doc-title" id="out-title">ì„¤ë¹„ ìˆ˜ë¦¬ í’ˆì˜ì„œ</h1>
                    <div class="doc-subtitle" id="out-subtitle">Repair Request Form & Cost Analysis</div>
                </div>
                <div class="header-right">
                    <table class="info-table">
                        <tr>
                            <td class="info-label">Date (ì¼ì):</td>
                            <td class="info-value" id="out-date"></td>
                        </tr>
                        <tr>
                            <td class="info-label">Type (êµ¬ë¶„):</td>
                            <td class="info-value category-badge" id="out-category"></td>
                        </tr>
                        <tr>
                            <td class="info-label">Dept (ë¶€ì„œ):</td>
                            <td class="info-value" id="out-dept"></td>
                        </tr>
                        <tr>
                            <td class="info-label">Ex.Rate (í™˜ìœ¨):</td>
                            <td class="info-value">1 MXN = <span id="out-rate"></span> KRW</td>
                        </tr>
                    </table>
                </div>
            </div>

            <div id="sec-overview">
                <div class="section-title">1. ê°œìš” ë° ëª©ì  <span class="section-sub">Resumen y PropÃ³sito</span></div>
                <div id="out-overview-box">
                    <div id="out-overview-text"></div>
                    <div id="out-overview-grid"></div>
                </div>
            </div>

            <div id="sec-issue">
                <div class="section-title">2. í•„ìš” ìì¬ ëª©ë¡ <span class="section-sub">Lista de Materiales Necesarios</span>
                </div>
                <table class="styled-table">
                    <colgroup>
                        <col width="8%">
                        <col width="30%">
                        <col width="62%">
                    </colgroup>
                    <thead>
                        <tr>
                            <th>No.</th>
                            <th>ì‚¬ì§„ (Foto)</th>
                            <th>ì„¤ëª… (ExplicaciÃ³n)</th>
                        </tr>
                    </thead>
                    <tbody id="out-issue-body"></tbody>
                </table>
            </div>

            <div id="sec-cost">
                <div class="section-title">3. ë¹„ìš© ì‚°ì¶œ <span class="section-sub">Detalle de Costos</span></div>
                <table class="styled-table">
                    <colgroup>
                        <col width="20%">
                        <col width="15%">
                        <col width="15%">
                        <col width="10%">
                        <col width="5%">
                        <col width="15%">
                        <col width="20%">
                    </colgroup>
                    <thead>
                        <tr>
                            <th>ë‚´ì—­ (Item)</th>
                            <th>ì—…ì²´ëª… (Prov.)</th>
                            <th>ì¬ê³ /ì´ë ¥ (Stock)</th>
                            <th>ìˆ˜ëŸ‰ (Cant.)</th>
                            <th>ë‹¨ìœ„ (U.)</th>
                            <th>ë‹¨ê°€ (Precio)</th>
                            <th>í•©ê³„ (Total)</th>
                        </tr>
                    </thead>

                    <tbody>
                        <tr>
                            <td colspan="7" class="cost-header-mxn">â–  í˜„ì§€ êµ¬ì… ë¹„ìš© (Costo Local - MXN)</td>
                        </tr>
                    </tbody>
                    <tbody id="out-mxn-body"></tbody>
                    <tr class="total-row">
                        <td colspan="6" style="text-align:right;">Subtotal (MXN)</td>
                        <td style="text-align:right;" id="out-total-mxn">0.00</td>
                    </tr>

                    <tbody>
                        <tr>
                            <td colspan="7" class="cost-header-krw">â–  êµ­ë‚´ êµ¬ì… ë¹„ìš© (Costo ImportaciÃ³n - KRW)</td>
                        </tr>
                    </tbody>
                    <tbody id="out-krw-body"></tbody>
                    <tr class="total-row">
                        <td colspan="6" style="text-align:right;">Subtotal (KRW)</td>
                        <td style="text-align:right;" id="out-total-krw">0</td>
                    </tr>

                    <tr class="grand-total-row">
                        <td colspan="6" style="text-align:center;">ì´ í•©ê³„ (Grand Total / MXN í™˜ì‚°)</td>
                        <td style="text-align:right;" id="out-grand-total-mxn">0.00</td>
                    </tr>
                </table>
            </div>

            <div id="sec-compare">
                <div class="section-title">4. ì—…ì²´ ì„ ì • ë° ë¹„êµ ê²¬ì  <span class="section-sub">ComparaciÃ³n de Cotizaciones</span>
                </div>

                <div style="font-size:11px; font-weight:bold; margin-bottom:4px; color:#333;">4-1. ì—…ì²´ ê°„ ë¹„êµ (Vendor
                    Comparison)</div>
                <table class="styled-table">
                    <colgroup>
                        <col width="20%">
                        <col width="20%">
                        <col width="15%">
                        <col width="20%">
                        <col width="15%">
                        <col width="10%">
                    </colgroup>
                    <thead>
                        <tr>
                            <th rowspan="2">ë‚´ì—­ (Item)</th>
                            <th colspan="2" class="compare-sel">ì„ ì • ì—…ì²´ (Seleccionado)</th>
                            <th colspan="2" class="compare-cmp">ë¹„êµ ì—…ì²´ (ComparaciÃ³n)</th>
                            <th rowspan="2">ì°¨ì•¡ (Diferencia)</th>
                        </tr>
                        <tr>
                            <th class="compare-sel">ì—…ì²´ëª… (Prov.)</th>
                            <th class="compare-sel">ë‹¨ê°€ (Precio)</th>
                            <th class="compare-cmp">ì—…ì²´ëª… (Prov.)</th>
                            <th class="compare-cmp">ë‹¨ê°€ (Precio)</th>
                        </tr>
                    </thead>
                    <tbody id="out-compare-body"></tbody>
                </table>

                <div style="font-size:11px; font-weight:bold; margin-bottom:4px; margin-top:15px; color:#20c997;">4-2.
                    ë‹¨ê°€ ë³€ë™ ì´ë ¥ (Price History)</div>
                <table class="styled-table">
                    <colgroup>
                        <col width="25%">
                        <col width="20%">
                        <col width="20%">
                        <col width="20%">
                        <col width="15%">
                    </colgroup>
                    <thead>
                        <tr>
                            <th>í’ˆëª© (Item)</th>
                            <th style="background:#f1f8ff;">ê¸ˆë²ˆ ë‹¨ê°€ (Actual)</th>
                            <th style="background:#fff5f5;">ì´ì „ ë‹¨ê°€ (Anterior)</th>
                            <th>ì´ì „ êµ¬ë§¤ì¼ (Fecha)</th>
                            <th>ë³€ë™ (Dif.)</th>
                        </tr>
                    </thead>
                    <tbody id="out-history-body"></tbody>
                </table>
            </div>

            <div id="sec-budget">
                <div class="section-title">5. ì˜ˆì‚° ê´€ë¦¬ <span class="section-sub">Control Presupuestario (MXN)</span></div>

                <div id="budget-section-label-p1"
                    style="font-size:12px; font-weight:bold; color:#28a745; border-bottom:1px solid #28a745; margin-bottom:5px; display:flex; align-items:center; gap:8px; padding:4px 0;">
                    Planta 1
                    <span class="plant-tag" style="display:none; background:#28a745; color:#fff; font-size:10px; padding:1px 7px; border-radius:10px;">â–¶ ê¸ˆë²ˆ í’ˆì˜ ë°˜ì˜</span>
                </div>
                <table class="styled-table" style="margin-bottom:2px;">
                    <thead>
                        <tr>
                            <th>êµ¬ë¶„ (Div.)</th>
                            <th>ë…„ ê³„íš (Plan)</th>
                            <th>ë…„ ëˆ„ì  (Acum.)</th>
                            <th>ê¸ˆë²ˆ í’ˆì˜ (Esta Sol.)</th>
                            <th>ì”ì—¬ ì˜ˆì‚° (Saldo)</th>
                            <th>ì§‘í–‰ë¥  (%)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr style="text-align: center;">
                            <td><strong>Total</strong></td>
                            <td id="p1-year-plan">-</td>
                            <td id="p1-year-used">-</td>
                            <td id="p1-this-req" style="font-weight:bold; color:blue;">-</td>
                            <td id="p1-bal" style="font-weight:bold;">-</td>
                            <td style="width:130px;">
                                <div id="p1-rate-text">-</div>
                                <div class="bar-bg">
                                    <div id="p1-bar" class="bar-fill"></div>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
                <table class="styled-table budget-month-table">
                    <thead>
                        <tr>
                            <th style="width:50px;">P1</th>
                            <th>1ì›”</th>
                            <th>2ì›”</th>
                            <th>3ì›”</th>
                            <th>4ì›”</th>
                            <th>5ì›”</th>
                            <th>6ì›”</th>
                            <th>7ì›”</th>
                            <th>8ì›”</th>
                            <th>9ì›”</th>
                            <th>10ì›”</th>
                            <th>11ì›”</th>
                            <th>12ì›”</th>
                        </tr>
                    </thead>
                    <tbody id="out-month-p1"></tbody>
                </table>

                <div id="budget-section-label-p3"
                    style="font-size:12px; font-weight:bold; color:#17a2b8; border-bottom:1px solid #17a2b8; margin-bottom:5px; margin-top:20px; display:flex; align-items:center; gap:8px; padding:4px 0;">
                    Planta 3
                    <span class="plant-tag" style="display:none; background:#17a2b8; color:#fff; font-size:10px; padding:1px 7px; border-radius:10px;">â–¶ ê¸ˆë²ˆ í’ˆì˜ ë°˜ì˜</span>
                </div>
                <table class="styled-table" style="margin-bottom:2px;">
                    <thead>
                        <tr>
                            <th>êµ¬ë¶„ (Div.)</th>
                            <th>ë…„ ê³„íš (Plan)</th>
                            <th>ë…„ ëˆ„ì  (Acum.)</th>
                            <th>ê¸ˆë²ˆ í’ˆì˜ (Esta Sol.)</th>
                            <th>ì”ì—¬ ì˜ˆì‚° (Saldo)</th>
                            <th>ì§‘í–‰ë¥  (%)</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr style="text-align: center;">
                            <td><strong>Total</strong></td>
                            <td id="p3-year-plan">-</td>
                            <td id="p3-year-used">-</td>
                            <td id="p3-this-req" style="font-weight:bold; color:blue;">-</td>
                            <td id="p3-bal" style="font-weight:bold;">-</td>
                            <td style="width:130px;">
                                <div id="p3-rate-text">-</div>
                                <div class="bar-bg">
                                    <div id="p3-bar" class="bar-fill"></div>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
                <table class="styled-table budget-month-table">
                    <thead>
                        <tr>
                            <th style="width:50px;">P3</th>
                            <th>1ì›”</th>
                            <th>2ì›”</th>
                            <th>3ì›”</th>
                            <th>4ì›”</th>
                            <th>5ì›”</th>
                            <th>6ì›”</th>
                            <th>7ì›”</th>
                            <th>8ì›”</th>
                            <th>9ì›”</th>
                            <th>10ì›”</th>
                            <th>11ì›”</th>
                            <th>12ì›”</th>
                        </tr>
                    </thead>
                    <tbody id="out-month-p3"></tbody>
                </table>
            </div>

            <div id="sec-schedule">
                <div class="section-title">6. ìˆ˜ë¦¬ ì¼ì • <span class="section-sub">Calendario de ReparaciÃ³n</span></div>
                <div style="text-align:right; font-size:10px; margin-bottom:5px;">
                    <span style="color:#2980b9; font-weight:bold;">ë²”ë¡€: â— ì‹œì‘(Start) â”â”â–¶ ì§„í–‰/ì™„ë£Œ(Process/End)</span>
                </div>
                <div style="overflow-x:auto;">
                    <table class="sch-table" id="schedule-table-view"></table>
                </div>
            </div>

        </div>
    </div>

    <script>
        // ==========================================
        // [ì¤‘ìš”] ì—¬ê¸°ì— ë°°í¬í•œ êµ¬ê¸€ ì›¹ ì•± URLì„ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”
        const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbw-UgoVHWs2X9RLadsvVqqoVNpeU8ciwdHxKO6jauVALKqfBm5Zd9qDeoEzmV8BhsZd/exec";
        // ==========================================

        let subTotalMXN = 0; let subTotalKRW = 0;

        // --- Cloud Functions ---

        // 1. ì €ì¥í•˜ê¸° (ë‚ ì§œ, ì œëª© ë“± ë©”íƒ€ë°ì´í„° í¬í•¨)
        async function saveToCloud() {
            if (APPS_SCRIPT_URL.includes("ì—¬ê¸°ì—")) { alert("ì½”ë“œë¥¼ ì—´ì–´ APPS_SCRIPT_URLì„ ì„¤ì •í•´ì£¼ì„¸ìš”!"); return; }

            const data = collectData();
            const docName = (data.docName || '').trim().replace(/[\\/:*?"<>|]/g, '_');
            const defaultName = docName ? `${docName}_${data.date}` : `Report_${data.date}`;
            let saveName = prompt('í´ë¼ìš°ë“œì— ì €ì¥í•  ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.', defaultName);
            if (saveName === null) return; // ì·¨ì†Œ
            saveName = saveName.trim() || defaultName;
            data.docName = saveName; // ì €ì¥ ì´ë¦„ì„ docNameì— ë°˜ì˜

            const btn = event.target; const orgTxt = btn.innerText;
            btn.innerText = "ì €ì¥ ì¤‘..."; btn.disabled = true;

            try {
                await fetch(APPS_SCRIPT_URL, {
                    method: "POST",
                    mode: "no-cors",
                    headers: { "Content-Type": "text/plain" },
                    body: JSON.stringify(data)
                });
                showToast(`â˜ï¸ "${saveName}" ì €ì¥ ì™„ë£Œ!`);
            } catch (error) {
                alert("ì˜¤ë¥˜: " + error.message);
            } finally {
                btn.innerText = orgTxt; btn.disabled = false;
            }
        }

        // 2. ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° (íŒì—… ì—´ê¸°)
        async function loadFromCloud() {
            if (APPS_SCRIPT_URL.includes("ì—¬ê¸°ì—")) { alert("ì½”ë“œë¥¼ ì—´ì–´ APPS_SCRIPT_URLì„ ì„¤ì •í•´ì£¼ì„¸ìš”!"); return; }

            const modal = document.getElementById('cloudModal');
            const listContainer = document.getElementById('cloudFileList');

            modal.style.display = 'flex';
            listContainer.innerHTML = '<div style="text-align:center; padding:20px; color:#aaa;">â˜ï¸ ëª©ë¡ ë¡œë”© ì¤‘...</div>';

            try {
                const response = await fetch(APPS_SCRIPT_URL + "?type=list");
                const result = await response.json();

                listContainer.innerHTML = "";

                if (!result.list || result.list.length === 0) {
                    listContainer.innerHTML = '<div style="text-align:center; padding:20px;">ì €ì¥ëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                    return;
                }

                result.list.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'file-item';
                    div.onclick = () => loadSpecificCloudData(item.row);

                    div.innerHTML = `
                    <div class="file-info">
                        <div class="f-title">${item.docName || '(ì œëª© ì—†ìŒ)'}</div>
                        <div class="f-meta">ğŸ“… ${item.date} | ğŸ‘¤ ${item.dept || '-'}</div>
                    </div>
                    <button class="f-btn">ë¶ˆëŸ¬ì˜¤ê¸°</button>
                `;
                    listContainer.appendChild(div);
                });

            } catch (error) {
                listContainer.innerHTML = `<div style="text-align:center; color:#ff6b6b;">ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨<br>${error.message}</div>`;
            }
        }

        // 3. íŠ¹ì • ë°ì´í„° ë¡œë“œ
        async function loadSpecificCloudData(rowIndex) {
            if (!confirm("ì„ íƒí•œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì‹œê² ìŠµë‹ˆê¹Œ?\n(í˜„ì¬ ì‘ì„± ì¤‘ì¸ ë‚´ìš©ì€ ì‚¬ë¼ì§‘ë‹ˆë‹¤)")) return;

            closeCloudModal();
            showToast("â˜ï¸ ë°ì´í„° ë‹¤ìš´ë¡œë“œ ì¤‘...");

            try {
                const response = await fetch(APPS_SCRIPT_URL + `?type=load&row=${rowIndex}`);
                const data = await response.json();
                applyDataToForm(data);
                showToast("â˜ï¸ ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ!");
            } catch (error) {
                alert("ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: " + error.message);
            }
        }

        function closeCloudModal() {
            document.getElementById('cloudModal').style.display = 'none';
        }

        function showToast(msg) {
            const t = document.getElementById('cloudToast');
            t.innerText = msg; t.style.display = 'block';
            setTimeout(() => { t.style.display = 'none'; }, 2000);
        }

        // --- Logic ---

        window.onload = function () {
            document.getElementById('in-date').valueAsDate = new Date();
            initForm();
            initResizer();
        };

        function toggleSection(id, isChecked) {
            const el = document.getElementById(id);
            if (el) el.style.display = isChecked ? 'block' : 'none';
        }

        function fmt(num, currency) {
            if (isNaN(num)) return "0";
            if (currency === 'KRW') {
                return Math.round(num).toLocaleString('ko-KR');
            } else {
                return num.toLocaleString('es-MX', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            }
        }

        function initResizer() {
            const resizer = document.getElementById('dragMe');
            const leftSide = document.getElementById('inputPanel');
            let x = 0; let w = 0;
            const mouseDownHandler = function (e) {
                x = e.clientX;
                const styles = window.getComputedStyle(leftSide);
                w = parseInt(styles.width, 10);
                resizer.classList.add('resizing');
                document.body.style.cursor = 'col-resize';
                document.body.style.userSelect = 'none';
                document.addEventListener('mousemove', mouseMoveHandler);
                document.addEventListener('mouseup', mouseUpHandler);
            };
            const mouseMoveHandler = function (e) { const dx = e.clientX - x; leftSide.style.width = `${w + dx}px`; };
            const mouseUpHandler = function () {
                resizer.classList.remove('resizing');
                document.body.style.removeProperty('cursor');
                document.body.style.removeProperty('user-select');
                document.removeEventListener('mousemove', mouseMoveHandler);
                document.removeEventListener('mouseup', mouseUpHandler);
            };

            resizer.addEventListener('mousedown', mouseDownHandler);
        }

        function toggleSidebar() {
            document.body.classList.toggle('full-screen');
            const btn = document.getElementById('btn-toggle-sidebar');

            if (document.body.classList.contains('full-screen')) {
                btn.innerText = "â–¶";
                btn.title = "Show Sidebar";
            } else {
                btn.innerText = "â—€";
                btn.title = "Hide Sidebar";
            }
        }

        function initForm() {
            addIssueRow();
            addCostRow('MXN'); addCostRow('KRW');
            addCompareRow('MXN'); addCompareRow('KRW');
            addHistoryRow();
            createBudgetInputs('p1'); createBudgetInputs('p3');
            addScheduleRow();
            updateView();
        }

        function captureImage() {
            const target = document.getElementById('capture-target');
            const originalOverflow = target.style.overflow;
            target.style.overflow = "visible";

            html2canvas(target, {
                scale: 2,
                useCORS: true,
                scrollY: -window.scrollY,
                windowWidth: document.documentElement.offsetWidth,
                height: target.scrollHeight + 50
            }).then(canvas => {
                target.style.overflow = originalOverflow;
                const link = document.createElement('a');
                const dateStr = document.getElementById('in-date').value;
                link.download = `Repair_Report_${dateStr}.jpg`;
                link.href = canvas.toDataURL("image/jpeg", 0.85);
                link.click();
            });
        }

        function compressImage(file, callback) {
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function (e) {
                const img = new Image();
                img.onload = function () {
                    const MAX_WIDTH = 1200;
                    const MAX_HEIGHT = 1200;
                    let width = img.width;
                    let height = img.height;
                    if (width > height) {
                        if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; }
                    } else {
                        if (height > MAX_HEIGHT) { width *= MAX_HEIGHT / height; height = MAX_HEIGHT; }
                    }
                    const canvas = document.createElement('canvas');
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
                    callback(dataUrl);
                }
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function addOverviewImgInput() {
            const container = document.getElementById('overview-img-list');
            const div = document.createElement('div');
            div.className = 'overview-img-row';
            div.style.marginBottom = "5px";
            div.style.display = "flex";
            div.style.alignItems = "center";

            div.innerHTML = `
            <input type="file" accept="image/*" onchange="processOverviewImage(this)" style="font-size:0.8rem; width:80%;">
            <input type="hidden" class="ov-img-data">
            <button class="btn-del-mini" onclick="this.parentElement.remove(); updateView()">ì‚­ì œ</button>
        `;
            container.appendChild(div);
        }

        function processOverviewImage(input) {
            if (input.files && input.files[0]) {
                compressImage(input.files[0], (base64) => {
                    input.parentElement.querySelector('.ov-img-data').value = base64;
                    updateView();
                });
            }
        }

        function addIssueRow() {
            const div = document.createElement('div');
            div.style.marginBottom = "5px"; div.style.background = "#2c3034"; div.style.padding = "5px"; div.style.borderRadius = "4px";
            div.innerHTML = `<input type="file" accept="image/*" onchange="handleImage(this)" style="font-size:0.8rem"><input type="text" class="issue-loc" placeholder="ìœ„ì¹˜ (UbicaciÃ³n)" onkeyup="updateView()"><input type="text" class="issue-desc" placeholder="ì„¤ëª… (DescripciÃ³n)" onkeyup="updateView()"><img class="temp-img" style="display:none;" src="">`;
            document.getElementById('issue-inputs').appendChild(div);
        }

        function handleImage(input) {
            if (input.files && input.files[0]) {
                compressImage(input.files[0], (base64) => {
                    input.parentElement.querySelector('.temp-img').src = base64;
                    updateView();
                });
            }
        }

        function addCostRow(type) {
            const div = document.createElement('div');
            div.className = "cost-input-group";
            div.innerHTML = `
            <div class="cost-row">
                <select class="c-plant-${type}" onchange="updateView()" style="width: 75px; padding: 4px; font-weight: bold; font-size: 0.8rem; background: #e9ecef;">
                    <option value="1ê³µì¥">1ê³µì¥</option>
                    <option value="3ê³µì¥">3ê³µì¥</option>
                </select>
                <input type="text" class="c-name-${type}" placeholder="í’ˆëª… (Item)" style="flex:2" onkeyup="updateView()">
                <input type="text" class="c-vendor-${type}" placeholder="ì—…ì²´ëª… (Proveedor)" style="flex:2" onkeyup="updateView()">
            </div>
            <div class="cost-row">
                <input type="text" class="c-stock-${type}" placeholder="ì¬ê³ /ì´ë ¥ (Stock)" style="flex:2" onkeyup="updateView()">
                <input type="number" class="c-qty-${type}" placeholder="ìˆ˜ëŸ‰ (Cant.)" style="flex:1" onchange="updateView()" onkeyup="updateView()">
                <input type="number" class="c-price-${type}" placeholder="ë‹¨ê°€ (Precio)" style="flex:1" onchange="updateView()" onkeyup="updateView()">
            </div>
        `;
            document.getElementById(type === 'MXN' ? 'mxn-inputs' : 'krw-inputs').appendChild(div);
        }

        function addCompareRow(type) {
            const div = document.createElement('div');
            div.className = "compare-input-box";
            div.innerHTML = `
            <div class="compare-row"><input type="text" class="cmp-desc-${type}" placeholder="${type} í’ˆëª©ëª… (Item)" style="width:100%" onkeyup="updateView()"></div>
            <div class="compare-row"><span class="cmp-label" style="color:#28a745;">ì„ ì •</span><input type="text" class="cmp-sel-vendor-${type}" placeholder="ì„ ì • ì—…ì²´ (Prov.)" style="flex:1" onkeyup="updateView()"><input type="number" class="cmp-sel-price-${type}" placeholder="ê¸ˆì•¡ (Monto)" style="flex:1" onkeyup="updateView()"></div>
            <div class="compare-row"><span class="cmp-label" style="color:#dc3545;">ë¹„êµ</span><input type="text" class="cmp-cmp-vendor-${type}" placeholder="ë¹„êµ ì—…ì²´ (Comp.)" style="flex:1" onkeyup="updateView()"><input type="number" class="cmp-cmp-price-${type}" placeholder="ê¸ˆì•¡ (Monto)" style="flex:1" onkeyup="updateView()"></div>
        `;
            document.getElementById(type === 'MXN' ? 'compare-mxn-inputs' : 'compare-krw-inputs').appendChild(div);
        }

        function addHistoryRow() {
            const div = document.createElement('div');
            div.className = "history-input-box";
            div.innerHTML = `
            <div class="history-row">
                <input type="text" class="h-name" placeholder="í’ˆëª©ëª… (Item)" style="flex:2" onkeyup="updateView()">
                <input type="number" class="h-curr" placeholder="ê¸ˆë²ˆ ë‹¨ê°€ (Precio Actual)" style="flex:1" onkeyup="updateView()">
            </div>
            <div class="history-row">
                <input type="date" class="h-date" placeholder="ì´ì „ ì¼ì" style="flex:1" onchange="updateView()">
                <input type="number" class="h-prev" placeholder="ì´ì „ ë‹¨ê°€ (Precio Ant.)" style="flex:1" onkeyup="updateView()">
            </div>
        `;
            document.getElementById('history-inputs').appendChild(div);
        }

        function parseLocalDate(str) {
            if (!str) return null;
            const [y, m, d] = str.split('-').map(Number);
            return new Date(y, m - 1, d);
        }

        function addScheduleRow(data = null) {
            const container = document.getElementById('schedule-inputs');
            const div = document.createElement('div');
            div.className = "schedule-box";
            const s = data ? data.start : '';
            const e = data ? data.end : '';
            const t = data ? data.desc : '';

            div.innerHTML = `
            <div class="row-flex">
                <input type="date" class="s-start" value="${s}" onchange="updateView()" style="flex:1">
                <span style="color:#aaa">~</span>
                <input type="date" class="s-end" value="${e}" onchange="updateView()" style="flex:1">
            </div>
            <div class="row-flex">
                <input type="text" class="s-desc" value="${t}" placeholder="ì‘ì—… ë‚´ìš© (Description)" onkeyup="updateView()" style="flex:2">
                <button class="sch-btn-small copy" onclick="copyRow(this)">C</button>
                <button class="sch-btn-small del" onclick="delRow(this)">D</button>
            </div>
        `;
            container.appendChild(div);
            if (!data) updateView();
        }

        function copyRow(btn) {
            const box = btn.closest('.schedule-box');
            addScheduleRow({
                start: box.querySelector('.s-start').value,
                end: box.querySelector('.s-end').value,
                desc: box.querySelector('.s-desc').value
            });
        }

        function delRow(btn) {
            if (confirm("ì¼ì • í•­ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                btn.closest('.schedule-box').remove();
                updateView();
            }
        }

        function renderSchedule() {
            const table = document.getElementById('schedule-table-view');
            table.innerHTML = "";

            const inputs = document.getElementById('schedule-inputs').children;
            let minDate = null;
            let maxDate = null;
            let validRows = [];

            for (let i = 0; i < inputs.length; i++) {
                const sVal = inputs[i].querySelector('.s-start').value;
                const eVal = inputs[i].querySelector('.s-end').value;
                const desc = inputs[i].querySelector('.s-desc').value;

                if (sVal && eVal && desc) {
                    const sd = parseLocalDate(sVal);
                    const ed = parseLocalDate(eVal);
                    if (sd && ed && sd <= ed) {
                        if (!minDate || sd < minDate) minDate = sd;
                        if (!maxDate || ed > maxDate) maxDate = ed;
                        validRows.push({ start: sd, end: ed, desc: desc });
                    }
                }
            }

            if (validRows.length === 0) {
                table.innerHTML = `<thead><tr><th style="background:#f8f9fa;">ì¼ì • ë°ì´í„° ì—†ìŒ (Sin Datos de Cronograma)</th></tr></thead><tbody><tr><td style="padding:10px; text-align:center; color:#666;">ê¸°ê°„ê³¼ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.</td></tr></tbody>`;
                return;
            }

            let hRow = `<thead><tr><th style="width:30%; background:#f1f3f5;">ì‘ì—… ë‚´ìš© (Activity)</th>`;
            let loopDate = new Date(minDate);
            const dates = [];
            let safety = 0;
            while (loopDate <= maxDate && safety < 100) {
                const m = loopDate.getMonth() + 1;
                const d = loopDate.getDate();
                const dy = loopDate.getDay();
                const bg = (dy === 0 || dy === 6) ? '#eee' : '#fff';
                hRow += `<th style="background:${bg};">${m}/${d}</th>`;
                dates.push(new Date(loopDate));
                loopDate.setDate(loopDate.getDate() + 1);
                safety++;
            }
            hRow += `</tr></thead>`;
            table.innerHTML += hRow;

            const tbody = document.createElement('tbody');
            validRows.forEach(row => {
                let tr = `<tr><td style="text-align:left; padding-left:5px; font-weight:bold; height:24px;">${row.desc}</td>`;
                dates.forEach(colDate => {
                    const cTime = colDate.getTime();
                    const sTime = row.start.getTime();
                    const eTime = row.end.getTime();
                    const dy = colDate.getDay();
                    const bg = (dy === 0 || dy === 6) ? '#f8f9fa' : '#fff';
                    let content = "";
                    if (cTime >= sTime && cTime <= eTime) {
                        if (cTime === sTime && cTime === eTime) {
                            content = `<div class="sch-bar-container"><div class="sch-dot"></div></div>`;
                        } else if (cTime === eTime) {
                            content = `<div class="sch-end-box"><div class="sch-line-end"></div><div class="sch-arrow"></div></div>`;
                        } else {
                            content = `<div class="sch-bar-container"><div class="sch-bar-middle"></div></div>`;
                        }
                    }
                    tr += `<td style="background:${bg}; padding:0;">${content}</td>`;
                });
                tr += `</tr>`;
                tbody.innerHTML += tr;
            });
            table.appendChild(tbody);
        }

        function updateView() {
            const docName = document.getElementById('in-doc-name').value;
            document.getElementById('out-title').innerText = docName || "ì„¤ë¹„ ìˆ˜ë¦¬ í’ˆì˜ì„œ";
            document.getElementById('out-subtitle').innerText = "Repair Request Form & Cost Analysis";

            document.getElementById('out-date').innerText = document.getElementById('in-date').value;
            document.getElementById('out-category').innerText = document.getElementById('in-category').value;
            document.getElementById('out-dept').innerText = document.getElementById('in-dept').value;
            const rate = parseFloat(document.getElementById('in-rate').value) || 1;
            document.getElementById('out-rate').innerText = rate.toLocaleString();

            document.getElementById('out-overview-text').innerText = document.getElementById('in-overview').value;

            const ovGrid = document.getElementById('out-overview-grid');
            ovGrid.innerHTML = "";
            const ovInputs = document.querySelectorAll('.ov-img-data');
            ovInputs.forEach(input => {
                const src = input.value;
                if (src && src.startsWith('data:')) {
                    const img = document.createElement('img');
                    img.src = src;
                    img.className = 'overview-img-item';
                    ovGrid.appendChild(img);
                }
            });

            const issueBody = document.getElementById('out-issue-body'); issueBody.innerHTML = "";
            const issues = document.getElementById('issue-inputs').children;
            for (let i = 0; i < issues.length; i++) {
                const imgSrc = issues[i].querySelector('.temp-img').src;
                const loc = issues[i].querySelector('.issue-loc').value;
                const desc = issues[i].querySelector('.issue-desc').value;
                if (!loc && !desc && (!imgSrc || imgSrc === window.location.href)) continue;
                issueBody.innerHTML += `<tr class="photo-row"><td>${i + 1}</td><td>${imgSrc ? `<img src="${imgSrc}" class="photo-img">` : '<span style="color:#ccc">No Photo</span>'}</td><td style="text-align:left; padding:5px;"><strong>[Location]</strong> ${loc}<br><strong>[Detail]</strong> ${desc}</td></tr>`;
            }

            subTotalMXN = 0;
            subTotalKRW = 0;
            let grandTotalP1 = 0;
            let grandTotalP3 = 0;

            const renderCost = (type) => {
                let html = "";
                let sub = 0;
                const plants = document.querySelectorAll(`.c-plant-${type}`);
                const names = document.querySelectorAll(`.c-name-${type}`);
                const vendors = document.querySelectorAll(`.c-vendor-${type}`);
                const stocks = document.querySelectorAll(`.c-stock-${type}`);
                const qtys = document.querySelectorAll(`.c-qty-${type}`);
                const prices = document.querySelectorAll(`.c-price-${type}`);
                
                for (let i = 0; i < names.length; i++) {
                    if (!names[i].value) continue;
                    const q = parseFloat(qtys[i].value) || 0; 
                    const p = parseFloat(prices[i].value) || 0;
                    const total = q * p;
                    sub += total;

                    const plantVal = plants[i].value;
                    const plantBadge = plantVal === '1ê³µì¥' ? '<span style="color:#28a745; font-weight:bold; font-size:9px;">[1ê³µì¥]</span>' : '<span style="color:#17a2b8; font-weight:bold; font-size:9px;">[3ê³µì¥]</span>';

                    // ê° ê³µì¥ë³„ ì´ì•¡(MXN ê¸°ì¤€) ê³„ì‚°
                    if (type === 'MXN') {
                        if (plantVal === '1ê³µì¥') grandTotalP1 += total;
                        else grandTotalP3 += total;
                    } else {
                        if (plantVal === '1ê³µì¥') grandTotalP1 += (total / rate);
                        else grandTotalP3 += (total / rate);
                    }

                    html += `<tr>
                    <td>${plantBadge} ${names[i].value}</td>
                    <td>${vendors[i].value}</td>
                    <td style="color:#666;">${stocks[i].value}</td>
                    <td style="text-align:center">${q}</td>
                    <td style="text-align:center">EA</td>
                    <td style="text-align:right">${fmt(p, type)}</td>
                    <td style="text-align:right">${fmt(total, type)}</td>
                </tr>`;
                }
                return { html, sub };
            };

            const mxnData = renderCost('MXN');
            document.getElementById('out-mxn-body').innerHTML = mxnData.html;
            subTotalMXN = mxnData.sub;
            document.getElementById('out-total-mxn').innerText = fmt(subTotalMXN, 'MXN');

            const krwData = renderCost('KRW');
            document.getElementById('out-krw-body').innerHTML = krwData.html;
            subTotalKRW = krwData.sub;
            document.getElementById('out-total-krw').innerText = fmt(subTotalKRW, 'KRW');

            const grandTotal = subTotalMXN + (subTotalKRW / rate);
            document.getElementById('out-grand-total-mxn').innerText = "$ " + fmt(grandTotal, 'MXN');

            renderCompareAll();
            renderHistory();
            
            // ê³µì¥ë³„ ì˜ˆì‚° ê°œë³„ ê³„ì‚°
            calcBudget('p1', grandTotalP1);
            calcBudget('p3', grandTotalP3);

            renderSchedule();
        }

        function renderCompareAll() {
            const body = document.getElementById('out-compare-body');
            body.innerHTML = "";
            const renderType = (type) => {
                const descs = document.querySelectorAll(`.cmp-desc-${type}`);
                const sVendors = document.querySelectorAll(`.cmp-sel-vendor-${type}`);
                const sPrices = document.querySelectorAll(`.cmp-sel-price-${type}`);
                const cVendors = document.querySelectorAll(`.cmp-cmp-vendor-${type}`);
                const cPrices = document.querySelectorAll(`.cmp-cmp-price-${type}`);
                for (let i = 0; i < descs.length; i++) {
                    if (!descs[i].value && !sVendors[i].value) continue;
                    const sP = parseFloat(sPrices[i].value) || 0; const cP = parseFloat(cPrices[i].value) || 0;
                    const diff = cP - sP;
                    const cls = diff >= 0 ? 'diff-plus' : 'diff-minus';
                    body.innerHTML += `<tr><td>${descs[i].value} <span style="font-size:9px;color:#888">(${type})</span></td>
                    <td class="compare-sel">${sVendors[i].value}</td>
                    <td class="compare-sel" style="text-align:right;">${fmt(sP, type)}</td>
                    <td class="compare-cmp">${cVendors[i].value}</td>
                    <td class="compare-cmp" style="text-align:right;">${fmt(cP, type)}</td>
                    <td style="text-align:right;" class="${cls}">${fmt(diff, type)}</td></tr>`;
                }
            };
            renderType('MXN'); renderType('KRW');
        }

        function renderHistory() {
            const body = document.getElementById('out-history-body');
            body.innerHTML = "";
            const inputs = document.getElementById('history-inputs').children;
            for (let r of inputs) {
                const name = r.querySelector('.h-name').value;
                const curr = parseFloat(r.querySelector('.h-curr').value) || 0;
                const prev = parseFloat(r.querySelector('.h-prev').value) || 0;
                const date = r.querySelector('.h-date').value;
                if (!name && !curr && !prev) continue;

                let diffHtml = "-";
                if (prev > 0 && curr > 0) {
                    const diff = curr - prev;
                    if (diff > 0) diffHtml = `<span class="price-up">â–² ${fmt(diff, 'MXN')}</span> (ì¸ìƒ)`;
                    else if (diff < 0) diffHtml = `<span class="price-down">â–¼ ${fmt(Math.abs(diff), 'MXN')}</span> (ì¸í•˜)`;
                    else diffHtml = `<span class="price-same">- ë³€ë™ì—†ìŒ</span>`;
                }

                body.innerHTML += `<tr>
                <td>${name}</td>
                <td style="text-align:right; font-weight:bold;">${fmt(curr, 'MXN')}</td>
                <td style="text-align:right; color:#666;">${fmt(prev, 'MXN')}</td>
                <td style="text-align:center;">${date}</td>
                <td style="text-align:center;">${diffHtml}</td>
            </tr>`;
            }
        }

        function createBudgetInputs(suffix) {
            const pC = document.getElementById(`budget-plan-${suffix}`);
            const aC = document.getElementById(`budget-act-${suffix}`);
            pC.innerHTML = ""; aC.innerHTML = "";
            for (let i = 1; i <= 12; i++) {
                pC.innerHTML += `<input type="number" class="b-plan-${suffix}" placeholder="${i}ì›” (Mes)" onkeyup="updateView()">`;
                aC.innerHTML += `<input type="number" class="b-act-${suffix}" placeholder="${i}ì›” (Mes)" onkeyup="updateView()">`;
            }
        }
        
        function switchBudgetTab(plant) {
            document.querySelectorAll('.budget-tab').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.budget-container').forEach(c => c.classList.remove('active'));
            if (plant === 'P1') {
                document.querySelectorAll('.budget-tab')[0].classList.add('active');
                document.getElementById('budget-input-p1').classList.add('active');
            } else {
                document.querySelectorAll('.budget-tab')[1].classList.add('active');
                document.getElementById('budget-input-p3').classList.add('active');
            }
        }
        
        function calcBudget(suffix, reqCost) {
            let tp = 0, tu = 0;
            const pp = document.querySelectorAll(`.b-plan-${suffix}`);
            const aa = document.querySelectorAll(`.b-act-${suffix}`);
            let mh = `<tr><th style="background:#f8f9fa;">Plan</th>`;
            let ah = `<tr><th style="background:#f8f9fa;">Act</th>`;
            for (let i = 0; i < 12; i++) {
                const p = parseFloat(pp[i].value) || 0;
                const a = parseFloat(aa[i].value) || 0;
                tp += p; tu += a;
                mh += `<td>${p ? fmt(p, 'MXN') : '-'}</td>`;
                ah += `<td>${a ? fmt(a, 'MXN') : '-'}</td>`;
            }
            mh += "</tr>"; ah += "</tr>";
            document.getElementById(`out-month-${suffix}`).innerHTML = mh + ah;
            
            const bal = tp - tu - reqCost;
            const rate = tp > 0 ? ((tu + reqCost) / tp) * 100 : 0;

            document.getElementById(`${suffix}-year-plan`).innerText = fmt(tp, 'MXN');
            document.getElementById(`${suffix}-year-used`).innerText = fmt(tu, 'MXN');
            document.getElementById(`${suffix}-this-req`).innerText = reqCost > 0 ? fmt(reqCost, 'MXN') : '-';
            document.getElementById(`${suffix}-bal`).innerText = fmt(bal, 'MXN');
            document.getElementById(`${suffix}-rate-text`).innerText = rate.toFixed(1) + "%";

            const bar = document.getElementById(`${suffix}-bar`);
            bar.style.width = (rate > 100 ? 100 : rate) + "%";
            bar.className = 'bar-fill ' + (rate > 100 ? 'danger' : (rate > 80 ? 'warning' : ''));

            // ë¹„ìš©ì´ 0ë³´ë‹¤ í¬ë©´ ëŒ€ìƒ ê³µì¥ìœ¼ë¡œ íŒë‹¨í•˜ì—¬ í—¤ë” ê°•ì¡°
            const labelId = `budget-section-label-${suffix}`;
            const el = document.getElementById(labelId);
            if (el) {
                if (reqCost > 0) {
                    el.style.background = (suffix === 'p1') ? 'rgba(40,167,69,0.12)' : 'rgba(23,162,184,0.12)';
                    el.style.borderRadius = '5px';
                    el.style.padding = '4px 8px';
                    el.querySelector('.plant-tag').style.display = 'inline-block';
                } else {
                    el.style.background = 'transparent';
                    el.style.padding = '4px 0';
                    el.querySelector('.plant-tag').style.display = 'none';
                }
            }
        }

        function collectData() {
            const visibility = {
                overview: document.getElementById('chk-overview').checked,
                issue: document.getElementById('chk-issue').checked,
                cost: document.getElementById('chk-cost').checked,
                compare: document.getElementById('chk-compare').checked,
                budget: document.getElementById('chk-budget').checked,
                schedule: document.getElementById('chk-schedule').checked
            };

            return {
                date: document.getElementById('in-date').value,
                dept: document.getElementById('in-dept').value,
                docName: document.getElementById('in-doc-name').value,
                category: document.getElementById('in-category').value,
                rate: document.getElementById('in-rate').value,
                overview: document.getElementById('in-overview').value,
                overviewImages: Array.from(document.querySelectorAll('.ov-img-data')).map(i => i.value),
                issues: getDynamicValues('issue-inputs', ['.issue-loc', '.issue-desc', '.temp-img'], ['loc', 'desc', 'img']),
                costsMXN: getDynamicValues('mxn-inputs', ['.c-plant-MXN', '.c-name-MXN', '.c-vendor-MXN', '.c-stock-MXN', '.c-qty-MXN', '.c-price-MXN'], ['plant', 'name', 'vendor', 'stock', 'qty', 'price']),
                costsKRW: getDynamicValues('krw-inputs', ['.c-plant-KRW', '.c-name-KRW', '.c-vendor-KRW', '.c-stock-KRW', '.c-qty-KRW', '.c-price-KRW'], ['plant', 'name', 'vendor', 'stock', 'qty', 'price']),
                compMXN: getDynamicValues('compare-mxn-inputs', ['.cmp-desc-MXN', '.cmp-sel-vendor-MXN', '.cmp-sel-price-MXN', '.cmp-cmp-vendor-MXN', '.cmp-cmp-price-MXN'], ['desc', 'selVendor', 'selPrice', 'cmpVendor', 'cmpPrice']),
                compKRW: getDynamicValues('compare-krw-inputs', ['.cmp-desc-KRW', '.cmp-sel-vendor-KRW', '.cmp-sel-price-KRW', '.cmp-cmp-vendor-KRW', '.cmp-cmp-price-KRW'], ['desc', 'selVendor', 'selPrice', 'cmpVendor', 'cmpPrice']),
                history: getDynamicValues('history-inputs', ['.h-name', '.h-curr', '.h-prev', '.h-date'], ['name', 'curr', 'prev', 'date']),
                budgetP1: { plan: Array.from(document.querySelectorAll('.b-plan-p1')).map(e => e.value), act: Array.from(document.querySelectorAll('.b-act-p1')).map(e => e.value) },
                budgetP3: { plan: Array.from(document.querySelectorAll('.b-plan-p3')).map(e => e.value), act: Array.from(document.querySelectorAll('.b-act-p3')).map(e => e.value) },
                schedule: getDynamicValues('schedule-inputs', ['.s-start', '.s-end', '.s-desc'], ['start', 'end', 'desc']),
                visibility: visibility
            };
        }

        function applyDataToForm(data) {
            document.getElementById('in-date').value = data.date;
            document.getElementById('in-dept').value = data.dept;
            document.getElementById('in-doc-name').value = data.docName;
            document.getElementById('in-category').value = data.category || 'ìˆ˜ì„  (ReparaciÃ³n)';
            document.getElementById('in-rate').value = data.rate;
            document.getElementById('in-overview').value = data.overview;

            if (data.visibility) {
                document.getElementById('chk-overview').checked = data.visibility.overview; toggleSection('sec-overview', data.visibility.overview);
                document.getElementById('chk-issue').checked = data.visibility.issue; toggleSection('sec-issue', data.visibility.issue);
                document.getElementById('chk-cost').checked = data.visibility.cost; toggleSection('sec-cost', data.visibility.cost);
                document.getElementById('chk-compare').checked = data.visibility.compare; toggleSection('sec-compare', data.visibility.compare);
                document.getElementById('chk-budget').checked = data.visibility.budget; toggleSection('sec-budget', data.visibility.budget);
                document.getElementById('chk-schedule').checked = data.visibility.schedule; toggleSection('sec-schedule', data.visibility.schedule);
            }

            document.getElementById('overview-img-list').innerHTML = "";
            if (data.overviewImages) {
                data.overviewImages.forEach(src => {
                    if (!src) return;
                    addOverviewImgInput();
                    const last = document.getElementById('overview-img-list').lastElementChild;
                    last.querySelector('.ov-img-data').value = src;
                });
            }

            restoreDynamicRows('issue-inputs', data.issues, addIssueRow, ['.issue-loc', '.issue-desc', '.temp-img'], ['loc', 'desc', 'img']);
            restoreDynamicRows('mxn-inputs', data.costsMXN, () => addCostRow('MXN'), ['.c-plant-MXN', '.c-name-MXN', '.c-vendor-MXN', '.c-stock-MXN', '.c-qty-MXN', '.c-price-MXN'], ['plant', 'name', 'vendor', 'stock', 'qty', 'price']);
            restoreDynamicRows('krw-inputs', data.costsKRW, () => addCostRow('KRW'), ['.c-plant-KRW', '.c-name-KRW', '.c-vendor-KRW', '.c-stock-KRW', '.c-qty-KRW', '.c-price-KRW'], ['plant', 'name', 'vendor', 'stock', 'qty', 'price']);
            restoreDynamicRows('compare-mxn-inputs', data.compMXN, () => addCompareRow('MXN'), ['.cmp-desc-MXN', '.cmp-sel-vendor-MXN', '.cmp-sel-price-MXN', '.cmp-cmp-vendor-MXN', '.cmp-cmp-price-MXN'], ['desc', 'selVendor', 'selPrice', 'cmpVendor', 'cmpPrice']);
            restoreDynamicRows('compare-krw-inputs', data.compKRW, () => addCompareRow('KRW'), ['.cmp-desc-KRW', '.cmp-sel-vendor-KRW', '.cmp-sel-price-KRW', '.cmp-cmp-vendor-KRW', '.cmp-cmp-price-KRW'], ['desc', 'selVendor', 'selPrice', 'cmpVendor', 'cmpPrice']);
            restoreDynamicRows('history-inputs', data.history, addHistoryRow, ['.h-name', '.h-curr', '.h-prev', '.h-date'], ['name', 'curr', 'prev', 'date']);

            if (data.budgetP1) { const pp = document.querySelectorAll('.b-plan-p1'); const aa = document.querySelectorAll('.b-act-p1'); data.budgetP1.plan.forEach((v, i) => pp[i].value = v); data.budgetP1.act.forEach((v, i) => aa[i].value = v); }
            if (data.budgetP3) { const pp = document.querySelectorAll('.b-plan-p3'); const aa = document.querySelectorAll('.b-act-p3'); data.budgetP3.plan.forEach((v, i) => pp[i].value = v); data.budgetP3.act.forEach((v, i) => aa[i].value = v); }

            restoreDynamicRows('schedule-inputs', data.schedule, () => addScheduleRow(), ['.s-start', '.s-end', '.s-desc'], ['start', 'end', 'desc']);
            updateView();
        }

        function resetForm() {
            if (confirm("ëª¨ë“  ë‚´ìš©ì„ ì§€ìš°ê³  ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (Reset all data?)")) {
                location.reload();
            }
        }

        function saveData() {
            const data = collectData();
            const blob = new Blob([JSON.stringify(data)], { type: "application/json" });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `Report_${data.date}.json`;
            link.click();
        }

        function loadDataFile(input) {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const data = JSON.parse(e.target.result);
                    applyDataToForm(data);
                } catch (e) { console.error(e); alert("Load Error"); }
            }
            reader.readAsText(file);
        }

        function getDynamicValues(id, sels, keys) {
            const res = [];
            for (let r of document.getElementById(id).children) {
                let obj = {};
                sels.forEach((s, i) => { const el = r.querySelector(s); if (el.tagName === 'IMG') obj[keys[i]] = el.src; else obj[keys[i]] = el.value; });
                res.push(obj);
            }
            return res;
        }
        
        function restoreDynamicRows(id, data, fn, sels, keys) {
            document.getElementById(id).innerHTML = "";
            if (!data) { fn(); return; }
            data.forEach(d => { 
                fn(); 
                const r = document.getElementById(id).lastElementChild; 
                sels.forEach((s, i) => { 
                    const el = r.querySelector(s); 
                    if (el.tagName === 'IMG') {
                        el.src = d[keys[i]]; 
                    } else if (el.tagName === 'SELECT') {
                        el.value = d[keys[i]] || '1ê³µì¥';
                    } else {
                        el.value = d[keys[i]] || '';
                    }
                }); 
            });
        }
    </script>

</body>

</html>