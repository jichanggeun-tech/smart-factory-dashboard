<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÎåÄÏó¨ÏûêÏÇ∞</title>
    <!-- Dependencies -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/3.3.4/vue.global.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dexie/3.2.4/dexie.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        :root {
            --bg-body: #111827;
            --bg-nav: #1f2937;
            --bg-card: #2d3748;
            --bg-input: #374151;
            --text-main: #f9fafb;
            --text-muted: #9ca3af;
            --accent: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --blue: #3b82f6;
            --border: #4b5563;
        }

        body {
            background-color: var(--bg-body);
            color: var(--text-main);
            font-family: 'Segoe UI', sans-serif;
            margin: 0;
            overflow: hidden;
            display: flex;
            height: 100vh;
        }

        /* Sidebar */
        aside {
            width: 260px;
            background: var(--bg-nav);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            padding: 15px;
        }

        .brand {
            font-size: 20px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 30px;
            color: var(--blue);
        }

        .nav-item {
            padding: 12px;
            margin-bottom: 5px;
            border-radius: 8px;
            cursor: pointer;
            transition: 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text-muted);
        }

        .nav-item:hover,
        .nav-item.active {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        .project-list {
            flex: 1;
            overflow-y: auto;
            margin-top: 20px;
        }

        .project-item {
            padding: 8px 12px;
            cursor: pointer;
            border-radius: 6px;
            margin-bottom: 2px;
            font-size: 14px;
            color: var(--text-muted);
            display: flex;
            justify-content: space-between;
        }

        .project-item:hover,
        .project-item.active {
            background: var(--bg-input);
            color: white;
        }

        /* Sidebar Controls (Home + Toggle wrapper) */
        .sidebar-controls {
            display: flex;
            align-items: center;
            position: fixed;
            top: 15px;
            left: 15px !important;
            z-index: 1001;
            transition: none;
        }

        .home-btn {
            background: #334155;
            color: #e2e8f0;
            border: 1px solid #475569;
            border-radius: 20px 0 0 20px;
            width: 70px;
            height: 36px;
            text-decoration: none;
            font-size: 12px;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            padding: 0;
            box-sizing: border-box;
        }

        .home-btn:hover {
            background: #4285F4;
            color: #fff;
        }

        .btn-toggle-sidebar {
            width: 70px;
            height: 36px;
            background: #1e293b;
            border: 1px solid #334155;
            border-left: none;
            border-radius: 0 20px 20px 0;
            color: #94a3b8;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            padding: 0;
            box-sizing: border-box;
        }

        .btn-toggle-sidebar:hover {
            color: white;
            background: #334155;
        }

        /* Collapsed State */
        body.sidebar-collapsed aside {
            margin-left: -260px;
        }

        body.sidebar-collapsed .sidebar-controls {
            left: 0;
        }

        /* Main Content */
        main {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        header {
            height: 60px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            background: var(--bg-body);
        }

        .search-bar {
            background: var(--bg-input);
            border-radius: 6px;
            padding: 8px 15px;
            display: flex;
            align-items: center;
            width: 300px;
        }

        .search-bar input {
            background: transparent;
            border: none;
            color: white;
            margin-left: 10px;
            width: 100%;
            outline: none;
        }

        .actions {
            display: flex;
            gap: 10px;
        }

        .btn {
            background: var(--bg-input);
            border: 1px solid var(--border);
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            transition: 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn:hover {
            background: #4b5563;
        }

        .btn.primary {
            background: var(--blue);
            color: white;
            border: none;
            font-weight: bold;
        }

        .btn.danger {
            background: rgba(239, 68, 68, 0.2);
            color: var(--danger);
            border-color: var(--danger);
        }

        /* Table */
        .table-container {
            flex: 1;
            overflow: auto;
            padding: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        th {
            text-align: left;
            padding: 12px;
            border-bottom: 2px solid var(--border);
            color: var(--text-muted);
            position: sticky;
            top: 0;
            background: var(--bg-body);
            z-index: 10;
        }

        td {
            padding: 10px 12px;
            border-bottom: 1px solid var(--border);
            vertical-align: middle;
        }

        tr:hover {
            background: rgba(255, 255, 255, 0.02);
        }

        .status-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            display: inline-block;
        }

        .status-use {
            background: rgba(16, 185, 129, 0.2);
            color: var(--accent);
        }

        .status-not-use {
            background: rgba(245, 158, 11, 0.2);
            color: var(--warning);
        }

        .status-returned {
            background: rgba(156, 163, 175, 0.2);
            color: var(--text-muted);
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal {
            background: var(--bg-card);
            border-radius: 12px;
            width: 700px;
            max-width: 90vw;
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            max-height: 90vh;
        }

        .modal-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border);
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-body {
            padding: 20px;
            overflow-y: auto;
        }

        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .input,
        select,
        textarea {
            width: 100%;
            background: var(--bg-input);
            border: 1px solid var(--border);
            color: white;
            padding: 8px;
            border-radius: 6px;
            margin-top: 4px;
            box-sizing: border-box;
            font-family: inherit;
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        /* Shared Report Styles */
        .report-style-base {
            background: white !important;
            color: black !important;
        }

        /* Report Mode (Screen) */
        .report-mode aside,
        .report-mode header,
        .report-mode .no-print {
            display: none !important;
        }

        .report-mode body {
            height: auto;
            display: block;
            background: white !important;
            color: black !important;
            overflow: visible !important;
        }

        .report-mode main {
            overflow: visible !important;
        }

        .report-mode .table-container {
            overflow: visible !important;
            padding: 0 !important;
        }

        .report-mode table {
            font-size: 11px;
            width: 100%;
            border-collapse: collapse;
            color: black !important;
        }

        .report-mode th,
        .report-mode td {
            border: 1px solid #000 !important;
            padding: 4px;
            color: black !important;
            background: white !important;
        }

        .report-mode th {
            background: #eee !important;
        }

        .report-mode .status-badge {
            border: 1px solid #000;
            color: black !important;
            background: transparent !important;
            font-weight: bold;
        }

        /* Print Override */
        /* Print Override */
        @media print {

            aside,
            header,
            .no-print,
            .btn,
            .modal-footer,
            .actions {
                display: none !important;
            }

            body,
            .modal {
                background: white;
                color: black;
                width: 100%;
                height: auto;
                overflow: visible;
                position: static;
            }

            .modal-overlay {
                position: static;
                background: white;
                display: block;
            }

            .modal {
                border: none;
                box-shadow: none;
                max-width: 100%;
                width: 100%;
            }

            th,
            td {
                border: 1px solid #000 !important;
                color: black !important;
            }

            th {
                background: #eee !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            .status-badge {
                border: 1px solid #000;
                color: black !important;
                background: transparent !important;
                font-weight: bold;
            }

            /* Hide Main Content if Modal is Open */
            main {
                display: none !important;
            }

            /* But if report modal is NOT open, we might want to print main table? 
               Actually, let's just assume we only print from report modal for now for consistency,
               OR we check if modal is open. 
               The .modal-overlay display:block handles showing the modal.
            */
        }

        /* High Contrast Symbols (Always useful, but critical in report) */
        .sym-use {
            color: #000 !important;
            font-weight: 900;
        }

        .sym-not {
            color: #000 !important;
            font-weight: 900;
        }

        .sym-ret {
            color: #888 !important;
        }
    </style>
</head>

<body>
    <div id="app" style="width:100%; display:flex;">

        <!-- SIDEBAR -->
        <aside>
            <div class="brand">
            </div>

            <!-- Dashboard Button removed as per simplification, or kept if needed. Let's keep it simple first. -->
            <div class="nav-item" :style="{color: isSyncing ? 'var(--warning)' : 'var(--text-muted)'}">
                <i class="fa-solid" :class="isSyncing ? 'fa-spinner fa-spin' : 'fa-cloud'"></i>
                {{ isSyncing ? 'ÎèôÍ∏∞Ìôî Ï§ë (Sincronizando...)' : 'ÎåÄÍ∏∞ (Listo)' }}
            </div>

            <div
                style="font-size:12px; font-weight:bold; margin-top:20px; margin-bottom:10px; color:#666; display:flex; justify-content:space-between;">
                PROJECTS (ÌîÑÎ°úÏ†ùÌä∏)
                <i class="fa-solid fa-plus" style="cursor:pointer; color:var(--blue);" @click="createProject"></i>
            </div>

            <div class="project-list">
                <div class="project-item" v-for="p in projects" :key="p.id"
                    :class="{active: currentProject && currentProject.id === p.id}" @click="selectProject(p)">
                    <span>{{ p.name }}</span>
                    <i class="fa-solid fa-trash" style="font-size:10px; color:#666;" @click.stop="deleteProject(p)"></i>
                </div>
            </div>

            <div style="margin-top:auto; font-size:11px; text-align:center; color:#444;">
                &copy; Antigravity Systems
            </div>

        </aside>

        <div class="sidebar-controls">
            <a class="home-btn" href="index.html">üè† Home</a>
            <button id="btn-toggle-sidebar" class="btn-toggle-sidebar" onclick="toggleSidebar()">‚óÄ</button>
        </div>



        <!-- MAIN -->
        <main>
            <header>
                <div class="search-bar">
                    <i class="fa-solid fa-search" style="color:#666;"></i>
                    <input v-model="searchQuery" placeholder="Í≤ÄÏÉâ (Search / Buscar)...">
                </div>

                <div class="app-title"
                    style="font-size: 20px; font-weight: bold; color: var(--blue); margin-left: 20px;">
                    <i class="fa-solid fa-boxes-stacked"></i> Rental Asset
                </div>

                <!-- Year Selector for Quarterly Status -->
                <div style="margin-left:20px; display:flex; align-items:center; gap:10px;">
                    <button class="btn" @click="selectedYear--"><i class="fa-solid fa-chevron-left"></i></button>
                    <span style="font-weight:bold; font-size:16px; color:var(--text-main);">{{ selectedYear }}ÎÖÑ</span>
                    <button class="btn" @click="selectedYear++"><i class="fa-solid fa-chevron-right"></i></button>
                </div>

                <div class="actions">
                    <button class="btn" @click="syncFromCloud" title="Download Projects"><i
                            class="fa-solid fa-cloud-arrow-down"></i> Î∂àÎü¨Ïò§Í∏∞ (Cargar)</button>
                    <button class="btn" @click="syncToCloud" title="Upload Current Project"><i
                            class="fa-solid fa-cloud-arrow-up"></i> Ï†ÄÏû• (Guardar)</button>
                    <div style="width:1px; height:20px; background:var(--border); margin:0 5px;"></div>

                    <button class="btn btn-primary" @click="openReport">
                        <i class="fa-solid fa-chart-line"></i> Î¶¨Ìè¨Ìä∏ (Reporte)
                    </button>

                    <button class="btn primary" @click="openAddModal">
                        <i class="fa-solid fa-plus"></i> ÏûêÏÇ∞ Ï∂îÍ∞Ä (Agregar)
                    </button>

                    <button class="btn" @click="showDataModal=true" title="Backup/Restore JSON"><i
                            class="fa-solid fa-database"></i></button>
                </div>
            </header>

            <div class="table-container">
                <table v-if="currentProject">
                    <thead>
                        <tr>
                            <th v-for="c in visibleColumns" :key="c.key"
                                :style="{width: c.width + 'px', cursor: c.sortable ? 'pointer' : 'default'}"
                                @click="c.sortable ? sortTable(c.key) : null">
                                {{ c.label }}
                                <i v-if="sortKey === c.key" class="fa-solid"
                                    :class="sortOrder === 1 ? 'fa-sort-up' : 'fa-sort-down'"></i>
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="p in filteredParts" :key="p.id">
                            <td v-for="c in visibleColumns" :key="c.key"
                                :style="{textAlign: (['status','action','img','q1','q2','q3','q4'].includes(c.key)?'center':'left')}">

                                <template v-if="c.key === 'img'">
                                    <div style="display:flex; gap:2px; justify-content:center;">
                                        <div v-if="p.img1"
                                            :style="`width:30px; height:30px; background-image:url(${p.img1}); background-size:cover; background-position:center; border-radius:4px; border:1px solid #555; cursor:pointer`"
                                            @click="setModalImage(p.img1)"></div>
                                        <div v-if="p.img2"
                                            :style="`width:30px; height:30px; background-image:url(${p.img2}); background-size:cover; background-position:center; border-radius:4px; border:1px solid #555; cursor:pointer`"
                                            @click="setModalImage(p.img2)"></div>
                                        <span v-if="!p.img1 && !p.img2" style="color:#444;">-</span>
                                    </div>
                                </template>

                                <template v-else-if="c.key === 'category'">
                                    <span style="font-weight:bold; color:var(--blue);">{{ p.category }}</span>
                                </template>

                                <template v-else-if="c.key === 'assetCode'">
                                    <span style="font-family:monospace; font-size:1.1em;">{{ p.assetCode }}</span>
                                </template>

                                <template v-else-if="c.key === 'status'">
                                    <span v-if="p.status === 'ÏÇ¨Ïö©Ï§ë'" class="status-badge status-use">ÏÇ¨Ïö©Ï§ë (En Uso)</span>
                                    <span v-else-if="p.status === 'ÎØ∏ÏÇ¨Ïö©'" class="status-badge status-not-use">ÎØ∏ÏÇ¨Ïö© (No
                                        Uso)</span>
                                    <span v-else-if="p.status === 'Î∞òÎÇ©'" class="status-badge status-returned">Î∞òÎÇ©
                                        (Devuelto)</span>
                                    <span v-else class="status-badge">{{ p.status }}</span>
                                </template>

                                <!-- Quarterly Status Symbols -->
                                <template v-else-if="['q1','q2','q3','q4'].includes(c.key)">
                                    <span :class="getQuarterSymbolClass(p, c.key)">
                                        {{ getQuarterSymbol(p, c.key) }}
                                    </span>
                                </template>

                                <template v-else-if="c.key === 'no'">
                                    {{ filteredParts.indexOf(p) + 1 }}
                                </template>

                                <template v-else-if="c.key === 'history'">
                                    <span style="font-size:0.9em; white-space:pre-wrap;">{{ p.history }}</span>
                                </template>

                                <template v-else-if="c.key === 'action'">
                                    <button type="button"
                                        style="background:none; border:none; padding:0; cursor:pointer; color:var(--text-muted);"
                                        @click.stop="() => editPart(p)">
                                        <i class="fa-solid fa-pen"></i>
                                    </button>
                                </template>

                                <template v-else>
                                    {{ p[c.key] }}
                                </template>
                            </td>
                        </tr>
                    </tbody>
                </table>
                <div v-else style="padding:50px; text-align:center; color:var(--text-muted);">
                    <i class="fa-solid fa-folder-open" style="font-size:48px; margin-bottom:20px;"></i>
                    <p>ÏãúÏûëÌïòÎ†§Î©¥ ÌîÑÎ°úÏ†ùÌä∏Î•º ÏÑ†ÌÉùÌïòÍ±∞ÎÇò ÏÉùÏÑ±ÌïòÏÑ∏Ïöî.<br>(Seleccione o cree un proyecto para comenzar.)</p>
                </div>
            </div>
        </main>

        <!-- REPORT MODAL -->
        <div v-if="showReportModal" class="modal-overlay" @click.self="showReportModal=false">
            <div class="modal" id="report-modal"
                style="width:1200px; max-width:98vw; height:90vh; display:flex; flex-direction:column;">
                <div class="modal-header">
                    <div style="display:flex; align-items:center; gap:10px;">
                        <span>üìä ÏûêÏÇ∞ Î∂ÑÍ∏∞Î≥Ñ Î¶¨Ìè¨Ìä∏ (Reporte Trimestral)</span>
                        <span style="font-size:1.2em; color:var(--blue);">{{ selectedYear }}</span>
                    </div>
                    <div class="actions">
                        <button class="btn btn-secondary" @click="captureReport">üì∑ Ï∫°Ï≤ò (Captura)</button>
                        <button class="btn btn-primary" @click="printReport">üñ® PDF Ïù∏ÏáÑ (Imprimir)</button>
                        <i class="fa-solid fa-times" style="cursor:pointer; margin-left:10px;"
                            @click="showReportModal=false"></i>
                    </div>
                </div>
                <div class="modal-body" id="report-print-area"
                    style="background:white; color:black; flex:1; padding:30px;">
                    <h2 style="text-align:center; margin-bottom:5px;">ÏûÑÎåÄ ÏûêÏÇ∞ ÌòÑÌô© Î¶¨Ìè¨Ìä∏ (Reporte de Estado de Activos de
                        Alquiler)</h2>
                    <h4 style="text-align:center; margin-top:0; color:#555;">Project: {{ currentProject?.name }} | Year:
                        {{ selectedYear }}</h4>

                    <table style="width:100%; border-collapse:collapse; border:1px solid #000; font-size:11px;">
                        <thead>
                            <tr style="background:#eee; color:black;">
                                <th style="border:1px solid #000; padding:6px;">No</th>
                                <th style="border:1px solid #000; padding:6px;">Img (ÏÇ¨ÏßÑ)</th>
                                <th style="border:1px solid #000; padding:6px;">Íµ¨Î∂Ñ (Categor√≠a)</th>
                                <th style="border:1px solid #000; padding:6px;">ÏûêÏÇ∞ ÏΩîÎìú (C√≥digo)</th>
                                <th style="border:1px solid #000; padding:6px;">Î™ÖÌåê (Placa)</th>
                                <th style="border:1px solid #000; padding:6px;">ÏÑ§Î™Ö (Descripci√≥n)</th>
                                <th style="border:1px solid #000; padding:6px; text-align:center;">ÏÉÅÌÉú (Estado)</th>

                                <th style="border:1px solid #000; padding:6px; text-align:center; background:#e0f7fa;">
                                    Q1</th>
                                <th style="border:1px solid #000; padding:6px; text-align:center; background:#f3e5f5;">
                                    Q2</th>
                                <th style="border:1px solid #000; padding:6px; text-align:center; background:#fff3e0;">
                                    Q3</th>
                                <th style="border:1px solid #000; padding:6px; text-align:center; background:#f1f8e9;">
                                    Q4</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="(p, idx) in filteredParts" :key="p.id">
                                <td style="border:1px solid #ccc; padding:4px; text-align:center;">{{ idx + 1 }}</td>
                                <td style="border:1px solid #ccc; padding:4px; text-align:center;">
                                    <div v-if="p.img1 || p.img2"
                                        :style="`width:40px; height:40px; background-image:url(${p.img1 || p.img2}); background-size:cover; background-position:center; margin:0 auto; border:1px solid #ddd;`">
                                    </div>
                                    <span v-else style="color:#ccc;">-</span>
                                </td>
                                <td style="border:1px solid #ccc; padding:4px;">{{ p.category }}</td>
                                <td
                                    style="border:1px solid #ccc; padding:4px; font-family:monospace; font-weight:bold;">
                                    {{ p.assetCode }}</td>
                                <td style="border:1px solid #ccc; padding:4px;">{{ p.nameplateCode }}</td>
                                <td style="border:1px solid #ccc; padding:4px;">{{ p.description }}</td>

                                <td style="border:1px solid #ccc; padding:4px; text-align:center;">
                                    <span v-if="p.status === 'ÏÇ¨Ïö©Ï§ë'" style="font-weight:bold; color:green;">In Use</span>
                                    <span v-else-if="p.status === 'ÎØ∏ÏÇ¨Ïö©'" style="font-weight:bold; color:orange;">Not
                                        Use</span>
                                    <span v-else-if="p.status === 'Î∞òÎÇ©'" style="color:#888;">Return</span>
                                    <span v-else>{{ p.status }}</span>
                                </td>

                                <!-- Q1 -->
                                <td style="border:1px solid #ccc; padding:4px; text-align:center; background:#e0f7fa;">
                                    <span :style="{fontWeight:'bold', color: getQuarterColor(p, 'q1')}">{{
                                        getQuarterSymbol(p, 'q1') }}</span>
                                </td>
                                <!-- Q2 -->
                                <td style="border:1px solid #ccc; padding:4px; text-align:center; background:#f3e5f5;">
                                    <span :style="{fontWeight:'bold', color: getQuarterColor(p, 'q2')}">{{
                                        getQuarterSymbol(p, 'q2') }}</span>
                                </td>
                                <!-- Q3 -->
                                <td style="border:1px solid #ccc; padding:4px; text-align:center; background:#fff3e0;">
                                    <span :style="{fontWeight:'bold', color: getQuarterColor(p, 'q3')}">{{
                                        getQuarterSymbol(p, 'q3') }}</span>
                                </td>
                                <!-- Q4 -->
                                <td style="border:1px solid #ccc; padding:4px; text-align:center; background:#f1f8e9;">
                                    <span :style="{fontWeight:'bold', color: getQuarterColor(p, 'q4')}">{{
                                        getQuarterSymbol(p, 'q4') }}</span>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                    <div style="margin-top:20px; font-size:10px; text-align:right;">
                        Generated by Rental Asset Manager | {{ new Date().toLocaleString() }}
                    </div>
                </div>
            </div>
        </div>

        <!-- ADD/EDIT MODAL -->
        <div v-if="showPartModal" class="modal-overlay" @click.self="showPartModal=false">
            <div class="modal" style="width:800px;">
                <div class="modal-header">
                    <span>{{ editingPart.id ? 'ÏàòÏ†ï (Editar)' : 'Ï∂îÍ∞Ä (Agregar)' }} Asset</span>
                    <i class="fa-solid fa-times" style="cursor:pointer;" @click="showPartModal=false"></i>
                </div>
                <div class="modal-body">
                    <div style="display:flex; gap:20px;">
                        <!-- Image Upload Area (Dual) -->
                        <div style="flex:0 0 160px; display:flex; flex-direction:column; gap:10px;">
                            <!-- IMG 1 -->
                            <div
                                style="width:160px; height:160px; border:2px dashed var(--border); border-radius:8px; display:flex; align-items:center; justify-content:center; overflow:hidden; position:relative; background:#1f2937;">
                                <img v-if="editingPart.img1" :src="editingPart.img1"
                                    style="width:100%; height:100%; object-fit:contain;">
                                <div
                                    style="position:absolute; top:5px; left:5px; background:rgba(0,0,0,0.6); color:white; padding:2px 6px; border-radius:4px; font-size:10px;">
                                    IMG 1</div>
                                <i v-if="editingPart.img1" class="fa-solid fa-times"
                                    @click.prevent="editingPart.img1=''"
                                    style="position:absolute; top:5px; right:5px; cursor:pointer; background:rgba(0,0,0,0.6); color:white; padding:4px; border-radius:50%;"></i>

                                <input type="file" @change="(e) => handleImageUpload(e, 1)" accept="image/*"
                                    style="position:absolute; inset:0; opacity:0; cursor:pointer;">
                                <div v-if="!editingPart.img1" style="color:#666; text-align:center; font-size:11px;">
                                    Click or Paste<br>(Main)
                                </div>
                            </div>
                            <!-- IMG 2 -->
                            <div
                                style="width:160px; height:160px; border:2px dashed var(--border); border-radius:8px; display:flex; align-items:center; justify-content:center; overflow:hidden; position:relative; background:#1f2937;">
                                <img v-if="editingPart.img2" :src="editingPart.img2"
                                    style="width:100%; height:100%; object-fit:contain;">
                                <div
                                    style="position:absolute; top:5px; left:5px; background:rgba(0,0,0,0.6); color:white; padding:2px 6px; border-radius:4px; font-size:10px;">
                                    IMG 2</div>
                                <i v-if="editingPart.img2" class="fa-solid fa-times"
                                    @click.prevent="editingPart.img2=''"
                                    style="position:absolute; top:5px; right:5px; cursor:pointer; background:rgba(0,0,0,0.6); color:white; padding:4px; border-radius:50%;"></i>

                                <input type="file" @change="(e) => handleImageUpload(e, 2)" accept="image/*"
                                    style="position:absolute; inset:0; opacity:0; cursor:pointer;">
                                <div v-if="!editingPart.img2" style="color:#666; text-align:center; font-size:11px;">
                                    Click or Paste<br>(Sub)
                                </div>
                            </div>
                        </div>

                        <!-- Form Fields -->
                        <div style="flex:1; display:flex; flex-direction:column; gap:10px;">
                            <div class="grid">
                                <div>
                                    <small>Íµ¨Î∂Ñ (Categor√≠a)</small>
                                    <select v-model="editingPart.category" class="input">
                                        <option value="INYECCION">INYECCION</option>
                                        <option value="PRENSAS">PRENSAS</option>
                                        <option value="ESPUMADO">ESPUMADO</option>
                                        <option value="TAMPOGRAFIA">TAMPOGRAFIA</option>
                                        <option value="PINTURA">PINTURA</option>
                                        <option value="CALIDAD">CALIDAD</option>
                                        <option value="NO USO">NO USO</option>
                                        <option value="OTROS">OTROS</option>
                                    </select>
                                </div>
                                <div>
                                    <small>ÌòÑÏû¨ ÏÉÅÌÉú (Estado Actual)</small>
                                    <select v-model="editingPart.status" class="input">
                                        <option value="ÏÇ¨Ïö©Ï§ë">ÏÇ¨Ïö©Ï§ë (In Use)</option>
                                        <option value="ÎØ∏ÏÇ¨Ïö©">ÎØ∏ÏÇ¨Ïö© (Not in Use)</option>
                                        <option value="Î∞òÎÇ©">Î∞òÎÇ© (Returned)</option>
                                    </select>
                                </div>
                            </div>

                            <div class="grid">
                                <div>
                                    <small>ÏûêÏÇ∞ ÏΩîÎìú (C√≥d. Activo)</small>
                                    <input v-model="editingPart.assetCode" class="input" placeholder="ÌïÑÏàò (Requerido)">
                                </div>
                                <div>
                                    <small>Î™ÖÌåê ÏΩîÎìú (C√≥d. Placa)</small>
                                    <input v-model="editingPart.nameplateCode" class="input">
                                </div>
                            </div>

                            <div>
                                <small>ÏÑ§Î™Ö (Descripci√≥n)</small>
                                <textarea v-model="editingPart.description" class="input" rows="3"></textarea>
                            </div>

                            <div>
                                <small>Ïù¥Î†• (Historial)</small>
                                <textarea v-model="editingPart.history" class="input" rows="2"
                                    placeholder="Ïú†ÏßÄÎ≥¥Ïàò ÎòêÎäî ÏúÑÏπò Ïù¥Î†• (Historial de mantenimiento o ubicaci√≥n)..."></textarea>
                            </div>
                            <!-- Quarterly Status Edit -->
                            <div
                                style="background:var(--bg-input); padding:10px; border-radius:6px; border:1px solid var(--border);">
                                <div style="font-weight:bold; margin-bottom:5px; color:var(--accent);">
                                    {{ selectedYear }} Î∂ÑÍ∏∞Î≥Ñ ÏÉÅÌÉú (Estado Trimestral)
                                </div>
                                <div class="grid" style="grid-template-columns: 1fr 1fr 1fr 1fr; gap:5px;">
                                    <div>
                                        <small>Q1</small>
                                        <select v-model="editingQuarterly.q1" class="input" style="font-size:12px;">
                                            <option value="">-</option>
                                            <option value="use">O (Use)</option>
                                            <option value="not">X (Not)</option>
                                            <option value="ret">Return</option>
                                        </select>
                                    </div>
                                    <div>
                                        <small>Q2</small>
                                        <select v-model="editingQuarterly.q2" class="input" style="font-size:12px;">
                                            <option value="">-</option>
                                            <option value="use">O (Use)</option>
                                            <option value="not">X (Not)</option>
                                            <option value="ret">Return</option>
                                        </select>
                                    </div>
                                    <div>
                                        <small>Q3</small>
                                        <select v-model="editingQuarterly.q3" class="input" style="font-size:12px;">
                                            <option value="">-</option>
                                            <option value="use">O (Use)</option>
                                            <option value="not">X (Not)</option>
                                            <option value="ret">Return</option>
                                        </select>
                                    </div>
                                    <div>
                                        <small>Q4</small>
                                        <select v-model="editingQuarterly.q4" class="input" style="font-size:12px;">
                                            <option value="">-</option>
                                            <option value="use">O (Use)</option>
                                            <option value="not">X (Not)</option>
                                            <option value="ret">Return</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Modal Footer -->
                <div class="modal-footer">
                    <button v-if="editingPart.id" class="btn danger" style="margin-right:auto;" @click="deletePart">ÏÇ≠Ï†ú
                        (Eliminar)</button>
                    <button class="btn" @click="showPartModal=false">Ï∑®ÏÜå (Cancelar)</button>
                    <button class="btn primary" @click="savePart">Ï†ÄÏû• (Guardar)</button>
                </div>
            </div>
        </div>

        <!-- DATA MODAL -->
        <div v-if="showDataModal" class="modal-overlay" @click.self="showDataModal=false">
            <div class="modal" style="width:400px;">
                <div class="modal-header">Î∞±ÏóÖ Î∞è Î≥µÏõê (Respaldo y Restauraci√≥n) <i class="fa-solid fa-times"
                        style="cursor:pointer;" @click="showDataModal=false"></i></div>
                <div class="modal-body">
                    <div style="margin-bottom:20px;">
                        <h4>1. Î∞±ÏóÖ (Exportar)</h4>
                        <button class="btn primary" style="width:100%;" @click="downloadJsonBackup"><i
                                class="fa-solid fa-download"></i> JSON Îã§Ïö¥Î°úÎìú (Descargar JSON)</button>
                    </div>
                    <div>
                        <h4>2. Î≥µÏõê (Importar)</h4>
                        <button class="btn" style="width:100%; position:relative; overflow:hidden;">
                            <i class="fa-solid fa-upload"></i> ÌååÏùº ÏÑ†ÌÉù (Seleccionar Archivo)
                            <input type="file" accept=".json" @change="uploadJsonRestore"
                                style="position:absolute; inset:0; opacity:0; cursor:pointer;">
                        </button>
                    </div>
                    <div style="margin-top:30px; border-top:1px solid #444; padding-top:20px;">
                        <button class="btn danger" style="width:100%;" @click="clearAllData">
                            <i class="fa-solid fa-trash-can"></i> Ï†ÑÏ≤¥ Îç∞Ïù¥ÌÑ∞ ÏÇ≠Ï†ú (Borrar Todo)
                        </button>
                    </div>
                </div>
                <div class="modal-footer"><button class="btn" @click="showDataModal=false">Îã´Í∏∞ (Cerrar)</button></div>
            </div>
        </div>

        <!-- CLOUD MODAL -->
        <div v-if="showCloudModal" class="modal-overlay" @click.self="showCloudModal=false">
            <div class="modal" style="width:400px;">
                <div class="modal-header">ÌÅ¥ÎùºÏö∞Îìú ÌîÑÎ°úÏ†ùÌä∏ ÏÑ†ÌÉù (Sel. Proyecto Nube) <i class="fa-solid fa-times"
                        style="cursor:pointer;" @click="showCloudModal=false"></i></div>
                <div class="modal-body">
                    <p style="color:var(--text-muted); font-size:12px; margin-bottom:15px;">Î≥µÏõêÌï† ÌîÑÎ°úÏ†ùÌä∏ ÏÑ†ÌÉù (Sel. proyecto
                        para restaurar)<br>ÌòÑÏû¨ Îç∞Ïù¥ÌÑ∞Í∞Ä ÎçÆÏñ¥ÏîåÏõåÏßëÎãàÎã§. (Se sobrescribir√°n los datos actuales.)</p>
                    <div v-for="p in cloudProjectsList" :key="p.name"
                        style="display:flex; align-items:center; gap:5px; margin-bottom:5px;">
                        <button class="btn" style="text-align:left; justify-content:flex-start; flex:1;"
                            @click="loadSelectedCloudProject(p.name)">
                            <i class="fa-solid fa-folder" style="color:var(--blue); margin-right:10px;"></i>
                            {{ p.name }} <span style="margin-left:auto; font-size:11px; color:#888;">({{ p.count
                                }})</span>
                        </button>
                        <button class="btn danger" style="padding:0 10px;" @click.stop="deleteCloudProject(p.name)"
                            title="ÏÇ≠Ï†ú (Eliminar)">
                            <i class="fa-solid fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ImageViewer Overlay -->
        <div v-if="zoomedImage" class="modal-overlay" @click="zoomedImage=null">
            <img :src="zoomedImage" style="max-width:90%; max-height:90vh; border-radius:8px; border:2px solid white;">
        </div>

    </div>

    <script>
        const CLOUD_URL = "https://script.google.com/macros/s/AKfycbyQxtAwkMp_KbRBU_xH-NPj6Md_NJAWYAX-BFxyv8z5oGTM3Kf4vrNQhqJRBfc6JNH-/exec";
        const { createApp, ref, computed, reactive, onMounted, onUnmounted, nextTick } = Vue;
        const db = new Dexie('RentalAssetDB');
        db.version(2).stores({
            projects: '++id, name, updated',
            assets: '++id, projectId, category, assetCode, nameplateCode, status'
        }).upgrade(tx => {
            // Version 2 migration if needed, but schema changes are mostly additions
        });

        createApp({
            setup() {
                const projects = ref([]);
                const currentProject = ref(null);
                const projectParts = ref([]);
                const searchQuery = ref("");
                const showPartModal = ref(false);
                const showDataModal = ref(false);
                const showCloudModal = ref(false);
                const isSyncing = ref(false);
                const isImageProcessing = ref(false);
                const zoomedImage = ref(null);
                const sortKey = ref('assetCode');
                const sortOrder = ref(1);
                const showReportModal = ref(false);

                const selectedYear = ref(new Date().getFullYear());

                const cloudProjectsList = ref([]);
                const rawCloudData = ref([]);

                const columns = ref([
                    { key: 'no', label: 'No.', width: 40, visible: true, sortable: false },
                    { key: 'img', label: 'Ïù¥ÎØ∏ÏßÄ (Img)', width: 70, visible: true, sortable: false },
                    { key: 'category', label: 'Íµ¨Î∂Ñ (Cat.)', width: 100, visible: true, sortable: true },
                    { key: 'assetCode', label: 'ÏûêÏÇ∞ ÏΩîÎìú (C√≥digo)', width: 100, visible: true, sortable: true },
                    { key: 'nameplateCode', label: 'Î™ÖÌåê (Placa)', width: 100, visible: true, sortable: true },
                    { key: 'description', label: 'ÏÑ§Î™Ö (Desc.)', width: 150, visible: true, sortable: true },
                    { key: 'status', label: 'ÏÉÅÌÉú (Estado)', width: 80, visible: true, sortable: true },
                    { key: 'q1', label: 'Q1', width: 40, visible: true, sortable: false },
                    { key: 'q2', label: 'Q2', width: 40, visible: true, sortable: false },
                    { key: 'q3', label: 'Q3', width: 40, visible: true, sortable: false },
                    { key: 'q4', label: 'Q4', width: 40, visible: true, sortable: false },
                    { key: 'history', label: 'Ïù¥Î†• (Historial)', width: 150, visible: true, sortable: true },
                    { key: 'action', label: 'Ìé∏Ïßë', width: 50, visible: true, sortable: false },
                ]);

                const visibleColumns = computed(() => columns.value.filter(c => c.visible));

                const defaultPart = {
                    projectId: null,
                    category: 'INYECCION',
                    assetCode: '',
                    nameplateCode: '',
                    description: '',
                    status: 'ÏÇ¨Ïö©Ï§ë',
                    img1: '',
                    img2: '',
                    history: '',
                    quarterly: {} // { "2024": { q1: 'use', q2: 'not' ... } }
                };
                const editingPart = reactive({ ...defaultPart });
                const editingQuarterly = reactive({ q1: '', q2: '', q3: '', q4: '' });

                // --- Global Paste Listener ---
                const handlePaste = (e) => {
                    if (!showPartModal.value) return;
                    const items = (e.clipboardData || e.originalEvent.clipboardData).items;
                    for (let item of items) {
                        if (item.kind === 'file' && item.type.includes('image/')) {
                            e.preventDefault();
                            const blob = item.getAsFile();
                            // If img1 empty, target 1. Else if img2 empty, target 2. Else replace 1.
                            let target = 1;
                            if (editingPart.img1 && !editingPart.img2) target = 2;
                            processImageFile(blob, target);
                            return;
                        }
                    }
                };

                onMounted(async () => {
                    loadProjects();
                    window.addEventListener('paste', handlePaste);
                    const lastId = localStorage.getItem('lastRentalProjectId');
                    if (lastId) {
                        const p = await db.projects.get(parseInt(lastId));
                        if (p) selectProject(p);
                    }
                });

                onUnmounted(() => {
                    window.removeEventListener('paste', handlePaste);
                });


                const filteredParts = computed(() => {
                    let p = projectParts.value;
                    const q = searchQuery.value.toLowerCase();
                    if (q) p = p.filter(x =>
                        (x.assetCode || '').toLowerCase().includes(q) ||
                        (x.nameplateCode || '').toLowerCase().includes(q) ||
                        (x.description || '').toLowerCase().includes(q)
                    );

                    const k = sortKey.value;
                    const o = sortOrder.value;
                    return p.sort((a, b) => {
                        let va = (a[k] || '').toString().toLowerCase();
                        let vb = (b[k] || '').toString().toLowerCase();
                        if (va < vb) return -1 * o;
                        if (va > vb) return 1 * o;
                        return 0;
                    });
                });

                const sortTable = (key) => {
                    if (sortKey.value === key) sortOrder.value *= -1;
                    else { sortKey.value = key; sortOrder.value = 1; }
                };

                // --- Project Management ---
                const loadProjects = async () => { projects.value = await db.projects.toArray(); };
                const createProject = async () => {
                    const n = prompt("ÌîÑÎ°úÏ†ùÌä∏ Ïù¥Î¶Ñ (Nombre del Proyecto):"); if (!n) return;
                    await db.projects.add({ name: n, updated: new Date() });
                    loadProjects();
                };
                const selectProject = async (p) => {
                    currentProject.value = p;
                    projectParts.value = await db.assets.where('projectId').equals(p.id).toArray();
                    localStorage.setItem('lastRentalProjectId', p.id);
                };
                const deleteProject = async (p) => {
                    if (!confirm(`ÌîÑÎ°úÏ†ùÌä∏ '${p.name}' Î∞è Î™®Îì† ÏûêÏÇ∞ÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå? (Delete project and assets?)`)) return;
                    await db.projects.delete(p.id);
                    await db.assets.where('projectId').equals(p.id).delete();
                    if (currentProject.value?.id === p.id) { currentProject.value = null; projectParts.value = []; }
                    loadProjects();
                };

                // --- Part Management ---
                const openAddModal = () => {
                    if (!currentProject.value) return alert("ÌîÑÎ°úÏ†ùÌä∏Î•º Î®ºÏ†Ä ÏÑ†ÌÉùÌïòÏÑ∏Ïöî! (¬°Seleccione un proyecto primero!)");
                    Object.assign(editingPart, { ...defaultPart, projectId: currentProject.value.id, quarterly: {} });

                    // Reset Quarterly edit Proxy
                    editingQuarterly.q1 = ''; editingQuarterly.q2 = ''; editingQuarterly.q3 = ''; editingQuarterly.q4 = '';

                    showPartModal.value = true;
                };

                const editPart = (p) => {
                    Object.assign(editingPart, JSON.parse(JSON.stringify(p)));

                    // Migration: If old img exists but new img1 doesn't, move it
                    if (p.img && !editingPart.img1) editingPart.img1 = p.img;
                    if (!editingPart.quarterly) editingPart.quarterly = {};

                    // Load Quarterly Status for current Year
                    const y = selectedYear.value.toString();
                    const qData = editingPart.quarterly[y] || { q1: '', q2: '', q3: '', q4: '' };
                    Object.assign(editingQuarterly, qData);

                    showPartModal.value = true;
                };

                const savePart = async () => {
                    if (isImageProcessing.value) return alert("Ïù¥ÎØ∏ÏßÄ Ï≤òÎ¶¨ Ï§ë... (Procesando imagen...)");
                    if (!editingPart.assetCode) return alert("ÏûêÏÇ∞ ÏΩîÎìúÎäî ÌïÑÏàòÏûÖÎãàÎã§! (Asset Code Required!)");

                    const copy = JSON.parse(JSON.stringify(editingPart));

                    // Save Quarterly Data
                    const y = selectedYear.value.toString();
                    if (!copy.quarterly) copy.quarterly = {};
                    copy.quarterly[y] = { ...editingQuarterly };

                    if (copy.id) {
                        projectParts.value = projectParts.value.map(p => p.id === copy.id ? copy : p);
                        await db.assets.put(copy);
                    } else {
                        const id = await db.assets.add(copy);
                        copy.id = id;
                        projectParts.value.push(copy);
                    }
                    showPartModal.value = false;
                };

                const deletePart = async () => {
                    if (!confirm("Ïù¥ ÏûêÏÇ∞ÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå? (Delete this asset?)")) return;
                    await db.assets.delete(editingPart.id);
                    projectParts.value = projectParts.value.filter(p => p.id !== editingPart.id);
                    showPartModal.value = false;
                };

                // --- Image Logic ---
                const handleImageUpload = (e, targetNum) => {
                    const f = e.target.files[0]; if (!f) return;
                    processImageFile(f, targetNum);
                };

                const processImageFile = (file, targetNum) => {
                    isImageProcessing.value = true;
                    const r = new FileReader();
                    r.onload = (ev) => {
                        const img = new Image();
                        img.onload = () => {
                            const c = document.createElement('canvas');
                            const MAX_SIZE = 800;
                            let width = img.width;
                            let height = img.height;

                            if (width > height) {
                                if (width > MAX_SIZE) { height *= MAX_SIZE / width; width = MAX_SIZE; }
                            } else {
                                if (height > MAX_SIZE) { width *= MAX_SIZE / height; height = MAX_SIZE; }
                            }

                            c.width = width;
                            c.height = height;
                            c.getContext('2d').drawImage(img, 0, 0, width, height);

                            const dataUrl = c.toDataURL('image/jpeg', 0.7);
                            if (targetNum === 1) editingPart.img1 = dataUrl;
                            else editingPart.img2 = dataUrl;

                            isImageProcessing.value = false;
                        };
                        img.src = ev.target.result;
                    };
                    r.readAsDataURL(file);
                };

                const setModalImage = (src) => { zoomedImage.value = src; }

                // --- Report & Util ---
                const openReport = () => { showReportModal.value = true; };

                const getQuarterSymbol = (p, qKey) => {
                    const y = selectedYear.value.toString();
                    if (!p.quarterly || !p.quarterly[y]) return '-';
                    const val = p.quarterly[y][qKey];
                    if (val === 'use') return 'O';
                    if (val === 'not') return 'X';
                    if (val === 'ret') return 'Return';
                    return '-';
                };

                const getQuarterColor = (p, qKey) => {
                    const y = selectedYear.value.toString();
                    if (!p.quarterly || !p.quarterly[y]) return '#ccc';
                    const val = p.quarterly[y][qKey];
                    if (val === 'use') return 'green';
                    if (val === 'not') return 'orange';
                    if (val === 'ret') return 'gray';
                    return 'black';
                };

                const getQuarterSymbolClass = (p, qKey) => {
                    const y = selectedYear.value.toString();
                    if (!p.quarterly || !p.quarterly[y]) return '';
                    const val = p.quarterly[y][qKey];
                    if (val === 'use') return 'sym-use text-green-500';
                    if (val === 'not') return 'sym-not text-orange-500';
                    if (val === 'ret') return 'sym-ret text-gray-500';
                    return '';
                };

                // --- Cloud Logic ---
                const syncToCloud = async () => {
                    if (!currentProject.value) return alert("ÌîÑÎ°úÏ†ùÌä∏Î•º Î®ºÏ†Ä ÏÑ†ÌÉùÌïòÏÑ∏Ïöî! (¬°Seleccione proyecto primero!)");
                    if (!confirm("ÌÅ¥ÎùºÏö∞ÎìúÏóê Ï†ÄÏû•ÌïòÏãúÍ≤†ÏäµÎãàÍπå? (ÌòÑÏû¨ Îç∞Ïù¥ÌÑ∞ ÎçÆÏñ¥Ïì∞Í∏∞)\nSave to Cloud? (Overwrite)")) return;
                    isSyncing.value = true;
                    try {
                        const batchId = Date.now();
                        let partsToSend;

                        if (projectParts.value.length === 0) {
                            partsToSend = [{
                                project: currentProject.value.name,
                                batchId: batchId,
                                assetCode: 'EMPTY_PROJECT_MARKER',
                                isMarker: true
                            }];
                        } else {
                            partsToSend = projectParts.value.map(p => ({
                                ...p,
                                project: currentProject.value.name,
                                batchId: batchId
                            }));
                        }

                        const r = await fetch(CLOUD_URL, {
                            method: 'POST',
                            redirect: 'follow', // GAS Î¶¨Îã§Ïù¥Î†âÌä∏ Ï≤òÎ¶¨ ÌïÑÏàò
                            body: JSON.stringify({ action: 'save', project: currentProject.value.name, parts: partsToSend })
                        });
                        const res = await r.json();
                        if (res.result === 'error') throw new Error(res.message);
                        alert(`Ï†ÄÏû• ÏôÑÎ£å! (Guardado!) (${partsToSend.length} items)`);
                    } catch (e) { alert("Error: " + e); } finally { isSyncing.value = false; }
                };

                const syncFromCloud = async () => {
                    isSyncing.value = true;
                    try {
                        const r = await fetch(CLOUD_URL + "?action=load", {
                            method: "GET",
                            redirect: "follow"
                        });
                        if (!r.ok) throw new Error("HTTP error: " + r.status);

                        const d = await r.json();
                        if (!d || !d.parts || d.parts.length === 0) return alert("ÌÅ¥ÎùºÏö∞ÎìúÏóê Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§. (No data in cloud.)");

                        rawCloudData.value = d.parts;

                        const counts = {};
                        d.parts.forEach(p => {
                            const name = (p.project || 'Unknown').trim();
                            counts[name] = (counts[name] || 0) + 1;
                        });

                        cloudProjectsList.value = Object.keys(counts).map(name => ({
                            name: name,
                            count: counts[name]
                        })).sort((a, b) => b.count - a.count);

                        showCloudModal.value = true;
                    } catch (e) { alert("Error: " + e); } finally { isSyncing.value = false; }
                };

                const loadSelectedCloudProject = async (pName) => {
                    if (!confirm(`ÌòÑÏû¨ ÌîÑÎ°úÏ†ùÌä∏Î•º ÍµêÏ≤¥ÌïòÏãúÍ≤†ÏäµÎãàÍπå? (Replace current project with '${pName}'?)`)) return;

                    let targetProj = projects.value.find(p => p.name === pName);
                    if (!targetProj) {
                        const id = await db.projects.add({ name: pName, updated: new Date() });
                        await loadProjects();
                        targetProj = projects.value.find(p => p.id === id);
                    }

                    await selectProject(targetProj);

                    const cloudParts = JSON.parse(JSON.stringify(rawCloudData.value.filter(p => (p.project || 'Unknown') === pName)));
                    if (cloudParts.length === 0) return alert("Îç∞Ïù¥ÌÑ∞Î•º Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§. (No data found.)");

                    const latestBatchId = cloudParts.reduce((max, p) => Math.max(max, p.batchId || 0), 0);
                    let latestParts = cloudParts.filter(p => (p.batchId || 0) === latestBatchId);

                    // Filter out markers
                    latestParts = latestParts.filter(p => !p.isMarker && p.assetCode !== 'EMPTY_PROJECT_MARKER');

                    projectParts.value = [];
                    await db.assets.where('projectId').equals(targetProj.id).delete();

                    if (latestParts.length > 0) {
                        const toAdd = latestParts.map(p => {
                            const { id, project, batchId, _syncId, ...rest } = p;
                            // Ensure projectId is a primitive number
                            const pid = Number(targetProj.id);
                            return { ...rest, projectId: pid };
                        });

                        // [Fix] Remove ANY reactivity or proxies by deep cloning the final array
                        const cleanToAdd = JSON.parse(JSON.stringify(toAdd));
                        await db.assets.bulkAdd(cleanToAdd);
                    }

                    projectParts.value = await db.assets.where('projectId').equals(targetProj.id).toArray();
                    alert(`Î°úÎìú ÏôÑÎ£å. ('${pName}' Loaded.)`);
                    showCloudModal.value = false;
                };

                const deleteCloudProject = async (pName) => {
                    if (!confirm(`ÌÅ¥ÎùºÏö∞ÎìúÏóêÏÑú ÏòÅÍµ¨ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå? (Delete '${pName}' permanently?)`)) return;
                    isSyncing.value = true;
                    try {
                        const r = await fetch(CLOUD_URL, {
                            method: 'POST',
                            body: JSON.stringify({ action: 'save', project: pName, parts: [] })
                        });
                        const res = await r.json();
                        if (res.result === 'error') throw new Error(res.message);
                        alert("ÌÅ¥ÎùºÏö∞ÎìúÏóêÏÑú ÏÇ≠Ï†úÎê®. (Deleted from Cloud.)");
                        await syncFromCloud();
                    } catch (e) { alert("Error: " + e); isSyncing.value = false; }
                };


                // --- Backup/Restore ---
                const downloadJsonBackup = () => {
                    db.transaction('r', db.projects, db.assets, async () => {
                        const allProjects = await db.projects.toArray();
                        const allAssets = await db.assets.toArray();
                        const data = { projects: allProjects, assets: allAssets };
                        const blob = new Blob([JSON.stringify(data)], { type: "application/json" });
                        const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
                        a.download = `RentalHelper_${new Date().toISOString().slice(0, 10)}.json`; a.click();
                    });
                };

                const uploadJsonRestore = (e) => {
                    const f = e.target.files[0]; if (!f) return;
                    const r = new FileReader();
                    r.onload = async (ev) => {
                        try {
                            const d = JSON.parse(ev.target.result);
                            if (confirm("Î≥µÏõêÌïòÎ©¥ Î™®Îì† Îç∞Ïù¥ÌÑ∞Í∞Ä ÏßÄÏõåÏßëÎãàÎã§. Í≥ÑÏÜçÌïòÏãúÍ≤†ÏäµÎãàÍπå? (Restore will WIPE all data. Continue?)")) {
                                await db.projects.clear(); await db.assets.clear();
                                if (d.projects) await db.projects.bulkAdd(d.projects);
                                if (d.assets) await db.assets.bulkAdd(d.assets);
                                location.reload();
                            }
                        } catch (er) { alert("Invalid File"); }
                    }; r.readAsText(f);
                };

                const clearAllData = async () => {
                    if (confirm("Î™®Îì† Îç∞Ïù¥ÌÑ∞Î•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå? (Delete ALL data? Irreversible!)")) {
                        await db.projects.clear();
                        await db.assets.clear();
                        localStorage.clear();
                        window.location.reload();
                    }
                }

                onMounted(async () => {
                    await loadProjects();
                    const lastId = localStorage.getItem('lastRentalProjectId');
                    if (lastId) {
                        const p = await db.projects.get(parseInt(lastId));
                        if (p) selectProject(p);
                    }
                });

                return {
                    projects, currentProject, filteredParts, searchQuery,
                    showPartModal, showDataModal, isSyncing, isImageProcessing,
                    editingPart, zoomedImage, visibleColumns, sortKey, sortOrder,
                    showCloudModal, cloudProjectsList, selectedYear, editingQuarterly,
                    showReportModal, // Added
                    createProject, selectProject, deleteProject,
                    openAddModal, editPart, savePart, deletePart,
                    handleImageUpload, setModalImage, sortTable, getQuarterSymbol, getQuarterSymbolClass, getQuarterColor,
                    syncToCloud, syncFromCloud, loadSelectedCloudProject, deleteCloudProject,
                    downloadJsonBackup, uploadJsonRestore, clearAllData, openReport,
                    printReport: () => window.print(),
                    captureReport: async () => {
                        const el = document.getElementById('report-print-area');
                        const canvas = await html2canvas(el, { scale: 2 });
                        const a = document.createElement('a');
                        a.href = canvas.toDataURL();
                        a.download = `RentalAssetReport_${selectedYear.value}.png`;
                        a.click();
                    }
                };
            }
        }).mount('#app');

        // Sidebar Toggle
        window.toggleSidebar = function () {
            document.body.classList.toggle('sidebar-collapsed');
            const btn = document.getElementById('btn-toggle-sidebar');
            if (document.body.classList.contains('sidebar-collapsed')) {
                btn.innerText = "‚ñ∂";
            } else {
                btn.innerText = "‚óÄ";
            }
            setTimeout(() => window.dispatchEvent(new Event('resize')), 300);
        };
    </script>
</body>

</html>